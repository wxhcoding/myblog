<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-rc.0">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/myblog/assets/img/favicon.ico"><link rel="manifest" href="/myblog/manifest.webmanifest"><meta name="theme-color" content="#3eaf7c"><title>Kafka | Jhw-Blog</title><meta name="description" content="Jhw-Blog">
    <link rel="preload" href="/myblog/assets/style-cpavdnw8.css" as="style"><link rel="stylesheet" href="/myblog/assets/style-cpavdnw8.css">
    <link rel="modulepreload" href="/myblog/assets/app-1lTnJ-Z-.js"><link rel="modulepreload" href="/myblog/assets/kafka.html-TqyYtOJI.js"><link rel="modulepreload" href="/myblog/assets/kafka.html-Hm-frda-.js">
    <link rel="prefetch" href="/myblog/assets/index.html-Wl1PsAI-.js" as="script"><link rel="prefetch" href="/myblog/assets/distributed-lock.html-EqBnxiPq.js" as="script"><link rel="prefetch" href="/myblog/assets/distributed-transaction.html-tL9JC4dQ.js" as="script"><link rel="prefetch" href="/myblog/assets/es6.html-ZIFOMWSy.js" as="script"><link rel="prefetch" href="/myblog/assets/headline.html-iQxNz79q.js" as="script"><link rel="prefetch" href="/myblog/assets/javaweb.html-eWdk1uNe.js" as="script"><link rel="prefetch" href="/myblog/assets/vue.html-Gu8dUKxJ.js" as="script"><link rel="prefetch" href="/myblog/assets/about.html-Mmqs-yBX.js" as="script"><link rel="prefetch" href="/myblog/assets/leetcode.html-d9qMMonP.js" as="script"><link rel="prefetch" href="/myblog/assets/project_learn.html-i6UvzIJa.js" as="script"><link rel="prefetch" href="/myblog/assets/docker.html-U-NptGUz.js" as="script"><link rel="prefetch" href="/myblog/assets/git.html-QKdD4BLW.js" as="script"><link rel="prefetch" href="/myblog/assets/linux.html-95BIkgfo.js" as="script"><link rel="prefetch" href="/myblog/assets/maven.html-zzF1XH4C.js" as="script"><link rel="prefetch" href="/myblog/assets/node.html-7wc2oKut.js" as="script"><link rel="prefetch" href="/myblog/assets/logback.html-yhzJS4yv.js" as="script"><link rel="prefetch" href="/myblog/assets/mybatis.html-Bz52-a_8.js" as="script"><link rel="prefetch" href="/myblog/assets/java_basic.html-tP4Yo5Sj.js" as="script"><link rel="prefetch" href="/myblog/assets/juc.html-6HoHfEGd.js" as="script"><link rel="prefetch" href="/myblog/assets/jvm.html-iEXdtkqR.js" as="script"><link rel="prefetch" href="/myblog/assets/spring.html-Y9UzXRue.js" as="script"><link rel="prefetch" href="/myblog/assets/springboot.html-ygPSVqH8.js" as="script"><link rel="prefetch" href="/myblog/assets/springcloud.html-Wxl5NcN3.js" as="script"><link rel="prefetch" href="/myblog/assets/spring_mvc.html-qp9D9o3C.js" as="script"><link rel="prefetch" href="/myblog/assets/ssm.html-eXce4ppB.js" as="script"><link rel="prefetch" href="/myblog/assets/elasticsearch.html-dt57WX6m.js" as="script"><link rel="prefetch" href="/myblog/assets/redis.html-Fo1p0r9s.js" as="script"><link rel="prefetch" href="/myblog/assets/redis_basic.html-G53LLX0K.js" as="script"><link rel="prefetch" href="/myblog/assets/redis_practice.html-TPHnUGzX.js" as="script"><link rel="prefetch" href="/myblog/assets/mysql_advanced.html-M6nIRymX.js" as="script"><link rel="prefetch" href="/myblog/assets/mysql_basic.html-vOaRzrU0.js" as="script"><link rel="prefetch" href="/myblog/assets/404.html-6ekMbMKm.js" as="script"><link rel="prefetch" href="/myblog/assets/index.html-qr4Og0Rr.js" as="script"><link rel="prefetch" href="/myblog/assets/distributed-lock.html-XUub3Fym.js" as="script"><link rel="prefetch" href="/myblog/assets/distributed-transaction.html-Z6y0cTF-.js" as="script"><link rel="prefetch" href="/myblog/assets/es6.html-E3eKG72j.js" as="script"><link rel="prefetch" href="/myblog/assets/headline.html-6RamNUSU.js" as="script"><link rel="prefetch" href="/myblog/assets/javaweb.html-1TeHUZPw.js" as="script"><link rel="prefetch" href="/myblog/assets/vue.html-WUpgFl2K.js" as="script"><link rel="prefetch" href="/myblog/assets/about.html-Er1rP_zQ.js" as="script"><link rel="prefetch" href="/myblog/assets/leetcode.html-hXt3DFmj.js" as="script"><link rel="prefetch" href="/myblog/assets/project_learn.html-BA3TzwH0.js" as="script"><link rel="prefetch" href="/myblog/assets/docker.html-8CsL54Kw.js" as="script"><link rel="prefetch" href="/myblog/assets/git.html-tk22OH3D.js" as="script"><link rel="prefetch" href="/myblog/assets/linux.html-XNDiQSL9.js" as="script"><link rel="prefetch" href="/myblog/assets/maven.html-EX-RejGP.js" as="script"><link rel="prefetch" href="/myblog/assets/node.html-nWfdA14A.js" as="script"><link rel="prefetch" href="/myblog/assets/logback.html-cNyE_cya.js" as="script"><link rel="prefetch" href="/myblog/assets/mybatis.html-NP16NZEg.js" as="script"><link rel="prefetch" href="/myblog/assets/java_basic.html-VrTOuTVp.js" as="script"><link rel="prefetch" href="/myblog/assets/juc.html-sGjKk3Y1.js" as="script"><link rel="prefetch" href="/myblog/assets/jvm.html-EUA1LDC3.js" as="script"><link rel="prefetch" href="/myblog/assets/spring.html-Gh4CgLBM.js" as="script"><link rel="prefetch" href="/myblog/assets/springboot.html-_s9YqnAk.js" as="script"><link rel="prefetch" href="/myblog/assets/springcloud.html-aOLK_E_h.js" as="script"><link rel="prefetch" href="/myblog/assets/spring_mvc.html-Q6Xl-jwi.js" as="script"><link rel="prefetch" href="/myblog/assets/ssm.html-V0xUMA4v.js" as="script"><link rel="prefetch" href="/myblog/assets/elasticsearch.html-uFK4xAZE.js" as="script"><link rel="prefetch" href="/myblog/assets/redis.html-R9Tcqrr7.js" as="script"><link rel="prefetch" href="/myblog/assets/redis_basic.html-jzaBuldH.js" as="script"><link rel="prefetch" href="/myblog/assets/redis_practice.html-cnuYp868.js" as="script"><link rel="prefetch" href="/myblog/assets/mysql_advanced.html-_NwIumpX.js" as="script"><link rel="prefetch" href="/myblog/assets/mysql_basic.html-pS0iCeJf.js" as="script"><link rel="prefetch" href="/myblog/assets/404.html-KeMubcAJ.js" as="script"><link rel="prefetch" href="/myblog/assets/index-7SG8bi1h.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/myblog/" class=""><img class="logo" src="/myblog/assets/img/logo.png" alt="Jhw-Blog"><span class="site-name can-hide">Jhw-Blog</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/myblog/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="后端"><span class="title">后端</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="后端"><span class="title">后端</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Java</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/myblog/backend/java/java_basic/" class="" aria-label="Java基础"><!--[--><!--]--> Java基础 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/java/jvm/" class="" aria-label="JVM"><!--[--><!--]--> JVM <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/java/juc/" class="" aria-label="JUC"><!--[--><!--]--> JUC <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Spring Framework</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/myblog/backend/spring/spring/" class="" aria-label="Spring IOC|AOP"><!--[--><!--]--> Spring IOC|AOP <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/spring/spring_mvc/" class="" aria-label="SpringMVC"><!--[--><!--]--> SpringMVC <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/spring/ssm/" class="" aria-label="SSM"><!--[--><!--]--> SSM <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/spring/springboot/" class="" aria-label="SpringBoot"><!--[--><!--]--> SpringBoot <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/spring/springcloud/" class="" aria-label="SpringCloud"><!--[--><!--]--> SpringCloud <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>框架</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/myblog/backend/framework/mybatis/" class="" aria-label="MyBatis"><!--[--><!--]--> MyBatis <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/framework/logback/" class="" aria-label="Logback"><!--[--><!--]--> Logback <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="数据库"><span class="title">数据库</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="数据库"><span class="title">数据库</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>SQL</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/myblog/database/sql/mysql_basic/" class="" aria-label="MySQL入门"><!--[--><!--]--> MySQL入门 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/database/sql/mysql_advanced/" class="" aria-label="MySQL高级"><!--[--><!--]--> MySQL高级 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>NoSQL</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/myblog/database/nosql/redis/" class="" aria-label="Redis"><!--[--><!--]--> Redis <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/database/nosql/redis_basic/" class="" aria-label="Redis基础"><!--[--><!--]--> Redis基础 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/database/nosql/redis_practice/" class="" aria-label="Redis实战"><!--[--><!--]--> Redis实战 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/database/nosql/elasticsearch" class="" aria-label="Elasticsearch"><!--[--><!--]--> Elasticsearch <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="分布式"><span class="title">分布式</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="分布式"><span class="title">分布式</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/myblog/distributed/distributed-lock/" class="" aria-label="分布式锁"><!--[--><!--]--> 分布式锁 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/distributed/distributed-transaction/" class="" aria-label="分布式事务"><!--[--><!--]--> 分布式事务 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="工具"><span class="title">工具</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="工具"><span class="title">工具</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/myblog/tools/linux/" class="" aria-label="Linux"><!--[--><!--]--> Linux <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/tools/git/" class="" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/tools/node/" class="" aria-label="Node"><!--[--><!--]--> Node <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/tools/maven/" class="" aria-label="Maven"><!--[--><!--]--> Maven <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/tools/docker/" class="" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/tools/kafka/" class="" aria-label="Kafka"><!--[--><!--]--> Kafka <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="前端"><span class="title">前端</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="前端"><span class="title">前端</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/myblog/fronted/javaweb/" class="" aria-label="JavaWeb"><!--[--><!--]--> JavaWeb <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/fronted/es6/" class="" aria-label="ES6"><!--[--><!--]--> ES6 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/fronted/vue/" class="" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/fronted/headline/" class="" aria-label="微头条"><!--[--><!--]--> 微头条 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="杂记"><span class="title">杂记</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="杂记"><span class="title">杂记</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/myblog/note/project_learn/" class="" aria-label="笔记"><!--[--><!--]--> 笔记 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/note/leetcode/" class="" aria-label="LeetCode"><!--[--><!--]--> LeetCode <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/note/about" class="" aria-label="关于"><!--[--><!--]--> 关于 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/wxhcoding/" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/myblog/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="后端"><span class="title">后端</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="后端"><span class="title">后端</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Java</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/myblog/backend/java/java_basic/" class="" aria-label="Java基础"><!--[--><!--]--> Java基础 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/java/jvm/" class="" aria-label="JVM"><!--[--><!--]--> JVM <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/java/juc/" class="" aria-label="JUC"><!--[--><!--]--> JUC <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Spring Framework</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/myblog/backend/spring/spring/" class="" aria-label="Spring IOC|AOP"><!--[--><!--]--> Spring IOC|AOP <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/spring/spring_mvc/" class="" aria-label="SpringMVC"><!--[--><!--]--> SpringMVC <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/spring/ssm/" class="" aria-label="SSM"><!--[--><!--]--> SSM <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/spring/springboot/" class="" aria-label="SpringBoot"><!--[--><!--]--> SpringBoot <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/spring/springcloud/" class="" aria-label="SpringCloud"><!--[--><!--]--> SpringCloud <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>框架</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/myblog/backend/framework/mybatis/" class="" aria-label="MyBatis"><!--[--><!--]--> MyBatis <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/framework/logback/" class="" aria-label="Logback"><!--[--><!--]--> Logback <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="数据库"><span class="title">数据库</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="数据库"><span class="title">数据库</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>SQL</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/myblog/database/sql/mysql_basic/" class="" aria-label="MySQL入门"><!--[--><!--]--> MySQL入门 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/database/sql/mysql_advanced/" class="" aria-label="MySQL高级"><!--[--><!--]--> MySQL高级 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>NoSQL</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/myblog/database/nosql/redis/" class="" aria-label="Redis"><!--[--><!--]--> Redis <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/database/nosql/redis_basic/" class="" aria-label="Redis基础"><!--[--><!--]--> Redis基础 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/database/nosql/redis_practice/" class="" aria-label="Redis实战"><!--[--><!--]--> Redis实战 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/database/nosql/elasticsearch" class="" aria-label="Elasticsearch"><!--[--><!--]--> Elasticsearch <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="分布式"><span class="title">分布式</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="分布式"><span class="title">分布式</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/myblog/distributed/distributed-lock/" class="" aria-label="分布式锁"><!--[--><!--]--> 分布式锁 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/distributed/distributed-transaction/" class="" aria-label="分布式事务"><!--[--><!--]--> 分布式事务 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="工具"><span class="title">工具</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="工具"><span class="title">工具</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/myblog/tools/linux/" class="" aria-label="Linux"><!--[--><!--]--> Linux <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/tools/git/" class="" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/tools/node/" class="" aria-label="Node"><!--[--><!--]--> Node <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/tools/maven/" class="" aria-label="Maven"><!--[--><!--]--> Maven <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/tools/docker/" class="" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/tools/kafka/" class="" aria-label="Kafka"><!--[--><!--]--> Kafka <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="前端"><span class="title">前端</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="前端"><span class="title">前端</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/myblog/fronted/javaweb/" class="" aria-label="JavaWeb"><!--[--><!--]--> JavaWeb <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/fronted/es6/" class="" aria-label="ES6"><!--[--><!--]--> ES6 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/fronted/vue/" class="" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/fronted/headline/" class="" aria-label="微头条"><!--[--><!--]--> 微头条 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="杂记"><span class="title">杂记</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="杂记"><span class="title">杂记</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/myblog/note/project_learn/" class="" aria-label="笔记"><!--[--><!--]--> 笔记 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/note/leetcode/" class="" aria-label="LeetCode"><!--[--><!--]--> LeetCode <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/note/about" class="" aria-label="关于"><!--[--><!--]--> 关于 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/wxhcoding/" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/myblog/tools/linux.html" class="sidebar-item sidebar-heading" aria-label="Linux"><!--[--><!--]--> Linux <!--[--><!--]--></a><!----></li><li><a href="/myblog/tools/git.html" class="sidebar-item sidebar-heading" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a><!----></li><li><a href="/myblog/tools/node.html" class="sidebar-item sidebar-heading" aria-label="Node"><!--[--><!--]--> Node <!--[--><!--]--></a><!----></li><li><a href="/myblog/tools/maven.html" class="sidebar-item sidebar-heading" aria-label="Maven"><!--[--><!--]--> Maven <!--[--><!--]--></a><!----></li><li><a href="/myblog/tools/docker.html" class="sidebar-item sidebar-heading" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html" class="router-link-active router-link-exact-active router-link-active sidebar-item sidebar-heading active" aria-label="Kafka"><!--[--><!--]--> Kafka <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/myblog/tools/kafka.html#消息队列" class="router-link-active router-link-exact-active sidebar-item" aria-label="消息队列"><!--[--><!--]--> 消息队列 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/myblog/tools/kafka.html#介绍" class="router-link-active router-link-exact-active sidebar-item" aria-label="介绍"><!--[--><!--]--> 介绍 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#消息队列的作用" class="router-link-active router-link-exact-active sidebar-item" aria-label="消息队列的作用"><!--[--><!--]--> 消息队列的作用 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#主流消息队列对比" class="router-link-active router-link-exact-active sidebar-item" aria-label="主流消息队列对比"><!--[--><!--]--> 主流消息队列对比 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#消息分类" class="router-link-active router-link-exact-active sidebar-item" aria-label="消息分类"><!--[--><!--]--> 消息分类 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#kafka特点" class="router-link-active router-link-exact-active sidebar-item" aria-label="Kafka特点"><!--[--><!--]--> Kafka特点 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/myblog/tools/kafka.html#安装使用" class="router-link-active router-link-exact-active sidebar-item" aria-label="安装使用"><!--[--><!--]--> 安装使用 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#kafka基础架构和术语名词" class="router-link-active router-link-exact-active sidebar-item" aria-label="Kafka基础架构和术语名词"><!--[--><!--]--> Kafka基础架构和术语名词 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#kafka常用命令" class="router-link-active router-link-exact-active sidebar-item" aria-label="Kafka常用命令"><!--[--><!--]--> Kafka常用命令 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/myblog/tools/kafka.html#启停命令" class="router-link-active router-link-exact-active sidebar-item" aria-label="启停命令"><!--[--><!--]--> 启停命令 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#主题命令" class="router-link-active router-link-exact-active sidebar-item" aria-label="主题命令"><!--[--><!--]--> 主题命令 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#生产者命令" class="router-link-active router-link-exact-active sidebar-item" aria-label="生产者命令"><!--[--><!--]--> 生产者命令 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#消费者命令" class="router-link-active router-link-exact-active sidebar-item" aria-label="消费者命令"><!--[--><!--]--> 消费者命令 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#消费者组-consumergroup-命令" class="router-link-active router-link-exact-active sidebar-item" aria-label="消费者组(consumerGroup)命令"><!--[--><!--]--> 消费者组(consumerGroup)命令 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#offset偏移量命令" class="router-link-active router-link-exact-active sidebar-item" aria-label="offset偏移量命令"><!--[--><!--]--> offset偏移量命令 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/myblog/tools/kafka.html#kafka原生api入门篇" class="router-link-active router-link-exact-active sidebar-item" aria-label="Kafka原生API入门篇"><!--[--><!--]--> Kafka原生API入门篇 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/myblog/tools/kafka.html#发送消息" class="router-link-active router-link-exact-active sidebar-item" aria-label="发送消息"><!--[--><!--]--> 发送消息 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#消费消息" class="router-link-active router-link-exact-active sidebar-item" aria-label="消费消息"><!--[--><!--]--> 消费消息 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#异步发送消息" class="router-link-active router-link-exact-active sidebar-item" aria-label="异步发送消息"><!--[--><!--]--> 异步发送消息 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#异步发送且callback回调" class="router-link-active router-link-exact-active sidebar-item" aria-label="异步发送且Callback回调"><!--[--><!--]--> 异步发送且Callback回调 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/myblog/tools/kafka.html#kafka原生api高阶篇" class="router-link-active router-link-exact-active sidebar-item" aria-label="Kafka原生API高阶篇"><!--[--><!--]--> Kafka原生API高阶篇 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/myblog/tools/kafka.html#生产者消费者配置类" class="router-link-active router-link-exact-active sidebar-item" aria-label="生产者消费者配置类"><!--[--><!--]--> 生产者消费者配置类 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#生产者分区" class="router-link-active router-link-exact-active sidebar-item" aria-label="生产者分区"><!--[--><!--]--> 生产者分区 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#发送消息ack可靠性" class="router-link-active router-link-exact-active sidebar-item" aria-label="发送消息ack可靠性"><!--[--><!--]--> 发送消息ack可靠性 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#kafka消费模式" class="router-link-active router-link-exact-active sidebar-item" aria-label="Kafka消费模式"><!--[--><!--]--> Kafka消费模式 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#offset偏移量" class="router-link-active router-link-exact-active sidebar-item" aria-label="offset偏移量"><!--[--><!--]--> offset偏移量 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/myblog/tools/kafka.html#kafka分布式集群搭建" class="router-link-active router-link-exact-active sidebar-item" aria-label="Kafka分布式集群搭建"><!--[--><!--]--> Kafka分布式集群搭建 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/myblog/tools/kafka.html#分析" class="router-link-active router-link-exact-active sidebar-item" aria-label="分析"><!--[--><!--]--> 分析 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#搭建" class="router-link-active router-link-exact-active sidebar-item" aria-label="搭建"><!--[--><!--]--> 搭建 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#使用集群" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用集群"><!--[--><!--]--> 使用集群 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/myblog/tools/kafka.html#springboot整合kafka" class="router-link-active router-link-exact-active sidebar-item" aria-label="SpringBoot整合Kafka"><!--[--><!--]--> SpringBoot整合Kafka <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/myblog/tools/kafka.html#生产者" class="router-link-active router-link-exact-active sidebar-item" aria-label="生产者"><!--[--><!--]--> 生产者 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/myblog/tools/kafka.html#创建主题" class="router-link-active router-link-exact-active sidebar-item" aria-label="创建主题"><!--[--><!--]--> 创建主题 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#发送消息-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="发送消息"><!--[--><!--]--> 发送消息 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#生产者事务" class="router-link-active router-link-exact-active sidebar-item" aria-label="生产者事务"><!--[--><!--]--> 生产者事务 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#生产者数据有序" class="router-link-active router-link-exact-active sidebar-item" aria-label="生产者数据有序"><!--[--><!--]--> 生产者数据有序 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/myblog/tools/kafka.html#消费者" class="router-link-active router-link-exact-active sidebar-item" aria-label="消费者"><!--[--><!--]--> 消费者 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/myblog/tools/kafka.html#简单消费" class="router-link-active router-link-exact-active sidebar-item" aria-label="简单消费"><!--[--><!--]--> 简单消费 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#消费指定分区并设置起始offset" class="router-link-active router-link-exact-active sidebar-item" aria-label="消费指定分区并设置起始offset"><!--[--><!--]--> 消费指定分区并设置起始offset <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#手动提交offset" class="router-link-active router-link-exact-active sidebar-item" aria-label="手动提交offset"><!--[--><!--]--> 手动提交offset <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#消费异常处理" class="router-link-active router-link-exact-active sidebar-item" aria-label="消费异常处理"><!--[--><!--]--> 消费异常处理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/tools/kafka.html#消息重试和死信队列" class="router-link-active router-link-exact-active sidebar-item" aria-label="消息重试和死信队列"><!--[--><!--]--> 消息重试和死信队列 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="kafka" tabindex="-1"><a class="header-anchor" href="#kafka" aria-hidden="true">#</a> Kafka</h1><p>Apache Kafka是一个高吞吐量、分布式、可水平扩展的消息传递系统，最初由LinkedIn开发。它的目标是解决海量数据的实时流式处理和传输问题。<br> Kafka的核心思想是将数据转化为流，并以发布-订阅的方式传递。<br><a href="https://kafka.apache.org/" target="_blank" rel="noopener noreferrer">Apache Kafka<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><br><a href="https://kafka.apachecn.org/" target="_blank" rel="noopener noreferrer">Kafka 中文文档<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="消息队列" tabindex="-1"><a class="header-anchor" href="#消息队列" aria-hidden="true">#</a> 消息队列</h2><p>消息队列，即MQ，Message Queue</p><h3 id="介绍" tabindex="-1"><a class="header-anchor" href="#介绍" aria-hidden="true">#</a> 介绍</h3><p>在现在开发中经常会遇到非必要的业务逻辑以同步(串行)的方式运行，太耗费时间、系统间耦合性太强、流量激增导致宕机等问题，这时就需要消息队列来解决这些问题</p><p>不同进程（process）之间传递消息时，两个进程之间<strong>耦合</strong>程度过高，改动一个进程，引发必须修改另一个进程，为了<strong>隔离</strong>这两个进程，在两进程间抽离出一层（一个模块），所有两进程之间传递的消息，都必须通过消息队列来传递，单独修改某一个进程，不会影响另一个；</p><p>不同进程（process）之间传递消息时，为了实现标准化，将消息的格式规范化了，并且，某一个进程接受的<strong>消息太多</strong>，一下子无法处理完，并且也有先后顺序，必须对收到的消息<strong>进行排队</strong>，因此诞生了事实上的消息队列；</p><p>消息队列是典型的：生产者、消费者模型。生产者不断向消息队列中生产消息，消费者不断的从队列中获取消息。因为消息的生产和消费都是异步的，而且只关心消息的发送和接收，没有业务逻辑的侵入，这样就实现了生产者和消费者的解耦。</p><ul><li>注册服务对保存注册信息以后，无需去发送邮件短信、保存日志，只是发送一条消息，不用关心消息被谁接收。</li><li>邮件、短信服务接收消息，去处理各自的业务。</li><li>如果以后有其它系统(如日志系统)也依赖注册服务的数据，同样监听消息即可，注册服务无需任何代码修改。</li></ul><h3 id="消息队列的作用" tabindex="-1"><a class="header-anchor" href="#消息队列的作用" aria-hidden="true">#</a> 消息队列的作用</h3><ul><li>异步处理<br> 用户注册后，需要发注册邮件和注册短信。传统的串行方式会等所有业务执行完成后再返回结果。并行方式将注册信息写入数据库成功后，发送注册邮件的同时，发送注册短信，可以加快响应速度。</li><li>应用解耦<br> 利用消息队列存储消息，需要消费消息的系统只需要订阅消息队列即可，有新的业务加入时无需修改原本的代码。</li><li>流量削锋<br> 高并发请求同时对数据库执行写操作，可能会导致数据库卡死导致宕机。将请求消息保存到消息队列，系统可以按照自己的能力来消费消息。</li></ul><h3 id="主流消息队列对比" tabindex="-1"><a class="header-anchor" href="#主流消息队列对比" aria-hidden="true">#</a> 主流消息队列对比</h3><table><thead><tr><th>特性</th><th>ActiveMQ</th><th>RabbitMQ</th><th>RocketMQ</th><th>Kafka</th></tr></thead><tbody><tr><td>开发语言</td><td>java</td><td>erlang</td><td>java</td><td>scala</td></tr><tr><td>单机吞吐量</td><td>万级</td><td>万级</td><td>10万级</td><td>100万级</td></tr><tr><td>时效性</td><td>ms</td><td>us</td><td>ms</td><td>ms级以内</td></tr><tr><td>可用性</td><td>高（主从）</td><td>高（主从）</td><td>非常高（分布式）</td><td>非常高（分布式）</td></tr><tr><td>功能特性</td><td>成熟的产品、较全的文档、各种协议支持好</td><td>并发能力强、性能好、延迟低，社区活跃度高，数据量没有那么大，优先选择功能比较完备的RabbitMQ</td><td>MQ功能比较完善，扩展性佳，可靠性要求高的金融互联网领域使用多,稳定性高，经历了多次阿里双11考验</td><td>只支持主要的MQ功能，大数据领域使用多，追求高吞吐量，适合产生大量数据的互联网服务的数据收集业务</td></tr></tbody></table><h3 id="消息分类" tabindex="-1"><a class="header-anchor" href="#消息分类" aria-hidden="true">#</a> 消息分类</h3><div class="custom-container tip"><p class="custom-container-title">点对点(Peer-to-Peer)</p></div><ul><li>一般基于Pull或者Polling接收消息</li><li>发送到队列中的消息被一个而且仅仅一个接收者所接收，即使有多个接收者在同一个队列中侦听同一消息</li><li>即支持异步“即发即弃”的消息传送方式，也支持同步请求/应答传送方式</li></ul><div class="custom-container tip"><p class="custom-container-title">发布/订阅</p></div><ul><li>发布到一个主题的消息，可被多个订阅者所接收</li><li>发布/订阅即可基于Push消费数据，也可基于Pull或者Polling消费数据</li><li>解耦能力比P2P模型更强</li></ul><h3 id="kafka特点" tabindex="-1"><a class="header-anchor" href="#kafka特点" aria-hidden="true">#</a> Kafka特点</h3><ul><li>高吞吐量、低延迟：即使是非常普通的硬件Kafka也可以支持每秒数百万的消息，它的延迟最低只有几毫秒</li><li>持久性：支持消息持久化，即使数TB级别的消息也能够保持长时间的稳定性能。</li><li>可靠性：支持数据备份防止丢失</li><li>容错性：支持通过Kafka服务器和消费机集群来分区消息，允许集群中的节点失败（若分区副本数量为n，则允许n-1个节点失败）</li><li>高并发：单机可支持数千个客户端同时读写，支持在线水平扩展。可无缝对接hadoop、strom、spark等，支持Hadoop并行数据加载</li></ul><table><thead><tr><th>ID</th><th>设计目标</th><th>功能</th></tr></thead><tbody><tr><td>1</td><td>日志收集</td><td>一个公司可以用Kafka可以收集各种服务的Log，通过Kafka以统一接口服务的方式开放给各种Consumer</td></tr><tr><td>2</td><td>消息系统</td><td>解耦生产者和消费者、缓存消息等</td></tr><tr><td>3</td><td>用户活动跟踪</td><td>用来记录web用户或者APP用户的各种活动，如网页搜索、搜索、点击，用户数据收集然后进行用户行为分析。</td></tr><tr><td>4</td><td>运营指标</td><td>Kafka也经常用来记录运营监控数据。包括收集各种分布式应用的数据，生产各种操作的集中反馈，比如报警和报告</td></tr><tr><td>5</td><td>流式处理</td><td>比如Spark Streaming和Storm</td></tr></tbody></table><h2 id="安装使用" tabindex="-1"><a class="header-anchor" href="#安装使用" aria-hidden="true">#</a> 安装使用</h2><blockquote><p>首先确保我们已经有了装有JDK环境的Linux虚拟机<br> 在官网下载 <a href="https://kafka.apache.org/downloads" target="_blank" rel="noopener noreferrer">Download Kafka<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><div class="custom-container tip"><p class="custom-container-title">解压</p></div><p>把下载的kafka压缩包上传到虚拟机的<code>/opt/soft</code>目录下，进入到目录进行解压，这里我们解压到上一级文件夹下</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 进入存放kafka压缩包的文件夹内</span>
<span class="token builtin class-name">cd</span> /opt/soft

<span class="token comment"># 解压kafka到上一级目录 /opt 下</span>
<span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> kafka_2.12-3.4.0.tgz <span class="token parameter variable">-C</span> <span class="token punctuation">..</span>/

<span class="token comment"># 修改解压之后的文件名 kafka</span>
<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>
<span class="token function">mv</span> kafka_2.12-3.4.0 kafka

<span class="token comment"># 进入kafka文件夹 输出当前所在目录 配置环境变量使用</span>
<span class="token builtin class-name">cd</span> kafka/
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># pwd</span>
/opt/kafka
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">配置环境变量</p></div><p>首先确保已经安装了Java环境并配置好</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 编辑文件</span>
<span class="token function">vim</span> /etc/profile.d/my_env.sh

<span class="token comment"># 按i进入编辑模式 把kafka的环境添加到文件中</span>
<span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/opt/jdk-17.0.7
<span class="token assign-left variable">KAFKA_HOME</span><span class="token operator">=</span>/opt/kafka
<span class="token assign-left variable">TOMCAT_HOME</span><span class="token operator">=</span>/opt/apache-tomcat-10.1.10
<span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$JAVA_HOME</span>/bin:<span class="token variable">$TOMCAT_HOME</span>/bin:<span class="token variable">$KAFKA_HOME</span>/bin
<span class="token builtin class-name">export</span> <span class="token environment constant">PATH</span> JAVA_HOME TOMCAT_HOME KAFKA_HOME

<span class="token comment"># 按Esc退出编辑模式  输入 :wq 保存退出</span>
<span class="token comment"># 激活 使环境变量生效</span>
<span class="token builtin class-name">source</span> /etc/profile.d/my_env.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">修改配置文件 server.properties</p></div><ol><li>Kafka需要使用Zookeeper，默认下载包里面已经集成了Zookeeper，可以直接使用</li><li>默认Kafka是仅在本地使用，如果要远程访问，需要修改config/server.properties</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 进入配置的文件夹 首先对要修改的配置文件备份</span>
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># cd config/</span>
<span class="token punctuation">[</span>root@jhw config<span class="token punctuation">]</span><span class="token comment"># ll</span>

<span class="token comment"># 备份server.properties</span>
<span class="token function">cp</span> server.properties server.properties.bk

<span class="token comment"># 修改</span>
<span class="token function">vim</span> server.properties

<span class="token comment"># 修改内容</span>
<span class="token assign-left variable">listeners</span><span class="token operator">=</span>PLAINTEXT://192.168.144.100:9092
<span class="token assign-left variable">advertised.listeners</span><span class="token operator">=</span>PLAINTEXT://192.168.144.100:9092
<span class="token assign-left variable">zookeeper.connect</span><span class="token operator">=</span><span class="token number">192.168</span>.144.100:2181
<span class="token comment"># 上面IP地址为自己Linux系统的真实IP地址</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">测试</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 查看Kafka版本</span>
<span class="token punctuation">[</span>root@jhw config<span class="token punctuation">]</span><span class="token comment"># kafka-topics.sh -version</span>
<span class="token number">3.4</span>.0 <span class="token punctuation">(</span>Commit:2e1947d240607d53<span class="token punctuation">)</span>

<span class="token comment"># 启动Kafka自带的Zookeeper</span>
<span class="token comment"># 后台启动，即消息内容别往前台打</span>
<span class="token comment"># nohup 英文全称 no hang up（不挂起），用于在系统后台不挂断地运行命令，退出终端不会影响程序的运行。</span>
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># nohup bin/zookeeper-server-start.sh config/zookeeper.properties &amp;</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token number">31582</span>
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># nohup: 忽略输入并把输出追加到&quot;nohup.out&quot;</span>

<span class="token comment"># 启动Kafka自身</span>
<span class="token comment"># -daemon 守护启动  server.properties kafka配置文件</span>
kafka-server-start.sh <span class="token parameter variable">-daemon</span> config/server.properties

<span class="token comment"># 查看端口号是否启动成功</span>
<span class="token comment"># zookeeper端口号 2181</span>
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># lsof -i:2181</span>
COMMAND   PID <span class="token environment constant">USER</span>   FD   TYPE  DEVICE SIZE/OFF NODE NAME
<span class="token function">java</span>    <span class="token number">31582</span> root  120u  IPv6 <span class="token number">4664962</span>      0t0  TCP *:eforward <span class="token punctuation">(</span>LISTEN<span class="token punctuation">)</span>
<span class="token comment"># kafka端口号 9092</span>
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># lsof -i:9092</span>
COMMAND   PID <span class="token environment constant">USER</span>   FD   TYPE  DEVICE SIZE/OFF NODE NAME
<span class="token function">java</span>    <span class="token number">32496</span> root  126u  IPv6 <span class="token number">4670579</span>      0t0  TCP bogon:XmlIpcRegSvc <span class="token punctuation">(</span>LISTEN<span class="token punctuation">)</span>
<span class="token function">java</span>    <span class="token number">32496</span> root  139u  IPv6 <span class="token number">4670581</span>      0t0  TCP bogon:57784-<span class="token operator">&gt;</span>bogon:XmlIpcRegSvc <span class="token punctuation">(</span>ESTABLISHED<span class="token punctuation">)</span>
<span class="token function">java</span>    <span class="token number">32496</span> root  140u  IPv6 <span class="token number">4670582</span>      0t0  TCP bogon:XmlIpcRegSvc-<span class="token operator">&gt;</span>bogon:57784 <span class="token punctuation">(</span>ESTABLISHED<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">创建Topic</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-topics.sh --create --topic hellokafka-topic --bootstrap-server 192.168.144.100:9092</span>
Created topic hellokafka-topic.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">查看已经创建的Topic信息</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 第一种方式</span>
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-topics.sh --list --bootstrap-server 192.168.144.100:9092</span>
hellokafka-topic

<span class="token comment"># 第二种方式</span>
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-topics.sh --describe --topic hellokafka-topic --bootstrap-server 192.168.144.100:9092</span>
Topic: hellokafka-topic TopicId: qQSjbLFNQIS_GQ8msJX8xA PartitionCount: <span class="token number">1</span>       ReplicationFactor: <span class="token number">1</span>    Configs: 
        Topic: hellokafka-topic Partition: <span class="token number">0</span>    Leader: <span class="token number">0</span>       Replicas: <span class="token number">0</span>     Isr: <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">发送消息</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-console-producer.sh  --topic hellokafka-topic --bootstrap-server 192.168.144.100:9092</span>
<span class="token operator">&gt;</span>k1
<span class="token operator">&gt;</span>k2
<span class="token operator">&gt;</span>k3
<span class="token operator">&gt;</span>k4
<span class="token operator">&gt;</span>k5
<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">消费消息</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 另外再启动一个窗口 接收消息</span>
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># bin/kafka-console-consumer.sh --topic hellokafka-topic --from-beginning --bootstrap-server 192.168.144.100:9092</span>
k1
k2
k3
k4
k5
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">停止kafka</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>bin/kafka-server-stop.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">停止zookeeper</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>bin/zookeeper-server-stop.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="kafka基础架构和术语名词" tabindex="-1"><a class="header-anchor" href="#kafka基础架构和术语名词" aria-hidden="true">#</a> Kafka基础架构和术语名词</h2><p><img src="https://cdn.jsdelivr.net/gh/wxhcoding/myblog-img/java/kafka-20231103144251.png" alt="kafka-20231103144251"></p><table><thead><tr><th>核心组件</th><th>概念</th></tr></thead><tbody><tr><td><strong>Producer</strong></td><td>生产者，可以向Broker topic发布消息的客户端</td></tr><tr><td><strong>Consumer</strong></td><td>消费者，从Broker topic订阅取消息的客户端</td></tr><tr><td><strong>Broker</strong></td><td>Broker是一个kafka实例，简单说就是一台kafka服务器，kafkaCluster表示集群。一个Linux服务器上启动一个或多个 kafka服务器实例。</td></tr><tr><td><strong>Topic</strong></td><td>主题,Kafka将消息分门别类，每一类的消息称之为一个主题。可以理解为一个队列，生产者和消费者面向的都是一个topic</td></tr><tr><td><strong>Partition</strong></td><td>Topic的分区，每个 Topic 可以有多个分区，同一个Topic 在不同分区的数据是不重复的，每个Partition是一个有序的队列。分区作用是做负载，提高 kafka 的吞吐量。每个partition都由一系列有序的、不可变的消息组成，这些消息被连续的追加到partition中。partition中的每个消息都有一个连续递增的序列号叫做offset，偏移量offset在每个分区中是唯一的。</td></tr><tr><td>Offset</td><td>生产者Offset：消息写入的时候，每一个分区都有一个offset，这个offset就是生产者的offset，同时也是这个分区的最新最大的offset。 消费者Offset：某个分区的offset情况。例如：生产者写入的offset是最新值是10，当一个Consumer开始消费时，从0消费，一直消费到了5，消费者的offset为5。</td></tr><tr><td>Replication</td><td>Partition(分区)的副本。每个分区可以有多个Replication，由一个Leader和若干个Follower组成。Leader负责接收生产者push的消息和消费者poll消费消息。Follower会实时从自己的Leader中同步数据保持同步。Leader故障时,某个Follower会上位为新的Leader。保证高可用</td></tr><tr><td>Message</td><td>kafka集群存储的消息是以topic为类别记录的，每个消息（也叫记录record）是由</td></tr><tr><td><strong>ConsumerGroup(CG)</strong></td><td>消费者组，由多个Consumer组成，每个ConsumerGroup中可以有多个consumer，每个consumer属于一个ConsumerGroup。同一个Topic下的某一个分区只能被某个消费者组内的同一个消费者所消费，但可以被多个 consumer group 消费</td></tr><tr><td>In-sync Replicas（ISR）</td><td>（ISR）已同步副本：表示存活且副本都已和Leader同步的的broker集合，是Leader所有replicas副本的子集。如果某个副本节点宕机，该副本就会从ISR集合中剔除。</td></tr></tbody></table><p>Kafka中的Broker、Topic、Consumer都会注册到zookeeper</p><div class="custom-container tip"><p class="custom-container-title">Events/Streams/Topics</p></div><ul><li>Event<br> 事件，代表过去发生的一个事实(比如下了一个购物订单)。简单理解就是一条消息、一条记录，Event 是不可变的，但是很活跃，经常从一个地方流向另一个地方。</li><li>Stream<br> 事件流表示运动中的相关事件</li><li>Topic<br> 当一个事件流进入 Kafka 之后，它就成为了一个 <strong>Topic</strong> 主题。所以，Topic 就是具体的事件流，也可以理解为一个 Topic 就是一个静止的 Stream。Topic 把相关的 Event 组织在一起，并且保存。一个 Topic 就像数据库中的一张表。</li></ul><div class="custom-container tip"><p class="custom-container-title">Partition 分区</p></div><p>Kafka 中 Topic 被分成多个 Partition 分区。Topic 是一个<strong>逻辑概念</strong>，Partition 是最小的存储单元，掌握着一个 Topic 的部分数据。</p><p>每个 Partition 都是一个单独的 log 文件，每条记录都以追加的形式写入。</p><div class="custom-container tip"><p class="custom-container-title">Offsets(偏移量)和消息的顺序</p></div><p>Partition 中的每条记录都会被分配一个唯一的序号，称为Offset（偏移量）。<br> Offset 是一个递增的、不可变的数字，由 Kafka 自动维护。当一条记录写入 Partition 的时候，它就被追加到 log 文件的末尾，并被分配一个序号，作为 Offset。</p><p>假如一个 Topic 有 3 个 Partition 分区，向 Topic 发送消息的时候，实际上是被写入某一个 Partition，并赋予Offset。消息的顺序性需要注意，一个 Topic 如果有多个 Partition 的话，那么从 Topic 这个层面来看，消息是无序的。但单独看 Partition 的话，Partition 内部消息是有序的。所以，一个 Partition 内部消息有序，一个 Topic 跨 Partition 是无序的。如果强制要求 Topic 整体有序，就只能让 Topic 只有一个 Partition。</p><div class="custom-container tip"><p class="custom-container-title">Partition 为 Kafka 提供了扩展能力</p></div><p>一个 Kafka 集群由多个 Broker（就是 Server） 构成，每个 Broker 中含有集群的部分数据。Kafka 把 Topic 的多个 Partition 分布在多个 Broker 中。</p><ul><li>扩容方便<br> 如果把 Topic 的所有 Partition 都放在一个 Broker 上，那么这个 Topic 的可扩展性就大大降低了，会受限于这个 Broker 的 IO 能力。把 Partition 分散开之后，Topic 就可以水平扩展</li><li>防止单点故障<br> 一个 Topic 可以被多个 Consumer 并行消费。如果 Topic 的所有 Partition 都在一个 Broker，那么支持的 Consumer 数量就有限，而分散之后，可以支持更多的 Consumer。</li><li>高并发<br> 一个 Consumer 可以有多个实例，Partition 分布在多个 Broker 的话，Consumer 的多个实例就可以连接不同的 Broker，大大提升了消息处理能力。可以让一个 Consumer 实例负责一个 Partition，这样消息处理既清晰又高效。</li></ul><h2 id="kafka常用命令" tabindex="-1"><a class="header-anchor" href="#kafka常用命令" aria-hidden="true">#</a> Kafka常用命令</h2><h3 id="启停命令" tabindex="-1"><a class="header-anchor" href="#启停命令" aria-hidden="true">#</a> 启停命令</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 在/opt/kafka 目录下执行下面的命令</span>
<span class="token comment"># 一定先启动zookeeper</span>
<span class="token function">nohup</span> bin/zookeeper-server-start.sh config/zookeeper.properties <span class="token operator">&amp;</span>
<span class="token comment"># -daemon 守护启动</span>
<span class="token comment"># server.properties Kafka配置文件,在路径 /opt/kafka/config目录下</span>
kafka-server-start.sh <span class="token parameter variable">-daemon</span> config/server.properties
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 停止命令 </span>
<span class="token comment"># 一定要先停止kafka</span>
kafka-server-stop.sh
<span class="token comment"># 再停止zookeeper</span>
zookeeper-server-stop.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="主题命令" tabindex="-1"><a class="header-anchor" href="#主题命令" aria-hidden="true">#</a> 主题命令</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-topics.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>常用参数列表:</p><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>--bootstrap-server &lt;String: server toconnect to&gt;</td><td>连接的Kafka Broker主机名称和端口号。</td></tr><tr><td>--topic &lt;String: topic&gt;</td><td>操作的topic名称。</td></tr><tr><td>--create</td><td>创建主题。</td></tr><tr><td>--delete</td><td>删除主题。</td></tr><tr><td>--alter</td><td>修改主题。</td></tr><tr><td>--list</td><td>查看所有主题。</td></tr><tr><td>--describe</td><td>查看主题详细描述。</td></tr><tr><td>--partitions &lt;Integer: # of partitions&gt;</td><td>设置分区数。</td></tr><tr><td>--replication-factor&lt;Integer: replication factor&gt;</td><td>设置分区副本。</td></tr><tr><td>--config &lt;String: name=value&gt;</td><td>更新系统默认的配置。</td></tr></tbody></table><div class="custom-container tip"><p class="custom-container-title">主题列表查询</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9092 <span class="token parameter variable">--list</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">创建topic(含分区和副本)</p></div><ul><li>逻辑概念同一个Topic的消息可分布在一个或多个节点( Broker)上</li><li>一个Topic包含一个或者多个Partition</li><li>每条消息都属于且仅属于一个Topic</li><li>Producer发布数据时，必须指定将该消息发布到哪一个Topic</li><li>Consumer订阅消息时，也必须指定订阅哪个Topic的消息</li><li>单机版的kafka在创建topic时只能创建一个副本 分区可以创建多个</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 各个参数含义如下：</span>
<span class="token comment"># --create：创建主题的动作指令</span>
<span class="token comment"># --bootstrap-server：指定kafka所连接的zookeeper服务地址</span>
<span class="token comment"># --topic：指定了所要创建主题的名称</span>
<span class="token comment"># --partitions：指定了分区个数</span>
<span class="token comment"># --replication-factor：指定了副本因子 一个broker创建topic的时候只能是一个副本</span>

<span class="token comment"># 创建1个分区1个副本的first主题：partitions 分区数, replication-factor 副本数，topic 主题名</span>
kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9092 <span class="token parameter variable">--create</span> <span class="token parameter variable">--partitions</span> <span class="token number">1</span> --replication-factor <span class="token number">1</span> <span class="token parameter variable">--topic</span> first

<span class="token comment"># 创建3个分区1个副本的first2主题：partitions 分区数, replication-factor 副本数，topic 主题名</span>
kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9092 <span class="token parameter variable">--create</span> <span class="token parameter variable">--partitions</span> <span class="token number">3</span> --replication-factor <span class="token number">1</span> <span class="token parameter variable">--topic</span> first2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 上述命令执行完，按照【log.dirs=/tmp/kafka-logs】配置，进入到/tmp/kafka-logs</span>
<span class="token comment"># 会看到你所建立的主题和对应分区</span>
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># cd /tmp/kafka-logs</span>
<span class="token punctuation">[</span>root@jhw kafka-logs<span class="token punctuation">]</span><span class="token comment"># ll</span>
总用量 <span class="token number">16</span>
<span class="token punctuation">..</span>.
drwxr-xr-x. <span class="token number">2</span> root root  <span class="token number">167</span> <span class="token number">11</span>月  <span class="token number">3</span> <span class="token number">18</span>:49 first-0
drwxr-xr-x. <span class="token number">2</span> root root  <span class="token number">167</span> <span class="token number">11</span>月  <span class="token number">3</span> <span class="token number">18</span>:50 first2-0
drwxr-xr-x. <span class="token number">2</span> root root  <span class="token number">167</span> <span class="token number">11</span>月  <span class="token number">3</span> <span class="token number">18</span>:50 first2-1
drwxr-xr-x. <span class="token number">2</span> root root  <span class="token number">167</span> <span class="token number">11</span>月  <span class="token number">3</span> <span class="token number">18</span>:50 first2-2
drwxr-xr-x. <span class="token number">2</span> root root  <span class="token number">204</span> <span class="token number">11</span>月  <span class="token number">3</span> <span class="token number">18</span>:20 hellokafka-topic-0
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">查看主题详情</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9092 <span class="token parameter variable">--describe</span> <span class="token parameter variable">--topic</span> first
kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9092 <span class="token parameter variable">--describe</span> <span class="token parameter variable">--topic</span> first2

<span class="token comment"># 主题详情</span>
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-topics.sh --bootstrap-server 192.168.144.100:9092 --describe --topic first</span>
Topic: first    TopicId: ZBd0pRj3STyCy7imwfh7CQ PartitionCount: <span class="token number">1</span>       ReplicationFactor: <span class="token number">1</span>    Configs: 
        Topic: first    Partition: <span class="token number">0</span>    Leader: <span class="token number">0</span>       Replicas: <span class="token number">0</span>     Isr: <span class="token number">0</span>

<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-topics.sh --bootstrap-server 192.168.144.100:9092 --describe --topic first2</span>
Topic: first2   TopicId: mALptiDdS1CRrETrejroJQ PartitionCount: <span class="token number">3</span>       ReplicationFactor: <span class="token number">1</span>    Configs: 
        Topic: first2   Partition: <span class="token number">0</span>    Leader: <span class="token number">0</span>       Replicas: <span class="token number">0</span>     Isr: <span class="token number">0</span>
        Topic: first2   Partition: <span class="token number">1</span>    Leader: <span class="token number">0</span>       Replicas: <span class="token number">0</span>     Isr: <span class="token number">0</span>
        Topic: first2   Partition: <span class="token number">2</span>    Leader: <span class="token number">0</span>       Replicas: <span class="token number">0</span>     Isr: <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">修改分区数</p></div><p><strong>注意：分区数只能增加,不能减少</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9092 <span class="token parameter variable">--alter</span> <span class="token parameter variable">--topic</span> first <span class="token parameter variable">--partitions</span> <span class="token number">3</span>

<span class="token comment"># 再次查看first主题详情</span>
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-topics.sh --bootstrap-server 192.168.144.100:9092 --describe --topic first</span>
Topic: first    TopicId: ZBd0pRj3STyCy7imwfh7CQ PartitionCount: <span class="token number">3</span>       ReplicationFactor: <span class="token number">1</span>    Configs: 
        Topic: first    Partition: <span class="token number">0</span>    Leader: <span class="token number">0</span>       Replicas: <span class="token number">0</span>     Isr: <span class="token number">0</span>
        Topic: first    Partition: <span class="token number">1</span>    Leader: <span class="token number">0</span>       Replicas: <span class="token number">0</span>     Isr: <span class="token number">0</span>
        Topic: first    Partition: <span class="token number">2</span>    Leader: <span class="token number">0</span>       Replicas: <span class="token number">0</span>     Isr: <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查询结果解释：</p><ul><li>第一行显示所有partitions的概要信息： <ul><li>列出了Topic名字，TopicId，partition总数，存储这些partition的broker数</li></ul></li><li>其他每一行是一个partition的详细信息： <table><thead><tr><th>Topic</th><th>主题</th></tr></thead><tbody><tr><td>Partition</td><td>分区编号</td></tr><tr><td>Leader</td><td>当前Partiton所有broker中担任leader的broker id，每个broker都有可能成为leader</td></tr><tr><td>Replicas</td><td>显示该partiton所有副本所在的broker列表，包括leader，不管该broker是否是存活，不管是否和leader保持了同步</td></tr><tr><td>Isr</td><td>in-sync replicas的简写，表示存活且副本都已同步的的broker集合，是replicas的子集</td></tr></tbody></table></li></ul><p><strong>说明</strong>：当producer发送一个消息时，producer自己会判断发送到哪个partiton上，如果发到了partition0上，消息会发到leader上处理这个消息，其它broker会从leader上同步这个消息。如果这个leader挂了，那么Kafka会在Isr列表中选一个新的leader</p><div class="custom-container tip"><p class="custom-container-title">删除主题</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 删除创建的 first和first2 topic</span>
kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9092 <span class="token parameter variable">--delete</span> <span class="token parameter variable">--topic</span> first
kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9092 <span class="token parameter variable">--delete</span> <span class="token parameter variable">--topic</span> first2

<span class="token comment"># 查看主题列表 </span>
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-topics.sh --bootstrap-server 192.168.144.100:9092 --list</span>
__consumer_offsets
hellokafka-topic
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="生产者命令" tabindex="-1"><a class="header-anchor" href="#生产者命令" aria-hidden="true">#</a> 生产者命令</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 新建主题topic: second</span>
kafka-topics.sh <span class="token parameter variable">--create</span>  <span class="token parameter variable">--topic</span> second --bootstrap-server <span class="token number">192.168</span>.144.100:9092

<span class="token comment"># 生产者发送消息到某个主题</span>
kafka-console-producer.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9092 <span class="token parameter variable">--topic</span> second
<span class="token comment"># 输入消息，回车发送消息</span>
<span class="token operator">&gt;</span>hello word
<span class="token operator">&gt;</span>kafka
<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="消费者命令" tabindex="-1"><a class="header-anchor" href="#消费者命令" aria-hidden="true">#</a> 消费者命令</h3><div class="custom-container tip"><p class="custom-container-title">消费者参数列表</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-console-consumer.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>参数列表:</p><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>--bootstrap-server &lt;String: server toconnect to&gt;</td><td>连接的Kafka Broker主机名称和端口号。</td></tr><tr><td>--topic &lt;String: topic&gt;</td><td>操作的topic名称。</td></tr><tr><td>--from-beginning</td><td>从头重新消费topic中的消息</td></tr><tr><td>--group &lt;String: consumer group id&gt;</td><td>指定消费者组名称。</td></tr></tbody></table><div class="custom-container tip"><p class="custom-container-title">消费主题数据(从头开始)</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-console-consumer.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9092  --from-beginning <span class="token parameter variable">--topic</span> second

<span class="token comment"># 不加--from-beginning 则是从哪发在哪接收(即不包含之前的历史数据)</span>
kafka-console-consumer.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9092 <span class="token parameter variable">--topic</span> second
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="消费者组-consumergroup-命令" tabindex="-1"><a class="header-anchor" href="#消费者组-consumergroup-命令" aria-hidden="true">#</a> 消费者组(consumerGroup)命令</h3><div class="custom-container tip"><p class="custom-container-title">消费组查看list</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-consumer-groups.sh  --bootstrap-server <span class="token number">192.168</span>.144.100:9092 <span class="token parameter variable">--list</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">消费组(点对点)</p></div><p>一条消息只能被同一个消费组里的一个消费者消费，组内有竞争先到先得，案例如下：</p><p>两个消费者都在同一个消费组，然后往主题里发送消息，结果只有一个消费者客户端能消费到。</p><p>也即，一个分区只能被一个消费组里面的一个消费者消费</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 新建topic kafkav1</span>
kafka-topics.sh <span class="token parameter variable">--create</span>  <span class="token parameter variable">--topic</span> kafkav1 --bootstrap-server <span class="token number">192.168</span>.144.100:9092

<span class="token comment"># 发送消息 生产者</span>
kafka-console-producer.sh  <span class="token parameter variable">--topic</span> kafkav1 --bootstrap-server <span class="token number">192.168</span>.144.100:9092
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-console-producer.sh  --topic kafkav1 --bootstrap-server 192.168.144.100:9092</span>
<span class="token operator">&gt;</span>k1
<span class="token operator">&gt;</span>k2
<span class="token operator">&gt;</span>k3
<span class="token operator">&gt;</span>

<span class="token comment"># 接收消息 创建一个有组的消费者</span>
<span class="token comment"># 关键参数：--consumer-property group.id=group01</span>
kafka-console-consumer.sh <span class="token parameter variable">--topic</span> kafkav1 --from-beginning --bootstrap-server <span class="token number">192.168</span>.144.100:9092 --consumer-property <span class="token assign-left variable">group.id</span><span class="token operator">=</span>group01
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-console-consumer.sh --topic kafkav1 --from-beginning --bootstrap-server 192.168.144.100:9092 --consumer-property group.id=group01</span>
k1
k2
k3

<span class="token comment"># 打开一个新的命令终端 创建同组消费者</span>
kafka-console-consumer.sh <span class="token parameter variable">--topic</span> kafkav1 --from-beginning --bootstrap-server <span class="token number">192.168</span>.144.100:9092 --consumer-property <span class="token assign-left variable">group.id</span><span class="token operator">=</span>group01
<span class="token comment"># 此时收不到任何消息 并且再次发送也只会在上面的消费者中收到消息 这个同组的消费者不会收到</span>
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-console-consumer.sh --topic kafkav1 --from-beginning --bootstrap-server 192.168.144.100:9092 --consumer-property group.id=group01</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">消费组(发布-订阅模式)</p></div><p>一条消息能被多个消费者消费，发布订阅模式，保证不同的消费者分属不同的消费组即可做到，结果两个客户端都能收到消息</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 新增一个消费者(不同组)后可以看到新的分组+消费到消息</span>
kafka-console-consumer.sh <span class="token parameter variable">--topic</span> kafkav1 --from-beginning --bootstrap-server <span class="token number">192.168</span>.144.100:9092 --consumer-property <span class="token assign-left variable">group.id</span><span class="token operator">=</span>group02
<span class="token comment"># 这里可以收到全部的消息</span>
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-console-consumer.sh --topic kafkav1 --from-beginning --bootstrap-server 192.168.144.100:9092 --consumer-property group.id=group02</span>
k1
k2
k3
k4
k5
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">消费组查看offset偏移量</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@jhw ~<span class="token punctuation">]</span><span class="token comment"># kafka-consumer-groups.sh  --bootstrap-server 192.168.144.100:9092 --describe --group group02</span>

GROUP           TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID                                           HOST             CLIENT-ID
group02         kafkav1         <span class="token number">0</span>          <span class="token number">5</span>               <span class="token number">5</span>               <span class="token number">0</span>               console-consumer-ac7a06f3-8cb1-4734-8ed5-f168a4d6f78a /192.168.144.100 console-consumer

<span class="token comment"># 在生产者的窗口 发送一条消息</span>
<span class="token comment"># 再次查看</span>
<span class="token punctuation">[</span>root@jhw ~<span class="token punctuation">]</span><span class="token comment"># kafka-consumer-groups.sh  --bootstrap-server 192.168.144.100:9092 --describe --group group02</span>

GROUP           TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID                                           HOST             CLIENT-ID
group02         kafkav1         <span class="token number">0</span>          <span class="token number">6</span>               <span class="token number">6</span>               <span class="token number">0</span>               console-consumer-ac7a06f3-8cb1-4734-8ed5-f168a4d6f78a /192.168.144.100 console-consumer

<span class="token comment"># 此时退出2号分组的消费者 生产者再次发送一条消息</span>
<span class="token comment"># 再次查看 发现已经落后了一条消息 LAG</span>
<span class="token punctuation">[</span>root@jhw ~<span class="token punctuation">]</span><span class="token comment"># kafka-consumer-groups.sh  --bootstrap-server 192.168.144.100:9092 --describe --group group02</span>

Consumer group <span class="token string">&#39;group02&#39;</span> has no active members.

GROUP           TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID     HOST            CLIENT-ID
group02         kafkav1         <span class="token number">0</span>          <span class="token number">6</span>               <span class="token number">7</span>               <span class="token number">1</span>               -               -               -

<span class="token comment"># 生产者再次发送三条消息 进行再次查看 可以看到已经落后了四条消息 LAG</span>
<span class="token punctuation">[</span>root@jhw ~<span class="token punctuation">]</span><span class="token comment"># kafka-consumer-groups.sh  --bootstrap-server 192.168.144.100:9092 --describe --group group02</span>

Consumer group <span class="token string">&#39;group02&#39;</span> has no active members.

GROUP           TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID     HOST            CLIENT-ID
group02         kafkav1         <span class="token number">0</span>          <span class="token number">6</span>               <span class="token number">10</span>              <span class="token number">4</span>               -               -               -

<span class="token comment"># 此时再次打开2组的消费者 则可以接收到后续发送的消息</span>
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-console-consumer.sh --topic kafkav1 --from-beginning --bootstrap-server 192.168.144.100:9092 --consumer-property group.id=group02</span>
k7
k8
k9
k10

<span class="token comment"># 再次查看 发现已经没有落后消息</span>
<span class="token punctuation">[</span>root@jhw ~<span class="token punctuation">]</span><span class="token comment"># kafka-consumer-groups.sh  --bootstrap-server 192.168.144.100:9092 --describe --group group02</span>

GROUP           TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID                                           HOST             CLIENT-ID
group02         kafkav1         <span class="token number">0</span>          <span class="token number">10</span>              <span class="token number">10</span>              <span class="token number">0</span>               console-consumer-b111380c-9856-4cd4-98a8-945856445575 /192.168.144.100 console-consumer
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>CURRENT-OFFSET<br> 当前消费者群组最近提交的offset，也就是消费者分区里读取的当前位置</li><li>LOG-END-OFFSET<br> 当前最高水位偏移量，也就是最近一个读取消息的偏移量，同时也是最近一个提交到集群的偏移量</li><li>LAG<br> 消费者的CURRENT-OFFSET与broker的LOG-END-OFFSET之间的差距</li></ul><div class="custom-container tip"><p class="custom-container-title">消费者-消费组总结</p></div><p><img src="https://cdn.jsdelivr.net/gh/wxhcoding/myblog-img/java/kafka-20231104100501.png" alt="kafka-20231104100501"><br> 一个分区同一个时刻在一个消费组中只能有一个消费者在消费，从而保证消费顺序。<br> 消费组中的消费者的数量不能比一个Topic中的分区的数量多，否则，多出来的消费者消费不到消息。</p><h3 id="offset偏移量命令" tabindex="-1"><a class="header-anchor" href="#offset偏移量命令" aria-hidden="true">#</a> offset偏移量命令</h3><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>--to-earliest</td><td>把位移调整到分区当前最小位移</td><td></td></tr><tr><td>--to-latest</td><td>把位移调整到分区当前最新位移</td><td></td></tr><tr><td>--to-current</td><td>把位移调整到分区当前位移</td><td></td></tr><tr><td>--to-offset 正整数</td><td>把位移调整到指定位移处</td><td></td></tr><tr><td>--execute：执行方案</td><td>执行真正的位移调整</td><td>只是打印出位移调整方案，不具体执行</td></tr></tbody></table><div class="custom-container tip"><p class="custom-container-title">to-earliest</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 停止2组的消费者</span>
<span class="token comment"># 查看</span>
<span class="token punctuation">[</span>root@jhw ~<span class="token punctuation">]</span><span class="token comment"># kafka-consumer-groups.sh  --bootstrap-server 192.168.144.100:9092 --describe --group group02</span>

Consumer group <span class="token string">&#39;group02&#39;</span> has no active members.

GROUP           TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID     HOST            CLIENT-ID
group02         kafkav1         <span class="token number">0</span>          <span class="token number">10</span>              <span class="token number">10</span>              <span class="token number">0</span>               -               -               -

<span class="token comment"># 移动到最小位移</span>
kafka-consumer-groups.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9092 <span class="token parameter variable">--group</span> group02 <span class="token parameter variable">--topic</span> kafkav1 --reset-offsets --to-earliest <span class="token parameter variable">--execute</span>
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-consumer-groups.sh --bootstrap-server 192.168.144.100:9092 --group group02 --topic kafkav1 --reset-offsets --to-earliest --execute</span>

GROUP                          TOPIC                          PARTITION  NEW-OFFSET     
group02                        kafkav1                        <span class="token number">0</span>          <span class="token number">0</span>   

<span class="token comment"># 再次查看 可以发现CURRENT-OFFSET已经变为了0</span>
<span class="token punctuation">[</span>root@jhw ~<span class="token punctuation">]</span><span class="token comment"># kafka-consumer-groups.sh  --bootstrap-server 192.168.144.100:9092 --describe --group group02</span>

Consumer group <span class="token string">&#39;group02&#39;</span> has no active members.

GROUP           TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID     HOST            CLIENT-ID
group02         kafkav1         <span class="token number">0</span>          <span class="token number">0</span>               <span class="token number">10</span>              <span class="token number">10</span>              -               -               -

<span class="token comment"># 此时如果再次开启2组的消费者接收消息 则会再次接收所有消息</span>
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-console-consumer.sh --topic kafkav1 --from-beginning --bootstrap-server 192.168.144.100:9092 --consumer-property group.id=group02</span>
k1
k2
k3
k4
k5
k6
k7
k8
k9
k10
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">to-latest</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 停止2组的消费者消费消息</span>
<span class="token comment"># 我们使用生产者再次生产三条消息</span>
<span class="token comment"># 查看消费组2的消费者</span>
<span class="token punctuation">[</span>root@jhw ~<span class="token punctuation">]</span><span class="token comment"># kafka-consumer-groups.sh  --bootstrap-server 192.168.144.100:9092 --describe --group group02</span>

Consumer group <span class="token string">&#39;group02&#39;</span> has no active members.

GROUP           TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID     HOST            CLIENT-ID
group02         kafkav1         <span class="token number">0</span>          <span class="token number">10</span>              <span class="token number">13</span>              <span class="token number">3</span>               -               -               -

<span class="token comment"># 移动到最新位移</span>
kafka-consumer-groups.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9092 <span class="token parameter variable">--group</span> group02 <span class="token parameter variable">--topic</span> kafkav1 --reset-offsets --to-latest  <span class="token parameter variable">--execute</span>

<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-consumer-groups.sh --bootstrap-server 192.168.144.100:9092 --group group02 --topic kafkav1 --reset-offsets --to-latest  --execute</span>

GROUP                          TOPIC                          PARTITION  NEW-OFFSET     
group02                        kafkav1                        <span class="token number">0</span>          <span class="token number">13</span>   

<span class="token comment"># 再次查看 可以看到已经到了最新的位移</span>
<span class="token punctuation">[</span>root@jhw ~<span class="token punctuation">]</span><span class="token comment"># kafka-consumer-groups.sh  --bootstrap-server 192.168.144.100:9092 --describe --group group02</span>

Consumer group <span class="token string">&#39;group02&#39;</span> has no active members.

GROUP           TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID     HOST            CLIENT-ID
group02         kafkav1         <span class="token number">0</span>          <span class="token number">13</span>              <span class="token number">13</span>              <span class="token number">0</span>               -               -               -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">to-current</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 生产者发送两条消息</span>
<span class="token comment"># 移动到当前位移</span>
kafka-consumer-groups.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9092 <span class="token parameter variable">--group</span> group02 <span class="token parameter variable">--topic</span> kafkav1 --reset-offsets --to-current  <span class="token parameter variable">--execute</span>

<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-consumer-groups.sh --bootstrap-server 192.168.144.100:9092 --group group02 --topic kafkav1 --reset-offsets --to-current  --execute</span>

GROUP                          TOPIC                          PARTITION  NEW-OFFSET     
group02                        kafkav1                        <span class="token number">0</span>          <span class="token number">13</span>     

<span class="token comment"># 再次查看2组消费者</span>
<span class="token punctuation">[</span>root@jhw ~<span class="token punctuation">]</span><span class="token comment"># kafka-consumer-groups.sh  --bootstrap-server 192.168.144.100:9092 --describe --group group02</span>

Consumer group <span class="token string">&#39;group02&#39;</span> has no active members.

GROUP           TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID     HOST            CLIENT-ID
group02         kafkav1         <span class="token number">0</span>          <span class="token number">13</span>              <span class="token number">15</span>              <span class="token number">2</span>               -               -               -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">to-offset</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 移动到指定位移7</span>
kafka-consumer-groups.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9092 <span class="token parameter variable">--group</span> group02 <span class="token parameter variable">--topic</span> kafkav1 --reset-offsets --to-offset <span class="token number">7</span>  <span class="token parameter variable">--execute</span>

<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-consumer-groups.sh --bootstrap-server 192.168.144.100:9092 --group group02 --topic kafkav1 --reset-offsets --to-offset 7  --execute</span>

GROUP                          TOPIC                          PARTITION  NEW-OFFSET     
group02                        kafkav1                        <span class="token number">0</span>          <span class="token number">7</span>   

<span class="token comment"># 再次查看</span>
<span class="token punctuation">[</span>root@jhw ~<span class="token punctuation">]</span><span class="token comment"># kafka-consumer-groups.sh  --bootstrap-server 192.168.144.100:9092 --describe --group group02</span>

Consumer group <span class="token string">&#39;group02&#39;</span> has no active members.

GROUP           TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID     HOST            CLIENT-ID
group02         kafkav1         <span class="token number">0</span>          <span class="token number">7</span>               <span class="token number">15</span>              <span class="token number">8</span>               -               -               -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="kafka原生api入门篇" tabindex="-1"><a class="header-anchor" href="#kafka原生api入门篇" aria-hidden="true">#</a> Kafka原生API入门篇</h2><h3 id="发送消息" tabindex="-1"><a class="header-anchor" href="#发送消息" aria-hidden="true">#</a> 发送消息</h3><div class="custom-container tip"><p class="custom-container-title">项目创建</p></div><p>创建一个kafka-demo导入下面的依赖 再创建一个模块kafka-producter</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!--kafka-clients 2023.8--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>kafka-clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.5.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">producer发送消息(默认)</p></div><p>需求：创建Kafka生产者，采用异步的方式发送消息到Kafka Broker<br><a href="https://kafka.apache.org/35/javadoc/org/apache/kafka/clients/producer/KafkaProducer.html" target="_blank" rel="noopener noreferrer">官方文档<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>新建主题topic:hellokafka</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9092 <span class="token parameter variable">--create</span> <span class="token parameter variable">--topic</span> hellokafka
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>注意：执行测试代码前，在控制台开启Kafka消费者监听hellokafka主题</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-console-consumer.sh <span class="token parameter variable">--topic</span> hellokafka  --bootstrap-server <span class="token number">192.168</span>.144.100:9092
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>测试代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// com.atcode.kafka.producer.MyProducerDemo</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyProducerDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;hellokafka&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建Kafka生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给Kafka配置对象添加配置信息：bootstrap.servers 配置虚拟机的ip地址</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.144.100:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// key,value序列化（必须）：key.serializer，value.serializer</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 创建Kafka生产者对象</span>
        <span class="token class-name">KafkaProducer</span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 调用send方法,发送消息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/*
            	public class ProducerRecord&lt;K, V&gt; {
            		//主题名称，必选参数
                    private final String topic;
                    //分区号，大于等于0的整数，可选参数。
                    private final Integer partition;
                    //消息的头信息，类型是RecordHeaders，可选属性。
                    private final Headers headers;
                    //键，可选参数。
                    private final K key;
                    //消息内容，必选参数。
                    private final V value;
                    //每条消息都有一个时间戳，可选参数
                    private final Long timestamp;
                }
            */</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;hellokafka~&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 5. 关闭资源</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行测试代码后，消费者中可以看到接收的消息</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-console-consumer.sh --topic hellokafka  --bootstrap-server 192.168.144.100:9092</span>
hellokafka~0
hellokafka~1
hellokafka~2
hellokafka~3
hellokafka~4
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>另外:</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>　　　　　　
    <span class="token comment">&lt;!-- 如果觉得idea控制台日志太多，src\main\resources目录下新建logback.xml
         屏蔽kafka debug --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>logger</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.apache.kafka.clients<span class="token punctuation">&quot;</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>debug<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="消费消息" tabindex="-1"><a class="header-anchor" href="#消费消息" aria-hidden="true">#</a> 消费消息</h3><p><a href="https://kafka.apache.org/35/javadoc/org/apache/kafka/clients/consumer/KafkaConsumer.html" target="_blank" rel="noopener noreferrer">参考文档<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>首先启动我们下面的消费消息的程序 然后再启动发送消息的程序 查看消费消息的输出内容</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// com.atcode.kafka.consumer.MyConsumerDemo</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyConsumerDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;hellokafka&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建Kafka生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给Kafka配置对象添加配置信息：bootstrap.servers</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.144.100:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;group.id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;enable.auto.commit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;auto.commit.interval.ms&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;key.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;value.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// System.out.println(&quot;....进行中&quot;);</span>
            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">:</span> records<span class="token punctuation">)</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;offset = %d, key = %s, value = %s%n&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动消费消息 然后启动生产消息 查看消费消息的输出内容:</p><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code>offset <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token boolean">null</span><span class="token punctuation">,</span> value <span class="token operator">=</span> hellokafka<span class="token operator">~</span><span class="token number">0</span>
offset <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token boolean">null</span><span class="token punctuation">,</span> value <span class="token operator">=</span> hellokafka<span class="token operator">~</span><span class="token number">1</span>
offset <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token boolean">null</span><span class="token punctuation">,</span> value <span class="token operator">=</span> hellokafka<span class="token operator">~</span><span class="token number">2</span>
offset <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token boolean">null</span><span class="token punctuation">,</span> value <span class="token operator">=</span> hellokafka<span class="token operator">~</span><span class="token number">3</span>
offset <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token boolean">null</span><span class="token punctuation">,</span> value <span class="token operator">=</span> hellokafka<span class="token operator">~</span><span class="token number">4</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="异步发送消息" tabindex="-1"><a class="header-anchor" href="#异步发送消息" aria-hidden="true">#</a> 异步发送消息</h3><p>producer默认是<strong>异步发送不阻塞</strong>，如果需要使用同步发送，可以在每次发送之后调用get方法，因为producer.send方法返回一个Future类型的结果，Future的get方法会一直阻塞直到该线程的任务得到返回值，也就是broker返回发送成功。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 异步发送 默认</span>
kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;second&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Kafka&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 同步发送</span>
kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;second&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Kafka&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="异步发送且callback回调" tabindex="-1"><a class="header-anchor" href="#异步发送且callback回调" aria-hidden="true">#</a> 异步发送且Callback回调</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// com.atcode.kafka.producer.KafkaProducerCallbackDemo</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaProducerCallbackDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;hellokafka&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 生产者配置文档：https://Kafka.apache.org/documentation.html#producerconfigs</span>

        <span class="token comment">// 1. 创建Kafka生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给Kafka配置对象添加配置信息</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.144.100:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// key,value序列化（必须）：key.serializer，value.serializer</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 创建Kafka生产者对象</span>
        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4. 调用send方法,发送消息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 添加回调</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;atcode &quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 回调函数会在producer收到ack时调用，该方法有两个参数:元数据信息（RecordMetadata）和异常信息（Exception）。</span>
                <span class="token comment">// 如果Exception为null，说明消息发送成功，否则消息发送失败。</span>
                <span class="token comment">// 注意：消息发送失败会自动重试，不需要我们在回调函数中手动重试。</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> metadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 没有异常,输出信息到控制台</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;主题：&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&gt;&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;分区：&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&gt;&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;偏移量: &quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 出现异常打印</span>
                        exception<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 5. 关闭资源</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行 查看输出结果如下:</p><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code>主题：hellokafka<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span><span class="token operator">-</span><span class="token operator">&gt;</span>偏移量<span class="token operator">:</span> <span class="token number">10</span>
主题：hellokafka<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span><span class="token operator">-</span><span class="token operator">&gt;</span>偏移量<span class="token operator">:</span> <span class="token number">11</span>
主题：hellokafka<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span><span class="token operator">-</span><span class="token operator">&gt;</span>偏移量<span class="token operator">:</span> <span class="token number">12</span>
主题：hellokafka<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span><span class="token operator">-</span><span class="token operator">&gt;</span>偏移量<span class="token operator">:</span> <span class="token number">13</span>
主题：hellokafka<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span><span class="token operator">-</span><span class="token operator">&gt;</span>偏移量<span class="token operator">:</span> <span class="token number">14</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="kafka原生api高阶篇" tabindex="-1"><a class="header-anchor" href="#kafka原生api高阶篇" aria-hidden="true">#</a> Kafka原生API高阶篇</h2><h3 id="生产者消费者配置类" tabindex="-1"><a class="header-anchor" href="#生产者消费者配置类" aria-hidden="true">#</a> 生产者消费者配置类</h3><div class="custom-container tip"><p class="custom-container-title">生产者配置类ProducerConfig</p></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomProducerParameters</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建Kafka生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给Kafka配置对象添加配置信息：bootstrap.servers</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.144.100:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// key,value序列化（必须）：key.serializer，value.serializer</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.Kafka.common.serialization.StringSerializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.Kafka.common.serialization.StringSerializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// batch.size：批次大小，默认16K</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BATCH_SIZE_CONFIG</span><span class="token punctuation">,</span> <span class="token number">16384</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// linger.ms：等待时间，默认0</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">LINGER_MS_CONFIG</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// RecordAccumulator：缓冲区大小，默认32M：buffer.memory</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BUFFER_MEMORY_CONFIG</span><span class="token punctuation">,</span> <span class="token number">33554432</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// compression.type：压缩，默认none，可配置值gzip、snappy、lz4和zstd(2.1.0开始支持)四种压缩算法</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">COMPRESSION_TYPE_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;snappy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 创建Kafka生产者对象</span>
        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 调用send方法,发送消息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;your topic name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;your message&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 5. 关闭资源</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>四种压缩算法对比：CPU资源充足，带宽资源有限时可以考虑使用压缩算法压缩消息。</p><table><thead><tr><th>压缩类型</th><th>压缩比率</th><th>CPU 使用率</th><th>压缩速度</th><th>带宽使用率</th></tr></thead><tbody><tr><td>Gzip</td><td>高</td><td>高</td><td>慢</td><td>低</td></tr><tr><td>Snappy</td><td>一般</td><td>一般</td><td>一般</td><td>一般</td></tr><tr><td>Lz4</td><td>低</td><td>低</td><td>快</td><td>高</td></tr><tr><td>Zstd</td><td>一般</td><td>一般</td><td>一般</td><td>一般</td></tr></tbody></table><div class="custom-container tip"><p class="custom-container-title">消费者配置ConsumerConfig</p></div><table><thead><tr><th>参数名称</th><th>描述</th></tr></thead><tbody><tr><td>bootstrap.servers</td><td>向Kafka集群建立初始连接用到的host/port列表。</td></tr><tr><td>key.deserializer和value.deserializer</td><td>指定接收消息的key和value的反序列化类型。一定要写全类名。</td></tr><tr><td>group.id</td><td>标记消费者所属的消费者组。</td></tr><tr><td>partition.assignment.strategy</td><td>消费者分区分配策略，默认策略是Range + CooperativeSticky。Kafka可以同时使用多个分区分配策略。可以选择的策略包括：Range、RoundRobin、Sticky、CooperativeSticky</td></tr><tr><td>enable.auto.commit</td><td>默认值为true，消费者会自动周期性地向服务器提交偏移量。</td></tr><tr><td>auto.commit.interval.ms</td><td>如果设置了 enable.auto.commit 的值为true， 则该值定义了消费者偏移量向Kafka提交的频率，默认5s。</td></tr><tr><td>auto.offset.reset</td><td>当Kafka中没有初始偏移量或当前偏移量在服务器中不存在（如，数据被删除了），该如何处理？ earliest：自动重置偏移量到最早的偏移量。 latest：默认，自动重置偏移量为最新的偏移量。 none：如果消费组原来的（previous）偏移量不存在，则向消费者抛异常。 anything：向消费者抛异常。</td></tr><tr><td>offsets.topic.num.partitions</td><td>__consumer_offsets的分区数，默认是50个分区。</td></tr><tr><td>heartbeat.interval.ms</td><td>Kafka消费者和coordinator之间的心跳时间，默认3s。该条目的值必须小于 session.timeout.ms ，也不应该高于 session.timeout.ms 的1/3。</td></tr><tr><td>session.timeout.ms</td><td>Kafka消费者和coordinator之间连接超时时间，默认45s。超过该值，该消费者被移除，消费者组执行再平衡。</td></tr><tr><td>max.poll.interval.ms</td><td>消费者处理消息的最大时长，默认是5分钟。超过该值，该消费者被移除，消费者组执行再平衡。</td></tr><tr><td>fetch.min.bytes</td><td>默认1个字节。消费者获取服务器端一批消息最小的字节数。</td></tr><tr><td>fetch.max.wait.ms</td><td>默认500ms。如果没有从服务器端获取到一批数据的最小字节数。该时间到，仍然会返回数据。</td></tr><tr><td>fetch.max.bytes</td><td>默认Default: 52428800（50 m）。消费者获取服务器端一批消息最大的字节数。如果服务器端一批次的数据大于该值（50m）仍然可以拉取回来这批数据，因此，这不是一个绝对最大值。一批次的大小受message.max.bytes （broker config）or max.message.bytes （topic config）影响。</td></tr><tr><td>max.poll.records</td><td>一次poll拉取数据返回消息的最大条数，默认是500条。</td></tr></tbody></table><h3 id="生产者分区" tabindex="-1"><a class="header-anchor" href="#生产者分区" aria-hidden="true">#</a> 生产者分区</h3><div class="custom-container tip"><p class="custom-container-title">介绍</p></div><p>Kafka可以将主题划分为多个分区（Partition），会根据分区规则选择把消息存储到哪个分区中</p><ul><li>便于合理使用存储资源，每个Partition在一个Broker上存储，可以把海量的数据按照分区切割成一块一块数据存储在多台Broker上。合理控制分区的任务，可以实现负载均衡的效果。</li><li>提高并行度，生产者可以以分区为单位发送数据；消费者可以以分区为单位进行消费数据。</li></ul><div class="custom-container tip"><p class="custom-container-title">生产者分区策略</p></div><p>生产者分区策略是决定⽣产者将消息发送到哪个分区的算法。<br> Kafka 为我们提供了默认的分区策略，同时它也⽀持你⾃定义分区策略。</p><p>在通过Kafka Producer的send方法发送包装成了ProducerRecord对象的消息时，必须要为ProducerRecord对象指定目标主题（topic）和消息内容（value），另外还有两个可选属性: 键（key）和分区号（partition）。</p><ul><li>如果消息ProducerRecord指定分区发送，就不会使用到分区器。指定分区发送的实现方式，是在消息ProducerRecord设置分区号；</li><li>如果不指定分区发送，则需要使用分区器经过规则计算出partition分区号，将消息发送到指定的分区。</li></ul><div class="custom-container tip"><p class="custom-container-title">键和分区号的作用</p></div><p>在进行下面测试时，我们首先给second主题增加分区数量为3</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 增加分区</span>
kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9092 <span class="token parameter variable">--alter</span> <span class="token parameter variable">--topic</span> second <span class="token parameter variable">--partitions</span> <span class="token number">3</span>

<span class="token comment"># 查看</span>
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-topics.sh --bootstrap-server 192.168.144.100:9092 --describe –topic  second</span>
Topic: second   TopicId: KbVITowXSqmdwpMHxQtx-Q PartitionCount: <span class="token number">3</span>       ReplicationFactor: <span class="token number">1</span>    Configs: 
        Topic: second   Partition: <span class="token number">0</span>    Leader: <span class="token number">0</span>       Replicas: <span class="token number">0</span>     Isr: <span class="token number">0</span>
        Topic: second   Partition: <span class="token number">1</span>    Leader: <span class="token number">0</span>       Replicas: <span class="token number">0</span>     Isr: <span class="token number">0</span>
        Topic: second   Partition: <span class="token number">2</span>    Leader: <span class="token number">0</span>       Replicas: <span class="token number">0</span>     Isr: <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>测试案例1: 键为空，不指定分区值</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// com.atcode.kafka.producer.CustomProducerCallbackPartitions</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomProducerCallbackPartitions</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;second&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建Kafka生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给Kafka配置对象添加配置信息</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.144.100:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// key,value序列化（必须）：key.serializer，value.serializer</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 不指定分区，key为空</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;atcode &quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> exception<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;主题：&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&gt;&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;分区：&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    exception<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看输出结果：</p><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code>主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>测试案例2:键为空，指定分区值</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;atcode &quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> exception<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>详细代码参考上面示例<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>查看输出结果:</p><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code>主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">1</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">1</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>测试案例3:键不为空，不指定分区值<br> 当前场景会将key的hash值与topic的partition数进行取余得到partition值。</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 依次指定key值为a,b,f ，数据key的hash值与3个分区求余，分别发往1、2、0</span>
<span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">;</span>

kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token string">&quot;atcode &quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> exception<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>详细代码参考上面示例<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看输出结果：</p><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code><span class="token operator">#</span> key为a时
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">1</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">1</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token operator">#</span> key为b时
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">2</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">2</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">2</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token operator">#</span> key为f时
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">默认分区器DefaultPartitioner</p></div><p>上述分区案例策略逻辑总结如下：</p><ol><li><p>指明partition的情况下，直接写入到指定partition分区；<br> 例如partition=0，所有数据写入分区0</p></li><li><p>没有指明partition值但有key的情况下，使用murmur2hash算法计算key的hash值与topic的partition数进行取余得到partition值；<br> 例如：key1的hash值=5， key2的hash值=6 ，topic的partition数=2，那么</p><ul><li>key1 对应的value1写入1号分区(5÷2余数1)</li><li>key2对应的value2写入0号分区(6÷2余数0)</li></ul></li><li><p>既没有partition值又没有key值的情况下，Kafka采用Sticky Partition（黏性分区器），会随机选择一个分区，并尽可能一直使用该分区，待该分区的batch（默认16k）已满或者已完成，Kafka再随机一个分区进行使用（和上一次的分区不同）。<br> 例如：第一次随机选择0号分区，等0号分区当前批次满了或者linger.ms设置的时间到， Kafka再随机一个分区进行使用（如果还是0会继续随机）。</p></li></ol><div class="custom-container tip"><p class="custom-container-title">轮询分区器RoundRobinPartitioner</p></div><p>轮询分区器，将消息均匀地分配给每一个分区。</p><p><strong>注意</strong>：在实际使用过程中，RoundRobinPartitioner分区器<strong>并不能</strong>真正的将将消息均匀地分配给每一个分区，而是将消费分配给第<strong>偶数分区</strong>（第0、2、4....个）。如果想要轮询效果，建议自定义分区策略。</p><p>在测试案例1的基础上 添加轮询分区器的配置</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//配置Kafka提供的RoundRobinPartitioner轮询分区器</span>
properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">PARTITIONER_CLASS_CONFIG</span><span class="token punctuation">,</span><span class="token string">&quot;org.apache.kafka.clients.producer.RoundRobinPartitioner&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>查看输出结果:</p><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code>主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">2</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">2</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">2</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">2</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">2</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">自定义分区器</p></div><p>我们实现一个自定义分区器，发送过来的数据中如果包含atcode发往0号分区，包含kafka发往1号分区，其他的发往2号分区。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// com.atcode.kafka.config.MyPartitioner</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyPartitioner</span> <span class="token keyword">implements</span> <span class="token class-name">Partitioner</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 返回信息发往的分区
     *
     * <span class="token keyword">@param</span> <span class="token parameter">topic</span>      主题
     * <span class="token keyword">@param</span> <span class="token parameter">key</span>        消息的key
     * <span class="token keyword">@param</span> <span class="token parameter">keyBytes</span>   消息的key序列化后的字节数组
     * <span class="token keyword">@param</span> <span class="token parameter">value</span>      消息的value
     * <span class="token keyword">@param</span> <span class="token parameter">valueBytes</span> 消息的value序列化后的字节数组
     * <span class="token keyword">@param</span> <span class="token parameter">cluster</span>    集群元数据可以查看分区信息
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> valueBytes<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取消息</span>
        <span class="token class-name">String</span> msgValue <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建partition</span>
        <span class="token keyword">int</span> partition<span class="token punctuation">;</span>
        <span class="token comment">// 判断消息是否包含atcode</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msgValue<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;atcode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            partition <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msgValue<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;kafka&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            partition <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            partition <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 返回分区号</span>
        <span class="token keyword">return</span> partition<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 关闭资源</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 配置方法</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> configs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面发送消息使用我们自定义的分区器</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 配置Kafka提供的RoundRobinPartitioner轮询分区器</span>
properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">PARTITIONER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;com.atcode.kafka.config.MyPartitioner&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 定义发送的消息 分别进行测试</span>
<span class="token class-name">String</span> value <span class="token operator">=</span> <span class="token string">&quot;atcode&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// String value = &quot;kafka&quot;;</span>
<span class="token comment">// String value = &quot;abc&quot;;</span>

kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">,</span> value <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> exception<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>详细代码参考上面示例<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看输出结果：</p><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code><span class="token operator">#</span> value为atcode时
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">0</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token operator">#</span> value为kafka时
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">1</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">1</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token operator">#</span> value为其他时
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">2</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">2</span>
主题：second<span class="token operator">-</span><span class="token operator">&gt;</span>分区：<span class="token number">2</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="发送消息ack可靠性" tabindex="-1"><a class="header-anchor" href="#发送消息ack可靠性" aria-hidden="true">#</a> 发送消息ack可靠性</h3><p>Kafka支持了ack机制，保证生产者可以将消息可靠的发送到达broker。<br> 生产者发送消息时可以配置ack的值：ProducerConfig.ACKS_CONFIG:</p><ul><li>acks=0：生产者发送过来数据，就不管了，可靠性差数据会丢，效率最高</li><li>acks=1：生产者发送过来数据，只需要Leader确认即可返回，可靠性中等，效率中等</li><li>acks=-1(all)：生产者发送过来数据，Leader和ISR队列里面所有Follwer应答，可靠性高效率最低</li></ul><p>在生产环境中：</p><ul><li>acks=0很少使用；</li><li>acks=1，一般用于传输普通日志，允许丢个别数据；</li><li>acks=-1(all)，一般用于传输重要不能丢失的数据(例如：钱、订单、积分等)，对可靠性要求比较高的场景。</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 设置acks  可以设置 &quot;0&quot;,&quot;1&quot;或者&quot;all&quot; all也可以改为-1</span>
properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">ACKS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 重试次数retries，默认Integer.MAX_VALUE （RETRY_BACKOFF_MS_CONFIG：重试间隔毫秒）</span>
properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">RETRIES_CONFIG</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="kafka消费模式" tabindex="-1"><a class="header-anchor" href="#kafka消费模式" aria-hidden="true">#</a> Kafka消费模式</h3><p>Kafka有两种模式消费数据：</p><ol><li><p>pull(拉模式，也叫发布订阅模式)：Kafka现在使用的方式，消费者可以自主选择从哪个分区开始拉取消息，并可以自主控制拉取消息的速度。Kafka 中为消费者维护着一个 offset，表示消费者已经消费的消息序号，当消费者拉取消息时，Kafka会返回该消费者还未消费的消息。虽然相比push模式实时性低一些，但是消费者灵活性高可以减少资源浪费。Kafka现在采用这种方式。</p><ul><li>可以有多个topic主题(例如：发送短息、发送邮件、保存日志等)</li><li>消费者消费数据后,不会删除数据</li><li>消费数据的多个消费者都可以消费到数据</li></ul></li><li><p>push(推模式，也叫点对点模式)：Kafka最初的默认方式，此模式生产者将消息直接推送到 Kafka 集群中的分区中，分区自动将消息存储在磁盘上，并异步将消息传输到消费者。生产者主动控制消息的推送速度，消费者则以自己的速度从Kafka集群中拉取可用消息。虽然push模式实时性高，但是可能会发送大量重复或无效消息，浪费资源。</p><ul><li>消费者主动拉取数据，消息收到后删除消息，每个消费者都属于不同的消费者组</li></ul></li></ol><div class="custom-container tip"><p class="custom-container-title">消费者组</p></div><p>所有的消费者都属于某个消费者组，即消费者组是逻辑上的一个订阅者。</p><p>Consumer Group（CG）：消费者组，由多个consumer组成。groupid相同的消费者们会形成一个消费者组。没有指定groupid的消费者会默认在一个消费者组中<br> 消费者组内每个消费者负责消费不同分区的数据，一个分区只能由一个组内消费者消费。</p><ul><li>消费者组之间互不影响</li><li>如果向消费组中添加更多的消费者，超过主题分区数量，则有一部分消费者就会闲置，不会接收任何消息</li></ul><h3 id="offset偏移量" tabindex="-1"><a class="header-anchor" href="#offset偏移量" aria-hidden="true">#</a> offset偏移量</h3><div class="custom-container tip"><p class="custom-container-title">介绍</p></div><ul><li>生产者offset <ul><li>每个分区无论Leader还是Follower，都有一个LEO（log end offset，如下图虚线标注）日志末端offset，表示生产者待写入消息的offset<br><img src="https://cdn.jsdelivr.net/gh/wxhcoding/myblog-img/java/kafka-20231109140655.png" alt="kafka-20231109140655"></li></ul></li><li>消费者offset <ul><li>Kafka会创建<code>__consumer_offsets</code>主题来保存 consumer 提交的位移，并采用key和value的方式存储： <ul><li>key: group.id+topic+分区号</li><li>value: 当前offset的值</li></ul></li><li>consumer 根据offset依次消费消息</li><li>同一个消费者/消费者组也可以通过重置offset多次消费某些数据**，**或者跳过消费某些数据</li><li>消费者消费数据时，会涉及到下图所示的几个概念: <ul><li>HW(high watermark高水位)：消费者最多能消费到的位置，也就是该分区Leader和所有Follower都到达的位置。如下图[0,8]都可以被消费，[9,12]Follower正在同步数据还未提交对消费者不可见</li><li>LEO(log end offset)：待写入消息的offset，此位置暂时没有消息。 <img src="https://cdn.jsdelivr.net/gh/wxhcoding/myblog-img/java/kafka-20231109141554.png" alt="kafka-20231109141554"></li></ul></li></ul></li></ul><p>Kafka提供了offset提交机制，使得Kafka在消费的过程中即使挂了或者引发再均衡问题重新分配Partation，恢复消费时仍然知道从哪里开始消费。</p><p>Kafka的offset有两种提交方式:</p><ol><li>自动提交(默认方式)</li><li>手动提交(可以灵活地控制offset)</li></ol><div class="custom-container tip"><p class="custom-container-title">自动提交offset</p></div><p>自动提交offset可以让我们能够专注于自己的业务逻辑。<br> Kafka中偏移量的自动提交是由参数<code>enable_auto_commit</code>和<code>auto_commit_interval_ms</code>控制的，当<code>enable_auto_commit=true</code>时，Kafka在消费时会以频率为<code>auto_commit_interval_ms</code>（默认5秒）将offset提交到Kafka的__consumer_offsets主题中。</p><p>首先创建一个主题topic <code>senior</code></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-topics.sh <span class="token parameter variable">--create</span>  <span class="token parameter variable">--topic</span> senior --bootstrap-server <span class="token number">192.168</span>.144.100:9092
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>消费者自动提交offset案例:<br> 先在IDEA工具里面启动消费者开始监听(即下面的方法)，然后我们去启动我们的生产者往主题中发送消息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 先在IDEA工具里面启动消费者开始监听, 即这个方法开始监听, 再去生产者发送消息
 */</span>
<span class="token comment">// com.atcode.kafka.offset.KafkaConsumerAutoCommitOffSetDemo</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaConsumerAutoCommitOffSetDemo</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;senior&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建Kafka生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给Kafka配置对象添加配置信息：bootstrap.servers</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.144.100:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 消费者组指定ID，每个消费者都在一个消费者组里面，是消费者组去订阅了Topic</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;group.id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;senior&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 默认值为true，消费者会自动周期性地向服务器提交偏移量,true表示读过的就不来了</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;enable.auto.commit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置了 enable.auto.commit 的值为true， 则该值定义了消费者偏移量向Kafka提交的频率，默认5s。</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;auto.commit.interval.ms&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;key.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;value.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;....进行中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置1秒消费一批数据</span>
            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 打印消费到的数据</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;offset = %d, key = %s, value = %s%n&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出内容如下:</p><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>进行中
offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token boolean">null</span><span class="token punctuation">,</span> value <span class="token operator">=</span> atcode <span class="token number">0</span>
offset <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token boolean">null</span><span class="token punctuation">,</span> value <span class="token operator">=</span> atcode <span class="token number">1</span>
offset <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token boolean">null</span><span class="token punctuation">,</span> value <span class="token operator">=</span> atcode <span class="token number">2</span>
offset <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token boolean">null</span><span class="token punctuation">,</span> value <span class="token operator">=</span> atcode <span class="token number">3</span>
offset <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token boolean">null</span><span class="token punctuation">,</span> value <span class="token operator">=</span> atcode <span class="token number">4</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>进行中
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>消费者仅关闭自动提交，但没有手动提交，导致重复消费案例：等30秒内</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//默认值为true，修改为false关闭自动提交，如没有手动提交会重复消费消息</span>
properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;enable.auto.commit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>再次重新运行监听消息，并重新发送消息<br> 消费者仅关闭自动提交，但没有手动提交，导致重复消费案例：等30秒内</p><ol><li>先启动一个消费者，出来记录一下</li><li>再启动一个消费者，看结果和第一次对比，发现一样内容被重复消费了</li></ol><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code><span class="token operator">#</span> 先启动一个消费者
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>进行中
offset <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token boolean">null</span><span class="token punctuation">,</span> value <span class="token operator">=</span> atcode <span class="token number">0</span>
offset <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token boolean">null</span><span class="token punctuation">,</span> value <span class="token operator">=</span> atcode <span class="token number">1</span>
offset <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token boolean">null</span><span class="token punctuation">,</span> value <span class="token operator">=</span> atcode <span class="token number">2</span>
offset <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token boolean">null</span><span class="token punctuation">,</span> value <span class="token operator">=</span> atcode <span class="token number">3</span>
offset <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token boolean">null</span><span class="token punctuation">,</span> value <span class="token operator">=</span> atcode <span class="token number">4</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>进行中
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token operator">#</span> 再启动一个消费者 等待一会 发现消费了重复的内容
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>进行中
offset <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token boolean">null</span><span class="token punctuation">,</span> value <span class="token operator">=</span> atcode <span class="token number">0</span>
offset <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token boolean">null</span><span class="token punctuation">,</span> value <span class="token operator">=</span> atcode <span class="token number">1</span>
offset <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token boolean">null</span><span class="token punctuation">,</span> value <span class="token operator">=</span> atcode <span class="token number">2</span>
offset <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token boolean">null</span><span class="token punctuation">,</span> value <span class="token operator">=</span> atcode <span class="token number">3</span>
offset <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token boolean">null</span><span class="token punctuation">,</span> value <span class="token operator">=</span> atcode <span class="token number">4</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>进行中
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>消费者消费消息以后自动提交，只有当消息提交以后，该消息才不会被再次接收到，</p><p>还可以配合<code>auto.commit.interval.ms</code>控制自动提交的频率。 有自动必然有手动，我们也可以通过<code>consumer.commitSync()</code>的方式实现手动提交</p><div class="custom-container tip"><p class="custom-container-title">手动提交offset</p></div><p>鉴于Kafka自动提交offset的不灵活性和不精确性(只能按指定频率提交)，Kafka提供了手动提交offset策略。手动提交能对偏移量更加灵活精准地控制，以保证消息不被重复消费以及消息不被丢失。</p><p>手动提交offset的方法有两种：</p><ul><li>commitSync（手动提交offset之同步提交）：必须等待offset提交完毕，再去消费下一批数据。</li><li>commitAsync（手动提交offset之异步提交）：发送完提交offset请求后，就开始消费下一批数据了。</li></ul><p>两者都会将本次提交的一批数据最高的偏移量提交；不同的是，同步提交阻塞当前线程，一直到提交成功，并且会自动失败重试（仍会出现提交失败），而异步提交则没有失败重试机制，当消费者异常关闭或者触发了再均衡前，偏移量还未提交会造成偏移量丢失。</p><ul><li>同步提交offset <ul><li>由于同步提交offset有失败重试机制，故更加可靠，但是由于一直等待提交结果，提交的效率比较低</li></ul></li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// com.atcode.kafka.offset.KafkaConsumerAutoCommitOffSetManualDemo</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaConsumerAutoCommitOffSetManualDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;senior&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建Kafka生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给Kafka配置对象添加配置信息：bootstrap.servers</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.144.100:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;group.id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;senior&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 默认值为true，修改为false关闭自动提交，如没有手动提交会重复消费消息</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;enable.auto.commit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;auto.commit.interval.ms&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;key.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;value.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;....进行中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置1秒消费一批数据</span>
            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 打印消费到的数据</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;offset = %d, key = %s, value = %s%n&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// !!!!!!!!!!!同步提交offset</span>
            <span class="token comment">// commitSync（手动提交offset之同步提交）：必须等待offset提交完毕，再去消费下一批数据。</span>
            consumer<span class="token punctuation">.</span><span class="token function">commitSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&quot;enable.auto.commit&quot;设置为&quot;false&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>异步提交offset <ul><li>虽然同步提交offset更可靠一些，但是由于其会阻塞当前线程，直到提交成功。因此吞吐量会受到很大的影响。</li><li>更多的情况下，会选用异步提交offset的方式，然后配合回调函数在broker做出响应的时候记录错误信息。</li></ul></li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// commitAsync（手动提交offset之异步提交）：发送完提交offset请求后，就开始消费下一批数据了。</span>
consumer<span class="token punctuation">.</span><span class="token function">commitAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//&quot;enable.auto.commit&quot;设置为&quot;false&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">指定offset消费</p></div><p>当Kafka中没有初始偏移量（消费者组第一次消费）或服务器上不再存在当前消费者偏移量时（例如该数据已被删除），该怎么办?<br> 可以配置参数：<code>ConsumerConfig.AUTO_OFFSET_RESET_CONFIG</code><br><code>auto.offset.reset = earliest | latest | none </code> 默认是latest。</p><ol><li>earliest：自动将偏移量重置为最早的偏移量，--from-beginning。<br> 对于新的GroupId来说，如果设置为earliest，它会从最早的消息开始进行消费，但是对于已经消费过的GroupId来说，它还是会从最大的offset取</li><li>latest（默认值）：自动将偏移量重置为最新偏移量。<br> 对于新的GroupId来说，它直接取最近的值，就是已经消费且提交的最大的offset值</li><li>none：如果未找到消费者组的先前偏移量，则向消费者抛出异常。</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaConsumerAutoCommitOffSetResetDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;senior&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建Kafka生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给Kafka配置对象添加配置信息：bootstrap.servers</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.144.100:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;group.id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;senior&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 默认值为true，修改为false关闭自动提交，如没有手动提交会重复消费消息</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;enable.auto.commit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;auto.commit.interval.ms&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;key.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;value.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置 auto.offset.reset   none、latest、earliest</span>
        <span class="token comment">// none: 使用新的消费者组名时，找不到自己的offset 会抛出异常NoOffsetForPartitionException</span>
        <span class="token comment">//       Undefined offset with no reset policy for partitions: [senior-0]</span>
        <span class="token comment">// latest: 将offset设置为最新的</span>
        <span class="token comment">// earliest：将offset设置为最早的</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">AUTO_OFFSET_RESET_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;earliest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;....进行中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置1秒消费一批数据</span>
            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 打印消费到的数据</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;offset = %d, key = %s, value = %s%n&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="kafka分布式集群搭建" tabindex="-1"><a class="header-anchor" href="#kafka分布式集群搭建" aria-hidden="true">#</a> Kafka分布式集群搭建</h2><blockquote><ul><li>Kafka是天然支持集群的，哪怕是一个节点实际上也是集群模式</li><li>Kafka集群依赖于Zookeeper进行协调，并且在早期的Kafka版本中很多数据都是存放在Zookeeper的</li><li>Kafka节点只要注册到同一个Zookeeper上就代表它们是同一个集群的</li><li>Kafka通过brokerId来区分集群中的不同节点</li></ul></blockquote><h3 id="分析" tabindex="-1"><a class="header-anchor" href="#分析" aria-hidden="true">#</a> 分析</h3><p>为了测试方便，我们选择搭建伪分布式Kafka集群，在同一台虚拟机上启动1个zookeeper实例，3个Kafka实例搭建集群<br> 创建Topic时可以分成3个partition，每个partition包括leader在内3个replication<br> 集群配置如下：</p><table><thead><tr><th></th><th>server1</th><th>server2</th><th>server3</th></tr></thead><tbody><tr><td>zookeeper</td><td>192.168.144.100:2181</td><td>192.168.144.100:2181</td><td>192.168.144.100:2181</td></tr><tr><td>kafka</td><td>192.168.144.100:9095</td><td>192.168.144.100:9096</td><td>192.168.144.100:9097</td></tr><tr><td>kafka配置文件</td><td>/opt/kafka/config/server1.properties</td><td>/opt/kafka/config/server2.properties</td><td>/opt/kafka/config/server3.properties</td></tr><tr><td>kafka日志文件</td><td>/tmp/kafkacluster-logs1</td><td>/tmp/kafkacluster-logs2</td><td>/tmp/kafkacluster-logs3</td></tr></tbody></table><h3 id="搭建" tabindex="-1"><a class="header-anchor" href="#搭建" aria-hidden="true">#</a> 搭建</h3><p>首先停止kafka 再停止zookeeper</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-server-stop.sh
zookeeper-server-stop.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">配置文件</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 进入到配置文件目录</span>
<span class="token builtin class-name">cd</span> /opt/kafka/config
<span class="token comment"># 复制一份zookeeper.properties 当作集群的配置文件</span>
<span class="token function">cp</span> zookeeper.properties zookeeper-cluster.properties 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改Kafka实例1配置文件,配置完1后照着它拷贝进行2和3实例配置:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 复制server.properties</span>
<span class="token function">cp</span> server.properties server1.properties
<span class="token comment"># 修改配置文件 修改以下内容</span>
<span class="token assign-left variable">broker.id</span><span class="token operator">=</span><span class="token number">1</span>
listeners <span class="token operator">=</span> PLAINTEXT://192.168.144.100:9095
<span class="token assign-left variable">advertised.listeners</span><span class="token operator">=</span>PLAINTEXT://192.168.144.100:9095
<span class="token assign-left variable">log.dirs</span><span class="token operator">=</span>/tmp/kafkacluster-logs1
<span class="token assign-left variable">zookeeper.connect</span><span class="token operator">=</span><span class="token number">192.168</span>.144.100:2181
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>复制上面的配置文件，在这个基础上修改为2和3的配置文件</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">cp</span> server1.properties  server2.properties
<span class="token function">cp</span> server1.properties  server3.properties

<span class="token comment"># 分别进行修改</span>
<span class="token comment"># server2.properties</span>
<span class="token assign-left variable">broker.id</span><span class="token operator">=</span><span class="token number">2</span>
listeners <span class="token operator">=</span> PLAINTEXT://192.168.144.100:9096
<span class="token assign-left variable">advertised.listeners</span><span class="token operator">=</span>PLAINTEXT://192.168.144.100:9096
<span class="token assign-left variable">log.dirs</span><span class="token operator">=</span>/tmp/kafkacluster-logs2
<span class="token assign-left variable">zookeeper.connect</span><span class="token operator">=</span><span class="token number">192.168</span>.144.100:2181

<span class="token comment"># server3.properties</span>
<span class="token assign-left variable">broker.id</span><span class="token operator">=</span><span class="token number">3</span>
listeners <span class="token operator">=</span> PLAINTEXT://192.168.144.100:9097
<span class="token assign-left variable">advertised.listeners</span><span class="token operator">=</span>PLAINTEXT://192.168.144.100:9097
<span class="token assign-left variable">log.dirs</span><span class="token operator">=</span>/tmp/kafkacluster-logs3
<span class="token assign-left variable">zookeeper.connect</span><span class="token operator">=</span><span class="token number">192.168</span>.144.100:2181
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">修改kafka和zookeeper的启动内存</p></div><p>修改Kafka启动内存大小</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">vim</span> /opt/kafka/bin/kafka-server-start.sh

<span class="token comment"># 修改内容如下</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;x<span class="token variable">$KAFKA_HEAP_OPTS</span>&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;x&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">export</span> <span class="token assign-left variable">KAFKA_HEAP_OPTS</span><span class="token operator">=</span><span class="token string">&quot;-Xmx256M -Xms256M&quot;</span>
<span class="token keyword">fi</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改zookeeper启动内存大小:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">vim</span> /opt/kafka/bin/zookeeper-server-start.sh

<span class="token comment"># 修改内容如下</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;x<span class="token variable">$KAFKA_HEAP_OPTS</span>&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;x&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">export</span> <span class="token assign-left variable">KAFKA_HEAP_OPTS</span><span class="token operator">=</span><span class="token string">&quot;-Xmx256M -Xms256M&quot;</span>
<span class="token keyword">fi</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">启动和停止zookeeper和kafka</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 等待2秒钟后请用命令lsof -i:2181查看zookeeper是否成功启动，务必保证zk先OK</span>
<span class="token comment"># 进入到 /opt/kafka/</span>
<span class="token builtin class-name">cd</span> /opt/kafka/
zookeeper-server-start.sh <span class="token parameter variable">-daemon</span>  config/zookeeper-cluster.properties

<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># lsof -i:2181</span>
COMMAND   PID <span class="token environment constant">USER</span>   FD   TYPE  DEVICE SIZE/OFF NODE NAME
<span class="token function">java</span>    <span class="token number">69966</span> root  120u  IPv6 <span class="token number">5682749</span>      0t0  TCP *:eforward <span class="token punctuation">(</span>LISTEN<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 启动三个kafka</span>
kafka-server-start.sh <span class="token parameter variable">-daemon</span> config/server1.properties
kafka-server-start.sh <span class="token parameter variable">-daemon</span> config/server2.properties
kafka-server-start.sh <span class="token parameter variable">-daemon</span> config/server3.properties
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 查看启动是否成功</span>
jps <span class="token parameter variable">-l</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> jps

<span class="token comment"># 如下所示 三个kafka和一个sookeeper实例启动成功</span>
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># jps -l | grep -v jps</span>
<span class="token number">70896</span> kafka.Kafka
<span class="token number">70469</span> kafka.Kafka
<span class="token number">71320</span> kafka.Kafka
<span class="token number">69966</span> org.apache.zookeeper.server.quorum.QuorumPeerMain
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>停止</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 停止kafka</span>
kafka-server-stop.sh
<span class="token comment"># 停止zookeeper</span>
zookeeper-server-stop.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="使用集群" tabindex="-1"><a class="header-anchor" href="#使用集群" aria-hidden="true">#</a> 使用集群</h3><div class="custom-container tip"><p class="custom-container-title">创建集群主题</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 建立3个分区并给每个分区建立3个副本</span>
kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9095,192.168.144.100:9096,192.168.144.100:9097 <span class="token parameter variable">--create</span> <span class="token parameter variable">--partitions</span> <span class="token number">3</span> --replication-factor <span class="token number">3</span> <span class="token parameter variable">--topic</span> myclustertopic
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">查看集群主题</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9095 <span class="token parameter variable">--describe</span> <span class="token parameter variable">--topic</span> myclustertopic

<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-topics.sh --bootstrap-server 192.168.144.100:9095 --describe --topic myclustertopic</span>
Topic: myclustertopic   TopicId: 4TOUeUUASjiy8kkTIWfSVA PartitionCount: <span class="token number">3</span>       ReplicationFactor: <span class="token number">3</span>    Configs: 
        Topic: myclustertopic   Partition: <span class="token number">0</span>    Leader: <span class="token number">2</span>       Replicas: <span class="token number">2,3</span>,1 Isr: <span class="token number">2,3</span>,1
        Topic: myclustertopic   Partition: <span class="token number">1</span>    Leader: <span class="token number">3</span>       Replicas: <span class="token number">3,1</span>,2 Isr: <span class="token number">3,1</span>,2
        Topic: myclustertopic   Partition: <span class="token number">2</span>    Leader: <span class="token number">1</span>       Replicas: <span class="token number">1,2</span>,3 Isr: <span class="token number">1,2</span>,3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">集群消息发送</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-console-producer.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9095,192.168.144.100:9096,192.168.144.100:9097 <span class="token parameter variable">--topic</span> myclustertopic

<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-console-producer.sh --bootstrap-server 192.168.144.100:9095,192.168.144.100:9096,192.168.144.100:9097 --topic myclustertopic</span>
<span class="token operator">&gt;</span>test1
<span class="token operator">&gt;</span>test2
<span class="token operator">&gt;</span>test3
<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">集群消息消费</p></div><p>执行下面的命令会发现没有任何消息消费 我们删除__consumer_offsets</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-console-consumer.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9095,192.168.144.100:9096,192.168.144.100:9097  --from-beginning <span class="token parameter variable">--topic</span> myclustertopic

<span class="token comment"># 我们此时查看主题列表 发现有之前的__consumer_offsets</span>
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-topics.sh --bootstrap-server 192.168.144.100:9095 --list</span>
__consumer_offsets
hellokafka
hellokafka-topic
kafkav1
myclustertopic
second
senior
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>参考下面的进行操作</p><div class="custom-container tip"><p class="custom-container-title">参考</p><p>清理__consumer_offsets主题的方式有两种：手动清理和自动清理。</p><ul><li><p>手动清理__consumer_offsets:</p><ul><li>停止Kafka服务。</li><li>删除存储__consumer_offsets主题的Kafka日志文件夹。默认情况下，这些文件位于Kafka的log.dirs配置指定的目录中。</li><li>删除Zookeeper中关于__consumer_offsets的节点。可以使用Zookeeper命令行工具或Zookeeper客户端来完成此操作。</li></ul></li><li><p>自动清理__consumer_offsets:</p><ul><li>Kafka支持自动清理__consumer_offsets主题，以下为自动清理的配置参数： <ul><li>log.cleanup.policy可以设置为compact。这将会启用日志压缩机制，在保留消费者组提交的最新偏移量的同时删除旧的偏移量。</li><li>log.cleaner.enable设置为true，启用日志清理器。</li><li>log.cleaner.threads设置为一个正整数，指定日志清理器线程的数量。</li><li>log.cleaner.min.compaction.lag.ms配置项指定了在这个时长内新写入的消息不会被清理。</li></ul></li></ul></li></ul><p>请注意，在清理__consumer_offsets之前，务必确保没有正在进行的消费者组活动，并且确保备份了重要的消费者组提交的偏移量。清理__consumer_offsets主题可能会导致消费者组丢失其偏移量，从而导致消费者重新开始消费消息。</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 停止kafka服务</span>
<span class="token comment"># 删除__consumer_offsets</span>
kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9095 <span class="token parameter variable">--delete</span> <span class="token parameter variable">--topic</span> __consumer_offsets
<span class="token comment"># 进入到/tmp 目录下 删除三个kafka集群日志</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> kafkacluster-logs1
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> kafkacluster-logs2
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> kafkacluster-logs3
<span class="token comment"># 之前的也删除</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> kafka-logs

<span class="token comment"># 删除zookeeper的__consumer_offsets</span>
<span class="token comment"># 进入到客户端</span>
zookeeper-shell.sh <span class="token number">192.168</span>.144.100:2181
<span class="token comment"># 查看</span>
<span class="token function">ls</span> /brokers/topics
<span class="token punctuation">[</span>__consumer_offsets, hellokafka, hellokafka-topic, kafkav1, myclustertopic, second, senior<span class="token punctuation">]</span>
<span class="token comment"># 删除</span>
deleteall /brokers/topics/__consumer_offsets

<span class="token comment"># 把上面创建的myclustertopic删除 重新创建</span>
kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9095 <span class="token parameter variable">--delete</span> <span class="token parameter variable">--topic</span> myclustertopic
kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.144.100:9095,192.168.144.100:9096,192.168.144.100:9097 <span class="token parameter variable">--create</span> <span class="token parameter variable">--partitions</span> <span class="token number">3</span> --replication-factor <span class="token number">3</span> <span class="token parameter variable">--topic</span> myclustertopic

<span class="token comment"># 再次重启进行消息发送</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再次发送消息接收消息测试</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-console-producer.sh --bootstrap-server 192.168.144.100:9095,192.168.144.100:9096,192.168.144.100:9097 --topic myclustertopic</span>
<span class="token operator">&gt;</span>k1
<span class="token operator">&gt;</span>k2
<span class="token operator">&gt;</span>k3
<span class="token operator">&gt;</span>

<span class="token comment"># 另起窗口进行接收测试</span>
<span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-console-consumer.sh --bootstrap-server 192.168.144.100:9095,192.168.144.100:9096,192.168.144.100:9097  --from-beginning --topic myclustertopic</span>
k1
k2
k3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://cdn.jsdelivr.net/gh/wxhcoding/myblog-img/java/kafka-20231110192353.png" alt="kafka-20231110192353"></p><h2 id="springboot整合kafka" tabindex="-1"><a class="header-anchor" href="#springboot整合kafka" aria-hidden="true">#</a> SpringBoot整合Kafka</h2><p><a href="https://spring.io/projects/spring-Kafka" target="_blank" rel="noopener noreferrer">spring-kafka<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>提供了<code>KafkaTemplate</code>模板类和<code>@KafkaListener</code>注解简化了Kafka的使用</p><h3 id="生产者" tabindex="-1"><a class="header-anchor" href="#生产者" aria-hidden="true">#</a> 生产者</h3><div class="custom-container tip"><p class="custom-container-title">项目搭建</p></div><p>在上面的API入门篇中创建的kafka-demo下继续创建一个Moudle <code>spring-kafka-producter</code><br> 因为父工程已经导入了一些基本的依赖，这里我们再导入一个lombok和spring-kafka即可(其余依赖请参考本节内容的API入门篇)</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在resources目录下创建application.yml配置文件</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8110</span>

<span class="token comment"># v1</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">kafka</span><span class="token punctuation">:</span>
    <span class="token comment"># kafka集群的ip地址及端口号</span>
    <span class="token key atrule">bootstrap-servers</span><span class="token punctuation">:</span> 192.168.144.100<span class="token punctuation">:</span><span class="token number">9095</span><span class="token punctuation">,</span>192.168.144.100<span class="token punctuation">:</span><span class="token number">9096</span><span class="token punctuation">,</span>192.168.144.100<span class="token punctuation">:</span><span class="token number">9097</span>
    <span class="token key atrule">producer</span><span class="token punctuation">:</span> <span class="token comment"># producer 生产者</span>
      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment"># 重试次数 0表示不重试</span>
      <span class="token key atrule">acks</span><span class="token punctuation">:</span> <span class="token number">-1</span> <span class="token comment"># 应答级别:多少个分区副本备份完成时向生产者发送ack确认(可选0、1、-1/all)</span>
      <span class="token key atrule">batch-size</span><span class="token punctuation">:</span> <span class="token number">16384</span> <span class="token comment"># 批次大小 单位byte</span>
      <span class="token key atrule">buffer-memory</span><span class="token punctuation">:</span> <span class="token number">33554432</span> <span class="token comment"># 生产者缓冲区大小 单位byte</span>
      <span class="token key atrule">key-serializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringSerializer <span class="token comment"># key的序列化器</span>
      <span class="token key atrule">value-serializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringSerializer <span class="token comment"># value的序列化器</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="创建主题" tabindex="-1"><a class="header-anchor" href="#创建主题" aria-hidden="true">#</a> 创建主题</h4><p>创建一个配置类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token comment">// com.atcode.kafka.config.KafkaConfig</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">NewTopic</span> <span class="token function">springTestTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">TopicBuilder</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_topic&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 主题名称</span>
                <span class="token punctuation">.</span><span class="token function">partitions</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 分区数量</span>
                <span class="token punctuation">.</span><span class="token function">replicas</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 副本数量</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建启动类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token comment">// com.atcode.kafka.SpringKafkaProducterApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringKafkaProducterApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SpringKafkaProducterApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动这个服务，查看主题是否创建成功</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-topics.sh --bootstrap-server 192.168.144.100:9095 --list</span>
__consumer_offsets
hellokafka
hellokafka-topic
kafkav1
myclustertopic
second
senior
spring_test_topic
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlight-line"> </div></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建<code>spring_test_topic</code>主题成功</p><h4 id="发送消息-1" tabindex="-1"><a class="header-anchor" href="#发送消息-1" aria-hidden="true">#</a> 发送消息</h4><div class="custom-container tip"><p class="custom-container-title">发送简单消息</p></div><p>在测试类创建发送消息方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> producer <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">KafkaTemplate</span> kafkaTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 参数1：主题名称</span>
        <span class="token comment">// 参数2：消息内容</span>
        kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_topic&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello,kafka&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接收消息成功</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-console-consumer.sh --bootstrap-server 192.168.144.100:9095,192.168.144.100:9096,192.168.144.100:9097  --from-beginning --topic spring_test_topic</span>
hello,kafka

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注意</strong>: 这里的测试类要加<code>@SpringBootTest</code>注解 否则会报下面的错误<br><code>java.lang.NullPointerException: Cannot invoke &quot;org.springframework.kafka.core.KafkaTemplate.send(String, Object)&quot; because &quot;this.kafkaTemplate&quot; is null</code></p><div class="custom-container tip"><p class="custom-container-title">生产者确认</p></div><p>生产者发送消息后接收到Kafka服务端应答acks可以通过回调确认消息是否发送成功</p><ul><li>创建生产者监听器</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token comment">// com.atcode.kafka.producer.KafkaSendResultHandler</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaSendResultHandler</span> <span class="token keyword">implements</span> <span class="token class-name">ProducerListener</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 发送成功回调
     *
     * <span class="token keyword">@param</span> <span class="token parameter">producerRecord</span>
     * <span class="token keyword">@param</span> <span class="token parameter">recordMetadata</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span> producerRecord<span class="token punctuation">,</span> <span class="token class-name">RecordMetadata</span> recordMetadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> topic <span class="token operator">=</span> producerRecord<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> producerRecord<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;topic: {}, value: {}, 发送成功回调---&quot;</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 发送失败回调
     *
     * <span class="token keyword">@param</span> <span class="token parameter">producerRecord</span>
     * <span class="token keyword">@param</span> <span class="token parameter">recordMetadata</span>
     * <span class="token keyword">@param</span> <span class="token parameter">exception</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span> producerRecord<span class="token punctuation">,</span> <span class="token class-name">RecordMetadata</span> recordMetadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> topic <span class="token operator">=</span> producerRecord<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> producerRecord<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;topic: {}, value: {}, 发送失败, 原因: {} ---&quot;</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span> value<span class="token punctuation">,</span> exception<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>启动这个服务 进行生产者监听 这里把我们上面创建主题的配置类注释 以免重复创建</li><li>下面进行消息的发送进行测试</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> producer <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">KafkaTemplate</span> kafkaTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMsg2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 参数1：主题名称</span>
        <span class="token comment">// 参数2：消息内容</span>
        kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_topic&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello,kafka2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//阻塞：避免回调未执行时线程结束</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到输出结果如下:</p><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code><span class="token level info keyword">INFO</span> <span class="token number">276</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>ad <span class="token operator">|</span> producer<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>k<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>KafkaSendResultHandler    <span class="token operator">:</span> topic<span class="token operator">:</span> spring_test_topic<span class="token punctuation">,</span> value<span class="token operator">:</span> hello<span class="token punctuation">,</span>kafka2<span class="token punctuation">,</span> 发送成功回调<span class="token separator comment">---</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-console-consumer.sh --bootstrap-server 192.168.144.100:9095,192.168.144.100:9096,192.168.144.100:9097  --from-beginning --topic spring_test_topic</span>
hello,kafka
hello,kafka2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">发送复杂消息</p></div><ul><li>新建一个实体类对象</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token comment">// com.atcode.kafka.entity.UserDTO</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDTO</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>创建测试方法进行消息发送</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token comment">// com.atcode.kafka.producer#sendMsg3</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMsg3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_topic&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span><span class="token string">&quot;tom&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">&quot;12332102345&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//阻塞：避免回调未执行时线程结束</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>启动测试 这里发现会报错</li></ul><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code><span class="token property">org.apache.kafka.common.errors.SerializationException:</span> Can&#39;t convert value of class com<span class="token punctuation">.</span>atcode<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>entity<span class="token punctuation">.</span>UserDTO to class org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span>StringSerializer specified in <span class="token domain constant">value.serializer</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这里是因为我们的生产者值的序列化器配置的是<code>StringSerializer</code><br> appication.yml中修改生产者序列化器 配置json序列化器</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">kafka</span><span class="token punctuation">:</span>
    <span class="token comment"># kafka集群的ip地址及端口号</span>
    <span class="token key atrule">bootstrap-servers</span><span class="token punctuation">:</span> 192.168.144.100<span class="token punctuation">:</span><span class="token number">9095</span><span class="token punctuation">,</span>192.168.144.100<span class="token punctuation">:</span><span class="token number">9096</span><span class="token punctuation">,</span>192.168.144.100<span class="token punctuation">:</span><span class="token number">9097</span>
    <span class="token key atrule">producer</span><span class="token punctuation">:</span> <span class="token comment"># producer 生产者</span>
      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment"># 重试次数 0表示不重试</span>
      <span class="token key atrule">acks</span><span class="token punctuation">:</span> <span class="token number">-1</span> <span class="token comment"># 应答级别:多少个分区副本备份完成时向生产者发送ack确认(可选0、1、-1/all)</span>
      <span class="token key atrule">batch-size</span><span class="token punctuation">:</span> <span class="token number">16384</span> <span class="token comment"># 批次大小 单位byte</span>
      <span class="token key atrule">buffer-memory</span><span class="token punctuation">:</span> <span class="token number">33554432</span> <span class="token comment"># 生产者缓冲区大小 单位byte</span>
      <span class="token key atrule">key-serializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringSerializer <span class="token comment"># key的序列化器</span>
<span class="token comment">#      value-serializer: org.apache.kafka.common.serialization.StringSerializer # value的序列化器</span>
      <span class="token key atrule">value-serializer</span><span class="token punctuation">:</span> org.springframework.kafka.support.serializer.JsonSerializer <span class="token comment"># 配置json序列化器</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>再次启动进行测试 生产者监听器输出结果如下 消费到的消息如下</li></ul><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code><span class="token level info keyword">INFO</span> <span class="token number">12800</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>ad <span class="token operator">|</span> producer<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>k<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>KafkaSendResultHandler    <span class="token operator">:</span> topic<span class="token operator">:</span> spring_test_topic<span class="token punctuation">,</span> value<span class="token operator">:</span> UserDTO<span class="token operator">(</span>name<span class="token operator">=</span>tom<span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">18</span><span class="token punctuation">,</span> phone<span class="token operator">=</span><span class="token number">12332102345</span><span class="token operator">)</span><span class="token punctuation">,</span> 发送成功回调<span class="token separator comment">---</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@jhw kafka<span class="token punctuation">]</span><span class="token comment"># kafka-console-consumer.sh --bootstrap-server 192.168.144.100:9095,192.168.144.100:9096,192.168.144.100:9097  --from-beginning --topic spring_test_topic</span>
hello,kafka
hello,kafka2
<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;tom&quot;</span>,<span class="token string">&quot;age&quot;</span>:18,<span class="token string">&quot;phone&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;12332102345&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">生产者拦截器</p></div><p>消息在通过<code>send()</code>方法发往 broker 的过程中，有可能依次经过拦截、序列化器和分区器的一系列作用之后才被真正地发往 broker。<br> 生产者拦截器既可以用来在消息发送前做一些准备工作，比如按照检查、修改消息内容，也可以用来在发送回调逻辑前做一些定制化的需求，比如统计工作。<br> 我们来实现一个统计消息发送的成功率</p><ul><li>创建生产者拦截器</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token comment">// com.atcode.kafka.producer.KafkaProducerInterceptor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaProducerInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">ProducerInterceptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> success <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> failure <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 消息发送前执行：可以对消息内容进行处理
     *
     * <span class="token keyword">@param</span> <span class="token parameter">producerRecord</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">onSend</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producerRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;即将要发送的消息为: {}&quot;</span><span class="token punctuation">,</span> producerRecord<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 此处可以修改producerRecord的属性值然后return</span>
        <span class="token keyword">return</span> producerRecord<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * Kafka服务端应答后，应答到达生产者确认回调前执行
     *
     * <span class="token keyword">@param</span> <span class="token parameter">recordMetadata</span>
     * <span class="token keyword">@param</span> <span class="token parameter">e</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAcknowledgement</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> recordMetadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 成功</span>
            success<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;success = &quot;</span> <span class="token operator">+</span> success<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">// 失败</span>
            failure<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;failure = &quot;</span> <span class="token operator">+</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 拦截器销毁前执行
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送统计, 成功数量：{}, 失败数量：{}, 成功比例：{}&quot;</span><span class="token punctuation">,</span>
                success<span class="token punctuation">,</span> failure<span class="token punctuation">,</span> <span class="token punctuation">(</span>success <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span>success <span class="token operator">+</span> failure<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">+</span> <span class="token string">&quot;%&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>KafkaTemplate配置生产者拦截器</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token comment">// com.atcode.kafka.SpringKafkaProducterApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringKafkaProducterApplication</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">KafkaTemplate</span> kafkaTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">KafkaProducerInterceptor</span> kafkaProducerInterceptor<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        kafkaTemplate<span class="token punctuation">.</span><span class="token function">setProducerInterceptor</span><span class="token punctuation">(</span>kafkaProducerInterceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;----init success over,KafkaTemplate配置生产者拦截器kafkaProducerInterceptor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SpringKafkaProducterApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>编写测试代码进行测试</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMsgByProducerInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_topic&quot;</span><span class="token punctuation">,</span> i <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span><span class="token string">&quot;tom&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">&quot;13512345678&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 阻塞：避免回调未执行时线程结束</span>
    <span class="token comment">// 如果不加这个阻塞 success可能统计不到数据 导致最后的结果为0</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>重启spring boot 运行测试代码</li></ul><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code><span class="token level info keyword">INFO</span> <span class="token number">8608</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>ionShutdownHook<span class="token punctuation">]</span> c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>k<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>KafkaProducerInterceptor  <span class="token operator">:</span> 消息发送统计<span class="token punctuation">,</span> 成功数量：<span class="token number">10</span><span class="token punctuation">,</span> 失败数量：<span class="token number">0</span><span class="token punctuation">,</span> 成功比例：<span class="token number">100.0</span><span class="token operator">%</span>
<span class="token level info keyword">INFO</span> <span class="token number">8608</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>ionShutdownHook<span class="token punctuation">]</span> c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>k<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>KafkaProducerInterceptor  <span class="token operator">:</span> 消息发送统计<span class="token punctuation">,</span> 成功数量：<span class="token number">10</span><span class="token punctuation">,</span> 失败数量：<span class="token number">0</span><span class="token punctuation">,</span> 成功比例：<span class="token number">100.0</span><span class="token operator">%</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="生产者事务" tabindex="-1"><a class="header-anchor" href="#生产者事务" aria-hidden="true">#</a> 生产者事务</h4><ul><li>At Most Once（默认）：最多一次【允许为0次，数据可能丢失】<br> Producer禁止重试</li><li>At Least Once：至少一次【至少一次，允许多次，数据可能重复】<br> Producer开启了重试机制，当发送的消息没有收到Kafka集群成功的应答时会再次发送数据</li><li>Exactly Once：有且仅有一次【只有一次，精准数据传输】<br> Kafka通过幂等性和事务这两个机制保证了精准一次</li></ul><p>Kafka 0.11版本以后，引入了幂等性和事务。</p><ul><li>幂等性<br> 幂等性就是指Producer不论向Broker发送多少次重复数据，Broker端都只会持久化一条，保证了不重复。</li><li>事务<br> 幂等性只能保证单次会话内的精准一次性，不能解决跨会话和跨分区的问题。事务保证Kafka在 Exactly Once 语义的基础上，Producer 和 Consumer 可以跨分区会话，要么全部成功，要么全部失败。<br> Kafka事务是指一系列的生产者生产消息和消费者提交偏移量的操作在一个事务中，是一个原子操作，同时成功或者失败。<br> Kafka事务操作有一些要求，首先<code>acks=all</code>，要确保每个节点都能同步消息，同时<code>retries&gt;0</code>，满足这2个条件后，就可以使用Kafka事务。</li></ul><p>首先对配置文件进行更改</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">kafka</span><span class="token punctuation">:</span>
    <span class="token comment"># kafka集群的ip地址及端口号</span>
    <span class="token key atrule">bootstrap-servers</span><span class="token punctuation">:</span> 192.168.144.100<span class="token punctuation">:</span><span class="token number">9095</span><span class="token punctuation">,</span>192.168.144.100<span class="token punctuation">:</span><span class="token number">9096</span><span class="token punctuation">,</span>192.168.144.100<span class="token punctuation">:</span><span class="token number">9097</span>
    <span class="token key atrule">producer</span><span class="token punctuation">:</span> <span class="token comment"># producer 生产者</span>
<span class="token comment">#      retries: 0 # 重试次数 0表示不重试</span>
<span class="token comment">#      acks: -1 # 应答级别:多少个分区副本备份完成时向生产者发送ack确认(可选0、1、-1/all)</span>
      <span class="token key atrule">batch-size</span><span class="token punctuation">:</span> <span class="token number">16384</span> <span class="token comment"># 批次大小 单位byte</span>
      <span class="token key atrule">buffer-memory</span><span class="token punctuation">:</span> <span class="token number">33554432</span> <span class="token comment"># 生产者缓冲区大小 单位byte</span>
      <span class="token key atrule">key-serializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringSerializer <span class="token comment"># key的序列化器</span>
<span class="token comment">#      value-serializer: org.apache.kafka.common.serialization.StringSerializer # value的序列化器</span>
      <span class="token key atrule">value-serializer</span><span class="token punctuation">:</span> org.springframework.kafka.support.serializer.JsonSerializer <span class="token comment"># 配置json序列化器</span>
      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 重试次数</span>
      <span class="token key atrule">acks</span><span class="token punctuation">:</span> <span class="token number">-1</span>
      <span class="token comment"># 事务前缀：配置后producer自动开启事务</span>
      <span class="token key atrule">transaction-id-prefix</span><span class="token punctuation">:</span> tx_
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编写测试代码进行测试 测试发送两条消息，并在中间制造异常</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span> <span class="token comment">// 添加事务注解：会自动回滚</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendKafkaTx</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;s1111&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_topic&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;trans_data1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;s2222&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 制造一个异常</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
    kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_topic&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;trans_data2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;s3333&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看输出日志</p><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code>s1111
<span class="token level info keyword">INFO</span> <span class="token number">9560</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>k<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>KafkaProducerInterceptor  <span class="token operator">:</span> 即将要发送的消息为<span class="token operator">:</span> trans_data1
s2222
<span class="token level info keyword">INFO</span> <span class="token number">9560</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> o<span class="token punctuation">.</span>a<span class="token punctuation">.</span>k<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>KafkaProducer     <span class="token operator">:</span> <span class="token punctuation">[</span>Producer clientId<span class="token operator">=</span>producer<span class="token operator">-</span>tx_0<span class="token punctuation">,</span> transactionalId<span class="token operator">=</span>tx_0<span class="token punctuation">]</span> Aborting incomplete transaction
failure <span class="token operator">=</span> <span class="token number">1</span>
<span class="token level info keyword">INFO</span> <span class="token number">9560</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span><span class="token operator">|</span> producer<span class="token operator">-</span>tx_0<span class="token punctuation">]</span> c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>k<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>KafkaSendResultHandler    <span class="token operator">:</span> topic<span class="token operator">:</span> spring_test_topic<span class="token punctuation">,</span> value<span class="token operator">:</span> trans_data1<span class="token punctuation">,</span> 发送失败<span class="token punctuation">,</span> 原因<span class="token operator">:</span> Failing batch since transaction was aborted <span class="token separator comment">---</span>

<span class="token exception javastacktrace language-javastacktrace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ArithmeticException<span class="token punctuation">:</span> / by zero
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>

<span class="token level info keyword">INFO</span> <span class="token number">9560</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>ionShutdownHook<span class="token punctuation">]</span> c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>k<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>KafkaProducerInterceptor  <span class="token operator">:</span> 消息发送统计<span class="token punctuation">,</span> 成功数量：<span class="token number">0</span><span class="token punctuation">,</span> 失败数量：<span class="token number">1</span><span class="token punctuation">,</span> 成功比例：<span class="token number">0.0</span><span class="token operator">%</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="生产者数据有序" tabindex="-1"><a class="header-anchor" href="#生产者数据有序" aria-hidden="true">#</a> 生产者数据有序</h4><p>Kafka 最多只保证单分区内的消息是有序的，所以如果要保证业务全局严格有序，就要设置 Topic 为单分区。但是，某批次的数据发送失败后，进行了重试，也可能出现后边的批次先于它到达的情况。</p><p>如何保证单分区内数据有序or怎么解决乱序?<br> 解决方案:<br> 通过将指定key的消息发送到同一个分区，可以保证消息的局部有序，因为Kafka可以保证同一个分区的消息是严格有序的，然后设置retries等于0</p><p>修改配置文件</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">kafka</span><span class="token punctuation">:</span>
    <span class="token comment"># kafka集群的ip地址及端口号</span>
    <span class="token key atrule">bootstrap-servers</span><span class="token punctuation">:</span> 192.168.144.100<span class="token punctuation">:</span><span class="token number">9095</span><span class="token punctuation">,</span>192.168.144.100<span class="token punctuation">:</span><span class="token number">9096</span><span class="token punctuation">,</span>192.168.144.100<span class="token punctuation">:</span><span class="token number">9097</span>
    <span class="token key atrule">producer</span><span class="token punctuation">:</span> <span class="token comment"># producer 生产者</span>
      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment"># 重试次数 0表示不重试</span>
      <span class="token key atrule">acks</span><span class="token punctuation">:</span> <span class="token number">-1</span> <span class="token comment"># 应答级别:多少个分区副本备份完成时向生产者发送ack确认(可选0、1、-1/all)</span>
      <span class="token key atrule">batch-size</span><span class="token punctuation">:</span> <span class="token number">16384</span> <span class="token comment"># 批次大小 单位byte</span>
      <span class="token key atrule">buffer-memory</span><span class="token punctuation">:</span> <span class="token number">33554432</span> <span class="token comment"># 生产者缓冲区大小 单位byte</span>
      <span class="token key atrule">key-serializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringSerializer <span class="token comment"># key的序列化器</span>
<span class="token comment">#      value-serializer: org.apache.kafka.common.serialization.StringSerializer # value的序列化器</span>
      <span class="token key atrule">value-serializer</span><span class="token punctuation">:</span> org.springframework.kafka.support.serializer.JsonSerializer <span class="token comment"># 配置json序列化器</span>
<span class="token comment">#      retries: 1 # 重试次数</span>
<span class="token comment">#      acks: -1</span>
      <span class="token comment"># 事务前缀：配置后producer自动开启事务</span>
<span class="token comment">#      transaction-id-prefix: tx_</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>发送消息时指定key保证发送到同一个分区</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">KafkaTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> kafkaTemplate2<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">sendMsgBysendMsgSamePartition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>kafkaTemplate2<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_topic&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ordered_data1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRecordMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>kafkaTemplate2<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_topic&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ordered_data2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRecordMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果为:</p><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code><span class="token level info keyword">INFO</span> <span class="token number">12984</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>k<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>KafkaProducerInterceptor  <span class="token operator">:</span> 即将要发送的消息为<span class="token operator">:</span> ordered_data1
<span class="token level info keyword">INFO</span> <span class="token number">12984</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>ad <span class="token operator">|</span> producer<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>Metadata        <span class="token operator">:</span> <span class="token punctuation">[</span>Producer clientId<span class="token operator">=</span>producer<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token property">Cluster ID:</span> W5nGc7t4RiWo9A98_KC4nw
success <span class="token operator">=</span> <span class="token number">1</span>
<span class="token number">2</span>
<span class="token level info keyword">INFO</span> <span class="token number">12984</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>k<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>KafkaProducerInterceptor  <span class="token operator">:</span> 即将要发送的消息为<span class="token operator">:</span> ordered_data2
<span class="token level info keyword">INFO</span> <span class="token number">12984</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>ad <span class="token operator">|</span> producer<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>k<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>KafkaSendResultHandler    <span class="token operator">:</span> topic<span class="token operator">:</span> spring_test_topic<span class="token punctuation">,</span> value<span class="token operator">:</span> ordered_data1<span class="token punctuation">,</span> 发送成功回调<span class="token separator comment">---</span>
success <span class="token operator">=</span> <span class="token number">2</span>
<span class="token number">2</span>
<span class="token level info keyword">INFO</span> <span class="token number">12984</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>ad <span class="token operator">|</span> producer<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>k<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>KafkaSendResultHandler    <span class="token operator">:</span> topic<span class="token operator">:</span> spring_test_topic<span class="token punctuation">,</span> value<span class="token operator">:</span> ordered_data2<span class="token punctuation">,</span> 发送成功回调<span class="token separator comment">---</span>
<span class="token level info keyword">INFO</span> <span class="token number">12984</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>ionShutdownHook<span class="token punctuation">]</span> c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>k<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>KafkaProducerInterceptor  <span class="token operator">:</span> 消息发送统计<span class="token punctuation">,</span> 成功数量：<span class="token number">2</span><span class="token punctuation">,</span> 失败数量：<span class="token number">0</span><span class="token punctuation">,</span> 成功比例：<span class="token number">100.0</span><span class="token operator">%</span>
<span class="token level info keyword">INFO</span> <span class="token number">12984</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>ionShutdownHook<span class="token punctuation">]</span> c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>k<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>KafkaProducerInterceptor  <span class="token operator">:</span> 消息发送统计<span class="token punctuation">,</span> 成功数量：<span class="token number">2</span><span class="token punctuation">,</span> 失败数量：<span class="token number">0</span><span class="token punctuation">,</span> 成功比例：<span class="token number">100.0</span><span class="token operator">%</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="消费者" tabindex="-1"><a class="header-anchor" href="#消费者" aria-hidden="true">#</a> 消费者</h3><div class="custom-container tip"><p class="custom-container-title">项目搭建</p></div><p>在上面的API入门篇中创建的kafka-demo下继续创建一个Moudle <code>spring-kafka-consumer</code><br> 因为父工程已经导入了一些基本的依赖，这里我们再导入一个lombok和spring-kafka即可(其余依赖请参考本节内容的API入门篇)</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>导入配置</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8120</span>

<span class="token comment"># v1</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">Kafka</span><span class="token punctuation">:</span>
    <span class="token key atrule">bootstrap-servers</span><span class="token punctuation">:</span> 192.168.144.100<span class="token punctuation">:</span><span class="token number">9095</span><span class="token punctuation">,</span>192.168.144.100<span class="token punctuation">:</span><span class="token number">9096</span><span class="token punctuation">,</span>192.168.144.100<span class="token punctuation">:</span><span class="token number">9097</span>
    <span class="token key atrule">consumer</span><span class="token punctuation">:</span> <span class="token comment"># consumer消费者配置</span>
      <span class="token key atrule">group-id</span><span class="token punctuation">:</span> consumer<span class="token punctuation">-</span>group <span class="token comment"># 默认的消费组ID</span>
      <span class="token key atrule">enable-auto-commit</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否自动提交offset</span>
      <span class="token key atrule">auto-commit-interval</span><span class="token punctuation">:</span> <span class="token number">120000</span> <span class="token comment"># 自动提交offset时间间隔2分钟。这期间服务异常停止时，再次重启会导致重复消费</span>
      <span class="token key atrule">auto-offset-reset</span><span class="token punctuation">:</span> latest  <span class="token comment"># 指定Offset消费:earliest | latest | none</span>
      <span class="token key atrule">key-deserializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringDeserializer
      <span class="token key atrule">value-deserializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringDeserializer
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面生产者的示例已经有了一个主题<code>spring_test_topic</code> 我们直接复用<br> 创建启动类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringKafkaConsumerApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SpringKafkaConsumerApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="简单消费" tabindex="-1"><a class="header-anchor" href="#简单消费" aria-hidden="true">#</a> 简单消费</h4><ul><li>创建消费者监听器</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token comment">// com.atcode.kafka.consumer.KafkaListeners</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaListeners</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 简单消费：
     * topics：消费的主题列表
     * 接收消息的两种方式：
     * 1、记录对象
     *      ConsumerRecord<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String,</span> <span class="token attr-name">String</span><span class="token punctuation">&gt;</span></span> record
     * 2、通过注解获取
     *      @Payload String data,
     *      @Header(KafkaHeaders.RECEIVED_TOPIC) String topic,
     *      @Header(KafkaHeaders.RECEIVED_PARTITION_ID) int partition,
     *      @Header(KafkaHeaders.RECEIVED_MESSAGE_KEY) String key,
     *      @Header(KafkaHeaders.RECEIVED_TIMESTAMP) long ts
     */</span>
    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;spring_test_topic&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">simpleConsumer</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;进入simpleConsumer方法&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span>
                <span class="token string">&quot;分区 = %d, 偏移量 = %d, key = %s, 内容 = %s, 时间戳 = %d%n&quot;</span><span class="token punctuation">,</span>
                record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                record<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动消费者微服务 然后我们去之前的生产者服务中的测试类发送一个消息 查看消费者服务的输出结果</p><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code>进入simpleConsumer方法
分区 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> 偏移量 <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token boolean">null</span><span class="token punctuation">,</span> 内容 <span class="token operator">=</span> <span class="token string">&quot;hello,kafka&quot;</span><span class="token punctuation">,</span> 时间戳 <span class="token operator">=</span> <span class="token number">1700114588807</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="消费指定分区并设置起始offset" tabindex="-1"><a class="header-anchor" href="#消费指定分区并设置起始offset" aria-hidden="true">#</a> 消费指定分区并设置起始offset</h4><ul><li>消费者服务创建一个新主题</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaInitConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">NewTopic</span> <span class="token function">springTestPartitionTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">TopicBuilder</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_partition_topic&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 主题名称</span>
                <span class="token punctuation">.</span><span class="token function">partitions</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 分区数量</span>
                <span class="token punctuation">.</span><span class="token function">replicas</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 副本数量</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动消费者微服务会自动创建<code>spring_test_partition_topic</code>主题 我们创建完成之后要注意注释掉该代码 否则重新启动还会重复创建</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 消费指定分区 并给不同分区设置不同的起始offset
 *
 * <span class="token keyword">@param</span> <span class="token parameter">record</span>
 */</span>
<span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>
        topicPartitions <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@TopicPartition</span><span class="token punctuation">(</span>
                        topic <span class="token operator">=</span> <span class="token string">&quot;spring_test_partition_topic&quot;</span><span class="token punctuation">,</span>
                        <span class="token comment">// 消费分区2所有的消息</span>
                        partitions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token comment">// 指定消费的分区，并配置消费该分区的起始offset,注意partitions中配置的主题不能重复</span>
                        partitionOffsets <span class="token operator">=</span> <span class="token punctuation">{</span>
                                <span class="token comment">// 分区0 offset从3开始消费</span>
                                <span class="token annotation punctuation">@PartitionOffset</span><span class="token punctuation">(</span>
                                        partition <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
                                        initialOffset <span class="token operator">=</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span>
                                        relativeToCurrent <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span>
                                <span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token comment">// 分区3 offset从0开始消费</span>
                                <span class="token annotation punctuation">@PartitionOffset</span><span class="token punctuation">(</span>
                                        partition <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
                                        initialOffset <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
                                        relativeToCurrent <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span>
                                <span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span>
                <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        concurrency <span class="token operator">=</span> <span class="token string">&quot;3&quot;</span>
<span class="token punctuation">)</span>
<span class="token comment">// com.atcode.kafka.consumer.KafkaListeners#consumeByPartitionOffsets</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consumeByPartitionOffsets</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;consumeByPartitionOffsets&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span>
            <span class="token string">&quot;主题 = %s,分区 = %d, 偏移量 = %d, key = %s, 内容 = %s,时间戳 = %d%n&quot;</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启消费者服务<br> 下面开始测试 我们在生产者服务的测试类中创建发送消息的方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token comment">// com.atcode.kafka.producer#sendPartitionMsg</span>
<span class="token keyword">void</span> <span class="token function">sendPartitionMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_partition_topic&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;simple_data&quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;_&quot;</span> <span class="token operator">+</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code>consumeByPartitionOffsets
主题 <span class="token operator">=</span> spring_test_partition_topic<span class="token punctuation">,</span>分区 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> 偏移量 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token punctuation">,</span> 内容 <span class="token operator">=</span> <span class="token string">&quot;simple_data1_2023-11-16T14:22:39.795973700&quot;</span><span class="token punctuation">,</span>时间戳 <span class="token operator">=</span> <span class="token number">1700115759796</span>
consumeByPartitionOffsets
consumeByPartitionOffsets
主题 <span class="token operator">=</span> spring_test_partition_topic<span class="token punctuation">,</span>分区 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> 偏移量 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token punctuation">,</span> 内容 <span class="token operator">=</span> <span class="token string">&quot;simple_data2_2023-11-16T14:22:39.797462600&quot;</span><span class="token punctuation">,</span>时间戳 <span class="token operator">=</span> <span class="token number">1700115759797</span>
主题 <span class="token operator">=</span> spring_test_partition_topic<span class="token punctuation">,</span>分区 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 偏移量 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token punctuation">,</span> 内容 <span class="token operator">=</span> <span class="token string">&quot;simple_data0_2023-11-16T14:22:39.111407400&quot;</span><span class="token punctuation">,</span>时间戳 <span class="token operator">=</span> <span class="token number">1700115759769</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="手动提交offset" tabindex="-1"><a class="header-anchor" href="#手动提交offset" aria-hidden="true">#</a> 手动提交offset</h4><p>自动提交和手动提交的区别请看 <a href="/myblog/tools/kafka.md/#offset%E5%81%8F%E7%A7%BB%E9%87%8F" class="">Kafka原生API高阶篇-offset偏移量</a><br> 手动提交偏移量配置</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8120</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">Kafka</span><span class="token punctuation">:</span>
    <span class="token key atrule">bootstrap-servers</span><span class="token punctuation">:</span> 192.168.144.100<span class="token punctuation">:</span><span class="token number">9095</span><span class="token punctuation">,</span>192.168.144.100<span class="token punctuation">:</span><span class="token number">9096</span><span class="token punctuation">,</span>192.168.144.100<span class="token punctuation">:</span><span class="token number">9097</span>
    <span class="token key atrule">consumer</span><span class="token punctuation">:</span> <span class="token comment"># consumer消费者配置</span>
      <span class="token key atrule">group-id</span><span class="token punctuation">:</span> consumer<span class="token punctuation">-</span>group <span class="token comment"># 默认的消费组ID</span>
      <span class="token key atrule">enable-auto-commit</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 是否自动提交offset</span>
      <span class="token key atrule">auto-commit-interval</span><span class="token punctuation">:</span> <span class="token number">120000</span> <span class="token comment"># 自动提交offset时间间隔2分钟。这期间服务异常停止时，再次重启会导致重复消费\</span>
      <span class="token key atrule">auto-offset-reset</span><span class="token punctuation">:</span> latest  <span class="token comment"># 指定Offset消费:earliest | latest | none</span>
      <span class="token key atrule">key-deserializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringDeserializer
      <span class="token key atrule">value-deserializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringDeserializer
    <span class="token key atrule">listener</span><span class="token punctuation">:</span>
      <span class="token comment"># 监听器消费消息运行的线程数，一般为 机器数*分区数</span>
      <span class="token key atrule">concurrency</span><span class="token punctuation">:</span> <span class="token number">3</span>
      <span class="token comment"># 自动提交关闭，需要设置手动消息确认</span>
      <span class="token comment"># MANUAL: 调用Acknowledgment.acknowledge()先将offset存放到map本地缓存，在下一次poll之前从缓存拿出来批量提交</span>
      <span class="token comment"># manual_immediate: 调用Acknowledgment.acknowledge()后立即提交</span>
      <span class="token key atrule">ack-mode</span><span class="token punctuation">:</span> manual_immediate
      <span class="token comment"># 消费监听接口监听的主题不存在时，默认会报错，所以设置为false忽略错误</span>
      <span class="token key atrule">missing-topics-fatal</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token comment"># 两次poll之间的最大间隔，默认值为5分钟。如果超过这个间隔会触发reBalance</span>
      <span class="token key atrule">poll-timeout</span><span class="token punctuation">:</span> <span class="token number">600000</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>消费者服务创建主题</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">NewTopic</span> <span class="token function">springTestPartitionTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">TopicBuilder</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_ack_topic&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 主题名称</span>
            <span class="token punctuation">.</span><span class="token function">partitions</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 分区数量</span>
            <span class="token punctuation">.</span><span class="token function">replicas</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 副本数量</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>消费者代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 手动提交
 *
 * <span class="token keyword">@param</span> <span class="token parameter">record</span>
 * <span class="token keyword">@param</span> <span class="token parameter">ack</span>
 */</span>
<span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>
        topics <span class="token operator">=</span> <span class="token string">&quot;spring_test_ack_topic&quot;</span><span class="token punctuation">,</span>
        <span class="token comment">// 3个消费者</span>
        concurrency <span class="token operator">=</span> <span class="token string">&quot;3&quot;</span>
<span class="token punctuation">)</span>
<span class="token comment">// com.atcode.kafka.consumer.KafkaListeners#consumeByAck</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consumeByAck</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span> <span class="token class-name">Acknowledgment</span> ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;consumeByAck&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span>
            <span class="token string">&quot;主题 = %s,分区 = %d, 偏移量 = %d, key = %s, 内容 = %s,时间戳 = %d%n&quot;</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 手动ack</span>
    ack<span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启消费者服务<br> 生产者创建一个测试方法发送消息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">sendAckMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_ack_topic&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;offset_data&quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;_&quot;</span> <span class="token operator">+</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code>consumeByAck
主题 <span class="token operator">=</span> spring_test_ack_topic<span class="token punctuation">,</span>分区 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 偏移量 <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token punctuation">,</span> 内容 <span class="token operator">=</span> <span class="token string">&quot;offset_data1_2023-11-16T15:29:53.196342300&quot;</span><span class="token punctuation">,</span>时间戳 <span class="token operator">=</span> <span class="token number">1700119793853</span>
consumeByAck
主题 <span class="token operator">=</span> spring_test_ack_topic<span class="token punctuation">,</span>分区 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 偏移量 <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token punctuation">,</span> 内容 <span class="token operator">=</span> <span class="token string">&quot;offset_data2_2023-11-16T15:29:53.879806500&quot;</span><span class="token punctuation">,</span>时间戳 <span class="token operator">=</span> <span class="token number">1700119793880</span>
consumeByAck
主题 <span class="token operator">=</span> spring_test_ack_topic<span class="token punctuation">,</span>分区 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 偏移量 <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token punctuation">,</span> 内容 <span class="token operator">=</span> <span class="token string">&quot;offset_data3_2023-11-16T15:29:53.881569600&quot;</span><span class="token punctuation">,</span>时间戳 <span class="token operator">=</span> <span class="token number">1700119793881</span>
consumeByAck
主题 <span class="token operator">=</span> spring_test_ack_topic<span class="token punctuation">,</span>分区 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 偏移量 <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token punctuation">,</span> 内容 <span class="token operator">=</span> <span class="token string">&quot;offset_data4_2023-11-16T15:29:53.882064500&quot;</span><span class="token punctuation">,</span>时间戳 <span class="token operator">=</span> <span class="token number">1700119793882</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="消费异常处理" tabindex="-1"><a class="header-anchor" href="#消费异常处理" aria-hidden="true">#</a> 消费异常处理</h4><p>当消费者对消息消费时，如果发生了异常当然也需要处理一下异常。一般我们在<code>@KafkaListener</code>中，只是监听topic中的主题并消费，如果再try catch捕获并处理的话，则会显得代码块非常臃肿不利于维护，kafka为我们提供了专门的异常处理器<code>ConsumerAwareListenerErrorHandler</code>，通过它我们可以处理consumer在消费时发生的异常。</p><ul><li>注册异常处理器</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token comment">// com.atcode.kafka.config.CustomListenerErrorHandler</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomListenerErrorHandler</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ConsumerAwareListenerErrorHandler</span> <span class="token function">listenerErrorHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>message<span class="token punctuation">,</span> exception<span class="token punctuation">,</span> consumer<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;--- 消费时发生异常 ---&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// return new ConsumerAwareListenerErrorHandler()</span>
        <span class="token comment">// {</span>
        <span class="token comment">//     @Override</span>
        <span class="token comment">//     public Object handleError(Message&lt;?&gt; message, ListenerExecutionFailedException exception, Consumer&lt;?, ?&gt; consumer)</span>
        <span class="token comment">//     {</span>
        <span class="token comment">//         System.out.println(&quot;--- 消费时发生异常 ---&quot;);</span>
        <span class="token comment">//         return null;</span>
        <span class="token comment">//     }</span>
        <span class="token comment">// };</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们复用上面的主题<code>spring_test_ack_topic</code></p><ul><li>消费者使用异常处理器</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 消费者使用异常处理器
 *
 * <span class="token keyword">@param</span> <span class="token parameter">record</span>
 * <span class="token keyword">@param</span> <span class="token parameter">ack</span>
 */</span>
<span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>
        topics <span class="token operator">=</span> <span class="token string">&quot;spring_test_ack_topic&quot;</span><span class="token punctuation">,</span>
        concurrency <span class="token operator">=</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span>
        errorHandler <span class="token operator">=</span> <span class="token string">&quot;listenerErrorHandler&quot;</span> <span class="token comment">// 配置我们的异常处理器</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consumeByAckWithExp</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span> <span class="token class-name">Acknowledgment</span> ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;============&gt; consumeByAckWithExp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span>
            <span class="token string">&quot;主题 = %s,分区 = %d, 偏移量 = %d, key = %s, 内容 = %s,时间戳 = %d%n&quot;</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 手动ack</span>
    ack<span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用之前的测试类进行消息发送</p><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code><span class="token separator comment">============</span><span class="token operator">&gt;</span> consumeByAckWithExp
主题 <span class="token operator">=</span> spring_test_ack_topic<span class="token punctuation">,</span>分区 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 偏移量 <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token punctuation">,</span> 内容 <span class="token operator">=</span> <span class="token string">&quot;offset_data1_2023-11-16T15:39:40.988906200&quot;</span><span class="token punctuation">,</span>时间戳 <span class="token operator">=</span> <span class="token number">1700120381687</span>
<span class="token separator comment">---</span> 消费时发生异常 <span class="token separator comment">---</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="消息重试和死信队列" tabindex="-1"><a class="header-anchor" href="#消息重试和死信队列" aria-hidden="true">#</a> 消息重试和死信队列</h4><p>需求：手动ack时，如果消息消费失败，尝试重试3次，再次失败，将消息发送到死信队列避免消息丢失。<br> 注意：需要配合之前的手动提交offset才可以</p><ul><li>重新创建一个测试主题</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaInitConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">NewTopic</span> <span class="token function">springTestPartitionTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">TopicBuilder</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_retry_topic&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 主题名称</span>
                <span class="token punctuation">.</span><span class="token function">partitions</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 分区数量</span>
                <span class="token punctuation">.</span><span class="token function">replicas</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 副本数量</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>消费者代码</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * attempts:重试的最大次数
 * autoCreateTopics:指定是否自动创建重试主题和 DLT（死信主题）
 * backoff: value 重试的时间间隔
 *
 * <span class="token keyword">@param</span> <span class="token parameter">record</span>
 * <span class="token keyword">@param</span> <span class="token parameter">ack</span>
 */</span>
<span class="token annotation punctuation">@RetryableTopic</span><span class="token punctuation">(</span>
        attempts <span class="token operator">=</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span>
        backoff <span class="token operator">=</span> <span class="token annotation punctuation">@Backoff</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token number">2_000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        autoCreateTopics <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span>
<span class="token punctuation">)</span>
<span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>
        topics <span class="token operator">=</span> <span class="token string">&quot;spring_test_retry_topic&quot;</span><span class="token punctuation">,</span>
        <span class="token comment">// 3个消费者</span>
        concurrency <span class="token operator">=</span> <span class="token string">&quot;3&quot;</span>
<span class="token punctuation">)</span>
<span class="token comment">// com.atcode.kafka.consumer.KafkaListeners#consumeByRetry</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consumeByRetry</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span> <span class="token class-name">Acknowledgment</span> ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;consumeByRetry&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span>
            <span class="token string">&quot;主题 = %s,分区 = %d, 偏移量 = %d, key = %s, 内容 = %s,时间戳 = %d%n&quot;</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 手动ack</span>
    ack<span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>重启消费者 查看主题列表</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@jhw ~<span class="token punctuation">]</span><span class="token comment"># kafka-topics.sh --bootstrap-server 192.168.144.100:9095 --list</span>
__consumer_offsets
__transaction_state
hellokafka
hellokafka-topic
kafkav1
myclustertopic
second
senior
spring_test_ack_topic
spring_test_offset1_topic
spring_test_offset_topic
spring_test_partition_topic
spring_test_retry_topic <span class="token comment"># 业务队列 </span>
spring_test_retry_topic-dlt <span class="token comment"># 死信队列</span>
spring_test_retry_topic-retry-0 <span class="token comment"># 重试队列</span>
spring_test_retry_topic-retry-1 <span class="token comment"># 重试队列</span>
spring_test_topic
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>生产者服务创建发送消息的测试方法</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">sendRertyMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_retry_topic&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;retry_data&quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;_&quot;</span> <span class="token operator">+</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>查看消费者服务的控制台输出结果 消息消费重试失败后，最终到达死信队列</li></ul><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code>consumeByRetry
主题 <span class="token operator">=</span> spring_test_retry_topic<span class="token punctuation">,</span>分区 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 偏移量 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token punctuation">,</span> 内容 <span class="token operator">=</span> <span class="token string">&quot;retry_data1_2023-11-16T15:51:07.643118700&quot;</span><span class="token punctuation">,</span>时间戳 <span class="token operator">=</span> <span class="token number">1700121068311</span>
<span class="token level info keyword">INFO</span> <span class="token number">14396</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">-</span>retry<span class="token operator">-</span><span class="token number">0</span><span class="token operator">-</span><span class="token number">0</span><span class="token operator">-</span>C<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> o<span class="token punctuation">.</span>a<span class="token punctuation">.</span>k<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>KafkaConsumer     <span class="token operator">:</span> <span class="token punctuation">[</span>Consumer clientId<span class="token operator">=</span>consumer<span class="token operator">-</span>consumer<span class="token operator">-</span>group<span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> groupId<span class="token operator">=</span>consumer<span class="token operator">-</span>group<span class="token punctuation">]</span> Seeking to offset <span class="token number">0</span> for partition spring_test_retry_topic<span class="token operator">-</span>retry<span class="token operator">-</span><span class="token number">0</span><span class="token operator">-</span><span class="token number">0</span>
consumeByRetry
主题 <span class="token operator">=</span> spring_test_retry_topic<span class="token operator">-</span>retry<span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">,</span>分区 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 偏移量 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token punctuation">,</span> 内容 <span class="token operator">=</span> <span class="token string">&quot;retry_data1_2023-11-16T15:51:07.643118700&quot;</span><span class="token punctuation">,</span>时间戳 <span class="token operator">=</span> <span class="token number">1700121068947</span>
<span class="token level info keyword">INFO</span> <span class="token number">14396</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">-</span>retry<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">0</span><span class="token operator">-</span>C<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> o<span class="token punctuation">.</span>a<span class="token punctuation">.</span>k<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>KafkaConsumer     <span class="token operator">:</span> <span class="token punctuation">[</span>Consumer clientId<span class="token operator">=</span>consumer<span class="token operator">-</span>consumer<span class="token operator">-</span>group<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span> groupId<span class="token operator">=</span>consumer<span class="token operator">-</span>group<span class="token punctuation">]</span> Seeking to offset <span class="token number">0</span> for partition spring_test_retry_topic<span class="token operator">-</span>retry<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">0</span>
consumeByRetry
主题 <span class="token operator">=</span> spring_test_retry_topic<span class="token operator">-</span>retry<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>分区 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 偏移量 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token punctuation">,</span> 内容 <span class="token operator">=</span> <span class="token string">&quot;retry_data1_2023-11-16T15:51:07.643118700&quot;</span><span class="token punctuation">,</span>时间戳 <span class="token operator">=</span> <span class="token number">1700121070973</span>
<span class="token level error important">ERROR</span> <span class="token number">14396</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">-</span>retry<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">0</span><span class="token operator">-</span>C<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> k<span class="token punctuation">.</span>r<span class="token punctuation">.</span>DeadLetterPublishingRecovererFactory <span class="token operator">:</span> 
<span class="token property">Record:</span> topic <span class="token operator">=</span> spring_test_retry_topic<span class="token operator">-</span>retry<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> partition <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 
main topic <span class="token operator">=</span> spring_test_retry_topic threw an error at topic spring_test_retry_topic<span class="token operator">-</span>retry<span class="token operator">-</span><span class="token number">1</span> 
and won&#39;t be retried<span class="token punctuation">.</span> Sending to DLT with name spring_test_retry_topic<span class="token operator">-</span>dlt<span class="token punctuation">.</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>消费者消费死信队列消息</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 消费者消费死信队列消息
 * 死信队列默认名称在原队列后拼接&#39;-dlt&#39;
 *
 * <span class="token keyword">@param</span> <span class="token parameter">record</span>
 * <span class="token keyword">@param</span> <span class="token parameter">ack</span>
 */</span>
<span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>
        topics <span class="token operator">=</span> <span class="token string">&quot;spring_test_retry_topic-dlt&quot;</span><span class="token punctuation">,</span>
        <span class="token comment">// 1个消费者</span>
        concurrency <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consumeByDLT</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span> <span class="token class-name">Acknowledgment</span> ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;consumeByDLT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span>
            <span class="token string">&quot;主题 = %s,分区 = %d, 偏移量 = %d, key = %s, 内容 = %s,时间戳 = %d%n&quot;</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            record<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 手动ack</span>
    ack<span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code>consumeByDLT
主题 <span class="token operator">=</span> spring_test_retry_topic<span class="token operator">-</span>dlt<span class="token punctuation">,</span>分区 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 偏移量 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token punctuation">,</span> 内容 <span class="token operator">=</span> <span class="token string">&quot;retry_data1_2023-11-16T15:59:36.326544500&quot;</span><span class="token punctuation">,</span>时间戳 <span class="token operator">=</span> <span class="token number">1700121694011</span>
consumeByDLT
主题 <span class="token operator">=</span> spring_test_retry_topic<span class="token operator">-</span>dlt<span class="token punctuation">,</span>分区 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 偏移量 <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token punctuation">,</span> 内容 <span class="token operator">=</span> <span class="token string">&quot;retry_data1_2023-11-16T16:00:06.091459400&quot;</span><span class="token punctuation">,</span>时间戳 <span class="token operator">=</span> <span class="token number">1700121695043</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 1515398578@qq.com">wxhcoding</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/myblog/tools/docker.html" class="" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/myblog/assets/app-1lTnJ-Z-.js" defer></script>
  </body>
</html>
