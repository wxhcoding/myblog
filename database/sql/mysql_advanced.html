<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-rc.0">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/myblog/assets/img/favicon.ico"><link rel="manifest" href="/myblog/manifest.webmanifest"><meta name="theme-color" content="#3eaf7c"><title>MySQL高级 | Jhw-Blog</title><meta name="description" content="Jhw-Blog">
    <link rel="preload" href="/myblog/assets/style-cpavdnw8.css" as="style"><link rel="stylesheet" href="/myblog/assets/style-cpavdnw8.css">
    <link rel="modulepreload" href="/myblog/assets/app-1lTnJ-Z-.js"><link rel="modulepreload" href="/myblog/assets/mysql_advanced.html-M6nIRymX.js"><link rel="modulepreload" href="/myblog/assets/mysql_advanced.html-_NwIumpX.js">
    <link rel="prefetch" href="/myblog/assets/index.html-Wl1PsAI-.js" as="script"><link rel="prefetch" href="/myblog/assets/distributed-lock.html-EqBnxiPq.js" as="script"><link rel="prefetch" href="/myblog/assets/distributed-transaction.html-tL9JC4dQ.js" as="script"><link rel="prefetch" href="/myblog/assets/es6.html-ZIFOMWSy.js" as="script"><link rel="prefetch" href="/myblog/assets/headline.html-iQxNz79q.js" as="script"><link rel="prefetch" href="/myblog/assets/javaweb.html-eWdk1uNe.js" as="script"><link rel="prefetch" href="/myblog/assets/vue.html-Gu8dUKxJ.js" as="script"><link rel="prefetch" href="/myblog/assets/about.html-Mmqs-yBX.js" as="script"><link rel="prefetch" href="/myblog/assets/leetcode.html-d9qMMonP.js" as="script"><link rel="prefetch" href="/myblog/assets/project_learn.html-i6UvzIJa.js" as="script"><link rel="prefetch" href="/myblog/assets/docker.html-U-NptGUz.js" as="script"><link rel="prefetch" href="/myblog/assets/git.html-QKdD4BLW.js" as="script"><link rel="prefetch" href="/myblog/assets/kafka.html-TqyYtOJI.js" as="script"><link rel="prefetch" href="/myblog/assets/linux.html-95BIkgfo.js" as="script"><link rel="prefetch" href="/myblog/assets/maven.html-zzF1XH4C.js" as="script"><link rel="prefetch" href="/myblog/assets/node.html-7wc2oKut.js" as="script"><link rel="prefetch" href="/myblog/assets/logback.html-yhzJS4yv.js" as="script"><link rel="prefetch" href="/myblog/assets/mybatis.html-Bz52-a_8.js" as="script"><link rel="prefetch" href="/myblog/assets/java_basic.html-tP4Yo5Sj.js" as="script"><link rel="prefetch" href="/myblog/assets/juc.html-6HoHfEGd.js" as="script"><link rel="prefetch" href="/myblog/assets/jvm.html-iEXdtkqR.js" as="script"><link rel="prefetch" href="/myblog/assets/spring.html-Y9UzXRue.js" as="script"><link rel="prefetch" href="/myblog/assets/springboot.html-ygPSVqH8.js" as="script"><link rel="prefetch" href="/myblog/assets/springcloud.html-Wxl5NcN3.js" as="script"><link rel="prefetch" href="/myblog/assets/spring_mvc.html-qp9D9o3C.js" as="script"><link rel="prefetch" href="/myblog/assets/ssm.html-eXce4ppB.js" as="script"><link rel="prefetch" href="/myblog/assets/elasticsearch.html-dt57WX6m.js" as="script"><link rel="prefetch" href="/myblog/assets/redis.html-Fo1p0r9s.js" as="script"><link rel="prefetch" href="/myblog/assets/redis_basic.html-G53LLX0K.js" as="script"><link rel="prefetch" href="/myblog/assets/redis_practice.html-TPHnUGzX.js" as="script"><link rel="prefetch" href="/myblog/assets/mysql_basic.html-vOaRzrU0.js" as="script"><link rel="prefetch" href="/myblog/assets/404.html-6ekMbMKm.js" as="script"><link rel="prefetch" href="/myblog/assets/index.html-qr4Og0Rr.js" as="script"><link rel="prefetch" href="/myblog/assets/distributed-lock.html-XUub3Fym.js" as="script"><link rel="prefetch" href="/myblog/assets/distributed-transaction.html-Z6y0cTF-.js" as="script"><link rel="prefetch" href="/myblog/assets/es6.html-E3eKG72j.js" as="script"><link rel="prefetch" href="/myblog/assets/headline.html-6RamNUSU.js" as="script"><link rel="prefetch" href="/myblog/assets/javaweb.html-1TeHUZPw.js" as="script"><link rel="prefetch" href="/myblog/assets/vue.html-WUpgFl2K.js" as="script"><link rel="prefetch" href="/myblog/assets/about.html-Er1rP_zQ.js" as="script"><link rel="prefetch" href="/myblog/assets/leetcode.html-hXt3DFmj.js" as="script"><link rel="prefetch" href="/myblog/assets/project_learn.html-BA3TzwH0.js" as="script"><link rel="prefetch" href="/myblog/assets/docker.html-8CsL54Kw.js" as="script"><link rel="prefetch" href="/myblog/assets/git.html-tk22OH3D.js" as="script"><link rel="prefetch" href="/myblog/assets/kafka.html-Hm-frda-.js" as="script"><link rel="prefetch" href="/myblog/assets/linux.html-XNDiQSL9.js" as="script"><link rel="prefetch" href="/myblog/assets/maven.html-EX-RejGP.js" as="script"><link rel="prefetch" href="/myblog/assets/node.html-nWfdA14A.js" as="script"><link rel="prefetch" href="/myblog/assets/logback.html-cNyE_cya.js" as="script"><link rel="prefetch" href="/myblog/assets/mybatis.html-NP16NZEg.js" as="script"><link rel="prefetch" href="/myblog/assets/java_basic.html-VrTOuTVp.js" as="script"><link rel="prefetch" href="/myblog/assets/juc.html-sGjKk3Y1.js" as="script"><link rel="prefetch" href="/myblog/assets/jvm.html-EUA1LDC3.js" as="script"><link rel="prefetch" href="/myblog/assets/spring.html-Gh4CgLBM.js" as="script"><link rel="prefetch" href="/myblog/assets/springboot.html-_s9YqnAk.js" as="script"><link rel="prefetch" href="/myblog/assets/springcloud.html-aOLK_E_h.js" as="script"><link rel="prefetch" href="/myblog/assets/spring_mvc.html-Q6Xl-jwi.js" as="script"><link rel="prefetch" href="/myblog/assets/ssm.html-V0xUMA4v.js" as="script"><link rel="prefetch" href="/myblog/assets/elasticsearch.html-uFK4xAZE.js" as="script"><link rel="prefetch" href="/myblog/assets/redis.html-R9Tcqrr7.js" as="script"><link rel="prefetch" href="/myblog/assets/redis_basic.html-jzaBuldH.js" as="script"><link rel="prefetch" href="/myblog/assets/redis_practice.html-cnuYp868.js" as="script"><link rel="prefetch" href="/myblog/assets/mysql_basic.html-pS0iCeJf.js" as="script"><link rel="prefetch" href="/myblog/assets/404.html-KeMubcAJ.js" as="script"><link rel="prefetch" href="/myblog/assets/index-7SG8bi1h.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/myblog/" class=""><img class="logo" src="/myblog/assets/img/logo.png" alt="Jhw-Blog"><span class="site-name can-hide">Jhw-Blog</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/myblog/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="后端"><span class="title">后端</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="后端"><span class="title">后端</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Java</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/myblog/backend/java/java_basic/" class="" aria-label="Java基础"><!--[--><!--]--> Java基础 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/java/jvm/" class="" aria-label="JVM"><!--[--><!--]--> JVM <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/java/juc/" class="" aria-label="JUC"><!--[--><!--]--> JUC <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Spring Framework</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/myblog/backend/spring/spring/" class="" aria-label="Spring IOC|AOP"><!--[--><!--]--> Spring IOC|AOP <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/spring/spring_mvc/" class="" aria-label="SpringMVC"><!--[--><!--]--> SpringMVC <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/spring/ssm/" class="" aria-label="SSM"><!--[--><!--]--> SSM <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/spring/springboot/" class="" aria-label="SpringBoot"><!--[--><!--]--> SpringBoot <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/spring/springcloud/" class="" aria-label="SpringCloud"><!--[--><!--]--> SpringCloud <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>框架</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/myblog/backend/framework/mybatis/" class="" aria-label="MyBatis"><!--[--><!--]--> MyBatis <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/framework/logback/" class="" aria-label="Logback"><!--[--><!--]--> Logback <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="数据库"><span class="title">数据库</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="数据库"><span class="title">数据库</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>SQL</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/myblog/database/sql/mysql_basic/" class="" aria-label="MySQL入门"><!--[--><!--]--> MySQL入门 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/database/sql/mysql_advanced/" class="" aria-label="MySQL高级"><!--[--><!--]--> MySQL高级 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>NoSQL</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/myblog/database/nosql/redis/" class="" aria-label="Redis"><!--[--><!--]--> Redis <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/database/nosql/redis_basic/" class="" aria-label="Redis基础"><!--[--><!--]--> Redis基础 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/database/nosql/redis_practice/" class="" aria-label="Redis实战"><!--[--><!--]--> Redis实战 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/database/nosql/elasticsearch" class="" aria-label="Elasticsearch"><!--[--><!--]--> Elasticsearch <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="分布式"><span class="title">分布式</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="分布式"><span class="title">分布式</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/myblog/distributed/distributed-lock/" class="" aria-label="分布式锁"><!--[--><!--]--> 分布式锁 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/distributed/distributed-transaction/" class="" aria-label="分布式事务"><!--[--><!--]--> 分布式事务 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="工具"><span class="title">工具</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="工具"><span class="title">工具</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/myblog/tools/linux/" class="" aria-label="Linux"><!--[--><!--]--> Linux <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/tools/git/" class="" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/tools/node/" class="" aria-label="Node"><!--[--><!--]--> Node <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/tools/maven/" class="" aria-label="Maven"><!--[--><!--]--> Maven <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/tools/docker/" class="" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/tools/kafka/" class="" aria-label="Kafka"><!--[--><!--]--> Kafka <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="前端"><span class="title">前端</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="前端"><span class="title">前端</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/myblog/fronted/javaweb/" class="" aria-label="JavaWeb"><!--[--><!--]--> JavaWeb <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/fronted/es6/" class="" aria-label="ES6"><!--[--><!--]--> ES6 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/fronted/vue/" class="" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/fronted/headline/" class="" aria-label="微头条"><!--[--><!--]--> 微头条 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="杂记"><span class="title">杂记</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="杂记"><span class="title">杂记</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/myblog/note/project_learn/" class="" aria-label="笔记"><!--[--><!--]--> 笔记 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/note/leetcode/" class="" aria-label="LeetCode"><!--[--><!--]--> LeetCode <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/note/about" class="" aria-label="关于"><!--[--><!--]--> 关于 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/wxhcoding/" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/myblog/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="后端"><span class="title">后端</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="后端"><span class="title">后端</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Java</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/myblog/backend/java/java_basic/" class="" aria-label="Java基础"><!--[--><!--]--> Java基础 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/java/jvm/" class="" aria-label="JVM"><!--[--><!--]--> JVM <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/java/juc/" class="" aria-label="JUC"><!--[--><!--]--> JUC <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Spring Framework</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/myblog/backend/spring/spring/" class="" aria-label="Spring IOC|AOP"><!--[--><!--]--> Spring IOC|AOP <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/spring/spring_mvc/" class="" aria-label="SpringMVC"><!--[--><!--]--> SpringMVC <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/spring/ssm/" class="" aria-label="SSM"><!--[--><!--]--> SSM <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/spring/springboot/" class="" aria-label="SpringBoot"><!--[--><!--]--> SpringBoot <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/spring/springcloud/" class="" aria-label="SpringCloud"><!--[--><!--]--> SpringCloud <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>框架</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/myblog/backend/framework/mybatis/" class="" aria-label="MyBatis"><!--[--><!--]--> MyBatis <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/backend/framework/logback/" class="" aria-label="Logback"><!--[--><!--]--> Logback <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="数据库"><span class="title">数据库</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="数据库"><span class="title">数据库</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>SQL</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/myblog/database/sql/mysql_basic/" class="" aria-label="MySQL入门"><!--[--><!--]--> MySQL入门 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/database/sql/mysql_advanced/" class="" aria-label="MySQL高级"><!--[--><!--]--> MySQL高级 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>NoSQL</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/myblog/database/nosql/redis/" class="" aria-label="Redis"><!--[--><!--]--> Redis <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/database/nosql/redis_basic/" class="" aria-label="Redis基础"><!--[--><!--]--> Redis基础 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/database/nosql/redis_practice/" class="" aria-label="Redis实战"><!--[--><!--]--> Redis实战 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/myblog/database/nosql/elasticsearch" class="" aria-label="Elasticsearch"><!--[--><!--]--> Elasticsearch <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="分布式"><span class="title">分布式</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="分布式"><span class="title">分布式</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/myblog/distributed/distributed-lock/" class="" aria-label="分布式锁"><!--[--><!--]--> 分布式锁 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/distributed/distributed-transaction/" class="" aria-label="分布式事务"><!--[--><!--]--> 分布式事务 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="工具"><span class="title">工具</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="工具"><span class="title">工具</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/myblog/tools/linux/" class="" aria-label="Linux"><!--[--><!--]--> Linux <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/tools/git/" class="" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/tools/node/" class="" aria-label="Node"><!--[--><!--]--> Node <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/tools/maven/" class="" aria-label="Maven"><!--[--><!--]--> Maven <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/tools/docker/" class="" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/tools/kafka/" class="" aria-label="Kafka"><!--[--><!--]--> Kafka <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="前端"><span class="title">前端</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="前端"><span class="title">前端</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/myblog/fronted/javaweb/" class="" aria-label="JavaWeb"><!--[--><!--]--> JavaWeb <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/fronted/es6/" class="" aria-label="ES6"><!--[--><!--]--> ES6 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/fronted/vue/" class="" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/fronted/headline/" class="" aria-label="微头条"><!--[--><!--]--> 微头条 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="杂记"><span class="title">杂记</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="杂记"><span class="title">杂记</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/myblog/note/project_learn/" class="" aria-label="笔记"><!--[--><!--]--> 笔记 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/note/leetcode/" class="" aria-label="LeetCode"><!--[--><!--]--> LeetCode <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/myblog/note/about" class="" aria-label="关于"><!--[--><!--]--> 关于 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/wxhcoding/" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/myblog/database/sql/mysql_basic.html" class="sidebar-item sidebar-heading" aria-label="MySQL入门"><!--[--><!--]--> MySQL入门 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html" class="router-link-active router-link-exact-active router-link-active sidebar-item sidebar-heading active" aria-label="MySQL高级"><!--[--><!--]--> MySQL高级 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#docker环境搭建" class="router-link-active router-link-exact-active sidebar-item" aria-label="Docker环境搭建"><!--[--><!--]--> Docker环境搭建 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#sql执行流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="sql执行流程"><!--[--><!--]--> sql执行流程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#存储引擎" class="router-link-active router-link-exact-active sidebar-item" aria-label="存储引擎"><!--[--><!--]--> 存储引擎 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#mysql索引" class="router-link-active router-link-exact-active sidebar-item" aria-label="MySQL索引"><!--[--><!--]--> MySQL索引 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#mysql索引结构" class="router-link-active router-link-exact-active sidebar-item" aria-label="MySQL索引结构"><!--[--><!--]--> MySQL索引结构 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#mysql索引类型" class="router-link-active router-link-exact-active sidebar-item" aria-label="MySQL索引类型"><!--[--><!--]--> MySQL索引类型 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#myisam与innodb对比" class="router-link-active router-link-exact-active sidebar-item" aria-label="MyISAM与InnoDB对比"><!--[--><!--]--> MyISAM与InnoDB对比 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#mysql索引操作" class="router-link-active router-link-exact-active sidebar-item" aria-label="MySQL索引操作"><!--[--><!--]--> MySQL索引操作 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#mysql索引优化" class="router-link-active router-link-exact-active sidebar-item" aria-label="MySQL索引优化"><!--[--><!--]--> MySQL索引优化 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#性能分析-explain" class="router-link-active router-link-exact-active sidebar-item" aria-label="性能分析(EXPLAIN)"><!--[--><!--]--> 性能分析(EXPLAIN) <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#数据准备" class="router-link-active router-link-exact-active sidebar-item" aria-label="数据准备"><!--[--><!--]--> 数据准备 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#单表索引优化" class="router-link-active router-link-exact-active sidebar-item" aria-label="单表索引优化"><!--[--><!--]--> 单表索引优化 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#关联查询优化" class="router-link-active router-link-exact-active sidebar-item" aria-label="关联查询优化"><!--[--><!--]--> 关联查询优化 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#子查询优化" class="router-link-active router-link-exact-active sidebar-item" aria-label="子查询优化"><!--[--><!--]--> 子查询优化 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#排序优化" class="router-link-active router-link-exact-active sidebar-item" aria-label="排序优化"><!--[--><!--]--> 排序优化 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#分组优化" class="router-link-active router-link-exact-active sidebar-item" aria-label="分组优化"><!--[--><!--]--> 分组优化 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#覆盖索引优化" class="router-link-active router-link-exact-active sidebar-item" aria-label="覆盖索引优化"><!--[--><!--]--> 覆盖索引优化 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#其他查询优化策略" class="router-link-active router-link-exact-active sidebar-item" aria-label="其他查询优化策略"><!--[--><!--]--> 其他查询优化策略 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#mysql基础日志" class="router-link-active router-link-exact-active sidebar-item" aria-label="MySQL基础日志"><!--[--><!--]--> MySQL基础日志 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#mysql事务日志" class="router-link-active router-link-exact-active sidebar-item" aria-label="MySQL事务日志"><!--[--><!--]--> MySQL事务日志 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#redo日志" class="router-link-active router-link-exact-active sidebar-item" aria-label="redo日志"><!--[--><!--]--> redo日志 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#undo日志" class="router-link-active router-link-exact-active sidebar-item" aria-label="undo日志"><!--[--><!--]--> undo日志 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#mysql锁" class="router-link-active router-link-exact-active sidebar-item" aria-label="MySQL锁"><!--[--><!--]--> MySQL锁 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#并发事务带来的问题" class="router-link-active router-link-exact-active sidebar-item" aria-label="并发事务带来的问题"><!--[--><!--]--> 并发事务带来的问题 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#并发事务的解决方案" class="router-link-active router-link-exact-active sidebar-item" aria-label="并发事务的解决方案"><!--[--><!--]--> 并发事务的解决方案 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#并发事务访问情况说明" class="router-link-active router-link-exact-active sidebar-item" aria-label="并发事务访问情况说明"><!--[--><!--]--> 并发事务访问情况说明 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#锁的分类" class="router-link-active router-link-exact-active sidebar-item" aria-label="锁的分类"><!--[--><!--]--> 锁的分类 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#myisam表锁" class="router-link-active router-link-exact-active sidebar-item" aria-label="MyISAM表锁"><!--[--><!--]--> MyISAM表锁 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#读锁案例" class="router-link-active router-link-exact-active sidebar-item" aria-label="读锁案例"><!--[--><!--]--> 读锁案例 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#写锁案例" class="router-link-active router-link-exact-active sidebar-item" aria-label="写锁案例"><!--[--><!--]--> 写锁案例 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#结论" class="router-link-active router-link-exact-active sidebar-item" aria-label="结论"><!--[--><!--]--> 结论 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#innodb行锁" class="router-link-active router-link-exact-active sidebar-item" aria-label="InnoDB行锁"><!--[--><!--]--> InnoDB行锁 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#行锁基本演示" class="router-link-active router-link-exact-active sidebar-item" aria-label="行锁基本演示"><!--[--><!--]--> 行锁基本演示 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#无索引行锁升级为表锁" class="router-link-active router-link-exact-active sidebar-item" aria-label="无索引行锁升级为表锁"><!--[--><!--]--> 无索引行锁升级为表锁 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#间隙锁危害" class="router-link-active router-link-exact-active sidebar-item" aria-label="间隙锁危害"><!--[--><!--]--> 间隙锁危害 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#innodb行锁争用情况" class="router-link-active router-link-exact-active sidebar-item" aria-label="InnoDB行锁争用情况"><!--[--><!--]--> InnoDB行锁争用情况 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#总结" class="router-link-active router-link-exact-active sidebar-item" aria-label="总结"><!--[--><!--]--> 总结 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#mysql中的mvcc" class="router-link-active router-link-exact-active sidebar-item" aria-label="MySQL中的MVCC"><!--[--><!--]--> MySQL中的MVCC <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#快照读和当前读" class="router-link-active router-link-exact-active sidebar-item" aria-label="快照读和当前读"><!--[--><!--]--> 快照读和当前读 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#隐藏字段以及undo-log版本链" class="router-link-active router-link-exact-active sidebar-item" aria-label="隐藏字段以及Undo Log版本链"><!--[--><!--]--> 隐藏字段以及Undo Log版本链 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#mvcc之readview" class="router-link-active router-link-exact-active sidebar-item" aria-label="MVCC之ReadView"><!--[--><!--]--> MVCC之ReadView <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#高性能架构" class="router-link-active router-link-exact-active sidebar-item" aria-label="高性能架构"><!--[--><!--]--> 高性能架构 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#mysql主从同步" class="router-link-active router-link-exact-active sidebar-item" aria-label="MySQL主从同步"><!--[--><!--]--> MySQL主从同步 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#shardingsphere-jdbc读写分离" class="router-link-active router-link-exact-active sidebar-item" aria-label="ShardingSphere-JDBC读写分离"><!--[--><!--]--> ShardingSphere-JDBC读写分离 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#shardingsphere-jdbc垂直分片" class="router-link-active router-link-exact-active sidebar-item" aria-label="ShardingSphere-JDBC垂直分片"><!--[--><!--]--> ShardingSphere-JDBC垂直分片 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#shardingsphere-jdbc水平分片" class="router-link-active router-link-exact-active sidebar-item" aria-label="ShardingSphere-JDBC水平分片"><!--[--><!--]--> ShardingSphere-JDBC水平分片 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a href="/myblog/database/nosql/redis.html" class="sidebar-item sidebar-heading" aria-label="Redis"><!--[--><!--]--> Redis <!--[--><!--]--></a><!----></li><li><a href="/myblog/database/nosql/redis_basic.html" class="sidebar-item sidebar-heading" aria-label="Redis基础"><!--[--><!--]--> Redis基础 <!--[--><!--]--></a><!----></li><li><a href="/myblog/database/nosql/redis_practice.html" class="sidebar-item sidebar-heading" aria-label="Redis实战"><!--[--><!--]--> Redis实战 <!--[--><!--]--></a><!----></li><li><a href="/myblog/database/nosql/elasticsearch.html" class="sidebar-item sidebar-heading" aria-label="Elasticsearch"><!--[--><!--]--> Elasticsearch <!--[--><!--]--></a><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="mysql高级" tabindex="-1"><a class="header-anchor" href="#mysql高级" aria-hidden="true">#</a> MySQL高级</h1><h2 id="docker环境搭建" tabindex="-1"><a class="header-anchor" href="#docker环境搭建" aria-hidden="true">#</a> Docker环境搭建</h2><blockquote><p>先在docker上创建一个包含MySQL的容器供我们使用，这里使用的版本的是8.0.29 若没有此镜像会在仓库中自动进行下载</p></blockquote><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-p</span> <span class="token number">3309</span>:3306 <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> mysql8_conf:/etc/mysql/conf.d <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> mysql8_data:/var/lib/mysql <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span>root <span class="token punctuation">\</span>
<span class="token parameter variable">--name</span> mysql8 <span class="token punctuation">\</span>
<span class="token parameter variable">--restart</span><span class="token operator">=</span>always <span class="token punctuation">\</span>
mysql:8.0.29
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container warning"><p class="custom-container-title">注意</p><ul><li>若远程连接出现问题<code>错误号码 2058</code> 出现这个原因是MySQL 8 之前的版本中加密规则是<strong>mysql_native_password</strong>，而在MySQL 8之后，加密规则是<strong>caching_sha2_password</strong></li><li>不过我们一般使用的新版本的SQLyog和Navicat不会出现此问题 若出现此问题可以把MySQL用户登录密码加密规则还原成<code>mysql_native_password</code></li><li>但是如果使用idea去连接这个数据库 则必须更改密码加密规则 否则会报错<code>Caused by: com.mysql.cj.exceptions.UnableToConnectException: Public Key Retrieval is not allowed</code></li></ul><hr><ul><li>如果远程连接出现问题 出现错误代码 10060之类的错误或者idea启动程序 出现 communications failure</li><li>可以尝试重启一下虚拟机上的docker(<code>systemctl restart docker</code>) 然后再开启我们的容器(<code>docker start 容器ID或者容器名</code>)</li></ul></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">#进入容器：env LANG=C.UTF-8 避免容器中显示中文乱码</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> mysql8 <span class="token function">env</span> <span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>C.UTF-8 /bin/bash

<span class="token comment">#进入容器内的mysql命令行</span>
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span>

<span class="token comment">#修改默认密码校验方式</span>
ALTER <span class="token environment constant">USER</span> <span class="token string">&#39;root&#39;</span>@<span class="token string">&#39;%&#39;</span> IDENTIFIED WITH mysql_native_password BY <span class="token string">&#39;root&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">字符集</p></div><blockquote><p>MySQL 8版本之前，默认字符集为 <strong>latin1</strong>（ISO-8859-1） ，不支持中文，使用前必须设置字符集为utf8（utf8mb3）或utf8mb4。<br> 从MySQL 8开始，数据库的默认字符集为 utf8mb4 ，从而避免中文乱码的问题<br> utf8 字符集表示一个字符需要使用1～4个字节，但是我们常用的一些字符使用1～3个字节就可以表示了。而字符集表示一个字符所用的最大字节长度，在某些方面会影响系统的存储和性能，所以设计MySQL的设计者偷偷的定义了两个概念：</p></blockquote><p><strong>utf8mb3</strong> ：utf8mb3 阉割过的 utf8 字符集，只使用1～3个字节表示字符（无法存储emoji表情）。<br><strong>utf8mb4</strong>：utf8mb4正宗的 utf8 字符集，使用1～4个字节表示字符。</p><blockquote><p><strong>注意</strong>：MySQL5.7中的utf8是utf8mb3字符集 , MySQL8.0中的utf8是utf8mb4字符集</p></blockquote><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 查看MySQL使用的字符集</span>
<span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">&#39;%char%&#39;</span><span class="token punctuation">;</span>

<span class="token operator">+</span><span class="token comment">--------------------------+--------------------------------+</span>
<span class="token operator">|</span> Variable_name            <span class="token operator">|</span> <span class="token keyword">Value</span>                          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------------+--------------------------------+</span>
<span class="token operator">|</span> character_set_client     <span class="token operator">|</span> utf8mb4                        <span class="token operator">|</span>
<span class="token operator">|</span> character_set_connection <span class="token operator">|</span> utf8mb4                        <span class="token operator">|</span>
<span class="token operator">|</span> character_set_database   <span class="token operator">|</span> utf8mb4                        <span class="token operator">|</span>
<span class="token operator">|</span> character_set_filesystem <span class="token operator">|</span> <span class="token keyword">binary</span>                         <span class="token operator">|</span>
<span class="token operator">|</span> character_set_results    <span class="token operator">|</span> utf8mb4                        <span class="token operator">|</span>
<span class="token operator">|</span> character_set_server     <span class="token operator">|</span> utf8mb4                        <span class="token operator">|</span>
<span class="token operator">|</span> character_set_system     <span class="token operator">|</span> utf8mb3                        <span class="token operator">|</span>
<span class="token operator">|</span> character_sets_dir       <span class="token operator">|</span> <span class="token operator">/</span>usr<span class="token operator">/</span><span class="token keyword">share</span><span class="token operator">/</span>mysql<span class="token operator">-</span><span class="token number">8.0</span><span class="token operator">/</span>charsets<span class="token operator">/</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------------+--------------------------------+</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">更改字符集</p></div><p>具体步骤：</p><ol><li>编辑MySQL配置文件：打开MySQL的配置文件，通常是my.cnf（Linux）或my.ini（Windows）。可以使用文本编辑器打开该文件。</li><li>定位到[mysqld]部分：在配置文件中找到 [mysqld] 部分，这是MySQL服务器的配置部分。</li><li>添加字符集设置：在 [mysqld] 部分添加以下两行配置，用于设置默认字符集为UTF-8：</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
character-set-server<span class="token operator">=</span>utf8
collation-server<span class="token operator">=</span>utf8_general_ci
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这将设置MySQL服务器的默认字符集为UTF-8，并使用utf8_general_ci作为默认的排序规则。 4. 保存并关闭配置文件：保存对配置文件的修改，并关闭文本编辑器。 5. 重启MySQL服务：重启MySQL服务，以使配置更改生效。</p><div class="custom-container tip"><p class="custom-container-title">sql_mode</p><p>sql_mode是MySQL中的一个系统变量，用于控制MySQL服务器在执行SQL语句时的行为和规则。<strong>它定义了MySQL对于SQL语句的语法、数据校验和处理方式的严格程度。</strong></p><p>常见的是下面这个:<br><code>ONLY_FULL_GROUP_BY</code>: 要求GROUP BY子句中的列必须出现在SELECT列表中，或者是聚合函数的参数，否则会抛出错误。</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 测试用例</span>
<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> testdb<span class="token punctuation">;</span>
<span class="token keyword">USE</span> testdb<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> employee<span class="token punctuation">(</span>id <span class="token keyword">INT</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>age <span class="token keyword">INT</span><span class="token punctuation">,</span>dept <span class="token keyword">INT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> employee <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&#39;zhang3&#39;</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> employee <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&#39;li4&#39;</span><span class="token punctuation">,</span><span class="token number">34</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> employee <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&#39;wang5&#39;</span><span class="token punctuation">,</span><span class="token number">34</span><span class="token punctuation">,</span><span class="token number">102</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> employee <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">&#39;zhao6&#39;</span><span class="token punctuation">,</span><span class="token number">34</span><span class="token punctuation">,</span><span class="token number">102</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> employee <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">&#39;tian7&#39;</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">,</span><span class="token number">102</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employee<span class="token punctuation">;</span>

<span class="token comment">-- 查询每个部门中年龄最大的人(错误)</span>
<span class="token keyword">SELECT</span> dept<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token function">MAX</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span> max_age
<span class="token keyword">FROM</span> employee
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> dept<span class="token punctuation">;</span>

<span class="token comment">-- &gt; 1055 - Expression #2 of SELECT list is not in GROUP BY clause and contains nonaggregated column &#39;testdb.employee.name&#39; </span>
<span class="token comment">-- which is not functionally dependent on columns in GROUP BY clause; this is incompatible with sql_mode=only_full_group_by</span>

<span class="token comment">-- 使用 GROUP BY 时 查询的字段只能是 GROUP BY 后面跟着的字段和函数 </span>
<span class="token comment">-- 否则会报错only_full_group_by 这是sql_mode在起作用</span>

<span class="token comment">-- 查询每个部门中年龄最大的人(正确)</span>
<span class="token keyword">SELECT</span>
	e<span class="token punctuation">.</span>dept<span class="token punctuation">,</span>
	e<span class="token punctuation">.</span>NAME<span class="token punctuation">,</span>
	b<span class="token punctuation">.</span>max_age 
<span class="token keyword">FROM</span>
	employee e
	<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span> <span class="token keyword">SELECT</span> dept<span class="token punctuation">,</span> <span class="token function">MAX</span><span class="token punctuation">(</span> age <span class="token punctuation">)</span> max_age <span class="token keyword">FROM</span> employee <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> dept <span class="token punctuation">)</span> b <span class="token keyword">ON</span> e<span class="token punctuation">.</span>dept <span class="token operator">=</span> b<span class="token punctuation">.</span>dept 
	<span class="token operator">AND</span> e<span class="token punctuation">.</span>age <span class="token operator">=</span> b<span class="token punctuation">.</span>max_age<span class="token punctuation">;</span>

<span class="token operator">+</span><span class="token comment">------+-------+---------+</span>
<span class="token operator">|</span> dept <span class="token operator">|</span> NAME  <span class="token operator">|</span> max_age <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+-------+---------+</span>
<span class="token operator">|</span>  <span class="token number">101</span> <span class="token operator">|</span> li4   <span class="token operator">|</span>      <span class="token number">34</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">102</span> <span class="token operator">|</span> tian7 <span class="token operator">|</span>      <span class="token number">36</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+-------+---------+</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="sql执行流程" tabindex="-1"><a class="header-anchor" href="#sql执行流程" aria-hidden="true">#</a> sql执行流程</h2><p><strong>首先</strong>，MySQL客户端通过协议与MySQL服务器建连接，通过SQL接口发送SQL语句，先检查查询缓存，如果命中，直接返回结果，(在mysql8中已经废除了缓存的功能，所以查询缓存只在之前的sql版本生效)否则进行语句解析。也就是说，在解析查询之前，服务器会先访问查询缓存，如果某个查询结果已经位于缓存中，服务器就不会再对查询进行解析、优化、以及执行。</p><p>它仅仅将缓存中的结果返回给用户即可，这将大大提高系统的性能。</p><p><strong>接下来是解析过程</strong>，MySQL解析器通过关键字将SQL语句进行解析，并生成一棵对应的解析树，解析器使用MySQL语法规则验证和解析SQL语句。</p><p>例如，它将验证是否使用了错误的关键字，或者使用关键字的顺序是否正确，引号能否前后匹配等；预处理器则根据MySQL规则进一步检查解析树是否合法，例如，这里将检查数据表和数据列是否存在，还会解析名字和别名，看是否有歧义等，并生成一棵新解析树，新解析树可能和旧解析树结构一致。</p><p><strong>然后是优化过程</strong>，MySQL优化程序会对我们的语句做一些优化，将查询的IO成本和CPU成本降到最低(<strong>在不影响结果的前提下调整sql的顺序</strong>)。优化的结果就是生成一个<strong>执行计划</strong>。这个执行计划表明了应该使用哪些索引执行查询，以及表之间的连接顺序是啥样，必要时将子查询转换为连接、表达式简化等等。我们可以使用<strong>EXPLAIN</strong>语句来查看某个语句的执行计划。</p><p><strong>最后</strong>，进入执行阶段。完成查询优化后，查询执行引擎会按照生成的执行计划调用存储引擎提供的接口执行SQL查询并将结果返回给客户端。在MySQL8以下的版本，如果设置了查询缓存，这时会将查询结果进行缓存，再返回给客户端。</p><div class="custom-container tip"><p class="custom-container-title">开启profiling(这里以mysql8为例)</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 确认 profiling 是否开启</span>
<span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">&#39;%profiling%&#39;</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------------------------+-------+</span>
<span class="token operator">|</span> Variable_name          <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------+-------+</span>
<span class="token operator">|</span> have_profiling         <span class="token operator">|</span> YES   <span class="token operator">|</span>
<span class="token operator">|</span> profiling              <span class="token operator">|</span> <span class="token keyword">OFF</span>   <span class="token operator">|</span>
<span class="token operator">|</span> profiling_history_size <span class="token operator">|</span> <span class="token number">15</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------+-------+</span>

<span class="token comment">-- profiling=0 代表关闭，我们需要把 profiling 打开，即设置为 1</span>
<span class="token comment">-- 这里的set 默认只对当前会话生效 会话关闭则失效</span>
<span class="token keyword">SET</span> profiling <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">-- 再次查看</span>
<span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">&#39;%profiling%&#39;</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------------------------+-------+</span>
<span class="token operator">|</span> Variable_name          <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------+-------+</span>
<span class="token operator">|</span> have_profiling         <span class="token operator">|</span> YES   <span class="token operator">|</span>
<span class="token operator">|</span> profiling              <span class="token operator">|</span> <span class="token keyword">ON</span>    <span class="token operator">|</span>
<span class="token operator">|</span> profiling_history_size <span class="token operator">|</span> <span class="token number">15</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------+-------+</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">显示查询</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 执行任意的sql查询语句</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employee<span class="token punctuation">;</span> 
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employee <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> 

<span class="token comment">-- 显示最近的几次查询</span>
<span class="token keyword">SHOW</span> PROFILES<span class="token punctuation">;</span>

<span class="token operator">+</span><span class="token comment">----------+------------+-------------------------------------+</span>
<span class="token operator">|</span> Query_ID <span class="token operator">|</span> Duration   <span class="token operator">|</span> Query                               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+------------+-------------------------------------+</span>
<span class="token operator">|</span>        <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">0.00162600</span> <span class="token operator">|</span> <span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">&#39;%profiling%&#39;</span>   <span class="token operator">|</span>
<span class="token operator">|</span>        <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">0.00033850</span> <span class="token operator">|</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employee              <span class="token operator">|</span>
<span class="token operator">|</span>        <span class="token number">3</span> <span class="token operator">|</span> <span class="token number">0.00049200</span> <span class="token operator">|</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employee <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+------------+-------------------------------------+</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">查看执行流程</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 查看最后一个的sql执行流程</span>
<span class="token keyword">SHOW</span> PROFILE<span class="token punctuation">;</span>

<span class="token operator">+</span><span class="token comment">--------------------------------+----------+</span>
<span class="token operator">|</span> <span class="token keyword">Status</span>                         <span class="token operator">|</span> Duration <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------------------+----------+</span>
<span class="token comment">-- 事务开始</span>
<span class="token operator">|</span> <span class="token keyword">starting</span>                       <span class="token operator">|</span> <span class="token number">0.000187</span> <span class="token operator">|</span>
<span class="token comment">-- 在事务期间执行钩子函数</span>
<span class="token operator">|</span> Executing hook <span class="token keyword">on</span> <span class="token keyword">transaction</span>  <span class="token operator">|</span> <span class="token number">0.000013</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token keyword">starting</span>                       <span class="token operator">|</span> <span class="token number">0.000013</span> <span class="token operator">|</span>
<span class="token comment">-- 检查权限 确保用户有权执行相应操作</span>
<span class="token operator">|</span> checking permissions           <span class="token operator">|</span> <span class="token number">0.000011</span> <span class="token operator">|</span>
<span class="token comment">-- 打开相关数据表</span>
<span class="token operator">|</span> Opening <span class="token keyword">tables</span>                 <span class="token operator">|</span> <span class="token number">0.000050</span> <span class="token operator">|</span>
<span class="token comment">-- 初始化操作</span>
<span class="token operator">|</span> init                           <span class="token operator">|</span> <span class="token number">0.000009</span> <span class="token operator">|</span>
<span class="token comment">-- 获取系统级别的锁定</span>
<span class="token operator">|</span> System <span class="token keyword">lock</span>                    <span class="token operator">|</span> <span class="token number">0.000014</span> <span class="token operator">|</span>
<span class="token comment">-- 优化查询条件</span>
<span class="token operator">|</span> optimizing                     <span class="token operator">|</span> <span class="token number">0.000016</span> <span class="token operator">|</span>
<span class="token comment">-- 收集统计信息</span>
<span class="token operator">|</span> <span class="token keyword">statistics</span>                     <span class="token operator">|</span> <span class="token number">0.000024</span> <span class="token operator">|</span>
<span class="token comment">-- 准备执行查询</span>
<span class="token operator">|</span> preparing                      <span class="token operator">|</span> <span class="token number">0.000026</span> <span class="token operator">|</span>
<span class="token comment">-- 执行查询</span>
<span class="token operator">|</span> executing                      <span class="token operator">|</span> <span class="token number">0.000057</span> <span class="token operator">|</span>
<span class="token comment">-- 事务结束</span>
<span class="token operator">|</span> <span class="token keyword">end</span>                            <span class="token operator">|</span> <span class="token number">0.000008</span> <span class="token operator">|</span>
<span class="token comment">-- 查询结束</span>
<span class="token operator">|</span> query <span class="token keyword">end</span>                      <span class="token operator">|</span> <span class="token number">0.000007</span> <span class="token operator">|</span>
<span class="token comment">-- 等待处理程序提交</span>
<span class="token operator">|</span> waiting <span class="token keyword">for</span> <span class="token keyword">handler</span> <span class="token keyword">commit</span>     <span class="token operator">|</span> <span class="token number">0.000013</span> <span class="token operator">|</span>
<span class="token comment">-- 关闭数据表</span>
<span class="token operator">|</span> closing <span class="token keyword">tables</span>                 <span class="token operator">|</span> <span class="token number">0.000010</span> <span class="token operator">|</span>
<span class="token comment">-- 释放资源</span>
<span class="token operator">|</span> freeing items                  <span class="token operator">|</span> <span class="token number">0.000019</span> <span class="token operator">|</span>
<span class="token comment">-- 清理操作</span>
<span class="token operator">|</span> cleaning up                    <span class="token operator">|</span> <span class="token number">0.000018</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------------------+----------+</span>

<span class="token comment">-- 查看指定SQL的执行流程：查询指定的 Query ID</span>
<span class="token keyword">SHOW</span> PROFILE <span class="token keyword">FOR</span> QUERY <span class="token number">3</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="存储引擎" tabindex="-1"><a class="header-anchor" href="#存储引擎" aria-hidden="true">#</a> 存储引擎</h2><blockquote><p>存储引擎层(Storage Engines)，负责<strong>MySQL中数据的存储和提取</strong>，对物理服务器级别维护的底层数据执行操作，服务器通过API与存储引擎进行通信</p></blockquote><div class="custom-container tip"><p class="custom-container-title">MyISAM和InnoDB的对比(只关注前四项即可)</p></div><table><thead><tr><th>对比项</th><th>MyISAM</th><th>InnoDB</th></tr></thead><tbody><tr><td>外键</td><td>不支持</td><td>支持</td></tr><tr><td>事务</td><td>不支持</td><td>支持</td></tr><tr><td>行表锁</td><td>表锁，即使操作一条记录也会锁住整个表，不适合高并发的操作</td><td>行锁，操作时只锁某一行，不对其它行有影响，适合高并发的操作。和表锁！</td></tr><tr><td>缓存</td><td>只缓存索引，不缓存真实数据</td><td>不仅缓存索引还要缓存真实数据，对内存要求较高，而且内存大小对性能有决定性的影响。支持聚簇索引</td></tr><tr><td>关注点</td><td>并发查询，节省资源、消耗少、简单业务</td><td>并发写、事务、更大更复杂的资源操作</td></tr><tr><td>默认使用</td><td>N</td><td>Y</td></tr><tr><td>自带系统表使用</td><td>Y</td><td>N</td></tr></tbody></table><h2 id="mysql索引" tabindex="-1"><a class="header-anchor" href="#mysql索引" aria-hidden="true">#</a> MySQL索引</h2><h3 id="mysql索引结构" tabindex="-1"><a class="header-anchor" href="#mysql索引结构" aria-hidden="true">#</a> MySQL索引结构</h3><blockquote><p>索引（index）是帮助MySQL高效获取数据的<strong>数据结构</strong>（有序）<br> 索引结构是指在数据库中用于<strong>组织和管理索引的数据结构</strong>。索引结构的设计和实现对于数据库的性能和效率具有重要影响</p></blockquote><div class="custom-container tip"><p class="custom-container-title">优点和缺点</p></div><p>优势</p><ul><li>类似于书籍的目录索引，提高数据检索的效率，降低数据库的IO成本</li><li>通过索引列对数据进行排序，降低数据排序的成本，降低CPU的消耗</li></ul><p>劣势</p><ul><li>实际上索引也是一张表，该表中保存了主键与索引字段，并指向实体类的记录，所以<strong>索引列也是要占用空间</strong>的</li><li>虽然索引大大提高了查询效率，同时却也<strong>降低更新表的速度</strong>，如对表进行INSERT、UPDATE、DELETE。因为更新表时，MySQL 不仅要保存数据，还要保存一下索引文件每次更新添加了索引列的字段，都会调整因为更新所带来的键值变化后的索引信息</li></ul><div class="custom-container tip"><p class="custom-container-title">B-tree</p></div><p>B-tree又叫<strong>多路平衡搜索树</strong>，一颗m叉的B-tree特性如下：</p><ol><li>树中每个节点最多包含m个子节点。</li><li>除根节点与叶子节点外，每个节点至少有[ceil(m/2)]个孩子。</li><li>若根节点不是叶子节点，则至少有两个孩子。</li><li>所有的叶子节点都在同一层。</li><li>每个非叶子节点由n个key与n+1个指针组成，其中[ceil(m/2)-1] &lt;= n &lt;= m-1</li></ol><hr><ul><li>B树中的非叶子结点中包含的数据有: 创建索引的数值、指向数据的指针、完整的数据</li><li>叶子结点中没有了指向数据的指针</li><li>因为B树的结点中包含完整的数据 所以在读取数据的时候需要较大的内存支持读入数据 如果比较的次数较多则需要多次的IO操作</li><li>而如果我们换为B+树 B+树中只有叶子结点才有完整的数据 所以一次可以读入较多的数据 以为非叶子结点没有完整的数据 这样会提高命中率 所以MySQL使用的是B+树的索引结构</li></ul><div class="custom-container tip"><p class="custom-container-title">索引结构-B+tree</p></div><ul><li>B+树中非叶子结点中包含的数据: 创建索引的数值、指向数据的指针</li><li>叶子结点中包含完整的数据 并且可以正向和反向按顺序遍历</li><li>B+树的构建: <ul><li>首先是叶子结点 等到达一定的数据之后 会把每页中的数据的最小值和当前的页码值提取出来放到上一层</li><li>也就是非叶子结点只会保存索引和指向下一个数据的指针 不会保存完整数据(这也是MySQL选择B+树作为索引结构的主要原因 因为没有完整数据所以占用空间更小 每次取出来的数据就会更多 命中率就会更高一些)</li></ul></li></ul><hr><ul><li>B树和B+树的对比</li></ul><ol><li>B+树中非叶子节点仅用于索引，不保存数据记录，跟记录有关的信息都放在叶子节点中。而B树中， 非叶子节点既保存索引，也保存数据记录</li><li>B+树中所有关键字[<strong>主键</strong>]都在叶子节点出现，叶子节点构成一个有序链表，而且叶子节点本身按照关键字的大小从小到大顺序链接</li><li>B+树中非叶子节点的关键字也会同时存在于子节点中，并且是在子节点中所有关键字的最小值</li></ol><h3 id="mysql索引类型" tabindex="-1"><a class="header-anchor" href="#mysql索引类型" aria-hidden="true">#</a> MySQL索引类型</h3><div class="custom-container tip"><p class="custom-container-title">聚簇索引</p></div><blockquote><p>一张表只有一个聚簇索引(也就是主键索引) 由MySQL自动创建</p></blockquote><ul><li>特点: <ul><li>使用记录主键值的大小进行记录和页的排序 <ul><li>页内的记录是按照主键的大小顺序排成一个单向链表</li><li>各个存放用户记录的页 也是根据页中用户记录的主键大小顺序排成一个双向链表</li><li>存放目录项记录的页分为不同的层次 在同一层次中的页也是根据页中目录项记录的主键大小顺序排成一个双向链表</li></ul></li><li>B+树的<strong>叶子节点存储的是完整的用户记录</strong>【所谓完整的用户记录，就是指这个记录中存储了所有列的值（包括隐藏列）】</li></ul></li><li>优点: <ul><li>数据访问快 因为索引和数据都在同一个B+树中</li><li>对于主键的 排序查找和范围查找 速度非常快</li><li>查询一定范围数据的时候 由于数据都是紧密相连的 数据库不用从多个数据块中提取数据 所以节省了大量的io操作</li></ul></li><li>缺点: <ul><li><strong>插入速度严重依赖于插入顺序</strong> 按照主键的顺序插入是最快的方式 否则将会出现页分裂 严重影响性能 因此对于InnoDB表 我们一般都会定义一个<strong>自增的ID列</strong>为主键</li><li><strong>更新主键的代价很高</strong> 因为将会导致被更新的行移动 因此对于InnoDB表 我们一般定义<strong>主键为不可更新</strong></li></ul></li><li>限制: <ul><li>只有InnoDB引擎支持聚簇索引 <strong>MyISAM不支持聚簇索引</strong></li><li>由于数据的物理存储排序方式只能有一种 所以<strong>每个MySQL的表只能有一个聚簇索引</strong></li><li>如果没有为表定义主键 InnoDB会选择<strong>非空且唯一索引列代替</strong> 如果没有这样的列 InnoDB会<strong>隐式的定义一个主键</strong>作为聚簇索引</li><li>为了充分利用聚簇索引的聚簇特性 InnoDB中<strong>表的主键应选择有序的id</strong> 不建议使用无序的id 比如UUID、MD5、HASH、字符串作为主键 无法保证数据的顺序增长</li></ul></li></ul><div class="custom-container tip"><p class="custom-container-title">非聚簇索引</p></div><blockquote><p>非聚簇索引常常也被称之为：二级索引、辅助索引。<br> 聚簇索引，只能在搜索条件是<strong>主键值</strong>时才发挥作用，因为B+树中的数据都是按照主键进行排序的，如果我们想以别的列作为搜索条件，那么需要创建非聚簇索引。</p></blockquote><ul><li>与聚簇索引的不同: <ul><li>叶子结点存储的并不是完整的用户记录 而只是非聚簇索引的值和主键值 这两个列的值</li><li>其余的和聚簇索引一致 页内是按索引值大小排列的单项链表 页与页之间是按索引值大小排列的双向链表 非叶子结点存储的是索引值和所在的页号</li><li>所以使用非聚簇索引进行查找时还需要使用聚簇索引 再去查询完整的数据 也就是需要<strong>回表查询</strong></li><li>一张表的聚簇索引只能有一个 而非聚簇索引可以有多个</li></ul></li></ul><div class="custom-container tip"><p class="custom-container-title">联合索引</p></div><blockquote><p>针对 多个非主键字段 创建索引</p></blockquote><div class="custom-container tip"><p class="custom-container-title">覆盖索引</p></div><blockquote><p>如果能通过读取索引就可以得到想要的数据，那就不需要读取用户记录，或者不用再做回表操作了。<strong>一个索引包含了满足查询结果的所有数据</strong>就叫做覆盖索引</p></blockquote><h3 id="myisam与innodb对比" tabindex="-1"><a class="header-anchor" href="#myisam与innodb对比" aria-hidden="true">#</a> MyISAM与InnoDB对比</h3><ul><li>InnoDB的数据和索引在同一个文件 而MyISAM的在不同文件</li><li>InnoDB中主键索引是聚簇索引，叶子节点中存储完整的数据记录；其他索引是非聚簇索引，存储相应记录主键的值</li><li>InnoDB要求表必须有主键 （ MyISAM可以没有 ）。如果没有显式指定，则MySQL系统会自动选择一个可以<strong>非空且唯一</strong>标识数据记录的列作为主键。如果不存在这种列，则MySQL自动为InnoDB表生成一个隐含字段作为主键</li><li>MyISAM中无论是主键索引还是非主键索引都是非聚簇的，叶子节点记录的是数据的<strong>地址</strong></li><li>MyISAM的回表操作是十分快速的，因为是拿着地址偏移量直接到文件中取数据的，反观InnoDB是通过获取主键之后再去聚簇索引里找记录，虽然说也不慢，但还是比不上直接用地址去访问</li></ul><h3 id="mysql索引操作" tabindex="-1"><a class="header-anchor" href="#mysql索引操作" aria-hidden="true">#</a> MySQL索引操作</h3><div class="custom-container tip"><p class="custom-container-title">创建索引</p></div><ul><li>随表一起创建索引<div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> customer <span class="token punctuation">(</span>
	id <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
	customer_no <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	customer_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

	<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">-- 主键索引：列设定为主键后会自动建立索引，唯一且不能为空。</span>
	<span class="token keyword">UNIQUE</span> uk_no <span class="token punctuation">(</span>customer_no<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">-- 唯一索引：索引列值必须唯一，允许有NULL值，且NULL可能会出现多次。</span>
	<span class="token keyword">KEY</span> idx_name <span class="token punctuation">(</span>customer_name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">-- 普通索引：既不是主键，列值也不需要唯一，单纯的为了提高查询速度而创建。</span>
	<span class="token keyword">KEY</span> idx_no_name <span class="token punctuation">(</span>customer_no<span class="token punctuation">,</span> customer_name<span class="token punctuation">)</span> <span class="token comment">-- 复合索引：即一个索引包含多个列。</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>单独创建索引<div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> customer1 <span class="token punctuation">(</span>
id <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span><span class="token punctuation">,</span>
customer_no <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
customer_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 建表后创建索引</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> customer1 <span class="token keyword">ADD</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> customer1<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 主键索引</span>
<span class="token keyword">CREATE</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> uk_no <span class="token keyword">ON</span> customer1<span class="token punctuation">(</span>customer_no<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 唯一索引</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_name <span class="token keyword">ON</span> customer1<span class="token punctuation">(</span>customer_name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">-- 普通索引</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_no_name <span class="token keyword">ON</span> customer1<span class="token punctuation">(</span>customer_no<span class="token punctuation">,</span>customer_name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 复合索引</span>

<span class="token comment">-- 使用ALTER命令</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> customer1 <span class="token keyword">ADD</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 主键索引</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> customer1 <span class="token keyword">ADD</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> uk_no <span class="token punctuation">(</span>customer_no<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 唯一索引</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> customer1 <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> idx_name <span class="token punctuation">(</span>customer_name<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">-- 普通索引</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> customer1 <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> idx_no_name <span class="token punctuation">(</span>customer_no<span class="token punctuation">,</span>customer_name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">-- 复合索引</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><div class="custom-container tip"><p class="custom-container-title">查看索引</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">SHOW</span> <span class="token keyword">INDEX</span> <span class="token keyword">FROM</span> customer<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">删除索引</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_name <span class="token keyword">ON</span> customer<span class="token punctuation">;</span> <span class="token comment">-- 删除单值、唯一、复合索引</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">索引使用场景</p></div><p><strong>哪些情况适合创建索引：</strong></p><ol><li>频繁作为WHERE查询条件的字段</li><li>经常GROUP BY 和 ORDER BY的列</li><li>字段的值有唯一性的限制</li><li>DISTINCT字段需要创建索引</li><li>多表JOIN时，对连接字段创建索引</li><li>使用频繁的列，放到联合索引的左侧</li></ol><p><strong>哪些情况不要创建索引：</strong></p><ol><li>WHERE、GROUP BY 、ORDER BY里用不到的字段不创建索引</li><li>表的数据记录太少</li><li>避免对经常增删改的表创建索引</li></ol><h2 id="mysql索引优化" tabindex="-1"><a class="header-anchor" href="#mysql索引优化" aria-hidden="true">#</a> MySQL索引优化</h2><h3 id="性能分析-explain" tabindex="-1"><a class="header-anchor" href="#性能分析-explain" aria-hidden="true">#</a> 性能分析(EXPLAIN)</h3><blockquote><p>基本语法 EXPLAIN sql语句;</p></blockquote><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> employee<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>    <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> employee <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token number">5</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">数据准备</p></div><ul><li>建表</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> s1 <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    key1 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key2 <span class="token keyword">INT</span><span class="token punctuation">,</span>
    key3 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key_part1 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key_part2 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key_part3 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    common_field <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">INDEX</span> idx_key1 <span class="token punctuation">(</span>key1<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> idx_key2 <span class="token punctuation">(</span>key2<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">INDEX</span> idx_key3 <span class="token punctuation">(</span>key3<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">INDEX</span> idx_key_part<span class="token punctuation">(</span>key_part1<span class="token punctuation">,</span> key_part2<span class="token punctuation">,</span> key_part3<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> s2 <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    key1 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key2 <span class="token keyword">INT</span><span class="token punctuation">,</span>
    key3 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key_part1 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key_part2 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key_part3 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    common_field <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">INDEX</span> idx_key1 <span class="token punctuation">(</span>key1<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> idx_key2 <span class="token punctuation">(</span>key2<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">INDEX</span> idx_key3 <span class="token punctuation">(</span>key3<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">INDEX</span> idx_key_part<span class="token punctuation">(</span>key_part1<span class="token punctuation">,</span> key_part2<span class="token punctuation">,</span> key_part3<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>自定义生成随机数的函数</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 查看mysql是否允许创建函数：</span>
<span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">&#39;log_bin_trust_function_creators&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> log_bin_trust_function_creators<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> 				<span class="token comment">-- 命令开启：允许创建函数设置：（global-所有session都生效）</span>

<span class="token comment">-- 随机产生字符串</span>
<span class="token keyword">DELIMITER</span> $$  <span class="token comment">-- 将分隔符设置为&quot;$$&quot;，以便在自定义函数中使用多个语句。</span>
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> rand_string<span class="token punctuation">(</span>n <span class="token keyword">INT</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>  <span class="token comment">-- n表示的随机字符串的长度 </span>
<span class="token keyword">BEGIN</span>    
  <span class="token keyword">DECLARE</span> chars_str <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">DECLARE</span> return_str <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">WHILE</span> i <span class="token operator">&lt;</span> n <span class="token keyword">DO</span>  
    <span class="token keyword">SET</span> return_str <span class="token operator">=</span> CONCAT<span class="token punctuation">(</span>return_str<span class="token punctuation">,</span>SUBSTRING<span class="token punctuation">(</span>chars_str<span class="token punctuation">,</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">52</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
  <span class="token keyword">RETURN</span> return_str<span class="token punctuation">;</span>
<span class="token keyword">END</span> $$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>

<span class="token comment">-- 假如要删除</span>
<span class="token comment">-- drop function rand_string;</span>

<span class="token comment">-- 用于随机产生区间数字</span>
<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> rand_num <span class="token punctuation">(</span>from_num <span class="token keyword">INT</span> <span class="token punctuation">,</span>to_num <span class="token keyword">INT</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>   
 <span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>  
 <span class="token keyword">SET</span> i <span class="token operator">=</span> FLOOR<span class="token punctuation">(</span>from_num <span class="token operator">+</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>to_num <span class="token operator">-</span> from_num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">RETURN</span> i<span class="token punctuation">;</span>  
<span class="token keyword">END</span>$$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>

<span class="token comment">-- 假如要删除</span>
<span class="token comment">-- drop function rand_num;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>创建存储过程</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 创建往s1表中插入数据的存储过程</span>
<span class="token keyword">DELIMITER</span> <span class="token comment">//</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> insert_s1 <span class="token punctuation">(</span><span class="token operator">IN</span> min_num <span class="token keyword">INT</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">IN</span> max_num <span class="token keyword">INT</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">SET</span> autocommit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">REPEAT</span>
    <span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> s1 <span class="token keyword">VALUES</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>min_num <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span>
        rand_string<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>min_num <span class="token operator">+</span> <span class="token number">30</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rand_string<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rand_string<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rand_string<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rand_string<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rand_string<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    UNTIL i <span class="token operator">=</span> max_num
    <span class="token keyword">END</span> <span class="token keyword">REPEAT</span><span class="token punctuation">;</span>
    <span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token comment">//</span>
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>

<span class="token comment">-- 创建往s2表中插入数据的存储过程</span>
<span class="token keyword">DELIMITER</span> <span class="token comment">//</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> insert_s2 <span class="token punctuation">(</span><span class="token operator">IN</span> min_num <span class="token keyword">INT</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">IN</span> max_num <span class="token keyword">INT</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">SET</span> autocommit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">REPEAT</span>
    <span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> s2 <span class="token keyword">VALUES</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>min_num <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span>
        rand_string<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>min_num <span class="token operator">+</span> <span class="token number">30</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rand_string<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rand_string<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rand_string<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rand_string<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rand_string<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    UNTIL i <span class="token operator">=</span> max_num
    <span class="token keyword">END</span> <span class="token keyword">REPEAT</span><span class="token punctuation">;</span>
    <span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token comment">//</span>
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>调用存储过程</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- s1表数据添加1万条记录</span>
<span class="token keyword">CALL</span> insert_s1<span class="token punctuation">(</span><span class="token number">10001</span><span class="token punctuation">,</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- s2表数据添加1万条记录</span>
<span class="token keyword">CALL</span> insert_s2<span class="token punctuation">(</span><span class="token number">10001</span><span class="token punctuation">,</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">table</p></div><p>查询的每一行记录都对应着一个单表</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s1    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">9895</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>s1驱动表 s2被驱动表</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> s2<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s1    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">9895</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>                          <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s2    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">9895</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">join</span> buffer <span class="token punctuation">(</span><span class="token keyword">hash</span> <span class="token keyword">join</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------------------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.10</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">id</p></div><p>对于包含子查询的查询语句来说，就可能涉及多个SELECT关键字，所以在包含子查询的查询语句的执行计划中，每个SELECT关键字都会对应一个唯一的id值，比如这样：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> key1 <span class="token keyword">FROM</span> s2<span class="token punctuation">)</span> <span class="token operator">OR</span> key3 <span class="token operator">=</span> <span class="token string">&#39;a&#39;</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------+---------+------+------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>      <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------+---------+------+------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> s1    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>   <span class="token operator">|</span> idx_key3      <span class="token operator">|</span> <span class="token boolean">NULL</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">9895</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> SUBQUERY    <span class="token operator">|</span> s2    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> idx_key1      <span class="token operator">|</span> idx_key1 <span class="token operator">|</span> <span class="token number">303</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">9895</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------+---------+------+------+----------+-------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.03</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>s1表在外层查询中，外层查询有一个独立的 SELECT 关键字，所以第一条记录的 id值就是1，s2表在子查询中，子查询有一个独立的SELECT 关键字，所以第二条记录的 id 值就是2<br> 但是这里需要特别注意，查询优化器可能对涉及子查询的查询语句进行重写，从而转换为连接查询。<br> 所以如果我们想知道查询优化器对某个包含子查询的语句是否进行了重写，直接查看执行计划就可以，比如:</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 查询优化器可能对涉及子查询的查询语句进行重写，转变为多表查询的操作。</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> key2 <span class="token keyword">FROM</span> s2 <span class="token keyword">WHERE</span> common_field <span class="token operator">=</span> <span class="token string">&#39;a&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+--------+---------------+----------+---------+----------------+------+----------+------------------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>   <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>      <span class="token operator">|</span> key_len <span class="token operator">|</span> ref            <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                              <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+--------+---------------+----------+---------+----------------+------+----------+------------------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s1    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>    <span class="token operator">|</span> idx_key1      <span class="token operator">|</span> <span class="token boolean">NULL</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>           <span class="token operator">|</span> <span class="token number">9895</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span>                        <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s2    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> eq_ref <span class="token operator">|</span> idx_key2      <span class="token operator">|</span> idx_key2 <span class="token operator">|</span> <span class="token number">5</span>       <span class="token operator">|</span> testdb<span class="token punctuation">.</span>s1<span class="token punctuation">.</span>key1 <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">10.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> condition<span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+--------+---------------+----------+---------+----------------+------+----------+------------------------------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token keyword">warnings</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>union</code>对两个表进行去重，这时就会有第三张临时表出现，比如：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">UNION</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s2<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+--------------+------------+------------+------+---------------+------+---------+------+------+----------+-----------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type  <span class="token operator">|</span> <span class="token keyword">table</span>      <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------------+------------+------------+------+---------------+------+---------+------+------+----------+-----------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>      <span class="token operator">|</span> s1         <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">9895</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>            <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>        <span class="token operator">|</span> s2         <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">9895</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">UNION</span> RESULT <span class="token operator">|</span> <span class="token operator">&lt;</span>union1<span class="token punctuation">,</span><span class="token number">2</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">temporary</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------------+------------+------------+------+---------------+------+---------+------+------+----------+-----------------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.11</span> sec<span class="token punctuation">)</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><div class="highlight-line"> </div><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>而<code>union all</code> 不会去重 就会只显示两张表</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">UNION</span> <span class="token keyword">ALL</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s2<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> s1    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">9895</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> s2    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">9895</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>小结：</strong></p><ul><li>id如果相同，可以认为是一组，<code>从上往下顺序执行</code></li><li>在所有组中，<code>id值越大，越先执行</code></li><li>关注点：每个id号码，表示一次独立的查询, <code>一个sql的查询趟数越少越好</code></li></ul><div class="custom-container tip"><p class="custom-container-title">select_type</p></div><blockquote><p>查询的类型，主要是用于区别普通查询、联合查询、子查询等的复杂查询</p></blockquote><ul><li>SIMPLE: 简单查询，查询中不包含子查询或者UNION</li><li>PRIMARY: 主查询，查询中若包含子查询，则最外层查询被标记为PRIMARY或者说 对于包含UNION、UNION ALL的大查询来说它是由几个小查询组成的，其中最左边的那个查询的select_type的值就是PRIMARY</li><li>UNION: 对于包含UNION或者UNION ALL的大查询来说，它是由几个小查询组成的，其中除了最左边的那个小查询以外，其余的小查询的select_type值就是UNION</li><li>UNION RESULT: UNION会对查询结果进行查询去重，MYSQL会使用临时表来完成UNION查询的去重工作，针对这个临时表的查询就是UNION RESULT</li><li>SUBQUERY: 子查询，在SELECT或WHERE列表中包含了子查询</li><li>DEPENDENT SUBQUERY: 如果包含了子查询，并且查询语句不能被优化器转换为连接查询，并且子查询是<strong>相关子查询（子查询基于外部数据列）</strong>，则子查询就是DEPENDENT SUBQUREY<div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> key1 <span class="token keyword">FROM</span> s2 <span class="token keyword">WHERE</span> s1<span class="token punctuation">.</span>key2 <span class="token operator">=</span> s2<span class="token punctuation">.</span>key2<span class="token punctuation">)</span> <span class="token operator">OR</span> key3 <span class="token operator">=</span> <span class="token string">&#39;a&#39;</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+--------------------+-------+------------+--------+-------------------+----------+---------+----------------+------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type        <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>   <span class="token operator">|</span> possible_keys     <span class="token operator">|</span> <span class="token keyword">key</span>      <span class="token operator">|</span> key_len <span class="token operator">|</span> ref            <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------------------+-------+------------+--------+-------------------+----------+---------+----------------+------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>            <span class="token operator">|</span> s1    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>    <span class="token operator">|</span> idx_key3          <span class="token operator">|</span> <span class="token boolean">NULL</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>           <span class="token operator">|</span> <span class="token number">9895</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> DEPENDENT SUBQUERY <span class="token operator">|</span> s2    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> eq_ref <span class="token operator">|</span> idx_key2<span class="token punctuation">,</span>idx_key1 <span class="token operator">|</span> idx_key2 <span class="token operator">|</span> <span class="token number">5</span>       <span class="token operator">|</span> testdb<span class="token punctuation">.</span>s1<span class="token punctuation">.</span>key2 <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">10.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------------------+-------+------------+--------+-------------------+----------+---------+----------------+------+----------+-------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token keyword">warnings</span> <span class="token punctuation">(</span><span class="token number">0.03</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>DEPENDENT UNION: 子查询中的UNION或者UNION ALL，除了最左边的查询是DEPENDENT SUBQUREY，其余的查询都是DEPENDENT UNION<div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> key1 <span class="token keyword">FROM</span> s2 <span class="token keyword">WHERE</span> key1 <span class="token operator">=</span> <span class="token string">&#39;a&#39;</span> <span class="token keyword">UNION</span> <span class="token keyword">SELECT</span> key1 <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">=</span> <span class="token string">&#39;b&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+--------------------+------------+------------+------+---------------+----------+---------+-------+------+----------+--------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type        <span class="token operator">|</span> <span class="token keyword">table</span>      <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>      <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------------------+------------+------------+------+---------------+----------+---------+-------+------+----------+--------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>            <span class="token operator">|</span> s1         <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">9895</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span>              <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> DEPENDENT SUBQUERY <span class="token operator">|</span> s2         <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_key1      <span class="token operator">|</span> idx_key1 <span class="token operator">|</span> <span class="token number">303</span>     <span class="token operator">|</span> const <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> DEPENDENT <span class="token keyword">UNION</span>    <span class="token operator">|</span> s1         <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_key1      <span class="token operator">|</span> idx_key1 <span class="token operator">|</span> <span class="token number">303</span>     <span class="token operator">|</span> const <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">UNION</span> RESULT       <span class="token operator">|</span> <span class="token operator">&lt;</span>union2<span class="token punctuation">,</span><span class="token number">3</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">temporary</span>          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------------------+------------+------------+------+---------------+----------+---------+-------+------+----------+--------------------------+</span>
<span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.10</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>DERIVED: 在包含**派生表（子查询在from子句中）**的查询中，MySQL会递归执行这些子查询，把结果放在临时表里<div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 这里的&lt;derived2&gt;就是在id为2的查询中产生的派生表</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> key1<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> c <span class="token keyword">FROM</span> s1 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> key1<span class="token punctuation">)</span> <span class="token keyword">AS</span> derived_s1 <span class="token keyword">where</span> c <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+-------+---------------+----------+---------+------+------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>      <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>      <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+-------+---------------+----------+---------+------+------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token operator">&lt;</span>derived2<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>   <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">9895</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> DERIVED     <span class="token operator">|</span> s1         <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> idx_key1      <span class="token operator">|</span> idx_key1 <span class="token operator">|</span> <span class="token number">303</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">9895</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+-------+---------------+----------+---------+------+------+----------+-------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.04</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><div class="custom-container tip"><p class="custom-container-title">type</p></div><blockquote><p>type字段表示了查询操作的<strong>访问类型</strong>，用于描述查询引擎在执行查询时使用的访问方法。</p></blockquote><ul><li>ALL: 全表扫描，Full Table Scan，将遍历全表以找到匹配的行</li><li>index: 表示全索引扫描，即遍历整个索引树来获取结果，而<strong>不需要回表</strong>查找数据</li><li>range: 只检索给定范围的行，使用一个索引来选择行。key 列显示使用了哪个索引，一般就是在你的where语句中出现了between、&lt;、&gt;、in等的查询。这种范围扫描索引扫描比全表扫描要好，因为它只需要开始于索引的某一点，而结束于另一点，不用扫描全部索引<div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">&#39;a&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;b&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;c&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------+---------+------+------+----------+-----------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>      <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------+---------+------+------+----------+-----------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s1    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range <span class="token operator">|</span> idx_key1      <span class="token operator">|</span> idx_key1 <span class="token operator">|</span> <span class="token number">303</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> condition <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------+---------+------+------+----------+-----------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.11</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>ref: 表示使用了非唯一索引进行的等值比较，可能返回多个匹配的行<div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">=</span> <span class="token string">&#39;a&#39;</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+----------+---------+-------+------+----------+-------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>      <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+----------+---------+-------+------+----------+-------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s1    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_key1      <span class="token operator">|</span> idx_key1 <span class="token operator">|</span> <span class="token number">303</span>     <span class="token operator">|</span> const <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+----------+---------+-------+------+----------+-------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>eq_ref: 在连接查询时，如果被驱动表是通过主键或者唯一二级索引列等值匹配的方式进行访问的（如果该主键或者唯一二级索引是联合索引的话，所有的索引列都必须进行等值比较）。则对该被驱动表的访问方法就是eq_ref<div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 从执行计划的结果中可以看出，MySQL打算将s2作为驱动表，s1作为被驱动表，重点关注s1的访问方法是 eq_ref ，表明在访问s1表的时候可以通过主键的等值匹配来进行访问</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> s2 <span class="token keyword">ON</span> s1<span class="token punctuation">.</span>id <span class="token operator">=</span> s2<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+--------+---------------+---------+---------+--------------+------+----------+-------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>   <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref          <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+--------+---------------+---------+---------+--------------+------+----------+-------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s1    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>    <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>         <span class="token operator">|</span> <span class="token number">9895</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s2    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> eq_ref <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> testdb<span class="token punctuation">.</span>s1<span class="token punctuation">.</span>id <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+--------+---------------+---------+---------+--------------+------+----------+-------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>system: 当表中只有一条记录并且该表使用的存储引擎的统计数据是精确的，比如MyISAM、Memory，那么对该表的访问方法就是system</li><li>const: 根据主键或者唯一二级索引列与常数进行等值匹配时，对单表的访问方法就是const<div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">10005</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s1    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> const <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> const <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>fulltext: 全文索引</li><li>ref_or_null: 对普通二级索引进行等值匹配查询，该索引列的值也可以是NULL值时，那么对该表的访问方法就可能是ref_or_null<div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">=</span> <span class="token string">&#39;a&#39;</span> <span class="token operator">OR</span> key1 <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------------+---------------+----------+---------+-------+------+----------+-----------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>        <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>      <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------------+---------------+----------+---------+-------+------+----------+-----------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s1    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref_or_null <span class="token operator">|</span> idx_key1      <span class="token operator">|</span> idx_key1 <span class="token operator">|</span> <span class="token number">303</span>     <span class="token operator">|</span> const <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> condition <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------------+---------------+----------+---------+-------+------+----------+-----------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>index_merge</li><li>unique_subquery</li><li>index_subquery</li></ul><div class="custom-container tip"><p class="custom-container-title">possible_keys和key</p></div><p>possible_keys列表示在某个查询语句中，对某个列执行单表查询时可能用到的索引有哪些。一般查询涉及到的字段上若存在索引，则该索引将被列出，但不一定被查询使用<br> key列表示实际用到的索引有哪些，如果为NULL，则没有使用索引</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">&gt;</span> <span class="token string">&#39;z&#39;</span> <span class="token operator">AND</span> key3 <span class="token operator">=</span> <span class="token string">&#39;a&#39;</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+-------------------+----------+---------+-------+------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys     <span class="token operator">|</span> <span class="token keyword">key</span>      <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+-------------------+----------+---------+-------+------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s1    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_key1<span class="token punctuation">,</span>idx_key3 <span class="token operator">|</span> idx_key3 <span class="token operator">|</span> <span class="token number">303</span>     <span class="token operator">|</span> const <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>     <span class="token number">5.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+-------------------+----------+---------+-------+------+----------+-------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">key_len</p></div><p>表示索引使用的字节数，根据这个值可以判断索引的使用情况，<code>检查是否充分利用了索引，针对联合索引值越大越好。</code><br> 如何计算:</p><ol><li>先看索引上字段的类型。比如：int=4 ; varchar(20) =20 ; char(20) =20</li><li>如果是varchar或者char这种字符串字段，视字符集要乘不同的值，比如utf8要乘 3(MySQL5.7)，如果是utf8mb4要乘4，GBK要乘2</li><li>varchar这种动态字符串要加2个字节</li><li>允许为空的字段要加1个字节</li></ol><div class="custom-container tip"><p class="custom-container-title">ref</p></div><p>ref字段表示连接操作中使用的索引列</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">=</span> <span class="token string">&#39;a&#39;</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+----------+---------+-------+------+----------+-------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>      <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+----------+---------+-------+------+----------+-------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s1    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_key1      <span class="token operator">|</span> idx_key1 <span class="token operator">|</span> <span class="token number">303</span>     <span class="token operator">|</span> const <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+----------+---------+-------+------+----------+-------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到ref列的值是const，表明在使用idx_key1索引执行查询时，与key1列作等值匹配的对象是一个常数，当然有时候更复杂一点:</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> s2 <span class="token keyword">ON</span> s1<span class="token punctuation">.</span>id <span class="token operator">=</span> s2<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+--------+---------------+---------+---------+--------------+------+----------+-------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>   <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref          <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+--------+---------------+---------+---------+--------------+------+----------+-------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s2    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>    <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>         <span class="token operator">|</span> <span class="token number">9895</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s1    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> eq_ref <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> testdb<span class="token punctuation">.</span>s2<span class="token punctuation">.</span>id <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+--------+---------------+---------+---------+--------------+------+----------+-------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">rows</p></div><p>rows字段的值是一个估计值，表示查询操作在执行时<strong>可能会扫描的行数</strong>。这个估计值是根据统计信息和查询优化器的算法得出的，并不是实际执行时的准确值。它可以用来帮助我们评估查询的性能和效率。rows字段的值<strong>越小越好</strong></p><div class="custom-container tip"><p class="custom-container-title">filtered</p></div><p>最后查询出来的数据占所有服务器端（server）检查行数（rows）的百分比。值越大越好</p><div class="custom-container tip"><p class="custom-container-title">Extra</p></div><p>Extra字段提供了一些与查询操作相关的<strong>附加信息</strong>，帮助我们更好地理解查询的执行过程和性能特点。MySQL提供的额外信息有好几十个，这里只挑比较重要的介绍</p><ul><li>Impossible WHERE: 当查询语句的WHERE子句永远为FALSE时将会提示该额外信息</li><li>Using where: 使用了where，但在where上有字段没有创建索引。也可以理解为如果数据从引擎层被返回到server层进行过滤，那么就是Using where</li><li>Using filesort: 在对查询结果中的记录进行排序时，是可以使用索引的 如果排序操作无法使用到索引，只能在内存中（记录较少时）或者磁盘中（记录较多时）进行排序（filesort）就会显示<div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> key1 <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------+---------+------+------+----------+-------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>      <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------+---------+------+------+----------+-------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s1    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> idx_key1 <span class="token operator">|</span> <span class="token number">303</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>   <span class="token number">10</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------+---------+------+------+----------+-------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> common_field <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s1    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">9895</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> filesort <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>Using index: 当我们的查询列表以及搜索条件中只包含属于某个索引的列，也就是在可以使用覆盖索引的情况下，在Extra列将会提示该额外信息</li><li>Using index condition: 叫作Index Condition Pushdown Optimization （索引下推优化）<div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> s1 <span class="token keyword">WHERE</span> key1 <span class="token operator">&gt;</span> <span class="token string">&#39;z&#39;</span> <span class="token operator">AND</span> key1 <span class="token operator">LIKE</span> <span class="token string">&#39;%a&#39;</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------+---------+------+------+----------+-----------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>      <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------+---------+------+------+----------+-----------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s1    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range <span class="token operator">|</span> idx_key1      <span class="token operator">|</span> idx_key1 <span class="token operator">|</span> <span class="token number">303</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>  <span class="token number">344</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> condition <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------+---------+------+------+----------+-----------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><code>如果没有索引下推（ICP）</code>，那么MySQL在存储引擎层找到满足<code>key1 &gt; &#39;z&#39;</code>条件的第一条二级索引记录。然后根据这个记录的<code>主键值进行回表</code>，返回完整的记录给server层，server层再判断其他的搜索条件是否成立。如果成立则保留该记录，否则跳过该记录。</li><li><code>如果使用了索引下推（ICP）</code>，那么MySQL在存储引擎层找到满足<code>key1 &gt; &#39;z&#39;</code>条件的第一条二级索引记录。这时<code>不着急执行回表</code>，而是在这条记录上先判断一下所有关于<code>idx_key1</code>索引中包含的条件是否成立，也就是<code>key1 &gt; &#39;z&#39; AND key1 LIKE &#39;%a&#39;</code>是否成立。如果这些条件不成立，则直接跳过该二级索引记录，去找下一条二级索引记录；如果这些条件成立，则执行回表操作，返回完整的记录给server层。</li></ol><blockquote><p><strong>注意：</strong> 如果这里的查询条件<code>只有content1 &gt; &#39;z&#39;</code>，那么找到满足条件的索引后也会进行一次索引下推的操作，判断content1 &gt; &#39;z&#39;是否成立（这是源码中为了编程方便做的冗余判断）</p></blockquote></li></ul><h3 id="数据准备" tabindex="-1"><a class="header-anchor" href="#数据准备" aria-hidden="true">#</a> 数据准备</h3><blockquote><p>在做优化之前，要准备大量数据。接下来创建两张表，并往员工表里插入50W数据，部门表中插入1W条数据</p></blockquote><div class="custom-container tip"><p class="custom-container-title">建表</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>dept<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>deptName<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>		<span class="token comment">-- 随机字符串，允许重复</span>
  <span class="token identifier"><span class="token punctuation">`</span>address<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>		<span class="token comment">-- 随机字符串，允许重复</span>
  ceo <span class="token keyword">INT</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span>							<span class="token comment">-- 1-50w之间的任意数字</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>emp<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>empno<span class="token punctuation">`</span></span> <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span>					<span class="token comment">-- 可以使用随机数字，或者从1开始的自增数字，不允许重复</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  		<span class="token comment">-- 随机生成，允许姓名重复</span>
  <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>				<span class="token comment">-- 区间随机数</span>
  <span class="token identifier"><span class="token punctuation">`</span>deptId<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>			<span class="token comment">-- 1-1w之间随机数</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
  <span class="token comment">#CONSTRAINT `fk_dept_id` FOREIGN KEY (`deptId`) REFERENCES `t_dept` (`id`)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">随机函数</p></div><ol><li>rand()：rand()函数返回一个0到1之间的随机浮点数</li><li>rand(n)：rand(n)函数接受一个种子值n，并返回一个0到1之间的随机浮点数。当使用相同的种子值n时，rand(n)将会生成相同的随机数序列</li><li>uuid()：uuid()函数用于生成一个通用唯一标识符（Universally Unique Identifier），也就是一个随机的字符串</li></ol><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 				<span class="token comment">-- 返回一个0到1之间的随机浮点数</span>
<span class="token keyword">SELECT</span> FLOOR<span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">-- 返回一个0到9之间的随机整数</span>
<span class="token keyword">SELECT</span> UUID<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 				<span class="token comment">-- 返回一个随机的唯一标识符</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>自定义生成随机数的函数:</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 查看mysql是否允许创建函数：</span>
<span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">&#39;log_bin_trust_function_creators&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> log_bin_trust_function_creators<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> 				<span class="token comment">-- 命令开启：允许创建函数设置：（global-所有session都生效）</span>

<span class="token comment">-- 随机产生字符串</span>
<span class="token keyword">DELIMITER</span> $$  <span class="token comment">-- 将分隔符设置为&quot;$$&quot;，以便在自定义函数中使用多个语句。</span>
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> rand_string<span class="token punctuation">(</span>n <span class="token keyword">INT</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>  <span class="token comment">-- n表示的随机字符串的长度 </span>
<span class="token keyword">BEGIN</span>    
  <span class="token keyword">DECLARE</span> chars_str <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">DECLARE</span> return_str <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">WHILE</span> i <span class="token operator">&lt;</span> n <span class="token keyword">DO</span>  
    <span class="token keyword">SET</span> return_str <span class="token operator">=</span> CONCAT<span class="token punctuation">(</span>return_str<span class="token punctuation">,</span>SUBSTRING<span class="token punctuation">(</span>chars_str<span class="token punctuation">,</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">52</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
  <span class="token keyword">RETURN</span> return_str<span class="token punctuation">;</span>
<span class="token keyword">END</span> $$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>

<span class="token comment">-- 假如要删除</span>
<span class="token comment">-- drop function rand_string;</span>


<span class="token comment">-- 用于随机产生区间数字</span>
<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> rand_num <span class="token punctuation">(</span>from_num <span class="token keyword">INT</span> <span class="token punctuation">,</span>to_num <span class="token keyword">INT</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>   
 <span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>  
 <span class="token keyword">SET</span> i <span class="token operator">=</span> FLOOR<span class="token punctuation">(</span>from_num <span class="token operator">+</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>to_num <span class="token operator">-</span> from_num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">RETURN</span> i<span class="token punctuation">;</span>  
<span class="token keyword">END</span>$$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>

<span class="token comment">-- 假如要删除</span>
<span class="token comment">-- drop function rand_num;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">存储过程</p></div><blockquote><p>存储过程（Stored Procedure）是一组<strong>预编译的SQL语句集合</strong>，它们被命名并存储在数据库中，可以像调用函数一样被应用程序或其他存储过程调用。存储过程通常用于<strong>执行特定的业务逻辑操作</strong>，并且可以接受参数、返回结果<br> 存储过程可以完成复杂的业务逻辑，包括数据处理、事务管理、错误处理等。它们还可以通过输入参数和输出参数与应用程序进行交互，实现更灵活和可定制的数据操作</p></blockquote><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 插入员工数据</span>
<span class="token keyword">DELIMITER</span> $$			<span class="token comment">-- 将分隔符设置为&quot;$$&quot;，以便在存储过程中使用多个语句。</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> insert_emp<span class="token punctuation">(</span><span class="token keyword">START</span> <span class="token keyword">INT</span><span class="token punctuation">,</span> max_num <span class="token keyword">INT</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>  
  <span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>   
  <span class="token keyword">SET</span> autocommit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">-- 将自动提交事务的选项设置为0，即关闭自动提交。</span>
  <span class="token keyword">REPEAT</span>  				<span class="token comment">-- REPEAT ... END REPEAT; ：开始一个循环，循环结束条件是`i = max_num`，每次循环`i`递增1。</span>
    <span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>  
    <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> emp <span class="token punctuation">(</span>empno<span class="token punctuation">,</span> NAME<span class="token punctuation">,</span> age<span class="token punctuation">,</span> deptid <span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">START</span><span class="token operator">+</span>i<span class="token punctuation">)</span> <span class="token punctuation">,</span>rand_string<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rand_num<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rand_num<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    UNTIL i <span class="token operator">=</span> max_num  
  <span class="token keyword">END</span> <span class="token keyword">REPEAT</span><span class="token punctuation">;</span>  
  <span class="token keyword">COMMIT</span><span class="token punctuation">;</span>  
<span class="token keyword">END</span>$$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
 
<span class="token comment">-- 删除</span>
<span class="token comment">-- drop PROCEDURE insert_emp;</span>


<span class="token comment">-- 插入部门数据</span>
<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> insert_dept<span class="token punctuation">(</span>max_num <span class="token keyword">INT</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>  
  <span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>   
  <span class="token keyword">SET</span> autocommit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    
  <span class="token keyword">REPEAT</span>  
    <span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>  
    <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> dept <span class="token punctuation">(</span> deptname<span class="token punctuation">,</span>address<span class="token punctuation">,</span>ceo <span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>rand_string<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>rand_string<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>rand_num<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">500000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    UNTIL i <span class="token operator">=</span> max_num  
  <span class="token keyword">END</span> <span class="token keyword">REPEAT</span><span class="token punctuation">;</span>  
  <span class="token keyword">COMMIT</span><span class="token punctuation">;</span>  
<span class="token keyword">END</span>$$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
 
<span class="token comment">-- 删除</span>
<span class="token comment">-- drop PROCEDURE insert_dept;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">调用存储过程</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 执行存储过程，往dept表添加1万条数据</span>
<span class="token keyword">CALL</span> insert_dept<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">-- 执行存储过程，往emp表添加50万条数据，编号从100000开始</span>
<span class="token keyword">CALL</span> insert_emp<span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">,</span><span class="token number">500000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">可以使用下面的命令开启查看sql运行的时间</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 显示sql语句执行时间</span>
<span class="token keyword">SET</span> profiling <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">SHOW</span> VARIABLES  <span class="token operator">LIKE</span> <span class="token string">&#39;%profiling%&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">SHOW</span> PROFILES<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">批量删除某个表的索引</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 查看某个表除去主键以外的索引</span>
<span class="token keyword">SELECT</span>
	index_name 
<span class="token keyword">FROM</span>
	information_schema<span class="token punctuation">.</span><span class="token keyword">STATISTICS</span> 
<span class="token keyword">WHERE</span>
	table_schema <span class="token operator">=</span> dbname 
	<span class="token operator">AND</span> table_name <span class="token operator">=</span> tablename 
	<span class="token operator">AND</span> seq_in_index <span class="token operator">=</span> <span class="token number">1</span> 
	<span class="token operator">AND</span> index_name <span class="token operator">&lt;&gt;</span> <span class="token string">&#39;PRIMARY&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 批量删除某个表上的所有索引</span>
<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> <span class="token identifier"><span class="token punctuation">`</span>proc_drop_index<span class="token punctuation">`</span></span><span class="token punctuation">(</span>dbname <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>tablename <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">DECLARE</span> done <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span> ct <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span> _index <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span> _cur <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span> <span class="token keyword">SELECT</span> index_name <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token keyword">STATISTICS</span> <span class="token keyword">WHERE</span> table_schema<span class="token operator">=</span>dbname <span class="token operator">AND</span> table_name<span class="token operator">=</span>tablename <span class="token operator">AND</span> seq_in_index<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> index_name <span class="token operator">&lt;&gt;</span><span class="token string">&#39;PRIMARY&#39;</span>  <span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span> <span class="token keyword">CONTINUE</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> <span class="token operator">NOT</span> FOUND <span class="token keyword">set</span> done<span class="token operator">=</span><span class="token number">2</span> <span class="token punctuation">;</span>      
	<span class="token keyword">OPEN</span> _cur<span class="token punctuation">;</span>
		<span class="token keyword">FETCH</span> _cur <span class="token keyword">INTO</span> _index<span class="token punctuation">;</span>
		<span class="token keyword">WHILE</span>  _index<span class="token operator">&lt;&gt;</span><span class="token string">&#39;&#39;</span> <span class="token keyword">DO</span> 
			<span class="token keyword">SET</span> <span class="token variable">@str</span> <span class="token operator">=</span> CONCAT<span class="token punctuation">(</span><span class="token string">&quot;drop index &quot;</span><span class="token punctuation">,</span>_index<span class="token punctuation">,</span><span class="token string">&quot; on &quot;</span><span class="token punctuation">,</span>tablename <span class="token punctuation">)</span><span class="token punctuation">;</span> 
			<span class="token keyword">PREPARE</span> sql_str <span class="token keyword">FROM</span> <span class="token variable">@str</span> <span class="token punctuation">;</span>
			<span class="token keyword">EXECUTE</span> sql_str<span class="token punctuation">;</span>
			<span class="token keyword">DEALLOCATE</span> <span class="token keyword">PREPARE</span> sql_str<span class="token punctuation">;</span>
			<span class="token keyword">SET</span> _index<span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">;</span> 
			<span class="token keyword">FETCH</span> _cur <span class="token keyword">INTO</span> _index<span class="token punctuation">;</span> 
		<span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
	<span class="token keyword">CLOSE</span> _cur<span class="token punctuation">;</span>
<span class="token keyword">END</span>$$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>


<span class="token comment">-- 调用存储过程执行批量删除：dbname 库名称, tablename 表名称</span>
<span class="token keyword">CALL</span> proc_drop_index<span class="token punctuation">(</span><span class="token string">&quot;dbname&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;tablename&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="单表索引优化" tabindex="-1"><a class="header-anchor" href="#单表索引优化" aria-hidden="true">#</a> 单表索引优化</h3><div class="custom-container tip"><p class="custom-container-title">创建索引</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_name <span class="token keyword">ON</span> emp<span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">计算、函数导致索引失效</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 显示查询分析</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> emp<span class="token punctuation">.</span>name  <span class="token operator">LIKE</span> <span class="token string">&#39;abc%&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> <span class="token keyword">LEFT</span><span class="token punctuation">(</span>emp<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">&#39;abc&#39;</span><span class="token punctuation">;</span> <span class="token comment">-- 索引失效</span>

<span class="token comment">-- 执行结果如下:</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> emp<span class="token punctuation">.</span>name  <span class="token operator">LIKE</span> <span class="token string">&#39;abc%&#39;</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------+---------+------+------+----------+-----------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>      <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------+---------+------+------+----------+-----------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range <span class="token operator">|</span> idx_name      <span class="token operator">|</span> idx_name <span class="token operator">|</span> <span class="token number">83</span>      <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>   <span class="token number">25</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> condition <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------+---------+------+------+----------+-----------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.03</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> <span class="token keyword">LEFT</span><span class="token punctuation">(</span>emp<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">&#39;abc&#39;</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>   <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">460530</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">LIKE以%开头索引失效</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> name <span class="token operator">LIKE</span> <span class="token string">&#39;%ab%&#39;</span><span class="token punctuation">;</span> <span class="token comment">-- 索引失效</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p><strong>注意</strong>：Alibaba《Java开发手册》【强制】页面搜索严禁左模糊或者全模糊，如果需要请走搜索引擎来解决</p></blockquote><div class="custom-container tip"><p class="custom-container-title">不等于(!= 或者&lt;&gt;)索引失效</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> emp<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&#39;abc&#39;</span> <span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> emp<span class="token punctuation">.</span>name <span class="token operator">&lt;&gt;</span> <span class="token string">&#39;abc&#39;</span> <span class="token punctuation">;</span> <span class="token comment">-- 索引失效</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">IS NOT NULL 和 IS NULL</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> emp<span class="token punctuation">.</span>name <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> emp<span class="token punctuation">.</span>name <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span> <span class="token comment">-- 索引失效</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>注意</strong>: 当数据库中的数据的<strong>索引列的NULL值达到比较高的比例的时候</strong>，即使在IS NOT NULL 的情况下 MySQL的查询优化器会选择使用索引，此时<strong>type的值是range（范围查询）</strong></p></blockquote><div class="custom-container tip"><p class="custom-container-title">类型转换导致索引失效</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">&#39;123&#39;</span><span class="token punctuation">;</span> 
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> name<span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment">-- 索引失效</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">全索引匹配效率最高</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 删除在emp表创建的索引</span>
<span class="token keyword">CALL</span> proc_drop_index<span class="token punctuation">(</span><span class="token string">&quot;testdb&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;emp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>为以下查询语句创建哪种索引效率最高</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 查询分析</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> emp<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">and</span> deptid <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">AND</span> emp<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&#39;abcd&#39;</span><span class="token punctuation">;</span>
<span class="token comment">-- 执行SQL</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> emp<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">and</span> deptid <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">AND</span> emp<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&#39;abcd&#39;</span><span class="token punctuation">;</span>
<span class="token comment">-- 查看执行时间</span>
<span class="token keyword">SHOW</span> PROFILES<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建索引并重新执行以上测试</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 创建索引：分别创建以下三种索引的一种，并分别进行以上查询分析</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_age <span class="token keyword">ON</span> emp<span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_age_deptid <span class="token keyword">ON</span> emp<span class="token punctuation">(</span>age<span class="token punctuation">,</span>deptid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_age_deptid_name <span class="token keyword">ON</span> emp<span class="token punctuation">(</span>age<span class="token punctuation">,</span>deptid<span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结论： 可以发现最高效的查询应用了联合索引<code>idx_age_deptid_name</code></p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> emp<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">and</span> deptid <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">AND</span> emp<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&#39;abcd&#39;</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+--------------------------------------------+---------------------+---------+-------------------+------+----------+-------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys                              <span class="token operator">|</span> <span class="token keyword">key</span>                 <span class="token operator">|</span> key_len <span class="token operator">|</span> ref               <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+--------------------------------------------+---------------------+---------+-------------------+------+----------+-------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_age<span class="token punctuation">,</span>idx_age_deptid<span class="token punctuation">,</span>idx_age_deptid_name <span class="token operator">|</span> idx_age_deptid_name <span class="token operator">|</span> <span class="token number">93</span>      <span class="token operator">|</span> const<span class="token punctuation">,</span>const<span class="token punctuation">,</span>const <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+--------------------------------------------+---------------------+---------+-------------------+------+----------+-------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">违背了最佳左前缀法则</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 删除在emp表创建的索引</span>
<span class="token keyword">CALL</span> proc_drop_index<span class="token punctuation">(</span><span class="token string">&quot;testdb&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;emp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 创建索引</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_age_deptid_name <span class="token keyword">ON</span> emp<span class="token punctuation">(</span>age<span class="token punctuation">,</span>deptid<span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>如果索引了多列，要遵守最左前缀法则。即查询<strong>从索引的最左前列开始并且不跳过索引中的列</strong>。</li><li>过滤条件要使用索引，必须按照<strong>索引建立时的顺序，依次满足</strong>，一旦跳过某个字段，索引后面的字段都无法被使用。</li></ol><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> emp<span class="token punctuation">.</span>age<span class="token operator">=</span><span class="token number">30</span> <span class="token operator">AND</span> emp<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&#39;abcd&#39;</span> <span class="token punctuation">;</span>
<span class="token comment">-- EXPLAIN结果：</span>
<span class="token comment">-- key_len：5 只使用了age索引</span>
<span class="token comment">-- 索引查找的顺序为 age、deptid、name，查询条件中不包含deptid，无法使用deptid和name索引</span>

<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> emp<span class="token punctuation">.</span>deptid<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> emp<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&#39;abcd&#39;</span><span class="token punctuation">;</span>
<span class="token comment">-- EXPLAIN结果：</span>
<span class="token comment">-- type： ALL， 执行了全表扫描</span>
<span class="token comment">-- key_len： NULL， 索引失效</span>
<span class="token comment">-- 索引查找的顺序为 age、deptid、name，查询条件中不包含age，无法使用整个索引</span>

<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> emp<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">AND</span> emp<span class="token punctuation">.</span>deptid<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> emp<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&#39;abcd&#39;</span><span class="token punctuation">;</span>
<span class="token comment">-- EXPLAIN结果：</span>
<span class="token comment">-- 索引查找的顺序为 age、deptid、name，匹配所有索引字段</span>

<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> emp<span class="token punctuation">.</span>deptid<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> emp<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&#39;abcd&#39;</span> <span class="token operator">AND</span> emp<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
<span class="token comment">-- EXPLAIN结果：</span>
<span class="token comment">-- 索引查找的顺序为 age、deptid、name</span>
<span class="token comment">-- 在不改变查询结果的前提下，会自动帮我们优化sql 交换两个条件以匹配所有索引字段</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">索引中范围条件右边的列失效</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 首先删除之前创建的索引</span>
<span class="token keyword">CALL</span> proc_drop_index<span class="token punctuation">(</span><span class="token string">&quot;testdb&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;emp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>为以下sqll语句创建哪种索引效率最高</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> emp<span class="token punctuation">.</span>age<span class="token operator">=</span><span class="token number">30</span> <span class="token operator">AND</span> emp<span class="token punctuation">.</span>deptId <span class="token operator">&gt;</span> <span class="token number">1000</span> <span class="token operator">AND</span> emp<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&#39;abc&#39;</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 创建索引并执行以上SQL语句的EXPLAIN</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_age_deptid_name <span class="token keyword">ON</span> emp<span class="token punctuation">(</span>age<span class="token punctuation">,</span>deptid<span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- key_len：10， 只是用了 age 和 deptid索引，name失效</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 创建索引并执行以上SQL语句的EXPLAIN（将deptid索引的放在最后）</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_age_name_deptid <span class="token keyword">ON</span> emp<span class="token punctuation">(</span>age<span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">,</span>deptid<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 使用了完整的索引</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> emp<span class="token punctuation">.</span>age<span class="token operator">=</span><span class="token number">30</span> <span class="token operator">AND</span> emp<span class="token punctuation">.</span>deptId <span class="token operator">&gt;</span> <span class="token number">1000</span> <span class="token operator">AND</span> emp<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&#39;abc&#39;</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+-----------------------------------------+---------------------+---------+------+------+----------+-----------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys                           <span class="token operator">|</span> <span class="token keyword">key</span>                 <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+-----------------------------------------+---------------------+---------+------+------+----------+-----------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range <span class="token operator">|</span> idx_age_deptid_name<span class="token punctuation">,</span>idx_age_name_deptid <span class="token operator">|</span> idx_age_name_deptid <span class="token operator">|</span> <span class="token number">93</span>      <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> condition <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+-----------------------------------------+---------------------+---------+------+------+----------+-----------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上两个索引都存在的时候，MySQL优化器会自动选择最好的方案</p><h3 id="关联查询优化" tabindex="-1"><a class="header-anchor" href="#关联查询优化" aria-hidden="true">#</a> 关联查询优化</h3><details class="custom-container details"><summary>建表sql</summary><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 分类</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>class<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>card<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 图书</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>book<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>bookid<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>card<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>bookid<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">-- 插入16条记录</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">-- 插入20条记录</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><div class="custom-container tip"><p class="custom-container-title">左外连接</p></div><p>没有创建索引前的测试： 进行了进行了全表扫描，查询次数为16*20</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> class <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> class<span class="token punctuation">.</span>card <span class="token operator">=</span> book<span class="token punctuation">.</span>card<span class="token punctuation">;</span>
<span class="token comment">-- 左表class：驱动表、右表book：被驱动表</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>测试1：在驱动表上创建索引：进行了全索引扫描，查询次数是16*20</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 创建索引</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_class_card <span class="token keyword">ON</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 在驱动表创建索引并没有优化 还是查询了16*20次</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> class <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> class<span class="token punctuation">.</span>card <span class="token operator">=</span> book<span class="token punctuation">.</span>card<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+--------------------------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>            <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                                      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+--------------------------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> class <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> idx_class_card <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>   <span class="token number">16</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>                                <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> book  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>   <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>           <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>   <span class="token number">20</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">join</span> buffer <span class="token punctuation">(</span><span class="token keyword">hash</span> <span class="token keyword">join</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+--------------------------------------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>测试2</strong>：在<strong>被驱动表</strong>上创建索引：可以避免全表扫描，查询次数是<code>16*1</code></li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 首先删除之前创建的索引</span>
<span class="token keyword">CALL</span> proc_drop_index<span class="token punctuation">(</span><span class="token string">&quot;testdb&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 创建索引</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_book_card <span class="token keyword">ON</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 可以看到此时我们的sql已经被优化到了16*1</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> class <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> class<span class="token punctuation">.</span>card <span class="token operator">=</span> book<span class="token punctuation">.</span>card<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+---------------+---------+-------------------+------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>           <span class="token operator">|</span> key_len <span class="token operator">|</span> ref               <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+---------------+---------+-------------------+------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> class <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>              <span class="token operator">|</span>   <span class="token number">16</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> book  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_book_card <span class="token operator">|</span> idx_book_card <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> testdb<span class="token punctuation">.</span>class<span class="token punctuation">.</span>card <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+---------------+---------+-------------------+------+----------+-------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>测试3：同时给两张表添加索引：充分利用了索引，查询次数是16*1</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- book表已经有了索引 再次在class表创建一个索引</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_class_card <span class="token keyword">ON</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> class <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> class<span class="token punctuation">.</span>card <span class="token operator">=</span> book<span class="token punctuation">.</span>card<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------------+---------+-------------------+------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>            <span class="token operator">|</span> key_len <span class="token operator">|</span> ref               <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------------+---------+-------------------+------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> class <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> idx_class_card <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>              <span class="token operator">|</span>   <span class="token number">16</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> book  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref   <span class="token operator">|</span> idx_book_card <span class="token operator">|</span> idx_book_card  <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> testdb<span class="token punctuation">.</span>class<span class="token punctuation">.</span>card <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+----------------+---------+-------------------+------+----------+-------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>结论</strong>：针对两张表的连接条件涉及的列，索引要创建在<strong>被驱动表</strong>上，<strong>驱动表尽量是小表</strong><span class="badge tip" style="vertical-align:top;"><!--[-->结论<!--]--></span></p><div class="custom-container tip"><p class="custom-container-title">内连接</p></div><p>将前面外连接中的LEFT JOIN 变成 INNER JOIN</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 换成inner join</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> class <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> class<span class="token punctuation">.</span>card<span class="token operator">=</span>book<span class="token punctuation">.</span>card<span class="token punctuation">;</span>

<span class="token comment">-- 交换class和book的位置</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> book <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> class <span class="token keyword">ON</span> class<span class="token punctuation">.</span>card<span class="token operator">=</span>book<span class="token punctuation">.</span>card<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>都有索引的情况下：查询优化器<strong>自动选择</strong>数据量小的表做为驱动表</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 上面两张表都有索引 我们直接测试即可 </span>
<span class="token comment">-- 我们可以看到不论我们的sql语句谁做驱动表 查询优化器都会帮我们选择数据量小的一个表class表作为驱动表</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> class <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> class<span class="token punctuation">.</span>card<span class="token operator">=</span>book<span class="token punctuation">.</span>card<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+----------------+----------------+---------+-------------------+------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys  <span class="token operator">|</span> <span class="token keyword">key</span>            <span class="token operator">|</span> key_len <span class="token operator">|</span> ref               <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+----------------+----------------+---------+-------------------+------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> class <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> idx_class_card <span class="token operator">|</span> idx_class_card <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>              <span class="token operator">|</span>   <span class="token number">16</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> book  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref   <span class="token operator">|</span> idx_book_card  <span class="token operator">|</span> idx_book_card  <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> testdb<span class="token punctuation">.</span>class<span class="token punctuation">.</span>card <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+----------------+----------------+---------+-------------------+------+----------+-------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> book <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> class <span class="token keyword">ON</span> class<span class="token punctuation">.</span>card<span class="token operator">=</span>book<span class="token punctuation">.</span>card<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+----------------+----------------+---------+-------------------+------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys  <span class="token operator">|</span> <span class="token keyword">key</span>            <span class="token operator">|</span> key_len <span class="token operator">|</span> ref               <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+----------------+----------------+---------+-------------------+------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> class <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> idx_class_card <span class="token operator">|</span> idx_class_card <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>              <span class="token operator">|</span>   <span class="token number">16</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> book  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref   <span class="token operator">|</span> idx_book_card  <span class="token operator">|</span> idx_book_card  <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> testdb<span class="token punctuation">.</span>class<span class="token punctuation">.</span>card <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+----------------+----------------+---------+-------------------+------+----------+-------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>class表有索引的情况下：book表是驱动表</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 把两张表的索引删除</span>
<span class="token keyword">CALL</span> proc_drop_index<span class="token punctuation">(</span><span class="token string">&quot;testdb&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CALL</span> proc_drop_index<span class="token punctuation">(</span><span class="token string">&quot;testdb&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;book&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 给class表创建索引</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_class_card <span class="token keyword">ON</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 那么我们的class表就是被驱动表 这两个sql都会优化成book是驱动表 class是被驱动表</span>
<span class="token comment">-- 有索引的会被作为被驱动表</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> class <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> class<span class="token punctuation">.</span>card<span class="token operator">=</span>book<span class="token punctuation">.</span>card<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+----------------+----------------+---------+------------------+------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys  <span class="token operator">|</span> <span class="token keyword">key</span>            <span class="token operator">|</span> key_len <span class="token operator">|</span> ref              <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+----------------+----------------+---------+------------------+------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> book  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>           <span class="token operator">|</span> <span class="token boolean">NULL</span>           <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>   <span class="token number">20</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> class <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_class_card <span class="token operator">|</span> idx_class_card <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> testdb<span class="token punctuation">.</span>book<span class="token punctuation">.</span>card <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+----------------+----------------+---------+------------------+------+----------+-------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><div class="highlight-line"> </div><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>book表有索引的情况下： class表是驱动表</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 删除class表的索引</span>
<span class="token keyword">CALL</span> proc_drop_index<span class="token punctuation">(</span><span class="token string">&quot;testdb&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 给book表创建索引</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_book_card <span class="token keyword">ON</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 两个sql都会选择有索引的book表作为被驱动表</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> book <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> class <span class="token keyword">ON</span> class<span class="token punctuation">.</span>card<span class="token operator">=</span>book<span class="token punctuation">.</span>card<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+---------------+---------+-------------------+------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>           <span class="token operator">|</span> key_len <span class="token operator">|</span> ref               <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+---------------+---------+-------------------+------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> class <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>              <span class="token operator">|</span>   <span class="token number">16</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> book  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_book_card <span class="token operator">|</span> idx_book_card <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> testdb<span class="token punctuation">.</span>class<span class="token punctuation">.</span>card <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+---------------+---------+-------------------+------+----------+-------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><div class="highlight-line"> </div><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>都没有索引的情况下：选择数据量小的表做为驱动表</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 删除book表的索引</span>
<span class="token keyword">CALL</span> proc_drop_index<span class="token punctuation">(</span><span class="token string">&quot;testdb&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;book&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 这两个sql都会选择数据量小的class表作为驱动表</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> book <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> class <span class="token keyword">ON</span> class<span class="token punctuation">.</span>card<span class="token operator">=</span>book<span class="token punctuation">.</span>card<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+--------------------------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                                      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+--------------------------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> class <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>   <span class="token number">16</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>                                       <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> book  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>   <span class="token number">20</span> <span class="token operator">|</span>    <span class="token number">10.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">join</span> buffer <span class="token punctuation">(</span><span class="token keyword">hash</span> <span class="token keyword">join</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+--------------------------------------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>结论：</strong> <span class="badge tip" style="vertical-align:top;"><!--[-->结论<!--]--></span></p><ol><li>发现即使交换表的位置，MySQL优化器也会自动选择驱动表。</li><li>自动选择驱动表的原则是：索引创建在被驱动表上，驱动表是小表。</li></ol><div class="custom-container tip"><p class="custom-container-title">查询方式选择</p></div><p>需求：查询每一个人所对应的部门主管人名称(这里我们使用之前创建的emp和dept表)</p><ul><li><strong>方式一</strong>: 三表左连接方式</li></ul><blockquote><p>首先emp表和dept表根据deptId连接 找到emp所属的dept 然后再根据dept表中的ceo字段找到部门的主管id 再根据这个主管id去emp表查找对应的姓名</p></blockquote><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 首先删除两张表的索引</span>
<span class="token keyword">CALL</span> proc_drop_index<span class="token punctuation">(</span><span class="token string">&quot;testdb&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;emp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CALL</span> proc_drop_index<span class="token punctuation">(</span><span class="token string">&quot;testdb&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;dept&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> emp<span class="token punctuation">.</span>name<span class="token punctuation">,</span> ceo<span class="token punctuation">.</span>name <span class="token keyword">AS</span> ceoname 
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">FROM</span> emp
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> dept <span class="token keyword">ON</span> emp<span class="token punctuation">.</span>deptid <span class="token operator">=</span> dept<span class="token punctuation">.</span>id 
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> emp ceo <span class="token keyword">ON</span> dept<span class="token punctuation">.</span>ceo <span class="token operator">=</span> ceo<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+--------+---------------+---------+---------+-------------------+--------+----------+-------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>   <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref               <span class="token operator">|</span> <span class="token keyword">rows</span>   <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+--------+---------------+---------+---------+-------------------+--------+----------+-------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>              <span class="token operator">|</span> <span class="token number">460530</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> dept  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> eq_ref <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> testdb<span class="token punctuation">.</span>emp<span class="token punctuation">.</span>deptId <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> ceo   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> eq_ref <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> testdb<span class="token punctuation">.</span>dept<span class="token punctuation">.</span>ceo   <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+--------+---------------+---------+---------+-------------------+--------+----------+-------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>一趟查询，用到了主键索引，<strong>效果最佳</strong></p><ul><li><strong>方式二</strong>：子查询方式</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> 
    <span class="token operator">-</span><span class="token operator">&gt;</span> emp<span class="token punctuation">.</span>name<span class="token punctuation">,</span> 
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> ceo<span class="token punctuation">.</span>name <span class="token keyword">FROM</span> emp ceo <span class="token keyword">WHERE</span> ceo<span class="token punctuation">.</span>id <span class="token operator">=</span> dept<span class="token punctuation">.</span>ceo<span class="token punctuation">)</span> <span class="token keyword">AS</span> ceoname
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">FROM</span> emp
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> dept <span class="token keyword">ON</span> emp<span class="token punctuation">.</span>deptid <span class="token operator">=</span> dept<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+--------------------+-------+------------+--------+---------------+---------+---------+-------------------+--------+----------+-------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type        <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>   <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref               <span class="token operator">|</span> <span class="token keyword">rows</span>   <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------------------+-------+------------+--------+---------------+---------+---------+-------------------+--------+----------+-------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>            <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>              <span class="token operator">|</span> <span class="token number">460530</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>            <span class="token operator">|</span> dept  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> eq_ref <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> testdb<span class="token punctuation">.</span>emp<span class="token punctuation">.</span>deptId <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> DEPENDENT SUBQUERY <span class="token operator">|</span> ceo   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> eq_ref <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> testdb<span class="token punctuation">.</span>dept<span class="token punctuation">.</span>ceo   <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------------------+-------+------------+--------+---------------+---------+---------+-------------------+--------+----------+-------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token keyword">warnings</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>两趟查询，用到了主键索引，跟第一种比，效果稍微差点</p><ul><li><strong>方式三</strong>：临时表连接方式1</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 查询所有员工及对应的ceo的id</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> emp_with_ceo_id<span class="token punctuation">.</span>name<span class="token punctuation">,</span> emp<span class="token punctuation">.</span>name <span class="token keyword">AS</span> ceoname <span class="token keyword">FROM</span> 
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> emp<span class="token punctuation">.</span>name<span class="token punctuation">,</span> dept<span class="token punctuation">.</span>ceo 
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">FROM</span> emp 
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> dept <span class="token keyword">ON</span> emp<span class="token punctuation">.</span>deptid <span class="token operator">=</span> dept<span class="token punctuation">.</span>id 
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">)</span> emp_with_ceo_id
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> emp <span class="token keyword">ON</span> emp_with_ceo_id<span class="token punctuation">.</span>ceo <span class="token operator">=</span> emp<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+--------+---------------+---------+---------+-------------------+--------+----------+-------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>   <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref               <span class="token operator">|</span> <span class="token keyword">rows</span>   <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+--------+---------------+---------+---------+-------------------+--------+----------+-------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>              <span class="token operator">|</span> <span class="token number">460530</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> dept  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> eq_ref <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> testdb<span class="token punctuation">.</span>emp<span class="token punctuation">.</span>deptId <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> eq_ref <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> testdb<span class="token punctuation">.</span>dept<span class="token punctuation">.</span>ceo   <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+--------+---------------+---------+---------+-------------------+--------+----------+-------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="highlight-lines"><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查询一趟，<strong>MySQL查询优化器将衍生表查询转换成了连接表查询</strong>，速度堪比第一种方式</p><ul><li><strong>方式四</strong>：临时表连接方式2</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- -- 查询并创建临时表ceo：包含ceo的部门id和ceo的name</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> emp<span class="token punctuation">.</span>name<span class="token punctuation">,</span> ceo<span class="token punctuation">.</span>ceoname <span class="token keyword">FROM</span> emp <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span> 
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> emp<span class="token punctuation">.</span>deptId <span class="token keyword">AS</span> deptId<span class="token punctuation">,</span> emp<span class="token punctuation">.</span>name <span class="token keyword">AS</span> ceoname 
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">FROM</span> emp 
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> dept <span class="token keyword">ON</span> emp<span class="token punctuation">.</span>id <span class="token operator">=</span> dept<span class="token punctuation">.</span>ceo 
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">)</span> ceo
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">ON</span> emp<span class="token punctuation">.</span>deptId <span class="token operator">=</span> ceo<span class="token punctuation">.</span>deptId<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+--------+---------------+---------+---------+-----------------+--------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>   <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref             <span class="token operator">|</span> <span class="token keyword">rows</span>   <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+--------+---------------+---------+---------+-----------------+--------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>            <span class="token operator">|</span> <span class="token number">460530</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> dept  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>            <span class="token operator">|</span>   <span class="token number">9952</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> eq_ref <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> testdb<span class="token punctuation">.</span>dept<span class="token punctuation">.</span>ceo <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+--------+---------------+---------+---------+-----------------+--------+----------+-------------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="highlight-lines"><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查询一趟，MySQL查询优化器将衍生表查询转换成了连接表查询，但是只有一个表使用了索引，数据检索的次数稍多，性能最差<br><strong>总结</strong>：<strong>能够直接多表关联的尽量直接关联，不用子查询。(减少查询的趟数)</strong><span class="badge tip" style="vertical-align:top;"><!--[-->结论<!--]--></span></p><h3 id="子查询优化" tabindex="-1"><a class="header-anchor" href="#子查询优化" aria-hidden="true">#</a> 子查询优化</h3><p>需求：查询不是部门主管人的信息</p><ul><li>方式一</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 查询员工，这些员工的id没在（部门主管id列表中）</span>
<span class="token comment">-- 【查询不是部门主管的员工】</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> emp<span class="token punctuation">.</span>id <span class="token operator">NOT</span> <span class="token operator">IN</span> 
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> dept<span class="token punctuation">.</span>ceo <span class="token keyword">FROM</span> dept <span class="token keyword">WHERE</span> dept<span class="token punctuation">.</span>ceo <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>   <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">460530</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> SUBQUERY    <span class="token operator">|</span> dept  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>   <span class="token number">9952</span> <span class="token operator">|</span>    <span class="token number">90.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>方式二 <span class="badge tip" style="vertical-align:top;"><!--[-->推荐<!--]--></span></li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> emp<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> dept <span class="token keyword">ON</span> emp<span class="token punctuation">.</span>id <span class="token operator">=</span> dept<span class="token punctuation">.</span>ceo <span class="token keyword">WHERE</span> dept<span class="token punctuation">.</span>id <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+--------------------------------------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>   <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                                                  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+--------------------------------------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">460530</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>                                                   <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> dept  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>   <span class="token number">9952</span> <span class="token operator">|</span>    <span class="token number">10.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token operator">Not</span> <span class="token keyword">exists</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">join</span> buffer <span class="token punctuation">(</span><span class="token keyword">hash</span> <span class="token keyword">join</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+--------------------------------------------------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment">-- 可以给dept的ceo字段创建一个索引</span>
<span class="token keyword">create</span> <span class="token keyword">index</span> idx_ceo <span class="token keyword">on</span> dept<span class="token punctuation">(</span>ceo<span class="token punctuation">)</span><span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> emp<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> dept <span class="token keyword">ON</span> emp<span class="token punctuation">.</span>id <span class="token operator">=</span> dept<span class="token punctuation">.</span>ceo <span class="token keyword">WHERE</span> dept<span class="token punctuation">.</span>id <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+---------+---------+---------------+--------+----------+--------------------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref           <span class="token operator">|</span> <span class="token keyword">rows</span>   <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+---------+---------+---------------+--------+----------+--------------------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token number">460530</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>                                 <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> dept  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_ceo       <span class="token operator">|</span> idx_ceo <span class="token operator">|</span> <span class="token number">5</span>       <span class="token operator">|</span> testdb<span class="token punctuation">.</span>emp<span class="token punctuation">.</span>id <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">10.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token operator">Not</span> <span class="token keyword">exists</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+---------+---------+---------------+--------+----------+--------------------------------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>结论</strong>: 尽量不要使用NOT IN 或者 NOT EXISTS，用LEFT JOIN xxx ON xx = xx WHERE xx IS NULL替代 <span class="badge tip" style="vertical-align:top;"><!--[-->结论<!--]--></span></p><h3 id="排序优化" tabindex="-1"><a class="header-anchor" href="#排序优化" aria-hidden="true">#</a> 排序优化</h3><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 删除之前所有的索引</span>
<span class="token keyword">CALL</span> proc_drop_index<span class="token punctuation">(</span><span class="token string">&quot;testdb&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;emp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CALL</span> proc_drop_index<span class="token punctuation">(</span><span class="token string">&quot;testdb&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;dept&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 创建新的索引结构</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_age_deptid_name <span class="token keyword">ON</span> emp <span class="token punctuation">(</span>age<span class="token punctuation">,</span>deptid<span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">无过滤不索引</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 没有使用索引：</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age<span class="token punctuation">,</span>deptid<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+----------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>   <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+----------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">460530</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> filesort <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+----------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment">-- 使用了索引：order by想使用索引，必须有过滤条件，索引才能生效，limit也可以看作是过滤条件</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age<span class="token punctuation">,</span>deptid <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+---------------------+---------+------+------+----------+-------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>                 <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+---------------------+---------+------+------+----------+-------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> idx_age_deptid_name <span class="token operator">|</span> <span class="token number">93</span>      <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>   <span class="token number">10</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+---------------------+---------+------+------+----------+-------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><div class="highlight-line"> </div><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">顺序错不索引</p></div><blockquote><p><strong>注意</strong>：key_len = 5是where语句使用age索引的标记，order by语句使用索引不在key_len中体现。<br> order by语句如果没有使用索引，在extra中会出现using filesort。 这里的顺序一定要考虑前面where的筛选条件</p></blockquote><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 排序使用了索引：                </span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> age<span class="token operator">=</span><span class="token number">45</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> deptid<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------------+---------------------+---------+-------+-------+----------+-------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys       <span class="token operator">|</span> <span class="token keyword">key</span>                 <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span>  <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------------+---------------------+---------+-------+-------+----------+-------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_age_deptid_name <span class="token operator">|</span> idx_age_deptid_name <span class="token operator">|</span> <span class="token number">5</span>       <span class="token operator">|</span> const <span class="token operator">|</span> <span class="token number">43926</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------------+---------------------+---------+-------+-------+----------+-------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 排序使用了索引：</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> age<span class="token operator">=</span><span class="token number">45</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> deptid<span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">;</span> 
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------------+---------------------+---------+-------+-------+----------+-------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys       <span class="token operator">|</span> <span class="token keyword">key</span>                 <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span>  <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------------+---------------------+---------+-------+-------+----------+-------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_age_deptid_name <span class="token operator">|</span> idx_age_deptid_name <span class="token operator">|</span> <span class="token number">5</span>       <span class="token operator">|</span> const <span class="token operator">|</span> <span class="token number">43926</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------------+---------------------+---------+-------+-------+----------+-------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 排序没有使用索引 </span>
<span class="token comment">-- 因为我们创建的索引字段中没有empno字段 所以只会deptid用上索引</span>
<span class="token comment">-- 如果我们的索引创建顺序为 age depid empno 则就可以使用索引</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> age<span class="token operator">=</span><span class="token number">45</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> deptid<span class="token punctuation">,</span> empno<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------------+---------------------+---------+-------+-------+----------+----------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys       <span class="token operator">|</span> <span class="token keyword">key</span>                 <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span>  <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------------+---------------------+---------+-------+-------+----------+----------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_age_deptid_name <span class="token operator">|</span> idx_age_deptid_name <span class="token operator">|</span> <span class="token number">5</span>       <span class="token operator">|</span> const <span class="token operator">|</span> <span class="token number">43926</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> filesort <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------------+---------------------+---------+-------+-------+----------+----------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 排序没有使用索引 </span>
<span class="token comment">-- 因为这里的顺序和我们创建索引的字段顺序不一致 这里优化器并不会优化顺序 如果交换排序的顺序那么结果就会不一致</span>
<span class="token comment">-- 如果使用索引 需要创建一个索引为 age name deptid</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> age<span class="token operator">=</span><span class="token number">45</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">,</span> deptid<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------------+---------------------+---------+-------+-------+----------+----------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys       <span class="token operator">|</span> <span class="token keyword">key</span>                 <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span>  <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------------+---------------------+---------+-------+-------+----------+----------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_age_deptid_name <span class="token operator">|</span> idx_age_deptid_name <span class="token operator">|</span> <span class="token number">5</span>       <span class="token operator">|</span> const <span class="token operator">|</span> <span class="token number">43926</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> filesort <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------------+---------------------+---------+-------+-------+----------+----------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 排序没有使用索引：出现的顺序要和复合索引中的列的顺序一致 </span>
<span class="token comment">-- 排序在条件过滤之后进行执行，条件过滤没有遵循最左前缀法则</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> deptid<span class="token operator">=</span><span class="token number">45</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-----------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>   <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-----------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">460530</span> <span class="token operator">|</span>    <span class="token number">10.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> filesort <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-----------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">方向反不索引</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 排序使用了索引：排序条件和索引一致，并方向相同，可以使用索引</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> age<span class="token operator">=</span><span class="token number">45</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> deptid <span class="token keyword">DESC</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">DESC</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------------+---------------------+---------+-------+-------+----------+---------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys       <span class="token operator">|</span> <span class="token keyword">key</span>                 <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span>  <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------------+---------------------+---------+-------+-------+----------+---------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_age_deptid_name <span class="token operator">|</span> idx_age_deptid_name <span class="token operator">|</span> <span class="token number">5</span>       <span class="token operator">|</span> const <span class="token operator">|</span> <span class="token number">43926</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> Backward <span class="token keyword">index</span> scan <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------------+---------------------+---------+-------+-------+----------+---------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment">-- 排序没有使用索引 因为字段一个升序一个降序 顺序不一致</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> age<span class="token operator">=</span><span class="token number">45</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> deptid <span class="token keyword">ASC</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">DESC</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------------+---------------------+---------+-------+-------+----------+----------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys       <span class="token operator">|</span> <span class="token keyword">key</span>                 <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span>  <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------------+---------------------+---------+-------+-------+----------+----------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_age_deptid_name <span class="token operator">|</span> idx_age_deptid_name <span class="token operator">|</span> <span class="token number">5</span>       <span class="token operator">|</span> const <span class="token operator">|</span> <span class="token number">43926</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> filesort <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------------+---------------------+---------+-------+-------+----------+----------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">索引优化</p></div><p>排序优化的目的是，<strong>去掉 Extra 中的 using filesort</strong></p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 删除之前所有的索引</span>
<span class="token keyword">CALL</span> proc_drop_index<span class="token punctuation">(</span><span class="token string">&quot;testdb&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;emp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CALL</span> proc_drop_index<span class="token punctuation">(</span><span class="token string">&quot;testdb&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;dept&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> emp<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">and</span> emp<span class="token punctuation">.</span>empno <span class="token operator">&lt;</span> <span class="token number">101000</span> <span class="token keyword">order</span> <span class="token keyword">BY</span> emp<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-----------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>   <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-----------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">460530</span> <span class="token operator">|</span>     <span class="token number">3.33</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> filesort <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-----------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>很显然，type 是 ALL，即最坏的情况。Extra 里还出现了 Using filesort,也是最坏的情况。<br> 优化是必须的 尽量让where的过滤条件和排序使用上索引</p><ul><li>我们首先新建一个涉及到上面三个字段的索引，试一下效果如何</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_age_empno_name <span class="token keyword">ON</span> emp<span class="token punctuation">(</span>age<span class="token punctuation">,</span>empno<span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> emp<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">and</span> emp<span class="token punctuation">.</span>empno <span class="token operator">&lt;</span> <span class="token number">101000</span> <span class="token keyword">order</span> <span class="token keyword">BY</span> emp<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+--------------------+--------------------+---------+------+------+----------+---------------------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys      <span class="token operator">|</span> <span class="token keyword">key</span>                <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                                 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+--------------------+--------------------+---------+------+------+----------+---------------------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range <span class="token operator">|</span> idx_age_empno_name <span class="token operator">|</span> idx_age_empno_name <span class="token operator">|</span> <span class="token number">9</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>   <span class="token number">50</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> condition<span class="token punctuation">;</span> <span class="token keyword">Using</span> filesort <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+--------------------+--------------------+---------+------+------+----------+---------------------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>看上面的分析，我们可以看到<code>key_len=9</code>，说明只用到了前面两个索引，name索引没有用到<br> 因为empno字段是范围索引会导致后面的索引失效，所以我们建三个字段的索引是没有意义的，并不会去除后面的Using filesort</p><ul><li>也就是说后面的两个字段索引我们只能选择其中两个，我们首先选择age 和 name 新建一个索引，先把Using filesort去除</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 删除上面创建的索引</span>
<span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_age_empno_name <span class="token keyword">ON</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- 给age和name创建索引</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_age_name <span class="token keyword">ON</span> emp<span class="token punctuation">(</span>age<span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 再次分析</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> emp<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">and</span> emp<span class="token punctuation">.</span>empno <span class="token operator">&lt;</span> <span class="token number">101000</span> <span class="token keyword">order</span> <span class="token keyword">BY</span> emp<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+--------------+---------+-------+-------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>          <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span>  <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+--------------+---------+-------+-------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_age_name  <span class="token operator">|</span> idx_age_name <span class="token operator">|</span> <span class="token number">5</span>       <span class="token operator">|</span> const <span class="token operator">|</span> <span class="token number">47604</span> <span class="token operator">|</span>    <span class="token number">33.33</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+--------------+---------+-------+-------+----------+-------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里我们可以看到后面的Using filesort已经去除，但是这里请注意rows这个值 可以看到不降反升</p><ul><li>我们再给age和empno两个字段新建索引</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 删除上面创建的索引</span>
<span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_age_name <span class="token keyword">ON</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- 给age和empno创建索引</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_age_empno <span class="token keyword">ON</span> emp<span class="token punctuation">(</span>age<span class="token punctuation">,</span>empno<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 再次分析</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> emp<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">and</span> emp<span class="token punctuation">.</span>empno <span class="token operator">&lt;</span> <span class="token number">101000</span> <span class="token keyword">order</span> <span class="token keyword">BY</span> emp<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+---------------+---------+------+------+----------+---------------------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>           <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                                 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+---------------+---------+------+------+----------+---------------------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> emp   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range <span class="token operator">|</span> idx_age_empno <span class="token operator">|</span> idx_age_empno <span class="token operator">|</span> <span class="token number">9</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>   <span class="token number">50</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> condition<span class="token punctuation">;</span> <span class="token keyword">Using</span> filesort <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+---------------+---------+------+------+----------+---------------------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里可以看到虽然后面的Using filesort没有去除但是我们的rows的值已经下降了很多</p><p>为什么有Using filesort的sql的执行速度可以超过已经优化掉Using filesort的sql呢?<br><strong>原因</strong>： 所有的<strong>排序都是在条件过滤之后才执行的</strong>，所以，如果条件过滤掉大部分数据的话，剩下几百几千条数据进行排序其实并不是很消耗性能，即使索引优化了排序，但实际提升性能很有限。 相对的<code>empno &lt; 101000</code>这个条件，如果没有用到索引的话，要对几万条的数据进行扫描，这是非常消耗性能的，所以索引放在这个字段上性价比最高，是最优选择。</p><p><strong>结论</strong> : 当【范围条件】和【group by 或者 order by】的字段出现二选一时，<strong>优先观察条件字段的过滤数量，如果过滤的数据足够多，而需要排序的数据并不多时，优先把索引放在范围字段上</strong>。也可以将选择权交给MySQL：索引同时存在，mysql自动选择最优的方案：（对于这个例子，mysql选择idx_age_empno），但是，随着数据量的变化，选择的索引也会随之变化的。<span class="badge tip" style="vertical-align:top;"><!--[-->结论<!--]--></span></p><div class="custom-container tip"><p class="custom-container-title">排序优化策略</p></div><p>如果排序没有使用索引，引起了filesort，那么filesort有两种算法</p><ol><li>双路排序 <ul><li>第一遍扫描出需要排序的字段，然后进行排序后，根据排序结果，第二遍再扫描一下需要select的列数据。这样会引起大量的随机IO，效率不高，但是节约内存。排序使用quick sort，但是如果内存不够则会按照block进行排序，将排序结果写入磁盘文件，然后再将结果合并。</li></ul></li><li>单路排序 <ul><li>在MySQL4.1版本之前只有第一种排序算法双路排序，第二种算法是从MySQL4.1开始的改进算法，主要目的是为了减少第一次算法中需要两次访问表数据的IO操作，将两次变成了一次，但相应也会耗用更多的sort buffer空间。当然，MySQL4.1开始的以后所有版本同时也支持第一种算法。</li><li>单路排序一次性将结果读取出来，然后在sort buffer中排序，避免了双路排序的两次读的随机IO</li></ul></li></ol><hr><p>优化:</p><ol><li>减少select 后面的查询的字段：<strong>order by时<code>select * </code>是一个大忌</strong></li><li>查询字段过多会占用sort_buffer_size的容量。<strong>增大sort_buffer_size参数的设置</strong>：当然，要根据系统的能力去提高，因为这个参数是针对每个进程（connection）的 1M-8M之间调整。 MySQL8.0，InnoDB存储引擎默认值是1048576字节，1MB</li><li>增大<strong>max_length_for_sort_data</strong>参数的设置：MySQL根据max_length_for_sort_data变量来确定使用哪种算法，默认值是4096字节，如果需要返回的列的总长度<strong>大于max_length_for_sort_data，使用双路排序算法</strong>，否则使用单路排序算法。但是如果设的太高，数据总容量超出sort_buffer_size的概率就增大，明显症状是高的磁盘I/O活动和低的处理器使用率。1024-8192之间调整</li></ol><h3 id="分组优化" tabindex="-1"><a class="header-anchor" href="#分组优化" aria-hidden="true">#</a> 分组优化</h3><ol><li>group by 使用索引的原则几乎跟order by一致。但是<strong>group by 即使没有过滤条件用到索引，也可以直接使用索引</strong>（order By 必须有过滤条件才能使用上索引）</li><li>包含了order by、group by、distinct这些查询的语句，where条件过滤出来的结果集请保持在1000行以内，否则SQL会很慢。</li></ol><h3 id="覆盖索引优化" tabindex="-1"><a class="header-anchor" href="#覆盖索引优化" aria-hidden="true">#</a> 覆盖索引优化</h3><ol><li>禁止使用select *，禁止查询与业务无关字段</li><li>尽量利用覆盖索引</li></ol><h3 id="其他查询优化策略" tabindex="-1"><a class="header-anchor" href="#其他查询优化策略" aria-hidden="true">#</a> 其他查询优化策略</h3><div class="custom-container tip"><p class="custom-container-title">COUNT(*) 和 COUNT(具体字段) 效率</p></div><ul><li>统计数据表的行数 <code>SELECT COUNT(*)</code> <code>SELECT COUNT(1)</code> <code>SELECT COUNT(具体字段)</code> 这三种方法效率怎么样</li><li><code>COUNT(*)</code> 和 <code>COUNT(1)</code> 本质上并没有区别 是对所有结果进行统计</li><li>如果是MyISAM存储引擎 那么时间复杂度是O(1) 因为会有一个信息来专门存储</li><li>如果是InnoDB存储引擎 需要扫描全表 如果采用<code>COUNT(具体字段)</code>这种形式要尽量采用二级索引</li><li>因为二级索引中只会有二级索引和主键索引的数据 而如果使用聚簇索引会有全部字段的信息 明显会大于二级索引</li><li>而对于<code>COUNT(*)</code> 和 <code>COUNT(1)</code> 系统会自动采用占用空间更小的二级索引来进行统计</li><li>如果有多个二级索引 会找key_len小的二级索引进行扫描 当没有二级索引的时候 才会采用主键索引进行统计</li></ul><div class="custom-container tip"><p class="custom-container-title">关于 SELECT (*)</p></div><ul><li>在表查询中建议明确字段 不要使用*作为查询的字段列表 推荐使用 <code>SELECT(字段列表)</code> 查询</li><li>其一是 MySQL在解析过程中会通过<code>查询数据字典</code>将 * 转换为所有的列名 会大大消耗资源和时间</li><li>其二是 无法使用 <code>覆盖索引</code></li></ul><div class="custom-container tip"><p class="custom-container-title">LIMIT 1 对优化的影响</p></div><ul><li>针对的是会全表扫描的sql语句 如果可以确定结果集只有一条 那么加上<code>LIMIT 1</code> 当找到一条结果就不会继续扫描会加快查询速度</li><li>如果已经针对字段建立了唯一索引 那么可以通过索引查询 不会全表扫描 就不需要加<code>LIMIT 1</code></li></ul><div class="custom-container tip"><p class="custom-container-title">多使用COMMIT</p></div><ul><li>只要有可能 在程序中尽量多使用COMMIT 这样程序性能可以得到提高 需求也会因为COMMIT所释放的资源而减少</li><li>COMMIT所释放的资源有: <ul><li>回滚段上用户恢复数据的信息</li><li>被程序语句获得的锁</li><li>redo/undo log buffer 中的空间</li><li>管理上述三种资源中的内部花费</li></ul></li></ul><h2 id="mysql基础日志" tabindex="-1"><a class="header-anchor" href="#mysql基础日志" aria-hidden="true">#</a> MySQL基础日志</h2><p>在任何一种数据库中，都会有各种各样的日志，记录着数据库工作的方方面面，以帮助数据库管理员追踪数据库曾经发生过的各种事件。MySQL有多种类型的日志，用于记录数据库的操作和状态。以下是一些常见的MySQL日志：</p><ol><li>错误日志（Error Log）：记录MySQL服务器在启动、运行过程中发生的错误和异常情况，如启动错误、语法错误等。</li><li>查询日志（Query Log）：记录所有执行的查询语句，包括SELECT、INSERT、UPDATE、DELETE等操作。可以用于分析查询性能和调试问题，但需要注意对于高负载的系统，开启查询日志可能会对性能产生影响。</li><li>慢查询日志（Slow Query Log）：记录执行时间超过指定阈值的查询语句。慢查询日志可以帮助你找出执行时间较长的查询，以便进行性能优化。</li><li>二进制日志（Binary Log）：记录所有对数据库的更改操作，包括数据修改、表结构变更等。二进制日志可以用于数据恢复、主从复制等场景。</li><li>事务日志（Transaction Log）：也称为重做日志（Redo Log），记录正在进行的事务的更改操作。事务日志用于保证数据库的ACID特性，并支持崩溃恢复。</li></ol><div class="custom-container tip"><p class="custom-container-title">错误日志</p></div><p>错误日志是 MySQL 中最重要的日志之一，它记录了当 mysqld 启动和停止时，以及服务器在运行过程中发生任何严重错误时的相关信息。当数据库出现任何故障导致无法正常使用时，可以首先查看此日志。<br> 查看错误日志的命令：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&#39;log_error%&#39;</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------------------------+----------------------------------------+</span>
<span class="token operator">|</span> Variable_name              <span class="token operator">|</span> <span class="token keyword">Value</span>                                  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------------+----------------------------------------+</span>
<span class="token operator">|</span> log_error                  <span class="token operator">|</span> stderr                                 <span class="token operator">|</span>
<span class="token operator">|</span> log_error_services         <span class="token operator">|</span> log_filter_internal<span class="token punctuation">;</span> log_sink_internal <span class="token operator">|</span>
<span class="token operator">|</span> log_error_suppression_list <span class="token operator">|</span>                                        <span class="token operator">|</span>
<span class="token operator">|</span> log_error_verbosity        <span class="token operator">|</span> <span class="token number">2</span>                                      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------------+----------------------------------------+</span>
<span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.09</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>log_error设置为stderr并且MySQL以守护进程（daemon）方式运行，那么错误日志将被重定向到系统日志文件（如/var/log/syslog）或其他操作系统特定的日志文件中，而不是直接输出到控制台</p><p>可以通过如下配置，设置错误日志的输出位置：<br> 打开MySQL的配置文件my.cnf。该文件通常位于MySQL安装目录下的/etc或者/etc/mysql子目录中</p><div class="language-vim line-numbers-mode" data-ext="vim"><pre class="language-vim"><code><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
log_error <span class="token operator">=</span> <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">/</span>mysql<span class="token operator">-</span>error<span class="token operator">.</span>err
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>重启mysql进行测试<br> 查看日志内容:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">tail</span> <span class="token parameter variable">-f</span> /var/lib/docker/volumes/mysql8_data/_data/mysql-error.err
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">查询日志</p></div><p>查询日志中记录了客户端的所有操作语句【CRUD】，而二进制日志不包含查询数据的SQL语句。<br> 默认情况下， 查询日志是未开启的。如果需要开启查询日志，可以设置以下配置：</p><div class="language-vim line-numbers-mode" data-ext="vim"><pre class="language-vim"><code># 该选项用来开启查询日志 ， 可选值 ： <span class="token number">0</span> 或者 <span class="token number">1</span> ； <span class="token number">0</span> 代表关闭， <span class="token number">1</span> 代表开启 
general_log <span class="token operator">=</span> <span class="token number">1</span>

# 设置日志的文件名 ， 如果没有指定， 默认的文件名为 host_name<span class="token operator">.</span>log 
general_log_file<span class="token operator">=</span>file_name
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在mysql 的配置文件 /var/lib/mysql/my.cnf 中配置如下内容 ：</p><div class="language-vim line-numbers-mode" data-ext="vim"><pre class="language-vim"><code>general_log<span class="token operator">=</span><span class="token number">1</span>
general_log_file<span class="token operator">=</span>mysql_query<span class="token operator">.</span>log
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>开启查询日志注意事项：</p><ol><li>开启查询日志会对MySQL的性能产生一定影响，特别是在高负载环境下。因此，在生产环境中建议谨慎使用，并根据需要进行开启和关闭。</li><li>查询日志可能会记录大量的查询语句，导致日志文件过大。可以通过定期清理或限制日志文件大小来处理这个问题。</li><li>查询日志可能会包含敏感信息（如密码），因此要确保只有授权的人员可以访问查询日志文件。</li></ol><div class="custom-container tip"><p class="custom-container-title">慢查询日志</p></div><ul><li><p>慢查询日志记录了所有执行时间超过参数 long_query_time 设置值，long_query_time 默认为 10 秒，最小为 0， 精度可以到微秒。</p></li><li><p>默认情况下，MySQL数据库没有开启慢查询日志，需要我们手动来设置这个参数。当然，如果不是调优需要的话，一般不建议启动该参数，因为开启慢查询日志会或多或少带来一定的性能影响。</p></li><li><p>慢查询日志默认是关闭的 。可以通过两个参数来控制慢查询日志 ：</p></li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 该参数用来控制慢查询日志是否开启， 可取值： 1 和 0 ， 1 代表开启， 0 代表关闭</span>
SET GLOBAL <span class="token assign-left variable">slow_query_log</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> 

<span class="token comment"># 该选项用来配置查询的时间限制， 超过这个时间将认为值慢查询， 将需要进行日志记录， 默认10s</span>
SET long_query_time <span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启mysql进行测试</p><hr><ol><li>查询慢查询是否开启以及日志文件位置</li></ol><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">&#39;%slow_query_log%&#39;</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>查询long_query_time 的值。</li></ol><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">&#39;%long_query_time%&#39;</span><span class="token punctuation">;</span> <span class="token comment">-- 查看值：默认10秒</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="3"><li>执行查询操作</li></ol><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>由于在查询的执行时间小于10s，因此该查询不会记录到慢查询日志中。<br> 4. 模拟慢查询效果</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">and</span> sleep<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>   <span class="token comment">-- 使用SLEEP函数可以让查询暂停指定的时间</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="5"><li>查看慢查询日志内容</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">cat</span> 慢查询日志名
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><hr><p>在生产环境中，如果要手工分析日志，查找、分析SQL，显然是个体力活，MySQL提供了日志分析工具mysqldumpslow<br><strong>注意</strong>：默认情况下，传统rpm方式安装的MySQL环境自带mysqldumpslow工具，直接使用即可。docker下安装的MySQL环境没有mysqldumpslow工具</p><p>退出mysql的命令行 执行下面命令测试</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 查看mysqldumpslow的帮助信息</span>
mysqldumpslow <span class="token parameter variable">--help</span>

<span class="token comment"># 工作常用参考</span>
<span class="token comment"># 1.得到返回记录集最多的10个SQL</span>
mysqldumpslow <span class="token parameter variable">-s</span> r <span class="token parameter variable">-t</span> <span class="token number">10</span> /var/lib/mysql/query-slow.log
<span class="token comment"># 2.得到访问次数最多的10个SQL</span>
mysqldumpslow <span class="token parameter variable">-s</span> c <span class="token parameter variable">-t</span> <span class="token number">10</span> /var/lib/mysql/query-slow.log
<span class="token comment"># 3.得到按照时间排序的前10条里面含有左连接的查询语句</span>
mysqldumpslow <span class="token parameter variable">-s</span> t <span class="token parameter variable">-t</span> <span class="token number">10</span> <span class="token parameter variable">-g</span> <span class="token string">&quot;left join&quot;</span> /var/lib/mysql/query-slow.log
<span class="token comment"># 4.另外建议在使用这些命令时结合 | 和more 使用 ，否则语句过多有可能出现爆屏情况</span>
mysqldumpslow <span class="token parameter variable">-s</span> r <span class="token parameter variable">-t</span> <span class="token number">10</span> /var/lib/mysql/query-slow.log <span class="token operator">|</span> <span class="token function">more</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>-a: 不将数字抽象成N，字符串抽象成S</li><li>-s: 是表示按照何种方式排序； <ul><li>c: sql语句的访问次数</li><li>l: 锁定时间</li><li>r: 返回数据记录集的总数量</li><li>t: 查询时间</li><li>al:平均锁定时间</li><li>ar:平均返回记录数</li><li>at:平均查询时间</li></ul></li><li>-t: 即为返回前面多少条的数据；</li><li>-g: 后边搭配一个正则匹配模式，大小写不敏感的</li></ul><h2 id="mysql事务日志" tabindex="-1"><a class="header-anchor" href="#mysql事务日志" aria-hidden="true">#</a> MySQL事务日志</h2><blockquote><p>事务: 就是由多个操作组成的一个逻辑单元，组成这个逻辑单元的多个操作要么都成功要么都失败</p></blockquote><div class="custom-container tip"><p class="custom-container-title">ACID四大特性</p></div><p><strong>A：原子性(Atomicity)</strong><br> 一个事务(transaction)中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。<br> 事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样。</p><p><strong>C：一致性(Consistency)</strong><br> 事务的一致性指的是在一个事务执行之前和执行之后数据库都必须处于一致性状态。<br> 如果事务成功地完成，那么系统中所有变化将正确地应用，系统处于有效状态。<br> 如果在事务中出现错误，那么系统中的所有变化将自动地回滚，系统返回到原始状态。</p><p><strong>I：隔离性(Isolation)</strong><br> 指的是在并发环境中，当不同的事务同时操纵相同的数据时，每个事务都有各自的完整数据空间。由并发事务所做的修改必须与任何其他并发事务所做的修改隔离。<br> 事务查看数据更新时，数据所处的状态要么是另一事务修改它之前的状态，要么是另一事务修改它之后的状态，事务不会查看到中间状态的数据。</p><p><strong>D：持久性(Durability)</strong><br> 指的是只要事务成功结束，它对数据库所做的更新就必须保存下来。即使发生系统崩溃，重新启动数据库系统后，数据库还能恢复到事务成功结束时的状态。</p><hr><p>注意：</p><ol><li>事务的隔离性由 <strong>锁机制</strong> 实现。</li><li>而事务的原子性、一致性和持久性由事务的 <strong>redo日志</strong>和<strong>undo日志</strong>来保证。 <ul><li>redo log称为重做日志 ，它记录了对数据库进行修改的操作，包括插入、更新和删除等。Redo日志的主要作用是保证数据库的持久性和恢复能 力。</li><li>undo log称为回滚日志 ，它记录了对数据库进行修改的操作的<strong>逆操作</strong>，用于实现事务的回滚和MVCC（多版本并发控制）。</li></ul></li></ol><h3 id="redo日志" tabindex="-1"><a class="header-anchor" href="#redo日志" aria-hidden="true">#</a> redo日志</h3><div class="custom-container tip"><p class="custom-container-title">InnoDB写数据过程</p></div><p>InnoDB存储引擎是以<strong>页为单位</strong>来管理存储空间的。在真正访问页面之前，需要把磁盘上的页缓存到内存【<strong>Buffer Pool</strong>】之后才可以访问。<br> 所有的变更必须<strong>先更新缓存池</strong>中的数据。然后缓存池中的<strong>脏页</strong>会以一定的频率被刷到磁盘，通过缓存池来优化CPU和磁盘之间的鸿沟，这样就保证了整体的性能不会下降太快。</p><div class="custom-container tip"><p class="custom-container-title">redo日志的意义</p></div><ul><li><p>没有 redo log 存在的问题</p><ul><li>缓冲池可以帮助我们消除CPU和磁盘之间的鸿沟，checkpoint机制可以保证数据的最终落盘，然而由于checkpoint <strong>并不是每次变更的时候就触发的</strong>，而是master线程隔一段时间去处理的。所以最坏的情况就是事务提交后，刚写完缓冲池，数据库宕机了，那么这段数据就是丢失的，无法恢复。</li></ul><blockquote><p>checkPoint机制主要的作用是将缓冲池中的脏页刷新到磁盘</p></blockquote></li><li><p>事务的持久性怎么保证</p><ul><li><p>方案1：在事务提交完成之前把该事务所修改的所有页面都刷新到磁盘，但是这个简单粗暴的做法有些问题</p><ol><li>修改量与刷新磁盘工作量严重不成比例<br> 有的时候仅仅修改了一个页中的某一个字节，但是在InnoDB中是以页为单位来进行磁盘IO的，也就是说在进行事务提交的时候不得不将一个完整的页面从内存刷到磁盘，一个页面是16KB，只修改了一个字节就需要刷新16KB的数据到磁盘显然有点大题小做。</li><li>随机IO刷新较慢<br> 一个事务可能包含很多个语句，即使一条语句可能也<strong>会修改很多页面</strong>，假如该事务修改的这些页面可能并不相邻，这就意味着在将某个事务修改的Buffer Pool的页刷新到磁盘时，需要进行很多的磁盘IO，随机IO比顺序IO慢，尤其对传统的机械磁盘来说。</li></ol></li><li><p>方案2：只把修改了哪些东西记录一下，并不是在提交事务时把修改的全部页面刷新到磁盘</p><p>Innodb引擎采用的是WAL技术(write-ahead logging) , 这种技术就是先写日志，再写磁盘，只有日志写入成功，才算事务提交成功，这里的日志就是<strong>redo log</strong>。</p><p>redo log可以简单分为以下两个部分：</p><ol><li>重做日志缓冲(<strong>redo log buffer</strong>)<br> 保存在内存中，是易失的。redo log buffer 大小，默认 16M ，最大值是4096M，最小值为1M。<div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&#39;%innodb_log_buffer_size%&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li>重做日志文件(<strong>redo log file</strong>)<br> 保存在硬盘中，是持久的。</li></ol></li></ul></li><li><p>整体流程说明<br> 第1步：先将原始数据从磁盘中读入内存中来，修改数据的内存拷贝<br> 第2步：生成一条重做日志并写入redo log buffer，记录的是数据被修改后的值<br> 第3步：当事务commit时，将redo log buffer中的内容刷新到 redo log file，对 redo log file采用追加 写的方式<br> 第4步：定期将内存中修改的数据刷新到磁盘中，当发生宕机且数据未刷新到磁盘的时候，可以通过redo log来恢复，保证了ACID中的D，这就是redo log的作用。</p></li></ul><div class="custom-container tip"><p class="custom-container-title">redo log的好处和特点</p></div><ul><li><p>优点：</p><ol><li>redo日志降低了刷盘频率</li><li>redo日志占用的空间非常小</li></ol></li><li><p>特点：</p><ol><li>redo日志是顺序写入磁盘的</li><li>事务执行过程中，redo log不断记录</li></ol></li></ul><div class="custom-container tip"><p class="custom-container-title">redo log的刷盘策略</p></div><blockquote><p>redo log的写入并不是直接写入磁盘的，InnoDB引擎会在写redo log的时候先写redo log buffer，之后以一定策略将redo log buffer刷入到真正的redo log file 中。<br> 这里的策略这就是我们要说的刷盘策略。</p></blockquote><p><strong>注意</strong>：redo log buffer刷盘到redo log file的过程并不是真正的刷到磁盘中去，只是刷入到 <strong>文件系统缓存（page cache）<strong>中去（这是现代操作系统为了提高文件写入效率做的一个优化），真正的写入会</strong>交给系统自己来决定</strong>（比如page cache足够大了）。那么对于InnoDB来说就存在一个问题，如果交给系统来同步，同样如果系统宕机，那么数据也丢失了（虽然整个系统宕机的概率还是比较小的）。</p><p>针对这种情况，InnoDB给出 <code>innodb_flush_log_at_trx_commit</code> 参数，该参数控制commit提交事务时，如何将 redo log buffer 中的日志刷新到 redo log file 中</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 查看innodb_flush_log_at_trx_commit变量的值 默认为1</span>
<span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">&#39;%innodb_flush_log_at_trx_commit%&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>它支持三种策略:</p><ol><li><strong>设置为0</strong> ：表示每次事务提交时不进行刷盘操作【不往文件系统中写】。（系统默认master thread每隔1s进行一次重做日志的同步）。<strong>性能最佳、数据风险较高。</strong> 可能丢失1s内的数据</li><li><strong>设置为1</strong> ：表示每次事务提交时都将进行同步，刷盘操作（ 默认值 ）。<strong>数据安全性较高、性能稍差。</strong></li><li><strong>设置为2</strong> ：表示每次事务提交时都只把 <strong>redo log buffer 内容写入 page cache</strong>，不进行同步。由os自己决定什么时候同步到磁盘文件。<strong>性能较高数据安全性较高</strong>。在发生数据库故障时，可能会丢失最近提交的事务的数据，因为尚未刷新到磁盘上的日志文件中。</li></ol><h3 id="undo日志" tabindex="-1"><a class="header-anchor" href="#undo日志" aria-hidden="true">#</a> undo日志</h3><div class="custom-container tip"><p class="custom-container-title">简介</p></div><p>事务需要保证 <strong>原子性</strong> ，也就是事务中的操作要么全部完成，要么什么也不做。但有时候事务执行到一半会出现一些情况，比如：<br> 情况一：事务执行过程中可能遇到各种错误，比如服务器本身的错误，操作系统错误，甚至是突然断电导致的错误。<br> 情况二：程序员可以在事务执行过程中手动输入ROLLBACK语句结束当前事务的执行。</p><p>以上情况出现，我们需要把数据改回原先的样子，这个过程称之为<strong>回滚</strong> ，这样就可以造成一个假象：这个事务看起来什么都没做，所以符合原子性要求。</p><p>如何保证原子性呢? 每当我们要对一条记录做改动时(INSERT、DELETE、UPDATE)，都需要<strong>留一手</strong> -------- 要把改动的东西记下来。比如：</p><ol><li><strong>插入一条记录</strong>时，至少要把这条记录的<strong>主键值记录</strong>下来，之后回滚的时候只需要把这个主键值对应的<strong>记录删除</strong>掉就好了(对于INSER，INNODB存储引擎会完成一个DELETE)。</li><li><strong>删除一条记录</strong>时，至少把这条记录的<strong>内容都记录</strong>下来，这样之后回滚时再把这些内容组成的<strong>记录插入</strong>到表中就好了(对于每个DELETE，INNODB存储引擎会执行一个INSERT)。</li><li><strong>修改一条记录</strong>时，至少要把修改这条记录前的<strong>旧值都记录</strong>下来，这样之后回滚时把这条<strong>记录更新</strong>为旧值就好了(对于每个UPDATE,INNODB存储引擎会执行一个反向的UPDATE,将修改之前的行放回去)。</li></ol><p>MySQL把这些为了回滚而记录的这些内容称之为<strong>撤销日志</strong>或者<strong>回滚日志</strong>(undo log)<br> redo log是事务持久性的保证，undo log是事务原子性的保证。<br> 在事务中<strong>更新数据</strong>的<strong>前置操作</strong>其实是要先写入一个undo log。</p><p>undo日志作用：</p><ol><li>回滚数据</li><li>MVCC</li></ol><div class="custom-container tip"><p class="custom-container-title">undo log存储结构</p></div><ul><li><p>回滚段与undo页</p><ul><li>InnoDB对undo log的管理采用段的方式，也就是回滚段（<strong>rollback segment</strong>） 每个回滚段记录了1024个 <strong>undo log segment</strong> ，而在每个undo log segment段中进行 <strong>undo页</strong> (存储的就是回滚记录)的申请。</li><li>在 InnoDB1.1版本之前 （不包括1.1版本），只有一个rollback segment，因此支持同时在线的事务限制为 1024 。虽然对绝大多数的应用来说都已经够用。</li><li>从1.1版本开始InnoDB支持最大 128个rollback segment ，故其支持同时在线的事务限制提高到 了 128*1024<div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 通过如下的SQL语句查询回滚段的大小</span>
<span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">&#39;innodb_rollback_segments&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p>undo页的重用</p><ul><li>在MySQL中，undo页的重用是指当事务提交或回滚后，<strong>之前使用的undo页可以被重新利用</strong>来存储新的事务的undo信息。这个过程称为undo页的重用</li><li><strong>当一个事务提交或回滚后，其对应的undo页就不再需要了</strong>。为了节省空间和提高性能，MySQL会将这些不再需要的undo页标记为可重用状态，并将它们添加到一个undo页的空闲链表中。当新的事务需要分配undo页时，MySQL会首先尝试从空闲链表中获取可重用的undo页，而不是分配新的页</li><li>通过重用undo页，可以减少对磁盘空间的需求，提高系统性能。然而，如果系统中存在长时间运行的读事务或长时间运行的只读事务，可能会导致undo页无法及时重用，从而增加了undo段的大小和磁盘空间的占用</li></ul></li><li><p>回滚段与事务</p><ul><li>每个事务只会使用一个回滚段，一个回滚段在同一时刻可能会服务于多个事务。</li><li>当一个事务开始的时候，会制定一个回滚段，在事务进行的过程中，当数据被修改时，原始的数据会被复制到回滚段。</li><li>当事务提交时，InnoDB存储引擎会做以下两件事情： <ul><li>将undo log放入列表中，以供之后的purge(<strong>清理</strong>)操作</li><li>判断undo log所在的页是否可以重用，若可以分配给下个事务使用</li></ul></li></ul></li><li><p>回滚段中的数据分类</p><ul><li><p>未提交的回滚数据（uncommitted undo information）</p><ul><li>是指在<strong>事务执行过程中所做的修改，但尚未提交的数据</strong>。</li><li>这意味着其他事务无法看到这些修改，因为它们尚未被永久保存到数据库中。如果该事务被回滚，那么这些未提交的回滚数据将被撤销，数据库恢复到事务开始之前的状态。</li><li>需要注意的是，未提交的回滚数据只存在于回滚段中，并且<strong>只对当前正在执行的事务可见</strong>。其他事务无法读取或修改这些未提交的数据。只有在事务成功提交后，这些数据才会成为已提交的数据，对其他事务可见。</li></ul></li><li><p>已经提交但未过期的回滚数据（committed undo information）</p><ul><li>是指在事务执行过程中所做的修改，并且已经成功提交到数据库中的数据。</li><li>已经提交的回滚数据<strong>对其他事务可见</strong>，可以被读取和修改。这意味着其他事务可以看到并访问这些已提交的数据，而不仅仅局限于当前事务的范围内。</li><li>需要注意的是，已经提交的回滚数据只有<strong>在没有过期的情况下才能被保留</strong>。过期数据是指由于某些原因（如长时间未使用）而被标记为可回收的数据。</li></ul></li><li><p>事务已经提交并过期的数据（expired undo information）</p><ul><li>是指在事务执行过程中所做的修改，并且已经成功提交到数据库中，但由于某些原因被标记为可回收的数据。</li><li>过期数据通常是由于长时间未使用或其他管理策略而被认为是可以回收的数据。<strong>过期的回滚数据可能会被后续的事务覆盖或清理，以释放存储空间或提高性能。</strong></li><li>这意味着虽然这些数据已经成功提交，但它们<strong>可能不再对其他事务可见或可访问。</strong></li></ul></li></ul></li></ul><div class="custom-container tip"><p class="custom-container-title">undo log类型</p></div><p>在InnoDB存储引擎中，undo log分为：insert undo log和update undo log</p><ul><li><p>insert undo log</p><ul><li>Insert undo log（插入撤销日志）是数据库中用于记录插入操作的一种撤销日志。</li><li>因为insert操作的记录，只对事务本身可见，对其他事务不可见(这是事务的隔离性的要求)，因此 undo log可以在<strong>事务提交之后删除</strong>。</li></ul></li><li><p>update undo log</p><ul><li>Update undo log（更新撤销日志）是数据库中用于记录更新操作(delete、update)的一种撤销日志。</li><li>该undo log可能需要提供MVCC机制，因此不能<strong>在事务提交是就进行删除。提交是放入undo log链表，等待purge线程进行最后的删除。</strong></li></ul></li></ul><h2 id="mysql锁" tabindex="-1"><a class="header-anchor" href="#mysql锁" aria-hidden="true">#</a> MySQL锁</h2><blockquote><p>事务的 <strong>隔离性</strong> 由 <strong>锁</strong> 来实现。<br><strong>锁</strong>是计算机协调多个进程或者线程<strong>并发访问某一个资源</strong>的机制。在任何时刻<strong>最多只有一个线程</strong>在访问，保证数据的完整性和一致性。</p></blockquote><h3 id="并发事务带来的问题" tabindex="-1"><a class="header-anchor" href="#并发事务带来的问题" aria-hidden="true">#</a> 并发事务带来的问题</h3><p>在典型的应用程序中，多个事务并发运行，经常会操作相同的数据来完成各自的任务（多个用户对同一数据进行操作）。并发虽然是必须的，但可能会导致以下的问题。</p><ul><li><p><strong>脏读（Dirty read）</strong><br> 当一个事务正在访问数据并且对数据进行了修改，而这种修改还没有提交到数据库中，这时另外一个事务也访问了这个数据，然后使用了这个数据。因为这个数据是还没有提交的数据，那么另外一个事务读到的这个数据是“脏数据”，依据“脏数据”所做的操作可能是不正确的。</p></li><li><p><strong>丢失修改（Lost to modify）</strong><br> 指在一个事务读取一个数据时，另外一个事务也访问了该数据，那么在第一个事务中修改了这个数据后，第二个事务也修改了这个数据。这样第一个事务内的修改结果就被丢失，因此称为丢失修改。 例如：事务1读取某表中的数据A=20，事务2也读取A=20，事务1修改A=A-1，事务2也修改A=A-1，最终结果A=19，事务1的修改被丢失。</p></li><li><p><strong>不可重复读（Unrepeatableread）</strong><br> 指在一个事务内多次读同一数据。在这个事务还没有结束时，另一个事务修改了该数据。那么，在第一个事务中的两次读数据之间，由于第二个事务的修改导致第一个事务两次读取的数据可能不太一样。这就发生了在一个事务内两次读到的数据是不一样的情况，因此称为不可重复读。</p></li><li><p><strong>幻读（Phantom read）</strong><br> 幻读与不可重复读类似。它发生在一个事务（T1）读取了几行数据，接着另一个并发事务（T2）插入了一些数据时。在随后的查询中，第一个事务（T1）就会发现多了一些原本不存在的记录，就好像发生了幻觉一样，所以称为幻读。</p></li></ul><h3 id="并发事务的解决方案" tabindex="-1"><a class="header-anchor" href="#并发事务的解决方案" aria-hidden="true">#</a> 并发事务的解决方案</h3><p>解决方案：对事务进行隔离</p><p>MySQL的四种隔离级别如下:</p><div class="custom-container tip"><p class="custom-container-title">读未提交(READ UNCOMMITTED)</p></div><p>这个隔离级别下,其他事务可以看到本事务没有提交的部分修改。因此会造成<strong>脏读</strong>的问题(读取到了其他事务未提交的部分,而之后该事务进行了回滚)。这个级别的性能没有足够大的优势,但是又有很多的问题,因此很少使用。</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment"># 创建数据库表</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> goods_innodb<span class="token punctuation">(</span>
	id <span class="token keyword">int</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
	name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">innodb</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token comment"># 插入数据</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> goods_innodb<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">&#39;华为&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> goods_innodb<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">&#39;小米&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 会话一</span>
<span class="token keyword">set</span> <span class="token keyword">session</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">read</span> <span class="token keyword">uncommitted</span> <span class="token punctuation">;</span> <span class="token comment"># 设置事务的隔离级别为read uncommitted</span>
<span class="token keyword">start</span> <span class="token keyword">transaction</span> <span class="token punctuation">;</span> <span class="token comment"># 开启事务</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span> <span class="token comment"># 查询数据</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> 华为   <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> 小米   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

<span class="token comment"># 另外再开一个窗口连接到数据库 进行修改操作</span>
<span class="token comment"># 会话二</span>
<span class="token keyword">set</span> <span class="token keyword">session</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">read</span> <span class="token keyword">uncommitted</span> <span class="token punctuation">;</span> <span class="token comment"># 设置事务的隔离级别为read uncommitted</span>
<span class="token keyword">start</span> <span class="token keyword">transaction</span> <span class="token punctuation">;</span> <span class="token comment"># 开启事务</span>
<span class="token keyword">update</span> goods_innodb <span class="token keyword">set</span> name <span class="token operator">=</span> <span class="token string">&#39;中兴&#39;</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">2</span> <span class="token punctuation">;</span> <span class="token comment"># 修改数据</span>

<span class="token comment"># 会话一</span>
<span class="token comment"># 这时再次查询数据库 发现数据和第一次读到的不一致</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span> <span class="token comment"># 查询数据</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> 华为   <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> 中兴   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">读已提交(READ COMMITTED)</p></div><p>其他事务只能读取到本事务已经提交的部分。这个隔离级别有<strong>不可重复读</strong>的问题，在同一个事务内的两次读取,拿到的结果竟然不一样,因为另外一个事务对数据进行了修改。</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment"># 会话一</span>
<span class="token keyword">set</span> <span class="token keyword">session</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">read</span> <span class="token keyword">committed</span> <span class="token punctuation">;</span>		<span class="token comment"># 设置事务的隔离级别为read committed</span>
<span class="token keyword">start</span> <span class="token keyword">transaction</span> <span class="token punctuation">;</span>												<span class="token comment"># 开启事务</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span>							<span class="token comment"># 查询数据</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> 华为   <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> 中兴   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment"># 会话二</span>
<span class="token comment"># 只修改数据但不提交</span>
<span class="token keyword">set</span> <span class="token keyword">session</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">read</span> <span class="token keyword">committed</span> <span class="token punctuation">;</span>		<span class="token comment"># 设置事务的隔离级别为read committed</span>
<span class="token keyword">start</span> <span class="token keyword">transaction</span> <span class="token punctuation">;</span>												<span class="token comment"># 开启事务</span>
<span class="token keyword">update</span> goods_innodb <span class="token keyword">set</span> name <span class="token operator">=</span> <span class="token string">&#39;小米&#39;</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">2</span> <span class="token punctuation">;</span>			   <span class="token comment"># 修改数据</span>

<span class="token comment"># 会话一</span>
<span class="token comment"># 这时查询到的数据还是原来的数据</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span>									<span class="token comment"># 查询数据</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> 华为   <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> 中兴   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment"># 会话二</span>
<span class="token comment"># 对事务进行提交</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>															<span class="token comment"># 提交事务</span>

<span class="token comment"># 会话一</span>
<span class="token comment"># 这时发现读到的数据不一致</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span>									<span class="token comment"># 查询数据</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> 华为   <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> 小米   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">REPEATABLE READ(可重复读)</p></div><p>可重复读隔离级别解决了上面不可重复读的问题(看名字也知道)，但是不能完全解决幻读。MySql默认的事务隔离级别就是：<strong>REPEATABLE READ</strong></p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> @<span class="token variable">@global.transaction_isolation</span> <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------------------------+</span>
<span class="token operator">|</span> @<span class="token variable">@global.transaction_isolation</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------------------+</span>
<span class="token operator">|</span> <span class="token keyword">REPEATABLE</span><span class="token operator">-</span><span class="token keyword">READ</span>                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>sql演示(解决不可重复读)</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment"># 会话一</span>
<span class="token keyword">set</span> <span class="token keyword">session</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">REPEATABLE</span> <span class="token keyword">READ</span> <span class="token punctuation">;</span>
<span class="token keyword">start</span> <span class="token keyword">transaction</span> <span class="token punctuation">;</span>												<span class="token comment"># 开启事务</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span>									<span class="token comment"># 查询数据</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> 华为   <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> 小米   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment"># 会话二</span>
<span class="token keyword">set</span> <span class="token keyword">session</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">REPEATABLE</span> <span class="token keyword">READ</span> <span class="token punctuation">;</span>
<span class="token keyword">start</span> <span class="token keyword">transaction</span> <span class="token punctuation">;</span>												<span class="token comment"># 开启事务</span>
<span class="token keyword">update</span> goods_innodb <span class="token keyword">set</span> name <span class="token operator">=</span> <span class="token string">&#39;荣耀&#39;</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span>			   <span class="token comment"># 修改数据</span>

<span class="token comment"># 会话一</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span>									<span class="token comment"># 查询数据</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> 华为   <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> 小米   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment"># 会话二</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>															<span class="token comment"># 提交事务</span>

<span class="token comment"># 会话一</span>
<span class="token comment"># 这时会话二已经提交了修改的事务 我们的数据并没有改变</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span>									<span class="token comment"># 查询数据</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> 华为   <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> 小米   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment"># 会话二</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span>									<span class="token comment"># 查询数据</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> 荣耀   <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> 小米   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment"># 会话一 </span>
<span class="token comment"># 进行事务提交 再次查询才会查询到会话二修改的数据</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">commit</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> 荣耀   <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> 小米   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>sql演示(测试不会出现幻读的情况)</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment"># 会话一</span>
<span class="token keyword">set</span> <span class="token keyword">session</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">REPEATABLE</span> <span class="token keyword">READ</span> <span class="token punctuation">;</span>
<span class="token keyword">start</span> <span class="token keyword">transaction</span> <span class="token punctuation">;</span>												<span class="token comment"># 开启事务</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span>									<span class="token comment"># 查询数据</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> 荣耀   <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> 小米   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

<span class="token comment"># 会话二</span>
<span class="token keyword">set</span> <span class="token keyword">session</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">REPEATABLE</span> <span class="token keyword">READ</span> <span class="token punctuation">;</span>
<span class="token keyword">start</span> <span class="token keyword">transaction</span> <span class="token punctuation">;</span>												<span class="token comment"># 开启事务</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> goods_innodb<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">&#39;小米&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			   	   <span class="token comment"># 插入数据</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>															<span class="token comment"># 提交事务</span>

<span class="token comment"># 会话一</span>
<span class="token comment"># 同样在我们还没有提交事务时并不会看到会话二新增的数据 只有在提交事务之后才会看到</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span>									<span class="token comment"># 查询数据</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> 荣耀   <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> 小米   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>sql演示(测试出现幻读的情况)</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment"># 表结构进行修改</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> goods_innodb <span class="token keyword">ADD</span> version <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token punctuation">;</span>

<span class="token comment"># 会话一</span>
<span class="token keyword">set</span> <span class="token keyword">session</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">REPEATABLE</span> <span class="token keyword">READ</span> <span class="token punctuation">;</span>
<span class="token keyword">start</span> <span class="token keyword">transaction</span> <span class="token punctuation">;</span>												<span class="token comment"># 开启事务</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token keyword">where</span> version <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>					<span class="token comment"># 查询一条不满足条件的数据</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token keyword">where</span> version <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
Empty <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment"># 会话二</span>
<span class="token keyword">set</span> <span class="token keyword">session</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">REPEATABLE</span> <span class="token keyword">READ</span> <span class="token punctuation">;</span>
<span class="token keyword">start</span> <span class="token keyword">transaction</span> <span class="token punctuation">;</span>												<span class="token comment"># 开启事务</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> goods_innodb<span class="token punctuation">(</span>name<span class="token punctuation">,</span> version<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">&#39;vivo&#39;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	    <span class="token comment"># 插入一条满足条件的数据 </span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>															<span class="token comment"># 提交事务</span>

<span class="token comment"># 会话一</span>
<span class="token comment"># 在之前查询到的数据还是空 这时既可以修改数据 也可以查询到该数据</span>
<span class="token keyword">update</span> goods_innodb <span class="token keyword">set</span> name <span class="token operator">=</span> <span class="token string">&#39;OPPO&#39;</span> <span class="token keyword">where</span> version <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> 		   <span class="token comment"># 将version为1的数据更改为&#39;OPPO&#39;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token keyword">where</span> version <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>					<span class="token comment"># 查询一条不满足条件的数据</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">update</span> goods_innodb <span class="token keyword">set</span> name <span class="token operator">=</span> <span class="token string">&#39;OPPO&#39;</span> <span class="token keyword">where</span> version <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> 
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> goods_innodb <span class="token keyword">where</span> version <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name <span class="token operator">|</span> version <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> OPPO <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">SERIALIZABLE(可串行化)</p></div><p>这是最高的隔离级别,可以解决上面提到的所有问题,因为他强制将所以的操作串行执行,这会导致并发性能极速下降,因此也不是很常用。</p><h3 id="并发事务访问情况说明" tabindex="-1"><a class="header-anchor" href="#并发事务访问情况说明" aria-hidden="true">#</a> 并发事务访问情况说明</h3><p>并发事务访问相同记录的情况大致可以划分为3种：读-读情况、写-写情况、读-写或写-读情况</p><div class="custom-container tip"><p class="custom-container-title">读-读情况</p></div><p><strong>读-读</strong>情况，即并发事务相继<strong>读取相同的记录</strong> 。读取操作本身不会对记录有任何影响，并不会引起什么问题，所以允许这种情况的发生。</p><div class="custom-container tip"><p class="custom-container-title">写-写情况</p></div><p><strong>写-写</strong>情况，即并发事务相继<strong>对相同的记录做出改动</strong>。<br> 在这种情况下会发生<strong>脏写</strong>(脏写读取、脏写覆盖)的问题，任何一种隔离级别都不允许这种问题的发生。所以在多个未提交事务相继对一条记录做改动时，需要让它们排队执行 ，这个排队的过程其实是通过<strong>锁</strong>来实现的。<br> 这个所谓的锁其实是一个内存中的结构 ，在事务执行前本来是没有锁的，也就是说一开始是没有锁结构和记录进行关联的。</p><hr><p>当一个事务想对这条记录做改动时，首先会看看内存中有没有与这条记录关联的<strong>锁结构</strong> ，当没有的时候就会在内存中生成一个锁结构与之关联。</p><ul><li>比如，事务 T1 要对这条记录做改动，就需要生成一个锁结构与之关联</li><li>当事务T1改动了这条记录后，就生成了一个锁结构与该条记录关联，因为之前没有别的事务为这条记录加锁，所以<code>is_waiting = false</code>，我们把这个场景就称之为获取锁成功，或者<strong>加锁成功</strong>。然后就可以继续进行操作了</li><li>在事务T1提交之前，另外一个事务T2也想对该记录做更改，那么先看看有没有锁结构与该条记录关联，发现有一个锁结构与之关联，然后也生成了一个锁结构与这条记录关联，不过锁结构的<code>is_waiting = true</code>，表示当前事务需要等待，我们把这个场景就称之为获取锁失败，或者<strong>加锁失败</strong></li></ul><p><img src="https://cdn.jsdelivr.net/gh/wxhcoding/myblog-img/mysql/mysql-20230809135704.png" alt="mysql-20230809135704"><code>trx</code>: 代表这个锁结构是哪一个事务生成的<br><code>is_waiting</code>: 代表当前事务是否在线等待</p><ul><li>当事务T1提交之后，就会把该事务生成的锁结构释放掉，然后看看有没有别的事务在等待获取锁，发现了事务T2还在等待获取锁，所以把事务T2对应的锁结构的<code>is_waiting</code>属性设置为<code>false</code>，然后把该事务对应的线程唤醒，让他继续执行，此时事务T2就算获取到了锁</li></ul><hr><ol><li><strong>不加锁</strong>意思就是不需要在内存中生成对应的锁结构，可以直接执行操作。</li><li><strong>获取锁成功，或者加锁成功</strong>意思就是在内存中生成了对应的锁结构，而且锁结构的<code>is_waiting = false</code>，也就是事务可以继续执行操作。</li><li><strong>获取锁失败，或者加锁失败</strong>意思就是没有获取到锁，内存中已存在了对应的锁结构 ，不过锁结构的<code>is_waiting = true</code>，也就是事务需要等待，不可以继续执行操作。</li></ol><div class="custom-container tip"><p class="custom-container-title">读-写情况</p></div><p>读-写或写-读，即一个事务进行读取操作，另一个进行改动操作。这种情况下可能发生 脏读、不可重复读、幻读 的问题。</p><p>要想解决这些问题就需要使用到到事务的隔离级别，而事务的隔离性的实现原理有两种：</p><ol><li>使用<strong>MVCC</strong>：读操作利用多版本并发控制(MVCC)，写操作进行加锁。</li></ol><blockquote><p>普通的SELECT语句在READ COMMITTED和REPEATABLE READ隔离级别下会使用到MVCC读取记录。</p><ul><li>在 READ COMMITTED 隔离级别下，一个事务在执行过程中<strong>每次</strong>执行SELECT操作时都会生成一 个<strong>ReadView</strong>，ReadView的存在本身就保证了事务不可以读取到未提交的事务所做的更改，也就是避免了脏读现象</li><li>在 REPEATABLE READ 隔离级别下，一个事务在执行过程中只有<strong>第一次</strong>执行SELECT操作才会生成一个<strong>ReadView</strong>，之后的SELECT操作都复用这个ReadView，这样也就避免了不可重复读和部分幻读的问题</li></ul></blockquote><ol start="2"><li>读、写操作都采用 加锁 的方式。</li></ol><hr><ul><li>采用 MVCC 方式的话，读-写 操作彼此并不冲突，性能更高</li><li>采用 加锁 方式的话， 读-写 操作彼此需要排队执行，影响性能</li></ul><p>一般情况下我们当然愿意采用 <a aria-current="page" href="/myblog/database/sql/mysql_advanced.html#mysql%E4%B8%AD%E7%9A%84mvcc" class="router-link-active router-link-exact-active">MVCC</a> 来解决 读-写 操作并发执行的问题，但是业务在某些特殊情况下，要求必须采用 加锁 的方式执行。</p><h3 id="锁的分类" tabindex="-1"><a class="header-anchor" href="#锁的分类" aria-hidden="true">#</a> 锁的分类</h3><p>从对数据操作的粒度分:</p><ul><li>表锁：操作时，会锁定整个表。</li><li>页面锁：操作时，会锁定某一页的数据。</li><li>行锁：操作时，会锁定当前操作行。</li></ul><p>从对数据操作的类型分:</p><ul><li>读锁（共享锁）：针对同一份数据，多个读操作可以同时进行而不会互相影响。</li><li>写锁（排它锁）：当前操作没有完成之前，它会阻断其他写锁和读锁。</li></ul><p>相对其他数据库而言，MySQL的锁机制比较简单，其最显著的特点是不同的存储引擎支持不同的锁机制。下表中罗列出了各存储引擎对锁的支持情况:</p><table><thead><tr><th>存储引擎</th><th>表级锁</th><th>行级锁</th><th>页面锁</th></tr></thead><tbody><tr><td>MyISAM</td><td>支持</td><td>不支持</td><td>不支持</td></tr><tr><td>InnoDB</td><td>支持</td><td>支持</td><td>不支持</td></tr><tr><td>MEMORY</td><td>支持</td><td>不支持</td><td>不支持</td></tr><tr><td>BDB</td><td>支持</td><td>不支持</td><td>支持</td></tr></tbody></table><p>MySQL这3种锁的特性可大致归纳如下:</p><table><thead><tr><th>锁类型</th><th>特点</th></tr></thead><tbody><tr><td>表级锁</td><td>偏向MyISAM 存储引擎，开销小，加锁快；不会出现死锁；锁定粒度大，发生锁冲突的概率最高,并发度最低。</td></tr><tr><td>行级锁</td><td>偏向InnoDB 存储引擎，开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低,并发度也最高。</td></tr><tr><td>页面锁</td><td>开销和加锁时间界于表锁和行锁之间；会出现死锁；锁定粒度界于表锁和行锁之间，并发度一般。</td></tr></tbody></table><p>从上述特点可见，很难笼统地说哪种锁更好，只能就具体应用的特点来说哪种锁更合适。<br> 仅从锁的角度来说：表级锁更适合于以查询为主，只有少量按索引条件更新数据的应用，如Web应用；而行级锁则更适合于有大量按索引条件并发更新少量不同数据，同时又有并查询的应用。</p><h3 id="myisam表锁" tabindex="-1"><a class="header-anchor" href="#myisam表锁" aria-hidden="true">#</a> MyISAM表锁</h3><blockquote><p>MyISAM 在执行查询语句（SELECT）前，<strong>会自动给涉及的所有表加读锁</strong>，在执行更新操作（UPDATE、DELETE、INSERT 等）前，<strong>会自动给涉及的表加写锁</strong>，这个过程并不需要用户干预，因此，用户一般不需要直接用 LOCK TABLE 命令给 MyISAM 表显式加锁。</p></blockquote><p>显示加表锁语法：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 加读锁</span>
<span class="token keyword">lock</span> <span class="token keyword">table</span> table_name <span class="token keyword">read</span><span class="token punctuation">;</span>
<span class="token comment">-- 加写锁</span>
<span class="token keyword">lock</span> <span class="token keyword">table</span> table_name <span class="token keyword">write</span>；
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="读锁案例" tabindex="-1"><a class="header-anchor" href="#读锁案例" aria-hidden="true">#</a> 读锁案例</h4><div class="custom-container tip"><p class="custom-container-title">准备环境</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">database</span> demo_03 <span class="token keyword">default</span> <span class="token keyword">charset</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>

<span class="token keyword">use</span> demo_03<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>tb_book<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>publish_time<span class="token punctuation">`</span></span> <span class="token keyword">DATE</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span>myisam <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_book <span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> publish_time<span class="token punctuation">,</span> <span class="token keyword">status</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">&#39;java编程思想&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;2088-08-01&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_book <span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> publish_time<span class="token punctuation">,</span> <span class="token keyword">status</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">&#39;solr编程思想&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;2088-08-08&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;0&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>tb_user<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span>myisam <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_user <span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">&#39;令狐冲&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_user <span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">&#39;田伯光&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面我们分为两个客户端窗口来演示</p><ul><li>客户端一</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 获得tb_book表的读锁 </span>
<span class="token keyword">lock</span> <span class="token keyword">table</span> tb_book <span class="token keyword">read</span><span class="token punctuation">;</span>

<span class="token comment">-- 执行查询操作</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tb_book<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------------------+--------------+--------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name             <span class="token operator">|</span> publish_time <span class="token operator">|</span> <span class="token keyword">status</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------------------+--------------+--------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> java编程思想     <span class="token operator">|</span> <span class="token number">2088</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">01</span>   <span class="token operator">|</span> <span class="token number">1</span>      <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> solr编程思想     <span class="token operator">|</span> <span class="token number">2088</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">08</span>   <span class="token operator">|</span> <span class="token number">0</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------------------+--------------+--------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>客户端二</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 执行查询操作</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tb_book<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------------------+--------------+--------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name             <span class="token operator">|</span> publish_time <span class="token operator">|</span> <span class="token keyword">status</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------------------+--------------+--------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> java编程思想     <span class="token operator">|</span> <span class="token number">2088</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">01</span>   <span class="token operator">|</span> <span class="token number">1</span>      <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> solr编程思想     <span class="token operator">|</span> <span class="token number">2088</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">08</span>   <span class="token operator">|</span> <span class="token number">0</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------------------+--------------+--------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>客户端一</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 查询未锁定的表</span>
<span class="token keyword">select</span> name <span class="token keyword">from</span> tb_user<span class="token punctuation">;</span>
<span class="token comment">-- 直接报错</span>
ERROR <span class="token number">1100</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: <span class="token keyword">Table</span> <span class="token string">&#39;tb_user&#39;</span> was <span class="token operator">not</span> locked <span class="token keyword">with</span> <span class="token keyword">LOCK</span> <span class="token keyword">TABLES</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>客户端二</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 查询未锁定的表</span>
<span class="token keyword">select</span> name <span class="token keyword">from</span> tb_user<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------+</span>
<span class="token operator">|</span> name      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+</span>
<span class="token operator">|</span> 令狐冲    <span class="token operator">|</span>
<span class="token operator">|</span> 田伯光    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>客户端一</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 执行插入操作</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> tb_book <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">&#39;Mysql高级&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;2088-01-01&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 直接报错</span>
ERROR <span class="token number">1099</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: <span class="token keyword">Table</span> <span class="token string">&#39;tb_book&#39;</span> was locked <span class="token keyword">with</span> a <span class="token keyword">READ</span> <span class="token keyword">lock</span> <span class="token operator">and</span> can&#39;t be updated
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>客户端二</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 执行插入操作</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> tb_book <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">&#39;Mysql高级&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;2088-01-01&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 此时在等待 被阻塞住</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>客户端一</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 释放锁</span>
<span class="token keyword">unlock</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>客户端一释放锁之后，客户端二的插入语句立即执行，并插入成功</p><h4 id="写锁案例" tabindex="-1"><a class="header-anchor" href="#写锁案例" aria-hidden="true">#</a> 写锁案例</h4><ul><li>客户端一</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 获得tb_book表的写锁 </span>
<span class="token keyword">lock</span> <span class="token keyword">table</span> tb_book <span class="token keyword">write</span> <span class="token punctuation">;</span>
<span class="token comment">-- 执行查询操作</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tb_book <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------------------+--------------+--------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name             <span class="token operator">|</span> publish_time <span class="token operator">|</span> <span class="token keyword">status</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------------------+--------------+--------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> java编程思想     <span class="token operator">|</span> <span class="token number">2088</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">01</span>   <span class="token operator">|</span> <span class="token number">1</span>      <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> solr编程思想     <span class="token operator">|</span> <span class="token number">2088</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">08</span>   <span class="token operator">|</span> <span class="token number">0</span>      <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> Mysql高级        <span class="token operator">|</span> <span class="token number">2088</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>   <span class="token operator">|</span> <span class="token number">1</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------------------+--------------+--------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token comment">-- 执行更新操作</span>
<span class="token keyword">update</span> tb_book <span class="token keyword">set</span> name <span class="token operator">=</span> <span class="token string">&#39;java编程思想（第二版）&#39;</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
<span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>客户端二</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 执行查询操作</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tb_book <span class="token punctuation">;</span>
<span class="token comment">-- 此时陷入了等待</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>客户端一</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 释放锁</span>
<span class="token keyword">unlock</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>客户端一释放锁之后，客户端二的查询语句立即执行，并查询成功</p><h4 id="结论" tabindex="-1"><a class="header-anchor" href="#结论" aria-hidden="true">#</a> 结论</h4><ol><li>对MyISAM 表的读操作，不会阻塞其他用户对同一表的读请求，但会阻塞对同一表的写请求；</li><li>对MyISAM 表的写操作，则会阻塞其他用户对同一表的读和写操作；</li></ol><p>简而言之，就是<strong>读锁会阻塞写，但是不会阻塞读。而写锁，则既会阻塞读，又会阻塞写</strong>。</p><p>此外，MyISAM 的读写锁调度是写优先，这也是MyISAM不适合做写为主的表的存储引擎的原因。因为写锁后，其他线程不能做任何操作，大量的更新会使查询很难得到锁，从而造成永远阻塞。</p><h3 id="innodb行锁" tabindex="-1"><a class="header-anchor" href="#innodb行锁" aria-hidden="true">#</a> InnoDB行锁</h3><div class="custom-container tip"><p class="custom-container-title">加锁特点</p></div><p>行锁特点: 偏向InnoDB 存储引擎，开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度也最高。<br> InnoDB 与 MyISAM 的最大不同有两点：一是支持事务；二是采用了行级锁。</p><p>InnoDB 实现了以下两种类型的行锁:</p><ol><li>共享锁（S）：又称为读锁，简称S锁，共享锁就是多个事务对于同一数据可以共享一把锁，都能访问到数据，但是只能读不能修改。</li><li>排他锁（X）：又称为写锁，简称X锁，排他锁就是不能与其他锁并存，如一个事务获取了一个数据行的排他锁，其他事务就不能再获取该行的其他锁，包括共享锁和排他锁，但是获取排他锁的事务是可以对数据就行读取和修改。</li></ol><ul><li>对于UPDATE、DELETE和INSERT语句，InnoDB会自动给涉及数据集加排他锁</li><li>对于普通SELECT语句，InnoDB不会加任何锁</li></ul><p>可以通过以下语句显示给记录集加共享锁或排他锁</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 共享锁(S)</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> table_name <span class="token keyword">WHERE</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">LOCK</span> <span class="token operator">IN</span> <span class="token keyword">SHARE</span> <span class="token keyword">MODE</span>

<span class="token comment">-- 排他锁(X)</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> table_name <span class="token keyword">WHERE</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">案例准备</p></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> test_innodb_lock<span class="token punctuation">(</span>
	id <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	sex <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token keyword">engine</span> <span class="token operator">=</span> <span class="token keyword">innodb</span> <span class="token keyword">default</span> <span class="token keyword">charset</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> test_innodb_lock <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&#39;100&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> test_innodb_lock <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&#39;3&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> test_innodb_lock <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">&#39;400&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;0&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> test_innodb_lock <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">&#39;500&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> test_innodb_lock <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token string">&#39;600&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;0&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> test_innodb_lock <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token string">&#39;700&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;0&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> test_innodb_lock <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">&#39;800&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> test_innodb_lock <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token string">&#39;900&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> test_innodb_lock <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&#39;200&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;0&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">index</span> idx_test_innodb_lock_id <span class="token keyword">on</span> test_innodb_lock<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">index</span> idx_test_innodb_lock_name <span class="token keyword">on</span> test_innodb_lock<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="行锁基本演示" tabindex="-1"><a class="header-anchor" href="#行锁基本演示" aria-hidden="true">#</a> 行锁基本演示</h4><p>同样这里我们使用两个客户端窗口进行演示</p><ul><li>客户端一</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 关闭自动提交</span>
<span class="token keyword">set</span> autocommit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">-- 查询所有数据</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test_innodb_lock<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------+------+------+</span>
<span class="token operator">|</span> id   <span class="token operator">|</span> name <span class="token operator">|</span> sex  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+------+</span>
<span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">100</span>  <span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span> <span class="token number">3</span>    <span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">4</span> <span class="token operator">|</span> <span class="token number">400</span>  <span class="token operator">|</span> <span class="token number">0</span>    <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">5</span> <span class="token operator">|</span> <span class="token number">500</span>  <span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">6</span> <span class="token operator">|</span> <span class="token number">600</span>  <span class="token operator">|</span> <span class="token number">0</span>    <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">7</span> <span class="token operator">|</span> <span class="token number">700</span>  <span class="token operator">|</span> <span class="token number">0</span>    <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">8</span> <span class="token operator">|</span> <span class="token number">800</span>  <span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">9</span> <span class="token operator">|</span> <span class="token number">900</span>  <span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">200</span>  <span class="token operator">|</span> <span class="token number">0</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+------+</span>
<span class="token number">9</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token comment">-- 查询id为3的数据</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test_innodb_lock <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------+------+------+</span>
<span class="token operator">|</span> id   <span class="token operator">|</span> name <span class="token operator">|</span> sex  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+------+</span>
<span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span> <span class="token number">3</span>    <span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token comment">-- 更新id为3的数据 但是不提交</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">update</span> test_innodb_lock <span class="token keyword">set</span> name <span class="token operator">=</span> <span class="token string">&#39;A1&#39;</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>客户端二</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 首先进行下面几个和客户端一样的查询操作 都没问题 可以正常查询到数据</span>
<span class="token comment">-- 关闭自动提交</span>
<span class="token keyword">set</span> autocommit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">-- 查询所有数据</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test_innodb_lock<span class="token punctuation">;</span>
<span class="token comment">-- 查询id为3的数据</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test_innodb_lock <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

<span class="token comment">-- 更新id为3的数据 发生阻塞 处于等待状态</span>
<span class="token keyword">update</span> test_innodb_lock <span class="token keyword">set</span> name <span class="token operator">=</span> <span class="token string">&#39;A2&#39;</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token comment">-- 发生等待</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>客户端一</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 提交事务</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">commit</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>客户端二</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 在客户端一提交事务后 立即解除阻塞 更新正常执行</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">update</span> test_innodb_lock <span class="token keyword">set</span> name <span class="token operator">=</span> <span class="token string">&#39;A2&#39;</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">33.06</span> sec<span class="token punctuation">)</span>
<span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面都是操作的同一行的数据 下面演示操作不同行的数据</p><ul><li>客户端一</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 更新id为3的数据 正常获取到行锁 执行更新</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">update</span> test_innodb_lock <span class="token keyword">set</span> name <span class="token operator">=</span> <span class="token string">&#39;B1&#39;</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>客户端二</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 更新id为5的数据 由于与客户端一操作的是不同行的数据 获取当前行锁进行更新</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">update</span> test_innodb_lock <span class="token keyword">set</span> name <span class="token operator">=</span> <span class="token string">&#39;C1&#39;</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="无索引行锁升级为表锁" tabindex="-1"><a class="header-anchor" href="#无索引行锁升级为表锁" aria-hidden="true">#</a> 无索引行锁升级为表锁</h4><p><strong>如果不通过索引条件检索数据，那么InnoDB将对表中的所有记录加锁，实际效果跟表锁一样</strong>。一定需要注意索引失效的问题。</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 查看当前表的索引</span>
<span class="token keyword">show</span>  <span class="token keyword">index</span>  <span class="token keyword">from</span> test_innodb_lock <span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span>  <span class="token keyword">index</span>  <span class="token keyword">from</span> test_innodb_lock <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------------------+------------+---------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+</span>
<span class="token operator">|</span> <span class="token keyword">Table</span>            <span class="token operator">|</span> Non_unique <span class="token operator">|</span> Key_name                  <span class="token operator">|</span> Seq_in_index <span class="token operator">|</span> Column_name <span class="token operator">|</span> Collation <span class="token operator">|</span> Cardinality <span class="token operator">|</span> Sub_part <span class="token operator">|</span> Packed <span class="token operator">|</span> <span class="token boolean">Null</span> <span class="token operator">|</span> Index_type <span class="token operator">|</span> <span class="token keyword">Comment</span> <span class="token operator">|</span> Index_comment <span class="token operator">|</span> Visible <span class="token operator">|</span> Expression <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+------------+---------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+</span>
<span class="token operator">|</span> test_innodb_lock <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_test_innodb_lock_id   <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> id          <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">8</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span>   <span class="token boolean">NULL</span> <span class="token operator">|</span> YES  <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>         <span class="token operator">|</span>               <span class="token operator">|</span> YES     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span>
<span class="token operator">|</span> test_innodb_lock <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_test_innodb_lock_name <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> name        <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">9</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span>   <span class="token boolean">NULL</span> <span class="token operator">|</span> YES  <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>         <span class="token operator">|</span>               <span class="token operator">|</span> YES     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+------------+---------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>客户端一</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 关闭事务的自动提交</span>
<span class="token keyword">set</span> autocommit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">-- 执行更新语句 </span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">update</span> test_innodb_lock <span class="token keyword">set</span> sex <span class="token operator">=</span> <span class="token string">&#39;2&#39;</span> <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.03</span> sec<span class="token punctuation">)</span>
<span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>客户端二</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 关闭事务的自动提交</span>
<span class="token keyword">set</span> autocommit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">-- 执行更新语句 这里name=400和id=9不是同一行数据</span>
<span class="token keyword">update</span> test_innodb_lock <span class="token keyword">set</span> sex <span class="token operator">=</span> <span class="token string">&#39;2&#39;</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
<span class="token comment">-- 发生了阻塞</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于客户端一执行更新时 name字段本来为varchar类型 我们是作为数字类型使用 存在类型转换，索引失效，最终行锁变为表锁</p><ul><li>客户端一</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 提交事务</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>在客户端提交事务完成后 客户端二的更新解除阻塞 执行更新成功 并执行提交事务</p><h4 id="间隙锁危害" tabindex="-1"><a class="header-anchor" href="#间隙锁危害" aria-hidden="true">#</a> 间隙锁危害</h4><p>当我们用范围条件，而不是使用相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据进行加锁； <strong>对于键值在条件范围内但并不存在的记录</strong>，叫做&quot;间隙（GAP）&quot;，InnoDB也会对这个&quot;间隙&quot;加锁，这种锁机制就是所谓的 间隙锁（Next-Key锁）。</p><ul><li>客户端一</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 关闭事务的自动提交</span>
<span class="token keyword">set</span> autocommit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">-- 根据id范围更新数</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">update</span> test_innodb_lock <span class="token keyword">set</span> name <span class="token operator">=</span> <span class="token string">&#39;6666&#39;</span> <span class="token keyword">where</span> id <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
<span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">3</span>  Changed: <span class="token number">3</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>客户端二</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 关闭事务的自动提交</span>
<span class="token keyword">set</span> autocommit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">-- 插入id为2的数据 这时处于阻塞状态</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> test_innodb_lock <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">&#39;2&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;1001&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 阻塞</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>客户端一</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 提交事务</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>这时客户端二的新增解除阻塞 执行新增操作 再进行提交</p><h4 id="innodb行锁争用情况" tabindex="-1"><a class="header-anchor" href="#innodb行锁争用情况" aria-hidden="true">#</a> InnoDB行锁争用情况</h4><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">&#39;innodb_row_lock%&#39;</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------------------------------+-------+</span>
<span class="token operator">|</span> Variable_name                 <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------------------+-------+</span>
<span class="token operator">|</span> Innodb_row_lock_current_waits <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Innodb_row_lock_time          <span class="token operator">|</span> <span class="token number">91697</span> <span class="token operator">|</span>
<span class="token operator">|</span> Innodb_row_lock_time_avg      <span class="token operator">|</span> <span class="token number">30565</span> <span class="token operator">|</span>
<span class="token operator">|</span> Innodb_row_lock_time_max      <span class="token operator">|</span> <span class="token number">41854</span> <span class="token operator">|</span>
<span class="token operator">|</span> Innodb_row_lock_waits         <span class="token operator">|</span> <span class="token number">3</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------------------+-------+</span>
<span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.05</span> sec<span class="token punctuation">)</span>

<span class="token comment">-- Innodb_row_lock_current_waits: 当前正在等待锁定的数量</span>
<span class="token comment">-- Innodb_row_lock_time: 从系统启动到现在锁定总时间长度</span>
<span class="token comment">-- Innodb_row_lock_time_avg:每次等待所花平均时长</span>
<span class="token comment">-- Innodb_row_lock_time_max:从系统启动到现在等待最长的一次所花的时间</span>
<span class="token comment">-- Innodb_row_lock_waits: 系统启动后到现在总共等待的次数</span>

<span class="token comment">-- 当等待的次数很高，而且每次等待的时长也不小的时候，我们就需要分析系统中为什么会有如此多的等待，然后根据分析结果着手制定优化计划。</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h4><p>InnoDB存储引擎由于实现了行级锁定，虽然在锁定机制的实现方面带来了性能损耗可能比表锁会更高一些，但是在整体并发处理能力方面要远远高于MyISAM的表锁的。当系统并发量较高的时候，InnoDB的整体性能和MyISAM相比就会有比较明显的优势。<br> 但是，InnoDB的行级锁同样也有其脆弱的一面，当我们使用不当的时候，可能会让InnoDB的整体性能表现不仅不能比MyISAM高，甚至可能会更差。</p><p><strong>优化建议</strong>:</p><ol><li>尽可能让所有数据检索都能通过索引来完成，避免无索引行锁升级为表锁</li><li>合理设计索引，尽量缩小锁的范围</li><li>尽可能减少索引条件，及索引范围，避免间隙锁</li><li>尽量控制事务大小，减少锁定资源量和时间长度</li><li>尽可使用低级别事务隔离（但是需要业务层面满足需求）</li></ol><h2 id="mysql中的mvcc" tabindex="-1"><a class="header-anchor" href="#mysql中的mvcc" aria-hidden="true">#</a> MySQL中的MVCC</h2><p>一想到并发控制，很多人第一反应就是加锁，的确，加锁确实是解决并发问题最常见的方案。但是，其实除了加锁以外，在数据库领域，还有一种无锁的方案可以来实现并发控制，那就是大名鼎鼎的MVCC。</p><p>MVCC（Multiversion Concurrency Control），多版本并发控制。顾名思义，MVCC是通过<strong>数据行的多个版本管理来实现数据库的并发控制</strong> 。<br> 这项技术使得在InnoDB的事务隔离级别下执行<strong>一致性读</strong>操作有了保证。换言之，就是为了查询一些正在被另一个事务更新的行，并且可以看到它们被更新之前的值，这样在做查询的时候就不用等待另一个事务释放锁。</p><p>在数据库中，对数据的操作主要有2中，分别是读和写，而在并发场景下，就可能出现以下三种情况:</p><blockquote><p>读-读并发<br> 写-写并发<br> 读-写并发</p></blockquote><p>我们都知道，在没有写的情况下读-读并发是不会出现问题的，而写-写并发这种情况比较常用的就是通过加锁的方式实现。那么，<strong>读-写并发则可以通过MVCC的机制解决</strong>。</p><h3 id="快照读和当前读" tabindex="-1"><a class="header-anchor" href="#快照读和当前读" aria-hidden="true">#</a> 快照读和当前读</h3><p>MVCC在MySQL InnoDB中的实现主要是为了提高数据库并发性能，用更好的方式去处理 读-写冲突，做到即使有<strong>读写冲突</strong>时，也能做到<strong>不加锁，非阻塞并发读</strong>，而这个读指的就是 <code>快照读</code>，而非 当前读。当前读实际上是一种加锁的操作，是悲观锁的实现。而MVCC本质是采用<strong>乐观锁</strong>思想的一种方式。</p><div class="custom-container tip"><p class="custom-container-title">快照读</p></div><p>快照读又叫<strong>一致性读</strong>，读取的是快照数据。<strong>不加锁的简单的 SELECT 都属于快照读</strong>，即不加锁的非阻塞读；比如这样:</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> table_name <span class="token keyword">WHERE</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>之所以出现快照读的情况，是基于提高并发性能的考虑，快照读的实现是基于MVCC，它在很多情况下，避免了加锁操作，降低了开销。<br> 既然是基于多版本，那么<strong>快照读可能读到的并不一定是数据的最新版本，而有可能是之前的历史版本</strong>。快照读的前提是隔离级别不是串行级别，串行级别下的快照读会退化成当前读。</p><div class="custom-container tip"><p class="custom-container-title">当前读</p></div><p>和快照读相对应的另外一个概念叫做当前读，<strong>当前读读取的是记录的最新版本</strong>（最新数据，而不是历史版本的数据），读取时还要保证其他并发事务不能修改当前记录，会对读取的记录进行加锁。<br><strong>加锁的 SELECT，或者对数据进行增删改都会进行当前读</strong>。比如:</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> xx_table <span class="token keyword">LOCK</span> <span class="token operator">IN</span> <span class="token keyword">SHARE</span> <span class="token keyword">MODE</span><span class="token punctuation">;</span>  <span class="token comment">-- 共享锁</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> xx_table <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span>			<span class="token comment">-- 排它锁</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> xx_table <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>					<span class="token comment">-- 排它锁</span>
<span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> xx_table <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>					<span class="token comment">-- 排它锁</span>
<span class="token keyword">UPDATE</span> xx_table <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>							<span class="token comment">-- 排它锁</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="隐藏字段以及undo-log版本链" tabindex="-1"><a class="header-anchor" href="#隐藏字段以及undo-log版本链" aria-hidden="true">#</a> 隐藏字段以及Undo Log版本链</h3><p>对于使用 InnoDB 存储引擎的表来说，它的聚簇索引记录中都包含两个必要的隐藏列:</p><ul><li>trx_id ：每次一个事务对某条聚簇索引记录进行改动时，都会把该事务的<strong>事务id</strong>赋值给<code>trx_id</code>隐藏列。</li><li>roll_pointer ：每次对某条聚簇索引记录进行改动时，都会把旧的版本写入到 undo日志 中，然后这个隐藏列就相当于一个指针，可以通过它来找到该记录修改前的信息。</li></ul><p><strong>insert undo只在事务回滚时起作用</strong>，当事务提交后，该类型的undo日志就没用了，它占用的Undo Log Segment也会被系统回收（也就是该undo日志占用的Undo页面链表要么被重用，要么被释放）。</p><hr><ul><li>假设 id = 100 的事务 A <strong>插入一条行</strong>记录（id = 1, username = &quot;Jack&quot;, age = 18），那么，这行记录的两个隐藏字段 trx_id = 100 和 roll_pointer指向一个空的 undo log，因为在这之前并没有事务操作 id = 1 的这行记录</li><li>然后，id = 200 的事务 B 修改了这条行记录，把 age 从 18 修改成了 20，于是，这条行记录的 trx_id就变成了 200，roll_pointer就指向事务 A 生成的 undo log</li><li>接着，id = 300 的事务 C 再次修改了这条行记录，把 age 从 20 修改成了 30</li></ul><p><img src="https://cdn.jsdelivr.net/gh/wxhcoding/myblog-img/mysql/mysql-20231123150420.png" alt="mysql-20231123150420"> 可以看到，每次修改行记录都会更新<code>trx_id</code>和<code>roll_pointer</code>这两个隐藏字段，之前的多个数据快照对应的<code>undo log</code>会通过<code>roll_pointer</code>指针串联起来，从而形成一个<strong>版本链</strong>。MVCC 这个机制，其实就是靠<code>update undo log</code>实现的。</p><h3 id="mvcc之readview" tabindex="-1"><a class="header-anchor" href="#mvcc之readview" aria-hidden="true">#</a> MVCC之ReadView</h3><p><strong>Read View 主要来帮我们解决可见性的问题的</strong>, 即他会来告诉我们本次事务应该看到哪个快照，不应该看到哪个快照。<br> MVCC主要针对的是<code>READ COMMITTED</code>、<code>REPEATABLE READ</code></p><p>这个ReadView中主要包含4个比较重要的内容，分别如下:</p><ol><li><code>creator_trx_id</code>: 创建这个 Read View 的事务 ID。</li><li><code>m_ids</code>: 生成 ReadView 时有哪些事务在执行但是还没提交的(称为<strong>活跃事务</strong>)，这些活跃事务的 id 就存在这个字段里。</li><li><code>min_trx_id</code>: m_ids 里最小的值</li><li><code>max_trx_id</code>: 生成 ReadView 时 InnoDB 将分配给下一个事务的 ID 的值（事务 ID 是递增分配的，越后面申请的事务 ID 越大）max_trx_id是系统最大的事务id值，这里要注意是系统中的事务id，需要区别于正在活跃的事务ID。</li></ol><p>通过 undo log 版本链和 ReadView 机制，可以保证一个事务不会读到并发执行的另一个事务的更新<br> 通过 undo log 版本链和 ReadView 机制，可以保证一个事务只可以读到该事务自己修改的数据或该事务开始之前的数据</p><div class="custom-container tip"><p class="custom-container-title">ReadView的规则</p></div><p>有了这个ReadView，这样在访问某条记录时，只需要按照下边的步骤判断记录的某个版本是否可见。</p><ol><li>如果被访问版本的<code>trx_id</code>属性值与ReadView中的<code>creator_trx_id</code>值相同，意味着当前事务在访问 它自己修改过的记录，所以该版本可以被当前事务访问。</li><li>如果被访问版本的<code>trx_id</code>属性值小于ReadView中的<code>min_trx_id</code>值，表明生成该版本的事务在当前事务生成ReadView前已经提交，所以该版本可以被当前事务访问。(因为readview中的<code>min_trx_id</code>是在生成时活跃事务的最小id 所以说明之前的事务都已经提交)</li><li>如果<code>row.trx_id &gt; ReadView.min_trx_id &amp;&amp; row.trx_id &lt; max_trx_id</code>说明，在执行当前事务的时候很有可能存在一个并发事务，然后需要判断当前行记录的事务的id，是否在ReadView的m_ids中，如果存在就说明的确存在一个并发事务，在进行数据都是的时候不允许读取当前行记录，可以通过行记录的回滚指针读取<code>undo log</code>获取数据。</li><li>如果<code>row.trx_id &gt; max_trx_id</code>，说明在执行当前事务的时候，有另外一个事务执行了并且提交了，那么当前事务在读取数据的时候不允许读取当前行数据，可以通过行记录的回滚指针读取undo log获取数据。(当前行的事务id比当初生成readview时的最大事务id还要大 那么说明在redview期间有其他事务执行并提交了)</li></ol><div class="custom-container tip"><p class="custom-container-title">MVCC整体操作流程</p></div><ol><li>首先获取事务自己的版本号，也就是事务 ID</li><li>获取 ReadView</li><li>查询得到的数据，然后与 ReadView 中的事务版本号进行比较</li><li>如果不符合 ReadView 规则，就需要从 Undo Log 中获取历史快照</li><li>最后返回符合规则的数据</li></ol><ul><li>在隔离级别为读已提交（Read Committed）时，一个事务中的每一次 SELECT 查询都会重新获取一次 Read View。(<strong>注意</strong>：此时同样的查询语句都会重新获取一次 Read View，这时如果 Read View 不同，就可能产生不可重复读或者幻读的情况)</li><li>当隔离级别为可重复读的时候，就避免了不可重复读，这是因为一个事务只在第一次 SELECT 的时候会 获取一次 Read View，而后面所有的 SELECT 都会复用这个 Read View</li></ul><h2 id="高性能架构" tabindex="-1"><a class="header-anchor" href="#高性能架构" aria-hidden="true">#</a> 高性能架构</h2><div class="custom-container tip"><p class="custom-container-title">读写分离架构</p></div><p><strong>读写分离的基本实现：</strong></p><ul><li><code>主库负责处理事务性的增删改操作，从库负责处理查询操作</code>，能够有效的避免由数据更新导致的行锁，使得整个系统的查询性能得到极大的改善。</li><li>读写分离是<code>根据 SQL 语义的分析</code>，<code>将读操作和写操作分别路由至主库与从库</code>。</li><li>通过<code>一主多从</code>的配置方式，可以将查询请求均匀的分散到多个数据副本，能够进一步的提升系统的处理能力。</li><li>使用<code>多主多从</code>的方式，不但能够提升系统的吞吐量，还能够提升系统的可用性，可以达到在任何一个数据库宕机，甚至磁盘物理损坏的情况下仍然不影响系统的正常运行。</li></ul><p><strong>CAP理论</strong>:</p><blockquote><p>在一个<code>分布式系统中</code>，当涉及读写操作时，只能保证一致性（Consistence）、可用性（Availability）、分区容错性（Partition Tolerance）三者中的两个，另外一个必须被牺牲。</p></blockquote><ul><li>C 一致性（Consistency）：对某个指定的客户端来说，读操作保证能够返回最新的写操作结果</li><li>A 可用性（Availability）：非故障的节点在合理的时间内返回合理的响应<code>（不是错误和超时的响应）</code></li><li>P 分区容忍性（Partition Tolerance）：当出现网络分区后<code>（可能是丢包，也可能是连接中断，还可能是拥塞）</code>，系统能够继续履行职责</li></ul><ul><li>在实际设计过程中，每个系统不可能只处理一种数据，而是包含多种类型的数据，<code>有的数据必须选择 CP，有的数据必须选择 AP，分布式系统理论上不可能选择 CA 架构。</code></li><li>CP: 保证<code>一致性</code>，比如一个节点A上的数据已经发生了更新，但是此时和另外一个节点B的复制通道中断，此时B节点的一部分数据还是旧的数据，若这时访问B节点中那部分未更新的数据，会提示客户端错误，这种处理方式违背了可用性，因此CAP只能满足CP</li><li>AP: 保证<code>可用性</code>，比如一个节点A上的数据已经发生了更新，但是此时和另外一个节点的复制通道关闭，此时B节点的一部分数据还是旧的数据，若这时访问B节点红那部分未更新的数据，会返回给客户端之前的旧的数据，这就不满足了一致性的要求，因此CAP只能满足AP</li><li>CAP 理论中的 <code>C 在实践中是不可能完美实现的</code>，在数据复制的过程中，节点A和节点B的数据并不一致（强一致性）。即使无法做到<code>强一致性</code>，但可以采用适合的方式达到<code>最终一致性</code>。具有如下特点： <ul><li>基本可用（Basically Available）：分布式系统在出现故障时，允许损失部分可用性，即保证核心可用。</li><li>软状态（Soft State）：允许系统存在中间状态，而该中间状态不会影响系统整体可用性。这里的中间状态就是 CAP 理论中的数据不一致。</li><li><code>最终一致性（Eventual Consistency）：系统中的所有数据副本经过一定时间后，最终能够达到一致的状态。</code></li></ul></li></ul><div class="custom-container tip"><p class="custom-container-title">数据分片架构</p></div><p><strong>读写分离的问题：</strong><br> 读写分离分散了数据库读写操作的压力，但没有分散存储压力，为了满足业务数据存储的需求，就需要<code>将存储分散到多台数据库服务器上</code><br><strong>数据分片：</strong><br> 将存放在单一数据库中的数据分散地存放至多个数据库或表中，以达到提升性能瓶颈以及可用性的效果。 数据分片的有效手段是对关系型数据库进行<code>分库和分表</code>。数据分片的拆分方式又分为<code>垂直分片和水平分片</code></p><ul><li>垂直分片 <ul><li>垂直分库 <ul><li><code>按照业务拆分的方式称为垂直分片，又称为纵向拆分</code>，它的核心理念是专库专用。 在拆分之前，一个数据库由多个数据表构成，每个表对应着不同的业务。而拆分之后，则是按照业务将表进行归类，分布到不同的数据库中，从而将压力分散至不同的数据库。</li><li>垂直拆分可以缓解数据量和访问量带来的问题，但无法根治。<code>如果垂直拆分之后，表中的数据量依然超过单节点所能承载的阈值，则需要水平分片来进一步处理。</code></li></ul></li><li>垂直分表 <ul><li>垂直分表适合将表中某些不常用的列，或者是占了大量空间的列拆分出去</li></ul></li></ul></li><li>水平拆分 <ul><li><code>水平分片又称为横向拆分。</code> 相对于垂直分片，它不再将数据根据业务逻辑分类，而是通过某个字段（或某几个字段），根据某种规则将数据分散至多个库或表中，每个分片仅包含数据的一部分。 例如：根据主键分片，偶数主键的记录放入 0 库（或表），奇数主键的记录放入 1 库（或表）</li><li>水平分表 <ul><li>单表切分为多表后，新的表即使在同一个数据库服务器中，也可能带来可观的性能提升，如果性能能够满足业务要求，可以不拆分到多台数据库服务器，毕竟业务分库也会引入很多复杂性</li></ul></li><li>水平分库 <ul><li>如果单表拆分为多表后，单台服务器依然无法满足性能要求，那就需要将多个表分散在不同的数据库服务器中</li></ul></li></ul></li></ul><blockquote><p><strong>阿里巴巴Java开发手册：</strong><br> 【推荐】单表行数超过 500 万行或者单表容量超过 2GB，才推荐进行分库分表。<br> 说明：如果预计三年后的数据量根本达不到这个级别，<code>请不要在创建表时就分库分表</code>。</p></blockquote><div class="custom-container tip"><p class="custom-container-title">解决方案</p></div><blockquote><p>读写分离和数据分片具体的实现方式一般有两种： <code>程序代码封装</code>和<code>中间件封装</code></p></blockquote><ul><li>程序代码封装 <ul><li>程序代码封装指在代码中抽象一个<code>数据访问层（或中间层封装）</code>，实现读写操作分离和数据库服务器连接的管理</li></ul></li><li>中间件封装 <ul><li>中间件封装指的是<code>独立一套系统出来</code>，实现读写操作分离和数据库服务器连接的管理。对于业务服务器来说，访问中间件和访问数据库没有区别，在业务服务器看来，中间件就是一个数据库服务器</li></ul></li><li>常用解决方案 <ul><li><a href="https://shardingsphere.apache.org/index_zh.html" target="_blank" rel="noopener noreferrer">Apache ShardingSphere<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><ul><li>程序代码封装：ShardingSphere-JDBC</li><li>中间件封装：ShardingSphere-Proxy</li></ul></li><li>MyCat <ul><li>数据库中间件</li></ul></li></ul></li></ul><h3 id="mysql主从同步" tabindex="-1"><a class="header-anchor" href="#mysql主从同步" aria-hidden="true">#</a> MySQL主从同步</h3><div class="custom-container tip"><p class="custom-container-title">原理</p><p>slave会从master读取binlog来进行数据同步<br><strong>具体步骤：</strong></p><ul><li><code>step1：</code>master将数据改变记录到<code>二进制日志（binary log）</code>中。</li><li><code>step2：</code> 当slave上执行 <code>start slave</code> 命令之后，slave会创建一个 <code>IO 线程</code>用来连接master，请求master中的binlog。</li><li><code>step3：</code>当slave连接master时，master会创建一个 <code>log dump 线程</code>，用于发送 binlog 的内容。在读取 binlog 的内容的操作中，会对主节点上的 binlog 加锁，当读取完成并发送给从服务器后解锁。</li><li><code>step4：</code>IO 线程接收主节点 binlog dump 进程发来的更新之后，保存到 <code>中继日志（relay log）</code> 中。</li><li><code>step5：</code>slave的<code>SQL线程</code>，读取relay log日志，并解析成具体操作，从而实现主从操作一致，最终数据一致。</li></ul><p><strong>注意:</strong> MySQL是从接入点开始复制 接入点之前的数据则不会复制</p></div><p>下面开始一主多从的配置(我们使用Linux虚拟机上的docker启动多个MySQL容器来模拟部署了多台MySQL服务器)</p><ul><li>主服务器：容器名<code>mysql-master</code>，端口<code>3306</code></li><li>从服务器：容器名<code>mysql-slave1</code>，端口<code>3307</code></li><li>从服务器：容器名<code>mysql-slave2</code>，端口<code>3308</code></li></ul><div class="custom-container tip"><p class="custom-container-title">准备主服务器</p></div><ul><li>在docker中创建并启动MySQL主服务器：<code>端口3306</code></li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-p</span> <span class="token number">3306</span>:3306 <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /root/mysql/master/conf:/etc/mysql/conf.d <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /root/mysql/master/data:/var/lib/mysql <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span>root <span class="token punctuation">\</span>
<span class="token parameter variable">--name</span> mysql-master <span class="token punctuation">\</span>
mysql:8.0.29
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>创建MySQL主服务器配置文件</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">vim</span> /root/mysql/master/conf/my.cnf

<span class="token comment"># 配置下面的内容</span>
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token comment"># 服务器唯一id，默认值1</span>
server-id<span class="token operator">=</span><span class="token number">1</span>
<span class="token comment"># 设置日志格式，默认值ROW</span>
<span class="token assign-left variable">binlog_format</span><span class="token operator">=</span>STATEMENT
<span class="token comment"># 二进制日志名，默认binlog</span>
<span class="token comment"># log-bin=binlog</span>
<span class="token comment"># 设置需要复制的数据库，默认复制全部数据库</span>
<span class="token comment">#binlog-do-db=mytestdb1</span>
<span class="token comment">#binlog-do-db=mytestdb2</span>
<span class="token comment"># 设置不需要复制的数据库</span>
<span class="token comment">#binlog-ignore-db=mytestdb3</span>
<span class="token comment">#binlog-ignore-db=mytestdb4</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>重启MySQL容器</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> restart mysql-master
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p><code>binlog格式说明：</code></p><ul><li>binlog_format=STATEMENT：日志记录的是主机数据库的<code>写指令</code>，性能高，但是now()之类的函数以及获取系统参数的操作会出现主从数据不同步的问题。</li><li>binlog_format=ROW（默认）：日志记录的是主机数据库的<code>写后的数据</code>，批量操作时性能较差，解决now()或者user()或者@@hostname 等操作在主从机器上不一致的问题。</li><li>binlog_format=MIXED：是以上两种level的混合使用，<code>有函数用ROW，没函数用STATEMENT</code></li></ul></blockquote><ul><li>使用命令行登录MySQL主服务器 修改默认的密码校验方式</li></ul><div class="custom-container tip"><p class="custom-container-title">warning</p><p>这里必须修改 否则后面idea连接数据库会有问题 <code>Caused by: com.mysql.cj.exceptions.UnableToConnectException: Public Key Retrieval is not allowed</code></p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 进入容器：env LANG=C.UTF-8 避免容器中显示中文乱码</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> mysql-master <span class="token function">env</span> <span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>C.UTF-8 /bin/bash
<span class="token comment"># 进入容器内的mysql命令行</span>
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span>
<span class="token comment"># 修改默认密码校验方式</span>
ALTER <span class="token environment constant">USER</span> <span class="token string">&#39;root&#39;</span>@<span class="token string">&#39;%&#39;</span> IDENTIFIED WITH mysql_native_password BY <span class="token string">&#39;root&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>主机中创建slave用户</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 创建slave用户</span>
<span class="token keyword">CREATE</span> <span class="token keyword">USER</span> <span class="token string">&#39;slave&#39;</span><span class="token variable">@&#39;%&#39;</span><span class="token punctuation">;</span>
<span class="token comment">-- 设置密码</span>
<span class="token keyword">ALTER</span> <span class="token keyword">USER</span> <span class="token string">&#39;slave&#39;</span><span class="token variable">@&#39;%&#39;</span> IDENTIFIED <span class="token keyword">WITH</span> mysql_native_password <span class="token keyword">BY</span> <span class="token string">&#39;root&#39;</span><span class="token punctuation">;</span>
<span class="token comment">-- 授予复制权限</span>
<span class="token keyword">GRANT</span> <span class="token keyword">REPLICATION</span> SLAVE <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">&#39;slave&#39;</span><span class="token variable">@&#39;%&#39;</span><span class="token punctuation">;</span>
<span class="token comment">-- 刷新权限</span>
FLUSH <span class="token keyword">PRIVILEGES</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>主机中查询master状态(执行完此步骤后<code>不要再操作主服务器MYSQL</code>，防止主服务器状态值变化)</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 记下File和Position的值 后面配置从机会用到</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">SHOW</span> MASTER <span class="token keyword">STATUS</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------+----------+--------------+------------------+-------------------+</span>
<span class="token operator">|</span> <span class="token keyword">File</span>          <span class="token operator">|</span> Position <span class="token operator">|</span> Binlog_Do_DB <span class="token operator">|</span> Binlog_Ignore_DB <span class="token operator">|</span> Executed_Gtid_Set <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+----------+--------------+------------------+-------------------+</span>
<span class="token operator">|</span> binlog<span class="token punctuation">.</span><span class="token number">000003</span> <span class="token operator">|</span>     <span class="token number">1051</span> <span class="token operator">|</span>              <span class="token operator">|</span>                  <span class="token operator">|</span>                   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+----------+--------------+------------------+-------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">准备从服务器1</p></div><ul><li>在docker中创建并启动MySQL从服务器：<code>端口3307</code></li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-p</span> <span class="token number">3307</span>:3306 <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /root/mysql/slave1/conf:/etc/mysql/conf.d <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /root/mysql/slave1/data:/var/lib/mysql <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span>root <span class="token punctuation">\</span>
<span class="token parameter variable">--name</span> mysql-slave1 <span class="token punctuation">\</span>
mysql:8.0.29
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>创建MySQL从服务器配置文件</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">vim</span> /root/mysql/slave1/conf/my.cnf

<span class="token comment"># 进入配置文件之后 按i进行编辑模式 添加下面的内容 添加完毕之后</span>
<span class="token comment"># 按Esc退出编辑模式 输入 :wq 保存退出</span>

<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token comment"># 服务器唯一id，每台服务器的id必须不同，如果配置其他从机，注意修改id</span>
server-id<span class="token operator">=</span><span class="token number">2</span>
<span class="token comment"># 中继日志名，默认xxxxxxxxxxxx-relay-bin</span>
<span class="token comment">#relay-log=relay-bin</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>重启MySQL容器</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> restart mysql-slave1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>使用命令行登录MySQL从服务器</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 进入容器：</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> mysql-slave1 <span class="token function">env</span> <span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>C.UTF-8 /bin/bash
<span class="token comment"># 进入容器内的mysql命令行</span>
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span>
<span class="token comment"># 修改默认密码校验方式</span>
ALTER <span class="token environment constant">USER</span> <span class="token string">&#39;root&#39;</span>@<span class="token string">&#39;%&#39;</span> IDENTIFIED WITH mysql_native_password BY <span class="token string">&#39;root&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>在从机上配置主从关系</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>CHANGE MASTER <span class="token keyword">TO</span> MASTER_HOST<span class="token operator">=</span><span class="token string">&#39;192.168.144.100&#39;</span><span class="token punctuation">,</span> 
MASTER_USER<span class="token operator">=</span><span class="token string">&#39;slave&#39;</span><span class="token punctuation">,</span>MASTER_PASSWORD<span class="token operator">=</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">,</span> MASTER_PORT<span class="token operator">=</span><span class="token number">3306</span><span class="token punctuation">,</span>
MASTER_LOG_FILE<span class="token operator">=</span><span class="token string">&#39;binlog.000003&#39;</span><span class="token punctuation">,</span>MASTER_LOG_POS<span class="token operator">=</span><span class="token number">1051</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">准备从服务器2</p></div><blockquote><p>和上面类似</p></blockquote><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-p</span> <span class="token number">3308</span>:3306 <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /root/mysql/slave2/conf:/etc/mysql/conf.d <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /root/mysql/slave2/data:/var/lib/mysql <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span>root <span class="token punctuation">\</span>
<span class="token parameter variable">--name</span> mysql-slave2 <span class="token punctuation">\</span>
mysql:8.0.29
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">vim</span> /root/mysql/slave2/conf/my.cnf

<span class="token comment"># 配置文件添加下面的内容</span>

<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token comment"># 服务器唯一id，每台服务器的id必须不同，如果配置其他从机，注意修改id</span>
server-id<span class="token operator">=</span><span class="token number">3</span>
<span class="token comment"># 中继日志名，默认xxxxxxxxxxxx-relay-bin</span>
<span class="token comment">#relay-log=relay-bin</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> restart mysql-slave2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">#进入容器：</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> mysql-slave2 <span class="token function">env</span> <span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>C.UTF-8 /bin/bash
<span class="token comment">#进入容器内的mysql命令行</span>
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span>
<span class="token comment">#修改默认密码校验方式</span>
ALTER <span class="token environment constant">USER</span> <span class="token string">&#39;root&#39;</span>@<span class="token string">&#39;%&#39;</span> IDENTIFIED WITH mysql_native_password BY <span class="token string">&#39;root&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>CHANGE MASTER <span class="token keyword">TO</span> MASTER_HOST<span class="token operator">=</span><span class="token string">&#39;192.168.144.100&#39;</span><span class="token punctuation">,</span> 
MASTER_USER<span class="token operator">=</span><span class="token string">&#39;slave&#39;</span><span class="token punctuation">,</span>MASTER_PASSWORD<span class="token operator">=</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">,</span> MASTER_PORT<span class="token operator">=</span><span class="token number">3306</span><span class="token punctuation">,</span>
MASTER_LOG_FILE<span class="token operator">=</span><span class="token string">&#39;binlog.000003&#39;</span><span class="token punctuation">,</span>MASTER_LOG_POS<span class="token operator">=</span><span class="token number">1051</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">启动主从同步</p></div><p>分别在两台从机上启动从机的复制功能，执行下面的SQL</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">START</span> SLAVE<span class="token punctuation">;</span>
<span class="token comment">-- 查看状态（不需要分号）</span>
<span class="token keyword">SHOW</span> SLAVE <span class="token keyword">STATUS</span>\G
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>两个关键进程</strong>: 下面两个参数都是Yes，则说明主从配置成功 两个从机分别进行查看</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">SHOW</span> SLAVE <span class="token keyword">STATUS</span>\G
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
               Slave_IO_State: Waiting <span class="token keyword">for</span> source <span class="token keyword">to</span> send event
                  Master_Host: <span class="token number">192.168</span><span class="token number">.144</span><span class="token number">.100</span>
                  Master_User: slave
                  Master_Port: <span class="token number">3306</span>
                Connect_Retry: <span class="token number">60</span>
              Master_Log_File: binlog<span class="token punctuation">.</span><span class="token number">000003</span>
          Read_Master_Log_Pos: <span class="token number">1051</span>
               Relay_Log_File: <span class="token number">3</span>e645e0a49ce<span class="token operator">-</span>relay<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000002</span>
                Relay_Log_Pos: <span class="token number">323</span>
        Relay_Master_Log_File: binlog<span class="token punctuation">.</span><span class="token number">000003</span>
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">测试主从同步</p></div><p>在主机中执行以下SQL，在从机中查看数据库、表和数据是否已经被同步</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> db_user<span class="token punctuation">;</span>
<span class="token keyword">USE</span> db_user<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t_user <span class="token punctuation">(</span>
 id <span class="token keyword">BIGINT</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
 uname <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_user<span class="token punctuation">(</span>uname<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">&#39;zhang3&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 这句sql执行之后 在三个服务器可以看到是不同的结果 因为获取的都是服务所在的本机的名字 这里获取的都是docker的id</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_user<span class="token punctuation">(</span>uname<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>@<span class="token variable">@hostname</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="shardingsphere-jdbc读写分离" tabindex="-1"><a class="header-anchor" href="#shardingsphere-jdbc读写分离" aria-hidden="true">#</a> ShardingSphere-JDBC读写分离</h3><blockquote><p>原理: 拦截到发送的sql 根据读请求和写请求发送到不同的主机和从机 然后去配置文件中去寻找对应的数据库 来完成读写分离，垂直水平分片的实现</p></blockquote><div class="custom-container tip"><p class="custom-container-title">创建SpringBoot程序</p></div><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>shardingsphere-jdbc-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.4.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!--兼容jdk17和spring boot3--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.yaml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>snakeyaml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.33<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.glassfish.jaxb<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jaxb-runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.3.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>8.0.30<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-plus-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.5.3.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.18.24<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">创建启动类</p></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// com.atcode.shardingjdbcdemo.ShardingJdbcDemoApplication</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShardingJdbcDemoApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ShardingJdbcDemoApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">创建实体类</p></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// com.atcode.shardingjdbcdemo.entity.User</span>
<span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span><span class="token string">&quot;t_user&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 绑定数据库表</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@TableId</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">IdType</span><span class="token punctuation">.</span><span class="token constant">AUTO</span><span class="token punctuation">)</span> <span class="token comment">// 绑定主键</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> uname<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">创建Mapper</p></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// com.atcode.shardingjdbcdemo.mapper.UserMapper</span>
<span class="token annotation punctuation">@Mapper</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span> <span class="token comment">//继承mybatis-plus的BaseMapper</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">编写配置文件application.properties</p></div><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># 配置 DataSource Driver</span>
<span class="token key attr-name">spring.datasource.driver-class-name</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.shardingsphere.driver.ShardingSphereDriver</span>
<span class="token comment"># 指定 YAML 配置文件</span>
<span class="token key attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:shardingsphere:classpath:shardingsphere.yaml</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># 模式配置</span>
<span class="token key atrule">mode</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> Standalone
  <span class="token key atrule">repository</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> JDBC

<span class="token comment"># 数据源配置</span>
<span class="token key atrule">dataSources</span><span class="token punctuation">:</span>
  <span class="token key atrule">write_ds</span><span class="token punctuation">:</span>
    <span class="token key atrule">dataSourceClassName</span><span class="token punctuation">:</span> com.zaxxer.hikari.HikariDataSource
    <span class="token key atrule">driverClassName</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">jdbcUrl</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.144.100<span class="token punctuation">:</span>3306/db_user
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root
  <span class="token key atrule">read_ds_0</span><span class="token punctuation">:</span>
    <span class="token key atrule">dataSourceClassName</span><span class="token punctuation">:</span> com.zaxxer.hikari.HikariDataSource
    <span class="token key atrule">driverClassName</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">jdbcUrl</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.144.100<span class="token punctuation">:</span>3307/db_user
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root
  <span class="token key atrule">read_ds_1</span><span class="token punctuation">:</span>
    <span class="token key atrule">dataSourceClassName</span><span class="token punctuation">:</span> com.zaxxer.hikari.HikariDataSource
    <span class="token key atrule">driverClassName</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">jdbcUrl</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.144.100<span class="token punctuation">:</span>3308/db_user
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root

<span class="token comment"># 读写分离配置</span>
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token tag">!READWRITE_SPLITTING</span>
    <span class="token key atrule">dataSources</span><span class="token punctuation">:</span>
      <span class="token key atrule">readwrite_ds</span><span class="token punctuation">:</span>
        <span class="token comment"># 写数据源</span>
        <span class="token key atrule">writeDataSourceName</span><span class="token punctuation">:</span> write_ds
        <span class="token comment"># 读数据源</span>
        <span class="token key atrule">readDataSourceNames</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> read_ds_0
          <span class="token punctuation">-</span> read_ds_1
        <span class="token key atrule">transactionalReadQueryStrategy</span><span class="token punctuation">:</span> PRIMARY <span class="token comment"># 事务内读请求的路由策略，可选值：PRIMARY（路由至主库）、FIXED（同一事务内路由至固定数据源）、DYNAMIC（同一事务内路由至非固定数据源）。默认值：DYNAMIC</span>
        <span class="token key atrule">loadBalancerName</span><span class="token punctuation">:</span> random
    <span class="token key atrule">loadBalancers</span><span class="token punctuation">:</span>
      <span class="token key atrule">random</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> RANDOM

<span class="token comment"># 输出sql</span>
<span class="token key atrule">props</span><span class="token punctuation">:</span>
  <span class="token key atrule">sql-show</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">编写测试类进行测试</p></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// com.atcode.shardingjdbcdemo.ShardingJdbcDemoApplicationTests</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShardingJdbcDemoApplicationTests</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserMapper</span> userMapper<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 写入数据测试
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setUname</span><span class="token punctuation">(</span><span class="token string">&quot;测试1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code><span class="token level info keyword">INFO</span> <span class="token number">9452</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_user  <span class="token operator">(</span> uname <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">9452</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> write_ds <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_user  <span class="token operator">(</span> uname <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span> <span class="token operator">)</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span>测试<span class="token number">1</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>并且可以从主机从机都可以看到新增的记录 说明主从同步配置成功</p><div class="custom-container tip"><p class="custom-container-title">负载均衡测试</p></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 负载均衡测试
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user1 <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># 负载均衡算法配置</span>
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token tag">!READWRITE_SPLITTING</span>
    <span class="token key atrule">loadBalancers</span><span class="token punctuation">:</span>
      <span class="token key atrule">random</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> RANDOM
      <span class="token key atrule">round_robin</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> ROUND_ROBIN
      <span class="token key atrule">weight</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> WEIGHT
        <span class="token key atrule">props</span><span class="token punctuation">:</span>
          <span class="token key atrule">read_ds_0</span><span class="token punctuation">:</span> <span class="token number">1</span>
          <span class="token key atrule">read_ds_1</span><span class="token punctuation">:</span> <span class="token number">2</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动测试 可以看到石洞不同的从机进行的读取数据 部分日志如下:</p><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code><span class="token level info keyword">INFO</span> <span class="token number">10636</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> read_ds_0 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> SELECT id<span class="token punctuation">,</span>uname FROM t_user WHERE id<span class="token operator">=</span><span class="token operator">?</span>  <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10636</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> SELECT id<span class="token punctuation">,</span>uname FROM t_user WHERE id<span class="token operator">=</span><span class="token operator">?</span> 
<span class="token level info keyword">INFO</span> <span class="token number">10636</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> read_ds_0 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> SELECT id<span class="token punctuation">,</span>uname FROM t_user WHERE id<span class="token operator">=</span><span class="token operator">?</span>  <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10636</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> SELECT id<span class="token punctuation">,</span>uname FROM t_user WHERE id<span class="token operator">=</span><span class="token operator">?</span> 
<span class="token level info keyword">INFO</span> <span class="token number">10636</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> read_ds_1 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> SELECT id<span class="token punctuation">,</span>uname FROM t_user WHERE id<span class="token operator">=</span><span class="token operator">?</span>  <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10636</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> SELECT id<span class="token punctuation">,</span>uname FROM t_user WHERE id<span class="token operator">=</span><span class="token operator">?</span> 
<span class="token level info keyword">INFO</span> <span class="token number">10636</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> read_ds_1 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> SELECT id<span class="token punctuation">,</span>uname FROM t_user WHERE id<span class="token operator">=</span><span class="token operator">?</span>  <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10636</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> SELECT id<span class="token punctuation">,</span>uname FROM t_user WHERE id<span class="token operator">=</span><span class="token operator">?</span> 
<span class="token level info keyword">INFO</span> <span class="token number">10636</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> read_ds_1 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> SELECT id<span class="token punctuation">,</span>uname FROM t_user WHERE id<span class="token operator">=</span><span class="token operator">?</span>  <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10636</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> SELECT id<span class="token punctuation">,</span>uname FROM t_user WHERE id<span class="token operator">=</span><span class="token operator">?</span> 
<span class="token level info keyword">INFO</span> <span class="token number">10636</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> read_ds_0 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> SELECT id<span class="token punctuation">,</span>uname FROM t_user WHERE id<span class="token operator">=</span><span class="token operator">?</span>  <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">事务测试</p></div><p><strong>transactionalReadQueryStrategy: PRIMARY</strong> (在yml中配置的) 事务内读请求的路由策略，可选值：</p><ul><li>PRIMARY（路由至主库）</li><li>FIXED（同一事务内路由至固定数据源）</li><li>DYNAMIC（同一事务内路由至非固定数据源）。</li><li>默认值：DYNAMIC</li></ul><hr><ul><li>测试1 <ul><li>不添加<code>@Transactional</code>：insert对主库操作，select对从库操作<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 事务测试 不开启注解
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testTrans</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	user<span class="token punctuation">.</span><span class="token function">setUname</span><span class="token punctuation">(</span><span class="token string">&quot;事务测试&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	userMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> users <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code><span class="token level info keyword">INFO</span> <span class="token number">17576</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_user  <span class="token operator">(</span> uname <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">17576</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> write_ds <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_user  <span class="token operator">(</span> uname <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span> <span class="token operator">)</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span>事务测试<span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">17576</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> SELECT  id<span class="token punctuation">,</span>uname  FROM t_user
<span class="token level info keyword">INFO</span> <span class="token number">17576</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> read_ds_0 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> SELECT  id<span class="token punctuation">,</span>uname  FROM t_user
</code></pre><div class="highlight-lines"><br><div class="highlight-line"> </div><br><div class="highlight-line"> </div></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li>测试2 <ul><li>添加<code>@Transactional</code>：则insert和select按照transactionalReadQueryStrategy的配置执行<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 事务测试
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token annotation punctuation">@Transactional</span> <span class="token comment">// 开启事务</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testTrans1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	user<span class="token punctuation">.</span><span class="token function">setUname</span><span class="token punctuation">(</span><span class="token string">&quot;事务测试1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	userMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> userList <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code><span class="token level info keyword">INFO</span> <span class="token number">4188</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_user  <span class="token operator">(</span> uname <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">4188</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> write_ds <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_user  <span class="token operator">(</span> uname <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span> <span class="token operator">)</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span>事务测试<span class="token number">1</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">4188</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> SELECT  id<span class="token punctuation">,</span>uname  FROM t_user
<span class="token level info keyword">INFO</span> <span class="token number">4188</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> write_ds <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> SELECT  id<span class="token punctuation">,</span>uname  FROM t_user
</code></pre><div class="highlight-lines"><br><div class="highlight-line"> </div><br><div class="highlight-line"> </div></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li></ul><p><strong>注意</strong>: 在JUnit环境下的<code>@Transactional</code>注解，默认情况下就会对事务进行回滚（即使在没加注解@Rollback，也会对事务回滚）</p><div class="custom-container tip"><p class="custom-container-title">QueryWrapper的简单使用</p></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * QueryWrapper
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testQueryWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> userQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userQueryWrapper<span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span><span class="token string">&quot;uname&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;测&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// SELECT  id,uname  FROM t_user WHERE (uname LIKE ? AND id = ?) ::: [%测%, 3]</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> userList <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>userQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    userList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//User(id=3, uname=测试1)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="shardingsphere-jdbc垂直分片" tabindex="-1"><a class="header-anchor" href="#shardingsphere-jdbc垂直分片" aria-hidden="true">#</a> ShardingSphere-JDBC垂直分片</h3><p>服务器规划：使用<code>docker</code>方式创建如下容器:</p><ul><li>容器名<code>server-user</code>，端口 <code>3301</code></li><li>容器名<code>server-order</code>，端口<code>3302</code></li></ul><div class="custom-container tip"><p class="custom-container-title">创建server-user容器</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 创建容器</span>

<span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-p</span> <span class="token number">3301</span>:3306 <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /root/mysql/server/user/conf:/etc/mysql/conf.d <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /root/mysql/server/user/data:/var/lib/mysql <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span>root <span class="token punctuation">\</span>
<span class="token parameter variable">--name</span> server-user <span class="token punctuation">\</span>
mysql:8.0.29
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 登录MySQL服务器 修改默认密码校验方式</span>

<span class="token comment">#进入容器：</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> server-user <span class="token function">env</span> <span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>C.UTF-8 /bin/bash
<span class="token comment">#进入容器内的mysql命令行</span>
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span>
<span class="token comment">#修改默认密码插件</span>
ALTER <span class="token environment constant">USER</span> <span class="token string">&#39;root&#39;</span>@<span class="token string">&#39;%&#39;</span> IDENTIFIED WITH mysql_native_password BY <span class="token string">&#39;root&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 创建数据库</span>

<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> db_user<span class="token punctuation">;</span>
<span class="token keyword">USE</span> db_user<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t_user <span class="token punctuation">(</span>
 id <span class="token keyword">BIGINT</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
 uname <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">创建server-order容器</p></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 创建容器</span>

<span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-p</span> <span class="token number">3302</span>:3306 <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /root/mysql/server/order/conf:/etc/mysql/conf.d <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /root/mysql/server/order/data:/var/lib/mysql <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span>root <span class="token punctuation">\</span>
<span class="token parameter variable">--name</span> server-order <span class="token punctuation">\</span>
mysql:8.0.29
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 登录MySQL服务器 修改默认密码校验方式</span>

<span class="token comment">#进入容器：</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> server-order <span class="token function">env</span> <span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>C.UTF-8 /bin/bash
<span class="token comment">#进入容器内的mysql命令行</span>
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span>
<span class="token comment">#修改默认密码插件</span>
ALTER <span class="token environment constant">USER</span> <span class="token string">&#39;root&#39;</span>@<span class="token string">&#39;%&#39;</span> IDENTIFIED WITH mysql_native_password BY <span class="token string">&#39;root&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment"># 创建数据库</span>

<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> db_order<span class="token punctuation">;</span>
<span class="token keyword">USE</span> db_order<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t_order <span class="token punctuation">(</span>
  id <span class="token keyword">BIGINT</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  order_no <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  user_id <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> 
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">程序实现</p></div><ul><li>创建实体类</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// com.atcode.shardingjdbcdemo.entity.Order</span>
<span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span><span class="token string">&quot;t_order&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@TableId</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">IdType</span><span class="token punctuation">.</span><span class="token constant">AUTO</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> orderNo<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>创建Mapper</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// com.atcode.shardingjdbcdemo.mapper.OrderMapper</span>
<span class="token annotation punctuation">@Mapper</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>配置垂直分片</li></ul><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># 模式配置</span>
<span class="token key atrule">mode</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> Standalone
  <span class="token key atrule">repository</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> JDBC

<span class="token comment"># 数据源配置</span>
<span class="token key atrule">dataSources</span><span class="token punctuation">:</span>
  <span class="token key atrule">user_ds</span><span class="token punctuation">:</span>
    <span class="token key atrule">dataSourceClassName</span><span class="token punctuation">:</span> com.zaxxer.hikari.HikariDataSource
    <span class="token key atrule">driverClassName</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">jdbcUrl</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.144.100<span class="token punctuation">:</span>3301/db_user
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root
  <span class="token key atrule">order_ds</span><span class="token punctuation">:</span>
    <span class="token key atrule">dataSourceClassName</span><span class="token punctuation">:</span> com.zaxxer.hikari.HikariDataSource
    <span class="token key atrule">driverClassName</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">jdbcUrl</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.144.100<span class="token punctuation">:</span>3302/db_order
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root

<span class="token comment"># 垂直分片配置</span>
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token tag">!SHARDING</span>
    <span class="token key atrule">tables</span><span class="token punctuation">:</span>
      <span class="token key atrule">t_user</span><span class="token punctuation">:</span>
        <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> user_ds.t_user
      <span class="token key atrule">t_order</span><span class="token punctuation">:</span>
        <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> order_ds.t_order

<span class="token comment"># 输出sql</span>
<span class="token key atrule">props</span><span class="token punctuation">:</span>
  <span class="token key atrule">sql-show</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>测试垂直分片</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">UserMapper</span> userMapper<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">OrderMapper</span> orderMapper<span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 垂直分片：插入数据测试
 * 自动给我们添加的是按照不同类型添加到了不同的数据库
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testInsertOrderAndUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setUname</span><span class="token punctuation">(</span><span class="token string">&quot;垂直分片测试&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setOrderNo</span><span class="token punctuation">(</span><span class="token string">&quot;CXFP001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code><span class="token level info keyword">INFO</span> <span class="token number">15584</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_user  <span class="token operator">(</span> uname <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">15584</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> user_ds <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_user  <span class="token operator">(</span> uname <span class="token operator">)</span>  VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token operator">)</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span>垂直分片测试<span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">15584</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order  <span class="token operator">(</span> order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">15584</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order  <span class="token operator">(</span> order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span><span class="token punctuation">[</span>CXFP001<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
</code></pre><div class="highlight-lines"><br><div class="highlight-line"> </div><br><div class="highlight-line"> </div></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 垂直分片：查询数据测试
 * 自动去不同的数据库去获取数据
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSelectFromOrderAndUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Order</span> order <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code><span class="token level info keyword">INFO</span> <span class="token number">15784</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> SELECT id<span class="token punctuation">,</span>uname FROM t_user WHERE id<span class="token operator">=</span><span class="token operator">?</span> 
<span class="token level info keyword">INFO</span> <span class="token number">15784</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> user_ds <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> SELECT id<span class="token punctuation">,</span>uname FROM t_user WHERE id<span class="token operator">=</span><span class="token operator">?</span>  <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">15784</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> SELECT id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id FROM t_order WHERE id<span class="token operator">=</span><span class="token operator">?</span> 
<span class="token level info keyword">INFO</span> <span class="token number">15784</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> SELECT id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id FROM t_order WHERE id<span class="token operator">=</span><span class="token operator">?</span>  <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
</code></pre><div class="highlight-lines"><br><div class="highlight-line"> </div><br><div class="highlight-line"> </div></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="shardingsphere-jdbc水平分片" tabindex="-1"><a class="header-anchor" href="#shardingsphere-jdbc水平分片" aria-hidden="true">#</a> ShardingSphere-JDBC水平分片</h3><p>服务器规划: 使用docker创建下面的容器</p><ul><li>服务器：容器名<code>server-order0</code>，端口<code>3310</code></li><li>服务器：容器名<code>server-order1</code>，端口<code>3311</code></li></ul><div class="custom-container tip"><p class="custom-container-title">创建server-order0容器</p></div><ul><li>创建容器</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-p</span> <span class="token number">3310</span>:3306 <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /root/mysql/server/order0/conf:/etc/mysql/conf.d <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /root/mysql/server/order0/data:/var/lib/mysql <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span>root <span class="token punctuation">\</span>
<span class="token parameter variable">--name</span> server-order0 <span class="token punctuation">\</span>
mysql:8.0.29
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>登录MySQL服务器 更改mysql密码校验默认规则</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">#进入容器：</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> server-order0 <span class="token function">env</span> <span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>C.UTF-8 /bin/bash
<span class="token comment">#进入容器内的mysql命令行</span>
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span>
<span class="token comment">#修改默认密码插件</span>
ALTER <span class="token environment constant">USER</span> <span class="token string">&#39;root&#39;</span>@<span class="token string">&#39;%&#39;</span> IDENTIFIED WITH mysql_native_password BY <span class="token string">&#39;root&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>创建数据库 <ul><li><strong>注意</strong>: 水平分片的id需要在业务层实现，<code>不能依赖数据库的主键自增</code> 因为要做水平分库 如果主键自增 那么不同数据库中的id就会重复 所以主键不可以自增 只用全局id</li></ul></li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> db_order<span class="token punctuation">;</span>
<span class="token keyword">USE</span> db_order<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t_order0 <span class="token punctuation">(</span>
  id <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  order_no <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  user_id <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> 
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t_order1 <span class="token punctuation">(</span>
  id <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  order_no <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  user_id <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> 
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">创建server-order1容器</p></div><ul><li>创建容器</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-p</span> <span class="token number">3311</span>:3306 <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /root/mysql/server/order1/conf:/etc/mysql/conf.d <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /root/mysql/server/order1/data:/var/lib/mysql <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span>root <span class="token punctuation">\</span>
<span class="token parameter variable">--name</span> server-order1 <span class="token punctuation">\</span>
mysql:8.0.29
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>登录MySQL服务器 更改默认的密码校验规则</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">#进入容器：</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> server-order1 <span class="token function">env</span> <span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>C.UTF-8 /bin/bash
<span class="token comment">#进入容器内的mysql命令行</span>
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span>
<span class="token comment">#修改默认密码插件</span>
ALTER <span class="token environment constant">USER</span> <span class="token string">&#39;root&#39;</span>@<span class="token string">&#39;%&#39;</span> IDENTIFIED WITH mysql_native_password BY <span class="token string">&#39;root&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>创建数据库 <ul><li>和server-order0相同 数据库名表名都一致 并且主键id不可自增 水平分片的id需要在业务层实现</li></ul></li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> db_order<span class="token punctuation">;</span>
<span class="token keyword">USE</span> db_order<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t_order0 <span class="token punctuation">(</span>
  id <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  order_no <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  user_id <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> 
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t_order1 <span class="token punctuation">(</span>
  id <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  order_no <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  user_id <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> 
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">水平分片</p></div><ul><li>配置一个分片节点</li></ul><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># 模式配置</span>
<span class="token key atrule">mode</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> Standalone
  <span class="token key atrule">repository</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> JDBC

<span class="token comment"># 数据源配置</span>
<span class="token key atrule">dataSources</span><span class="token punctuation">:</span>
  <span class="token key atrule">user_ds</span><span class="token punctuation">:</span>
    <span class="token key atrule">dataSourceClassName</span><span class="token punctuation">:</span> com.zaxxer.hikari.HikariDataSource
    <span class="token key atrule">driverClassName</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">jdbcUrl</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.144.100<span class="token punctuation">:</span>3301/db_user
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root
  <span class="token key atrule">order_ds_0</span><span class="token punctuation">:</span>
    <span class="token key atrule">dataSourceClassName</span><span class="token punctuation">:</span> com.zaxxer.hikari.HikariDataSource
    <span class="token key atrule">driverClassName</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">jdbcUrl</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.144.100<span class="token punctuation">:</span>3310/db_order
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root
  <span class="token key atrule">order_ds_1</span><span class="token punctuation">:</span>
    <span class="token key atrule">dataSourceClassName</span><span class="token punctuation">:</span> com.zaxxer.hikari.HikariDataSource
    <span class="token key atrule">driverClassName</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">jdbcUrl</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.144.100<span class="token punctuation">:</span>3311/db_order
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root

<span class="token comment"># 配置一个order分片节点 </span>
<span class="token comment"># 先配置一个进行测试 因为分片规则还没有配置 所以其他的分片目前还不可以配置</span>
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token tag">!SHARDING</span>
    <span class="token key atrule">tables</span><span class="token punctuation">:</span>
      <span class="token key atrule">t_user</span><span class="token punctuation">:</span>
        <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> user_ds.t_user
      <span class="token key atrule">t_order</span><span class="token punctuation">:</span>
        <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> order_ds_0.t_order0

<span class="token comment"># 输出sql</span>
<span class="token key atrule">props</span><span class="token punctuation">:</span>
  <span class="token key atrule">sql-show</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>修改Order实体类的主键策略</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// @TableId(type = IdType.AUTO) // 依赖数据库的主键自增策略</span>
<span class="token annotation punctuation">@TableId</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">IdType</span><span class="token punctuation">.</span><span class="token constant">ASSIGN_ID</span><span class="token punctuation">)</span> <span class="token comment">// 分布式id</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>测试</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 水平分片：插入数据测试
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testInsertOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setOrderNo</span><span class="token punctuation">(</span><span class="token string">&quot;SPFP001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code><span class="token level info keyword">INFO</span> <span class="token number">2144</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">2144</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_0 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order0  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">1716996525386690561</span><span class="token punctuation">,</span> SPFP001<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">水平分库配置</p></div><ul><li>使用<a href="https://shardingsphere.apache.org/document/current/cn/features/sharding/concept/#%E8%A1%8C%E8%A1%A8%E8%BE%BE%E5%BC%8F" target="_blank" rel="noopener noreferrer">行表达式<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>将数据 分片到order_ds_0和order_ds_1中</li></ul><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># 这里使用行表达式 代表 order_ds_0.t_order0 order_ds_1.t_order0</span>
<span class="token comment"># 如果有多个 比如 0 1 2 3  则 ${0..3}</span>
<span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> order_ds_$<span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>.t_order0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>分片算法配置(分库) <ul><li>分片规则：order表中<code>user_id</code>为偶数时，数据插入<code>server-order0服务器</code>，<code>user_id</code>为奇数时，数据插入<code>server-order1服务器</code></li><li>这样分片的好处是，同一个用户的订单数据，一定会被插入到同一台服务器上，查询一个用户的订单时效率较高</li></ul></li></ul><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token tag">!SHARDING</span>
    <span class="token key atrule">tables</span><span class="token punctuation">:</span>
      <span class="token key atrule">t_user</span><span class="token punctuation">:</span>
        <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> user_ds.t_user
      <span class="token key atrule">t_order</span><span class="token punctuation">:</span>
        <span class="token comment"># 行表达式 order_ds_0.t_order0  order_ds_1.t_order0</span>
        <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> order_ds_$<span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>.t_order0
        <span class="token key atrule">databaseStrategy</span><span class="token punctuation">:</span>
          <span class="token key atrule">standard</span><span class="token punctuation">:</span>
            <span class="token comment"># 指定分片的依据字段名</span>
            <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> user_id
            <span class="token comment"># 指定分片算法名 和下面一致</span>
            <span class="token key atrule">shardingAlgorithmName</span><span class="token punctuation">:</span> userid_inline
    <span class="token comment"># 分片算法</span>
    <span class="token key atrule">shardingAlgorithms</span><span class="token punctuation">:</span>
      <span class="token key atrule">userid_inline</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> INLINE
        <span class="token comment"># 具体实现 根据用户id取模去分配到不同的数据库</span>
        <span class="token key atrule">props</span><span class="token punctuation">:</span>
          <span class="token key atrule">algorithm-expression</span><span class="token punctuation">:</span> order_ds_$<span class="token punctuation">{</span>user_id % 2<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>测试 <ul><li>可以清空相关数据库中的数据 <code>truncate t_order0;</code></li></ul></li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 水平分片：分库插入数据测试
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testInsertOrderDatabaseStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setOrderNo</span><span class="token punctuation">(</span><span class="token string">&quot;SPFP&quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code><span class="token level info keyword">INFO</span> <span class="token number">1236</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">1236</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_1 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order0  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">1717009237567160322</span><span class="token punctuation">,</span> SPFP1698201877339<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">1236</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">1236</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_0 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order0  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">1717009257821454337</span><span class="token punctuation">,</span> SPFP1698201882221<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">1236</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">1236</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_1 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order0  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">1717009257888563202</span><span class="token punctuation">,</span> SPFP1698201882236<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">1236</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">1236</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_0 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order0  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">1717009257951477762</span><span class="token punctuation">,</span> SPFP1698201882245<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
</code></pre><div class="highlight-lines"><br><div class="highlight-line"> </div><br><div class="highlight-line"> </div><br><div class="highlight-line"> </div><br><div class="highlight-line"> </div></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在数据库中查看对应的数据 可以看到根据用户id 分到了不同的数据库</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- order_ds_0中的数据</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_order0<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token operator">|</span> id                  <span class="token operator">|</span> order_no          <span class="token operator">|</span> user_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token operator">|</span> <span class="token number">1717009237567160322</span> <span class="token operator">|</span> SPFP1698201877339 <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1717009257888563202</span> <span class="token operator">|</span> SPFP1698201882236 <span class="token operator">|</span>       <span class="token number">3</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment">-- order_ds_1中的数据</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_order0<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token operator">|</span> id                  <span class="token operator">|</span> order_no          <span class="token operator">|</span> user_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token operator">|</span> <span class="token number">1717009257821454337</span> <span class="token operator">|</span> SPFP1698201882221 <span class="token operator">|</span>       <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1717009257951477762</span> <span class="token operator">|</span> SPFP1698201882245 <span class="token operator">|</span>       <span class="token number">4</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">水平分表配置</p></div><p>将数据分片到order_ds_0和order_ds_1的t_order0和t_order1中</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> order_ds_$<span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>.t_order$<span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>分片算法配置(分表) <ul><li>分片规则：order表中<code>id</code>为偶数时，数据插入<code>t_order0数据表</code>，<code>id</code>为奇数时，数据插入<code>t_order1数据表</code></li></ul></li></ul><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token tag">!SHARDING</span>
    <span class="token key atrule">tables</span><span class="token punctuation">:</span>
      <span class="token key atrule">t_user</span><span class="token punctuation">:</span>
        <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> user_ds.t_user
      <span class="token key atrule">t_order</span><span class="token punctuation">:</span>
        <span class="token comment"># 行表达式 数据分片到order_ds_0和order_ds_1的t_order0和t_order1中 </span>
        <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> order_ds_$<span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>.t_order$<span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>
        <span class="token comment"># 数据库分片</span>
        <span class="token key atrule">databaseStrategy</span><span class="token punctuation">:</span>
          <span class="token key atrule">standard</span><span class="token punctuation">:</span>
            <span class="token comment"># 指定分片的依据字段名</span>
            <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> user_id
            <span class="token comment"># 指定分片算法名 和下面一致</span>
            <span class="token key atrule">shardingAlgorithmName</span><span class="token punctuation">:</span> userid_inline
        <span class="token comment"># 数据表分片</span>
        <span class="token key atrule">tableStrategy</span><span class="token punctuation">:</span>
          <span class="token key atrule">standard</span><span class="token punctuation">:</span>
            <span class="token comment"># 指定分片的依据字段名</span>
            <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> id
            <span class="token comment"># 指定分片算法名 和下面一致</span>
            <span class="token key atrule">shardingAlgorithmName</span><span class="token punctuation">:</span> orderid_inline

    <span class="token key atrule">shardingAlgorithms</span><span class="token punctuation">:</span>
      <span class="token comment"># 分库算法</span>
      <span class="token key atrule">userid_inline</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> INLINE
        <span class="token key atrule">props</span><span class="token punctuation">:</span>
          <span class="token comment"># 根据用户id取模进行分库</span>
          <span class="token key atrule">algorithm-expression</span><span class="token punctuation">:</span> order_ds_$<span class="token punctuation">{</span>user_id % 2<span class="token punctuation">}</span>
      <span class="token comment"># 分表算法</span>
      <span class="token key atrule">orderid_inline</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> INLINE
        <span class="token key atrule">props</span><span class="token punctuation">:</span>
          <span class="token comment"># 根据order的id进行分表</span>
          <span class="token key atrule">algorithm-expression</span><span class="token punctuation">:</span> t_order$<span class="token punctuation">{</span>id % 2<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>测试 <ul><li>可以清空相关数据库中的数据 <code>truncate t_order0;</code></li></ul></li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 水平分片：分表插入数据测试
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testInsertOrderTableStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setOrderNo</span><span class="token punctuation">(</span><span class="token string">&quot;SPFP&quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setOrderNo</span><span class="token punctuation">(</span><span class="token string">&quot;SPFP&quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code><span class="token level info keyword">INFO</span> <span class="token number">10428</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">10428</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_1 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order1  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span><span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1717011840980004865</span><span class="token punctuation">,</span> SPFP1698202498041<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10428</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">10428</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_1 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order0  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span><span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1717011860886171650</span><span class="token punctuation">,</span> SPFP1698202502843<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10428</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">10428</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_1 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order1  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span><span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1717011860949086209</span><span class="token punctuation">,</span> SPFP1698202502855<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10428</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">10428</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_1 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order1  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span><span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1717011861016195073</span><span class="token punctuation">,</span> SPFP1698202502863<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10428</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">10428</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_0 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order0  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span><span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1717011861016195074</span><span class="token punctuation">,</span> SPFP1698202502872<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10428</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">10428</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_0 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order0  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span><span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1717011861079109634</span><span class="token punctuation">,</span> SPFP1698202502890<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10428</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">10428</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_0 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order1  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span><span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1717011861142024193</span><span class="token punctuation">,</span> SPFP1698202502895<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10428</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">10428</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_0 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order0  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span><span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1717011861142024194</span><span class="token punctuation">,</span> SPFP1698202502899<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
</code></pre><div class="highlight-lines"><br><div class="highlight-line"> </div><br><div class="highlight-line"> </div><br><div class="highlight-line"> </div><br><div class="highlight-line"> </div><br><div class="highlight-line"> </div><br><div class="highlight-line"> </div><br><div class="highlight-line"> </div><br><div class="highlight-line"> </div></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在不同的数据库的不同数据库表查看数据</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- order_ds_0中的数据 根据订单id分到了不同的数据表中</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_order0<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token operator">|</span> id                  <span class="token operator">|</span> order_no          <span class="token operator">|</span> user_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token operator">|</span> <span class="token number">1717011860886171650</span> <span class="token operator">|</span> SPFP1698202502843 <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_order1<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token operator">|</span> id                  <span class="token operator">|</span> order_no          <span class="token operator">|</span> user_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token operator">|</span> <span class="token number">1717011840980004865</span> <span class="token operator">|</span> SPFP1698202498041 <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1717011860949086209</span> <span class="token operator">|</span> SPFP1698202502855 <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1717011861016195073</span> <span class="token operator">|</span> SPFP1698202502863 <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment">-- order_ds_1中的数据 根据订单id分到了不同的数据表中</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_order0<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token operator">|</span> id                  <span class="token operator">|</span> order_no          <span class="token operator">|</span> user_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token operator">|</span> <span class="token number">1717011861016195074</span> <span class="token operator">|</span> SPFP1698202502872 <span class="token operator">|</span>       <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1717011861079109634</span> <span class="token operator">|</span> SPFP1698202502890 <span class="token operator">|</span>       <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1717011861142024194</span> <span class="token operator">|</span> SPFP1698202502899 <span class="token operator">|</span>       <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_order1<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token operator">|</span> id                  <span class="token operator">|</span> order_no          <span class="token operator">|</span> user_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token operator">|</span> <span class="token number">1717011861142024193</span> <span class="token operator">|</span> SPFP1698202502895 <span class="token operator">|</span>       <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">多表关联</p></div><ul><li>创建关联表 <ul><li>在<code>server-order0、server-order1</code>服务器中分别创建两张订单详情表<code>t_order_item0、t_order_item1</code></li><li>我们希望<code>同一个用户的订单表和订单详情表中的数据都在同一个数据源中，避免跨库(跨主机)关联</code>，因此这两张表我们使用相同的分片策略</li><li>那么在<code>t_order_item</code>中我们也需要创建<code>order_id</code>和<code>user_id</code>这两个分片键</li></ul></li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- server-order0和server-order1中分别新建下面两张表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t_order_item0<span class="token punctuation">(</span>
    id <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
    user_id <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
    order_id <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
    price <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>count<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t_order_item1<span class="token punctuation">(</span>
    id <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
    user_id <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
    order_id <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
    price <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>count<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>创建实体类</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// com.atcode.shardingjdbcdemo.entity.OrderItem</span>
<span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span><span class="token string">&quot;t_order_item&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderItem</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@TableId</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">IdType</span><span class="token punctuation">.</span><span class="token constant">ASSIGN_ID</span><span class="token punctuation">)</span> <span class="token comment">// 分布式id</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> orderId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> price<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>创建Mapper</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// com.atcode.shardingjdbcdemo.mapper.OrderItemMapper</span>
<span class="token annotation punctuation">@Mapper</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderItemMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItem</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>配置关联表</li></ul><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token tag">!SHARDING</span>
    <span class="token key atrule">tables</span><span class="token punctuation">:</span>
      <span class="token key atrule">t_user</span><span class="token punctuation">:</span>
        <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> user_ds.t_user
      <span class="token key atrule">t_order</span><span class="token punctuation">:</span>
        <span class="token comment"># 行表达式 数据分片到order_ds_0和order_ds_1的t_order0和t_order1中</span>
        <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> order_ds_$<span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>.t_order$<span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>
        <span class="token comment"># 数据库分片</span>
        <span class="token key atrule">databaseStrategy</span><span class="token punctuation">:</span>
          <span class="token key atrule">standard</span><span class="token punctuation">:</span>
            <span class="token comment"># 指定分片的依据字段名</span>
            <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> user_id
            <span class="token comment"># 指定分片算法名 和下面一致</span>
            <span class="token key atrule">shardingAlgorithmName</span><span class="token punctuation">:</span> userid_inline
        <span class="token comment"># 数据表分片</span>
        <span class="token key atrule">tableStrategy</span><span class="token punctuation">:</span>
          <span class="token key atrule">standard</span><span class="token punctuation">:</span>
            <span class="token comment"># 指定分片的依据字段名</span>
            <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> id
            <span class="token comment"># 指定分片算法名 和下面一致</span>
            <span class="token key atrule">shardingAlgorithmName</span><span class="token punctuation">:</span> orderid_inline
      <span class="token comment"># 配置订单详情表</span>
      <span class="token key atrule">t_order_item</span><span class="token punctuation">:</span>
        <span class="token comment"># 行表达式</span>
        <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> order_ds_$<span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>.t_order_item$<span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>
        <span class="token comment"># 分库策略</span>
        <span class="token key atrule">databaseStrategy</span><span class="token punctuation">:</span>
          <span class="token key atrule">standard</span><span class="token punctuation">:</span>
            <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> user_id
            <span class="token key atrule">shardingAlgorithmName</span><span class="token punctuation">:</span> userid_inline
        <span class="token comment"># 分表策略</span>
        <span class="token key atrule">tableStrategy</span><span class="token punctuation">:</span>
          <span class="token key atrule">standard</span><span class="token punctuation">:</span>
            <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> order_id
            <span class="token key atrule">shardingAlgorithmName</span><span class="token punctuation">:</span> orderid_item_inline

    <span class="token key atrule">shardingAlgorithms</span><span class="token punctuation">:</span>
      <span class="token comment"># 分库算法</span>
      <span class="token key atrule">userid_inline</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> INLINE
        <span class="token key atrule">props</span><span class="token punctuation">:</span>
          <span class="token comment"># 根据用户id取模进行分库</span>
          <span class="token key atrule">algorithm-expression</span><span class="token punctuation">:</span> order_ds_$<span class="token punctuation">{</span>user_id % 2<span class="token punctuation">}</span>
      <span class="token comment"># 分表算法</span>
      <span class="token key atrule">orderid_inline</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> INLINE
        <span class="token key atrule">props</span><span class="token punctuation">:</span>
          <span class="token comment"># 根据order的id进行分表</span>
          <span class="token key atrule">algorithm-expression</span><span class="token punctuation">:</span> t_order$<span class="token punctuation">{</span>id % 2<span class="token punctuation">}</span>
      <span class="token comment"># 订单详情表的分表算法</span>
      <span class="token key atrule">orderid_item_inline</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> INLINE
        <span class="token key atrule">props</span><span class="token punctuation">:</span>
          <span class="token key atrule">algorithm-expression</span><span class="token punctuation">:</span> t_order_item$<span class="token punctuation">{</span>order_id % 2<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>测试 <ul><li>先把之前相关数据库中的数据表清空 <code>truncate t_order0;</code> <code>truncate t_order1;</code></li></ul></li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 测试关联表插入
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testInsertOrderAndOrderItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setOrderNo</span><span class="token punctuation">(</span><span class="token string">&quot;SPFP&quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">OrderItem</span> orderItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderItem<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderItem<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderItem<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderItem<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderItemMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setOrderNo</span><span class="token punctuation">(</span><span class="token string">&quot;SPFP&quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">OrderItem</span> orderItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderItem<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderItem<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderItem<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderItem<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderItemMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code><span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_1 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order0  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span><span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1717020274433490946</span><span class="token punctuation">,</span> SPFP1698204508735<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order_item  <span class="token operator">(</span> id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>order_id<span class="token punctuation">,</span>price<span class="token punctuation">,</span>count <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_1 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order_item0  <span class="token operator">(</span> id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>order_id<span class="token punctuation">,</span>price<span class="token punctuation">,</span>count <span class="token operator">)</span> VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1717020295392428033</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1717020274433490946</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order_item  <span class="token operator">(</span> id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>order_id<span class="token punctuation">,</span>price<span class="token punctuation">,</span>count <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_1 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order_item0  <span class="token operator">(</span> id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>order_id<span class="token punctuation">,</span>price<span class="token punctuation">,</span>count <span class="token operator">)</span> VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1717020295585366017</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1717020274433490946</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_1 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order1  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span><span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1717020295711195137</span><span class="token punctuation">,</span> SPFP1698204513854<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order_item  <span class="token operator">(</span> id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>order_id<span class="token punctuation">,</span>price<span class="token punctuation">,</span>count <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_1 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order_item1  <span class="token operator">(</span> id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>order_id<span class="token punctuation">,</span>price<span class="token punctuation">,</span>count <span class="token operator">)</span> VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1717020295774109698</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1717020295711195137</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order_item  <span class="token operator">(</span> id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>order_id<span class="token punctuation">,</span>price<span class="token punctuation">,</span>count <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_1 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order_item1  <span class="token operator">(</span> id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>order_id<span class="token punctuation">,</span>price<span class="token punctuation">,</span>count <span class="token operator">)</span> VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1717020295841218561</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1717020295711195137</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_0 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order1  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span><span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1717020295904133121</span><span class="token punctuation">,</span> SPFP1698204513896<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order_item  <span class="token operator">(</span> id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>order_id<span class="token punctuation">,</span>price<span class="token punctuation">,</span>count <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_0 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order_item1  <span class="token operator">(</span> id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>order_id<span class="token punctuation">,</span>price<span class="token punctuation">,</span>count <span class="token operator">)</span> VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1717020295904133122</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1717020295904133121</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order_item  <span class="token operator">(</span> id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>order_id<span class="token punctuation">,</span>price<span class="token punctuation">,</span>count <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_0 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order_item1  <span class="token operator">(</span> id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>order_id<span class="token punctuation">,</span>price<span class="token punctuation">,</span>count <span class="token operator">)</span> VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1717020295971241986</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1717020295904133121</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_0 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order1  <span class="token operator">(</span> id<span class="token punctuation">,</span>order_no<span class="token punctuation">,</span>user_id <span class="token operator">)</span>  VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span><span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1717020295971241987</span><span class="token punctuation">,</span> SPFP1698204513918<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order_item  <span class="token operator">(</span> id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>order_id<span class="token punctuation">,</span>price<span class="token punctuation">,</span>count <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_0 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order_item1  <span class="token operator">(</span> id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>order_id<span class="token punctuation">,</span>price<span class="token punctuation">,</span>count <span class="token operator">)</span> VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1717020295971241988</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1717020295971241987</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Logic SQL<span class="token operator">:</span> INSERT INTO t_order_item  <span class="token operator">(</span> id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>order_id<span class="token punctuation">,</span>price<span class="token punctuation">,</span>count <span class="token operator">)</span>  VALUES  <span class="token operator">(</span> <span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token operator">)</span>
<span class="token level info keyword">INFO</span> <span class="token number">10700</span> <span class="token separator comment">---</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ShardingSphere<span class="token operator">-</span>SQL                       <span class="token operator">:</span> Actual SQL<span class="token operator">:</span> order_ds_0 <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> INSERT INTO t_order_item1  <span class="token operator">(</span> id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>order_id<span class="token punctuation">,</span>price<span class="token punctuation">,</span>count <span class="token operator">)</span> VALUES  <span class="token operator">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">)</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1717020296034156545</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1717020295971241987</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在数据库中查询相关数据 根据用户id进行分库 根据订单id进行分表</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- order_ds_0中的数据</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_order0<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token operator">|</span> id                  <span class="token operator">|</span> order_no          <span class="token operator">|</span> user_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token operator">|</span> <span class="token number">1717020274433490946</span> <span class="token operator">|</span> SPFP1698204508735 <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_order_item0<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------------+---------+---------------------+-------+-------+</span>
<span class="token operator">|</span> id                  <span class="token operator">|</span> user_id <span class="token operator">|</span> order_id            <span class="token operator">|</span> price <span class="token operator">|</span> count <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+---------+---------------------+-------+-------+</span>
<span class="token operator">|</span> <span class="token number">1717020295392428033</span> <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">1717020274433490946</span> <span class="token operator">|</span> <span class="token number">10.00</span> <span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1717020295585366017</span> <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">1717020274433490946</span> <span class="token operator">|</span> <span class="token number">10.00</span> <span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+---------+---------------------+-------+-------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_order1<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token operator">|</span> id                  <span class="token operator">|</span> order_no          <span class="token operator">|</span> user_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token operator">|</span> <span class="token number">1717020295711195137</span> <span class="token operator">|</span> SPFP1698204513854 <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_order_item1<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------------+---------+---------------------+-------+-------+</span>
<span class="token operator">|</span> id                  <span class="token operator">|</span> user_id <span class="token operator">|</span> order_id            <span class="token operator">|</span> price <span class="token operator">|</span> count <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+---------+---------------------+-------+-------+</span>
<span class="token operator">|</span> <span class="token number">1717020295774109698</span> <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">1717020295711195137</span> <span class="token operator">|</span> <span class="token number">10.00</span> <span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1717020295841218561</span> <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">1717020295711195137</span> <span class="token operator">|</span> <span class="token number">10.00</span> <span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+---------+---------------------+-------+-------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

<span class="token comment">-- order_ds_1中的数据</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_order0<span class="token punctuation">;</span>
Empty <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_order_item0<span class="token punctuation">;</span>
Empty <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_order1<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token operator">|</span> id                  <span class="token operator">|</span> order_no          <span class="token operator">|</span> user_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token operator">|</span> <span class="token number">1717020295904133121</span> <span class="token operator">|</span> SPFP1698204513896 <span class="token operator">|</span>       <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1717020295971241987</span> <span class="token operator">|</span> SPFP1698204513918 <span class="token operator">|</span>       <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+-------------------+---------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_order_item1<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------------+---------+---------------------+-------+-------+</span>
<span class="token operator">|</span> id                  <span class="token operator">|</span> user_id <span class="token operator">|</span> order_id            <span class="token operator">|</span> price <span class="token operator">|</span> count <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+---------+---------------------+-------+-------+</span>
<span class="token operator">|</span> <span class="token number">1717020295904133122</span> <span class="token operator">|</span>       <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">1717020295904133121</span> <span class="token operator">|</span>  <span class="token number">5.00</span> <span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1717020295971241986</span> <span class="token operator">|</span>       <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">1717020295904133121</span> <span class="token operator">|</span>  <span class="token number">5.00</span> <span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1717020295971241988</span> <span class="token operator">|</span>       <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">1717020295971241987</span> <span class="token operator">|</span>  <span class="token number">5.00</span> <span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1717020296034156545</span> <span class="token operator">|</span>       <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">1717020295971241987</span> <span class="token operator">|</span>  <span class="token number">5.00</span> <span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+---------+---------------------+-------+-------+</span>
<span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 1515398578@qq.com">wxhcoding</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/myblog/database/sql/mysql_basic.html" class="" aria-label="MySQL入门"><!--[--><!--]--> MySQL入门 <!--[--><!--]--></a></span><span class="next"><a href="/myblog/database/nosql/redis.html" class="" aria-label="Redis"><!--[--><!--]--> Redis <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/myblog/assets/app-1lTnJ-Z-.js" defer></script>
  </body>
</html>
